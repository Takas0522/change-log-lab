name: Issue Answer

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  issue-analysis:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

      - name: Get Issue Content
        id: issue-content
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Use heredoc format for multiline strings in GitHub Output
          {
            echo "issue-title=${ISSUE_TITLE}"
            echo "issue-number=${ISSUE_NUMBER}"
            echo "issue-body<<EOF"
            echo "${ISSUE_BODY}"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Extract URLs from markdown links and create a cleaner format
          PROCESSED_BODY="${ISSUE_BODY}"
          echo "Debug: Original body:"
          echo "${PROCESSED_BODY}"
          
          # Extract GitHub attachment URLs and convert to plain text
          ATTACHMENT_URLS=$(echo "${ISSUE_BODY}" | grep -oE '\[([^\]]+)\]\((https://github\.com/user-attachments/files/[^)]+)\)' | sed -E 's/\[([^\]]+)\]\(([^)]+)\)/ãƒ•ã‚¡ã‚¤ãƒ«: \1\nURL: \2/g' || echo "")
          echo "Debug: Attachment URLs:"
          echo "${ATTACHMENT_URLS}"

          # Replace markdown links with plain text in the body
          PROCESSED_BODY=$(echo "${ISSUE_BODY}" | sed -E 's/\[([^\]]+)\]\(https:\/\/github\.com\/user-attachments\/files\/[^)]+\)/æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: \1/g')
          echo "Debug: Processed body:"
          echo "${PROCESSED_BODY}"
          
          # Create prompt for Copilot CLI using heredoc for multiline strings
          if [ -n "$ATTACHMENT_URLS" ]; then
            {
              echo "copilot-prompt<<EOF"
              echo "ä»¥ä¸‹ã®Issueã«ã¤ã„ã¦åˆ†æã—ã€è§£æ±ºç­–ã‚„å›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"
              echo ""
              echo "ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}"
              echo ""
              echo "å†…å®¹: ${PROCESSED_BODY}"
              echo ""
              echo "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:"
              echo "${ATTACHMENT_URLS}"
              echo ""
              echo "ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«URLã‹ã‚‰å†…å®¹ã‚’å–å¾—ã—ã¦åˆ†æã«å«ã‚ã¦ãã ã•ã„ã€‚"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            {
              echo "copilot-prompt<<EOF"
              echo "ä»¥ä¸‹ã®Issueã«ã¤ã„ã¦åˆ†æã—ã€è§£æ±ºç­–ã‚„å›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"
              echo ""
              echo "ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}"
              echo ""
              echo "å†…å®¹: ${PROCESSED_BODY}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Run Copilot CLI Analysis
        id: copilot-analysis
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT="${{ steps.issue-content.outputs.copilot-prompt }}"
          
          echo "Running Copilot CLI analysis..."
          echo "Prompt length: ${#PROMPT} characters"
          echo "--- Prompt Content (first 500 chars) ---"
          echo "${PROMPT:0:500}..."
          echo "--- End Prompt Preview ---"
          
          # Run Copilot CLI with error handling and better output capture
          COPILOT_RESULT=""
          echo "Executing: copilot with the prepared prompt"
          
          if COPILOT_RESULT=$(timeout 600 copilot --agent=sql-performance-review -p "$PROMPT" --allow-all-tools 2>&1); then
            echo "Copilot CLI executed successfully"
            echo "Result length: ${#COPILOT_RESULT} characters"
          else
            EXIT_CODE=$?
            echo "Copilot CLI encountered an error (exit code: $EXIT_CODE)"
            echo "Error output: $COPILOT_RESULT"
            COPILOT_RESULT="ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ã‚¨ãƒ©ãƒ¼è©³ç´°: 
            $COPILOT_RESULT

            æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚å•é¡ŒãŒç¶™ç¶šã™ã‚‹å ´åˆã¯ã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi
          
          # Use heredoc format for multiline output
          {
            echo "result<<EOF"
            echo "$COPILOT_RESULT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post Comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-content.outputs.issue-number }}"
          COPILOT_RESULT="${{ steps.copilot-analysis.outputs.result }}"
          
          # Create comment body using heredoc
          COMMENT_BODY=$(cat << 'EOL'
          ## ğŸ¤– Copilot CLI ã«ã‚ˆã‚‹åˆ†æçµæœ

          $COPILOT_RESULT

          ---
          *ã“ã®å›ç­”ã¯ GitHub Copilot CLI ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã® URL ãŒã‚ã‚‹å ´åˆã¯ã€Copilot CLI ãŒè‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åˆ†æã«å«ã‚ã¾ã™ã€‚*
          EOL
          )
          
          # Substitute the actual result
          COMMENT_BODY=$(echo "$COMMENT_BODY" | sed "s/\$COPILOT_RESULT/$COPILOT_RESULT/g")
          
          # Escape JSON for API call
          ESCAPED_COMMENT=$(echo "$COMMENT_BODY" | jq -Rs .)
          
          # Post comment using GitHub REST API
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
            -d "{\"body\": ${ESCAPED_COMMENT}}"

  copilot-cli-test:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Install GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

          echo "Running GitHub Copilot CLI with 'Hello' input..."
          copilot -p "Hello" --allow-all-tools
      
      # - name: Setup GitHub Copilot CLI with PAT
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #   run: |
      #     echo "Setting up GitHub Copilot CLI authentication..."
      #     # Authenticate with GitHub using PAT
      #     # gh auth login --with-token <<< "$GITHUB_TOKEN"
          
      #     # Verify authentication
      #     # gh auth status
      
      # - name: Run GitHub Copilot CLI
      #   run: |
      #     echo "Running GitHub Copilot CLI with 'Hello' input..."
      #     copilot -p "Hello" --allow-all-tools