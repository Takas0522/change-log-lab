name: Issue Answer

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  issue-analysis:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

      - name: Get Issue Content
        id: issue-content
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          echo "issue-title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue-body=${ISSUE_BODY}" >> $GITHUB_OUTPUT
          echo "issue-number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          
          # Create prompt for Copilot CLI (keep original markdown format with URLs)
          PROMPT="ä»¥ä¸‹ã®Issueã«ã¤ã„ã¦åˆ†æã—ã€è§£æ±ºç­–ã‚„å›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®URLãŒã‚ã‚‹å ´åˆã¯ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚‚å‚ç…§ã—ã¦ãã ã•ã„ã€‚

          ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}
          
          å†…å®¹: ${ISSUE_BODY}"
          
          echo "copilot-prompt=${PROMPT}" >> $GITHUB_OUTPUT

      - name: Run Copilot CLI Analysis
        id: copilot-analysis
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT="${{ steps.issue-content.outputs.copilot-prompt }}"
          
          echo "Running Copilot CLI analysis..."
          echo "Prompt length: ${#PROMPT} characters"
          
          # Run Copilot CLI with error handling
          COPILOT_RESULT=""
          if COPILOT_RESULT=$(copilot -p "$PROMPT" --allow-all-tools 2>&1); then
            echo "Copilot CLI executed successfully"
          else
            echo "Copilot CLI encountered an error, using fallback response"
            COPILOT_RESULT="ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
            ã‚¨ãƒ©ãƒ¼è©³ç´°: $COPILOT_RESULT
            æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"
          fi
          
          # Escape newlines for GitHub output
          ESCAPED_RESULT=$(echo "$COPILOT_RESULT" | jq -Rs .)
          echo "result=${ESCAPED_RESULT}" >> $GITHUB_OUTPUT

      - name: Post Comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-content.outputs.issue-number }}"
          COPILOT_RESULT=$(echo '${{ steps.copilot-analysis.outputs.result }}' | jq -r .)
          
          # Create comment body
          COMMENT_BODY="## ğŸ¤– Copilot CLI ã«ã‚ˆã‚‹åˆ†æçµæœ

          ${COPILOT_RESULT}

          ---
          *ã“ã®å›ç­”ã¯ GitHub Copilot CLI ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã® URL ãŒã‚ã‚‹å ´åˆã¯ã€Copilot CLI ãŒè‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åˆ†æã«å«ã‚ã¾ã™ã€‚*"
          
          # Escape JSON for API call
          ESCAPED_COMMENT=$(echo "$COMMENT_BODY" | jq -Rs .)
          
          # Post comment using GitHub REST API
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
            -d "{\"body\": ${ESCAPED_COMMENT}}"

  copilot-cli-test:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Install GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

          echo "Running GitHub Copilot CLI with 'Hello' input..."
          copilot -p "Hello" --allow-all-tools
      
      # - name: Setup GitHub Copilot CLI with PAT
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #   run: |
      #     echo "Setting up GitHub Copilot CLI authentication..."
      #     # Authenticate with GitHub using PAT
      #     # gh auth login --with-token <<< "$GITHUB_TOKEN"
          
      #     # Verify authentication
      #     # gh auth status
      
      # - name: Run GitHub Copilot CLI
      #   run: |
      #     echo "Running GitHub Copilot CLI with 'Hello' input..."
      #     copilot -p "Hello" --allow-all-tools