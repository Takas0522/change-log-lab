name: Issue Answer

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  issue-analysis:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

      - name: Get Issue Content
        id: issue-content
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Use heredoc format for multiline strings in GitHub Output
          {
            echo "issue-title=${ISSUE_TITLE}"
            echo "issue-number=${ISSUE_NUMBER}"
            echo "issue-body<<EOF"
            echo "${ISSUE_BODY}"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Extract URLs from markdown links and create a cleaner format
          PROCESSED_BODY="${ISSUE_BODY}"
          echo "Debug: Original body:"
          echo "${PROCESSED_BODY}"
          
          # Extract GitHub attachment URLs and convert to plain text
          ATTACHMENT_URLS=$(echo "${ISSUE_BODY}" | grep -oE '\[([^\]]+)\]\((https://github\.com/user-attachments/files/[^)]+)\)' | sed -E 's/\[([^\]]+)\]\(([^)]+)\)/„Éï„Ç°„Ç§„É´: \1\nURL: \2/g' || echo "")
          echo "Debug: Attachment URLs:"
          echo "${ATTACHMENT_URLS}"

          # Replace markdown links with plain text in the body
          PROCESSED_BODY=$(echo "${ISSUE_BODY}" | sed -E 's/\[([^\]]+)\]\(https:\/\/github\.com\/user-attachments\/files\/[^)]+\)/Ê∑ª‰ªò„Éï„Ç°„Ç§„É´: \1/g')
          echo "Debug: Processed body:"
          echo "${PROCESSED_BODY}"
          
          # Create prompt for Copilot CLI using heredoc for multiline strings
          if [ -n "$ATTACHMENT_URLS" ]; then
            {
              echo "copilot-prompt<<EOF"
              echo "‰ª•‰∏ã„ÅÆIssue„Å´„Å§„ÅÑ„Å¶ÂàÜÊûê„Åó„ÄÅËß£Ê±∫Á≠ñ„ÇÑÂõûÁ≠î„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
              echo ""
              echo "„Çø„Ç§„Éà„É´: ${ISSUE_TITLE}"
              echo ""
              echo "ÂÜÖÂÆπ: ${PROCESSED_BODY}"
              echo ""
              echo "Ê∑ª‰ªò„Éï„Ç°„Ç§„É´:"
              echo "${ATTACHMENT_URLS}"
              echo ""
              echo "„Åì„Çå„Çâ„ÅÆ„Éï„Ç°„Ç§„É´URL„Åã„ÇâÂÜÖÂÆπ„ÇíÂèñÂæó„Åó„Å¶ÂàÜÊûê„Å´Âê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            {
              echo "copilot-prompt<<EOF"
              echo "‰ª•‰∏ã„ÅÆIssue„Å´„Å§„ÅÑ„Å¶ÂàÜÊûê„Åó„ÄÅËß£Ê±∫Á≠ñ„ÇÑÂõûÁ≠î„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
              echo ""
              echo "„Çø„Ç§„Éà„É´: ${ISSUE_TITLE}"
              echo ""
              echo "ÂÜÖÂÆπ: ${PROCESSED_BODY}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Run Copilot CLI Analysis
        id: copilot-analysis
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT="${{ steps.issue-content.outputs.copilot-prompt }}"
          
          echo "Running Copilot CLI analysis..."
          echo "Prompt length: ${#PROMPT} characters"
          echo "--- Prompt Content (first 500 chars) ---"
          echo "${PROMPT:0:500}..."
          echo "--- End Prompt Preview ---"
          
          # Run Copilot CLI with error handling and better output capture
          COPILOT_RESULT=""
          echo "Executing: copilot with the prepared prompt"
          
          # Use a temporary file to capture output safely
          TEMP_OUTPUT=$(mktemp)
          
          if timeout 600 copilot --agent=sql-performance-review -p "$PROMPT" --allow-all-tools > "$TEMP_OUTPUT" 2>&1; then
            COPILOT_RESULT=$(cat "$TEMP_OUTPUT")
            echo "Copilot CLI executed successfully"
            echo "Result length: ${#COPILOT_RESULT} characters"
          else
            EXIT_CODE=$?
            COPILOT_ERROR=$(cat "$TEMP_OUTPUT")
            echo "Copilot CLI encountered an error (exit code: $EXIT_CODE)"
            echo "Error output: $COPILOT_ERROR"
            COPILOT_RESULT="Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ

            „Ç®„É©„ÉºË©≥Á¥∞: 
            $COPILOT_ERROR

            ÊâãÂãï„Åß„ÅÆÁ¢∫Ë™ç„Çí„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇÂïèÈ°å„ÅåÁ∂ôÁ∂ö„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„ÇíÁõ¥Êé•Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          fi
          
          # Clean up temporary file
          rm -f "$TEMP_OUTPUT"
          
          # Use heredoc format for multiline output with safe approach
          # Write directly to file to avoid shell interpretation
          {
            echo "result<<EOF"
            printf '%s\n' "$COPILOT_RESULT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post Comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-content.outputs.issue-number }}"
          
          # Read the copilot result more safely
          COPILOT_RESULT="${{ steps.copilot-analysis.outputs.result }}"
          
          # Create comment body template
          COMMENT_TEMPLATE="## ü§ñ Copilot CLI „Å´„Çà„ÇãÂàÜÊûêÁµêÊûú

          RESULT_PLACEHOLDER

          ---
          *„Åì„ÅÆÂõûÁ≠î„ÅØ GitHub Copilot CLI „Å´„Çà„ÇäËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅÆ URL „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅCopilot CLI „ÅåËá™ÂãïÁöÑ„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶ÂàÜÊûê„Å´Âê´„ÇÅ„Åæ„Åô„ÄÇ*"
          
          # Create a temporary file for safe text processing
          TEMP_RESULT=$(mktemp)
          printf '%s' "$COPILOT_RESULT" > "$TEMP_RESULT"
          
          TEMP_FINAL=$(mktemp)
          # Use awk for safer text replacement
          awk -v result_file="$TEMP_RESULT" '
          /RESULT_PLACEHOLDER/ {
            while ((getline line < result_file) > 0)
              print line
            close(result_file)
            next
          }
          { print }
          ' <<< "$COMMENT_TEMPLATE" > "$TEMP_FINAL"
          
          # Clean up result temp file
          rm -f "$TEMP_RESULT"
          
          # Escape JSON for API call using the safer approach
          ESCAPED_COMMENT=$(jq -Rs . < "$TEMP_FINAL")
          
          # Clean up final temp file  
          rm -f "$TEMP_FINAL"
          
          # Post comment using GitHub REST API
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
            -d "{\"body\": ${ESCAPED_COMMENT}}"

  copilot-cli-test:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Install GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          sudo rm -f /usr/bin/gh

          echo "Running GitHub Copilot CLI with 'Hello' input..."
          copilot -p "Hello" --allow-all-tools
      
      # - name: Setup GitHub Copilot CLI with PAT
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #   run: |
      #     echo "Setting up GitHub Copilot CLI authentication..."
      #     # Authenticate with GitHub using PAT
      #     # gh auth login --with-token <<< "$GITHUB_TOKEN"
          
      #     # Verify authentication
      #     # gh auth status
      
      # - name: Run GitHub Copilot CLI
      #   run: |
      #     echo "Running GitHub Copilot CLI with 'Hello' input..."
      #     copilot -p "Hello" --allow-all-tools