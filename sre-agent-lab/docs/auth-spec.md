# 認証仕様書

## 概要

独自の認証基盤を提供し、JWT (JSON Web Token) によるステートレスな認証を実現する。

---

## 認証フロー

### ユーザー登録

1. クライアントが `POST /api/auth/register` にメールアドレス・パスワード・表示名を送信
2. サーバーがメールアドレスの重複を確認
3. パスワードをBCryptでハッシュ化して `users` テーブルに保存
4. 登録成功レスポンスを返す（トークンは発行しない → ログイン画面へ遷移）

### ログイン

1. クライアントが `POST /api/auth/login` にメールアドレス・パスワードを送信
2. サーバーがメールアドレスでユーザーを検索
3. BCryptでパスワードを検証
4. 検証成功時、JWTトークンを生成して返却
5. クライアントはトークンを `sessionStorage` に保存

### APIアクセス

1. クライアントがHTTPリクエストに `Authorization: Bearer <token>` ヘッダーを付与
2. サーバーがJWTトークンを検証（署名、有効期限、Issuer、Audience）
3. 検証成功時、トークンのクレームからユーザーIDを取得してリクエストを処理
4. 検証失敗時、`401 Unauthorized` を返す

### ログアウト

1. クライアントが `sessionStorage` からトークンを削除
2. ログイン画面にリダイレクト

---

## JWT仕様

### トークン構成

| 項目 | 値 |
|---|---|
| アルゴリズム | HMAC-SHA256 (HS256) |
| 有効期限 | 60分 |
| Issuer | `sre-agent-lab` |
| Audience | `sre-agent-lab` |

### クレーム

| クレーム | 説明 |
|---|---|
| sub | ユーザーID (UUID) |
| email | メールアドレス |
| jti | トークン一意識別子 (UUID) |
| iat | 発行日時 |
| exp | 有効期限 |

### 署名鍵

- 開発環境: `appsettings.Development.json` に格納
- 本番環境: 環境変数 `JWT_SIGNING_KEY` から取得
- 最低32文字以上の文字列

---

## パスワードポリシー

| 項目 | 値 |
|---|---|
| ハッシュアルゴリズム | BCrypt |
| コストファクタ | 11 |
| 最小文字数 | 8文字 |

---

## トークン保存

| ストレージ | 理由 |
|---|---|
| sessionStorage | タブ/ウィンドウを閉じた際にトークンが自動的に破棄される。パブリック公開アプリのためlocalStorageより安全。 |

---

## セキュリティ考慮事項

- JWT秘密鍵は本番環境では環境変数から取得し、ソースコードに含めない
- CORS設定は本番環境では特定のフロントエンドオリジンのみ許可
- トークンのペイロードに機密情報（パスワード等）を含めない
- ユーザーは自分のToDoのみにアクセス可能（JWTの `sub` クレームで所有者検証）
- パスワードはサーバー側でバリデーション（最低8文字）
- ログインエラーメッセージは「メールアドレスまたはパスワードが正しくありません」と統一し、メールアドレスの存在有無を漏洩させない
