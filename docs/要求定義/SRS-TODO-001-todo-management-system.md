# 要求仕様書: 高機能ToDoマネジメントシステム

**文書ID**: SRS-TODO-001  
**バージョン**: 1.1  
**作成日**: 2024-01-15  
**最終更新日**: 2024-01-31  
**ステータス**: Review  
**作成者**: AI Agent

---

## 1. はじめに

### 1.1 目的

本文書は、高機能ToDoマネジメントシステムの要求仕様を明確化し、ISO/IEC/IEEE 29148:2018に準拠した形式で、ステークホルダー間の共通理解を確立することを目的とします。

本システムは、ユーザーがタスク管理を効率的に行い、生産性を向上させることを目指します。

### 1.2 範囲

本要求仕様書は以下の範囲をカバーします:

**対象システム**:
- ToDoアイテムの作成、閲覧、更新、削除（CRUD操作）
- ラベルベースのタスク分類機能
- 高度なフィルタリングおよび検索機能
- ステータス管理によるタスク進捗トラッキング

**対象外**:
- 複数ユーザー間のコラボレーション機能（共有、コメント等）
- カレンダー統合機能
- 通知・リマインダー機能（将来の拡張として検討）
- モバイルアプリケーション（Web版のみ）

### 1.3 定義・略語・略称

| 用語 | 定義 |
|---|---|
| ToDo | ユーザーが管理するタスクアイテム（表記統一：「ToDo」を使用、「Todo」は不可） |
| ラベル | ToDoを分類・識別するための色付きタグ |
| ステータス | ToDoの進捗状態を表す属性 |
| CRUD | Create（作成）、Read（読取）、Update（更新）、Delete（削除）の略 |
| SPA | Single Page Application - 単一ページで動作するWebアプリケーション |
| API | Application Programming Interface - アプリケーション間のインターフェース |
| UX | User Experience - ユーザー体験 |
| REST | Representational State Transfer - アーキテクチャスタイル |
| 楽観的同時実行制御 | 複数ユーザーの同時更新を検出し、競合時にエラーを返す仕組み（バージョン管理） |
| 物理削除 | データベースからレコードを完全に削除する方式 |
| 論理削除 | レコードを削除フラグで管理し、物理的には残す方式 |
| Essential（必須） | システムの基本機能に不可欠な要件。MVPに含まれる |
| Conditional（条件付き） | 特定条件下で必要な要件。Phase 1.5または2で実装 |
| Optional（任意） | あると望ましいが必須ではない要件。Phase 2以降で検討 |

### 1.4 参照資料

- ISO/IEC/IEEE 29148:2018 - Systems and software engineering — Life cycle processes — Requirements engineering
- Angular公式ドキュメント (latest)
- ASP.NET Core公式ドキュメント (latest)
- SQL Server データベース設計ベストプラクティス
- プロジェクトリポジトリ: `/src/todo-service`

---

## 2. ビジネスコンテキスト

### 2.1 ビジネス目的

**主要目的**:
個人およびチームのタスク管理を支援し、生産性向上と作業の可視化を実現する

**期待される効果**:
1. **タスク管理の効率化**: 直感的なUIによる迅速なタスク登録・更新
2. **進捗の可視化**: ステータス管理による作業状況の明確化
3. **情報の構造化**: ラベル機能による柔軟な分類とフィルタリング
4. **時間管理の改善**: 日時ベースの検索・ソート機能
5. **ユーザー体験の向上**: モダンなWeb技術による快適な操作感

**ビジネスKPI**:
- タスク完了率の向上（目標: 15%改善）
- タスク登録から完了までの平均日数の短縮（目標: 20%削減）
- ユーザー満足度（目標: 4.0/5.0以上）
- システム利用継続率（目標: 月次70%以上）

### 2.2 ステークホルダー

| ステークホルダー | 役割 | 関心事項 |
|---|---|---|
| エンドユーザー | システムの主要利用者 | 使いやすさ、レスポンス速度、機能の充実度 |
| プロダクトオーナー | 要件定義・ビジネス価値の最大化 | ROI、ユーザー満足度、市場競争力 |
| 開発チーム | システム実装・保守 | 技術的実現可能性、保守性、拡張性 |
| QAチーム | 品質保証 | テスタビリティ、バグの早期発見、品質基準 |
| システム管理者 | 運用・監視 | 可用性、パフォーマンス、セキュリティ |
| セキュリティチーム | セキュリティ監査 | データ保護、認証認可、脆弱性対策 |

### 2.3 ビジネスプロセス

#### 現行業務フロー（想定）
```
ユーザー → メモアプリ/付箋 → タスク記録 → 手動管理 → 完了確認（散在）
```
**課題**:
- タスク情報が散在し一元管理できない
- 優先度や進捗が不明確
- 検索性が低く過去タスクの参照が困難

#### 改善後のフロー
```
ユーザー → ToDoシステム → タスク登録（構造化） 
         ↓
       ラベル付与・ステータス管理
         ↓
       フィルタリング・検索
         ↓
       進捗確認・完了
```
**改善点**:
- 一元管理による情報の集約
- ステータス管理による進捗の可視化
- ラベルによる柔軟な分類
- 高度な検索・フィルタリング機能

---

## 3. システム要件

### 3.1 機能要件

#### 3.1.1 ToDo管理機能

##### REQ-FUNC-001: ToDo作成機能
- **説明**: ユーザーは新規ToDoを作成できる
- **入力**: 
  - タイトル（必須、1-200文字）
  - 内容（任意、0-5000文字）
  - ラベル（任意、複数選択可）
- **処理**: 
  1. 入力値のバリデーション実行
  2. 投稿日時を自動設定（サーバータイムスタンプ）
  3. 初期ステータスを「未着手」に設定
  4. データベースに永続化
  5. 一意のToDo IDを生成
- **出力**: 
  - 作成されたToDoオブジェクト（ID含む）
  - 成功/失敗ステータス
- **優先度**: Essential

**詳細バリデーションルール**:

**タイトル**:
- 文字数: 1-200文字（必須）
- 許可文字: Unicode文字全般（絵文字含む）
- 禁止文字: なし
- 前後の空白: 自動トリミング
- HTMLタグ: エスケープして保存（表示時はテキストとして扱う）
- 制御文字: 改行（\n）のみ許可、その他は除去

**内容**:
- 文字数: 0-5000文字（任意）
- 許可文字: Unicode文字全般（絵文字含む）
- HTMLタグ: エスケープして保存
- Markdown: Phase 2で対応予定（現在は非対応）

- **受け入れ基準**: 
  - タイトルが空の場合、HTTP 400エラーとエラーコード「TITLE_REQUIRED」を返すこと
    - テスト方法: 空文字列でPOSTリクエストを送信し、400エラーが返ることを確認
  - タイトルが200文字を超える場合、HTTP 400エラーとエラーコード「TITLE_TOO_LONG」を返すこと
    - テスト方法: 201文字のタイトルでPOSTし、エラーが返ることを確認
  - 内容が5000文字を超える場合、HTTP 400エラーとエラーコード「CONTENT_TOO_LONG」を返すこと
    - テスト方法: 5001文字の内容でPOSTし、エラーが返ることを確認
  - 作成成功後、500ms以内に一覧画面に反映されること
    - テスト方法: Performance APIで作成APIコール完了から画面更新までの時間を測定
  - 投稿日時は常にサーバーのタイムゾーン（UTC）で記録されること
    - テスト方法: レスポンスのCreatedAtフィールドがISO 8601形式（末尾Z）であることを確認
  - ラベルは0個以上選択可能であること
    - テスト方法: ラベル0個、1個、5個で作成し、全て成功することを確認
  - HTMLタグを含むタイトルはエスケープされて保存されること
    - テスト方法: `<script>alert('test')</script>` を含むタイトルで作成し、エスケープされて保存されることを確認
  - 絵文字を含むタイトルが正しく保存・表示されること
    - テスト方法: 「買い物 🛒」のようなタイトルで作成し、正しく表示されることを確認

##### REQ-FUNC-002: ToDo閲覧機能
- **説明**: ユーザーは登録済みToDoを閲覧できる
- **入力**: 
  - フィルター条件（任意）
  - ソート条件（任意）
  - ページネーション情報（ページ番号、表示件数）
- **処理**: 
  1. フィルター条件に基づくデータ抽出
  2. ソート条件に基づく並び替え
  3. ページネーション適用
  4. ラベル情報の結合
- **出力**: 
  - ToDoリスト（ページング対応）
  - 総件数
  - ページ情報
- **優先度**: Essential

**ページネーション詳細仕様**:

1. **デフォルト値**:
   - ページサイズ: 20件/ページ
   - 開始ページ: 1（1-based index）

2. **クエリパラメータ**:
   - `page`: ページ番号（1から開始）
   - `pageSize`: 1ページあたりの件数
   - 最小値: `pageSize=1`
   - 最大値: `pageSize=100`（100を超える場合はHTTP 400エラー）

3. **レスポンス形式**:
   ```json
   {
     "data": [ /* ToDoリスト */ ],
     "pagination": {
       "currentPage": 1,
       "pageSize": 20,
       "totalItems": 157,
       "totalPages": 8,
       "hasNextPage": true,
       "hasPreviousPage": false
     }
   }
   ```

4. **総ページ数の計算**:
   ```
   totalPages = Math.ceil(totalItems / pageSize)
   ```
   - 例: totalItems=157, pageSize=20 → totalPages=8

5. **境界条件**:
   - ページ番号が総ページ数を超える場合: 空の配列を返す（404ではない）
   - ページ番号が0以下: HTTP 400 Bad Request

- **受け入れ基準**: 
  - デフォルトで20件/ページが表示されること
    - テスト方法: クエリパラメータなしでGETリクエストし、最大20件が返ることを確認
  - 各ToDoにタイトル、ステータス、投稿日時、ラベルが表示されること
    - テスト方法: レスポンスの各ToDoオブジェクトに全フィールドが含まれることを確認
  - 内容は最初の100文字を表示し、100文字を超える場合は「...」を末尾に付加すること
    - テスト方法: 101文字の内容を持つToDoを作成し、一覧画面で「100文字+...」が表示されることを確認
  - 内容が改行を含む場合、最初の改行までを表示し「...」を付加すること
    - テスト方法: 「タイトル\n詳細内容」のような内容で、「タイトル...」が表示されることを確認
  - ページネーションレスポンスに`totalItems`, `totalPages`, `hasNextPage`, `hasPreviousPage`が含まれること
    - テスト方法: レスポンスのpaginationオブジェクトに全フィールドが含まれることを確認
  - `pageSize`が100を超える場合、HTTP 400エラーが返ること
    - テスト方法: `pageSize=101`でGETリクエストし、400エラーが返ることを確認
  - 初期表示時は投稿日時の降順（新しい順）でソートされること
    - テスト方法: ソート指定なしでGETし、createdAtが降順であることを確認

##### REQ-FUNC-003: ToDo詳細閲覧機能
- **説明**: ユーザーは個別ToDoの詳細情報を閲覧できる
- **入力**: ToDo ID
- **処理**: 
  1. 指定されたIDのToDoを検索
  2. 関連するラベル情報を取得
  3. 詳細情報を整形
- **出力**: 
  - ToDo詳細情報（全フィールド）
  - 関連ラベルリスト
- **優先度**: Essential
- **受け入れ基準**: 
  - 全ての項目（タイトル、内容、投稿日時、ステータス、ラベル）が表示されること
  - 存在しないIDの場合、404エラーを返すこと
  - ラベルは色と名前が視覚的に表示されること

##### REQ-FUNC-004: ToDo更新機能
- **説明**: ユーザーは既存ToDoの情報を更新できる
- **入力**: 
  - ToDo ID
  - 更新するフィールド（タイトル、内容、ステータス、ラベル）
  - RowVersion（楽観的同時実行制御用）
- **処理**: 
  1. 指定されたToDoの存在確認
  2. 入力値のバリデーション
  3. RowVersionの検証
  4. 更新可能フィールドのみ変更
  5. 最終更新日時の自動更新
  6. データベースに永続化
- **出力**: 
  - 更新後のToDoオブジェクト（新しいRowVersion含む）
  - 成功/失敗ステータス
- **優先度**: Essential

**楽観的同時実行制御の詳細**:

1. **バージョン管理フィールド**:
   - データベースに `RowVersion` (ROWVERSION/TIMESTAMP) を追加
   - 各更新時に自動的にインクリメント

2. **更新処理フロー**:
   ```
   1. クライアントがToDo取得時に RowVersion を保持
   2. 更新リクエスト時に保持している RowVersion を送信
   3. サーバーは現在の RowVersion と比較
   4. 一致する場合: 更新を実行し、新しい RowVersion を返却
   5. 不一致の場合: HTTP 409 Conflict を返却
   ```

3. **競合発生時の処理**:
   - **エラーレスポンス**:
     ```json
     {
       "error": {
         "code": "CONCURRENT_UPDATE_CONFLICT",
         "message": "このToDoは他のユーザーによって更新されています",
         "details": [{
           "field": "rowVersion",
           "issue": "バージョンが一致しません。最新データを取得してください。"
         }],
         "currentVersion": "AAAAAABcd123",
         "currentData": { /* 最新のToDoデータ */ },
         "timestamp": "2024-01-31T10:30:00Z",
         "traceId": "abc123-def456"
       }
     }
     ```
   - **クライアントサイドの対応**:
     - エラーダイアログを表示
     - 「最新データを表示」ボタンを提供
     - ユーザーの入力内容は一時保存（ブラウザのlocalStorageに退避）
     - 最新データを取得後、変更箇所を比較表示（オプション）
     - 再編集を促す

4. **リトライポリシー**:
   - 競合エラー（409）は自動リトライしない
   - ユーザーに明示的な操作を求める

- **受け入れ基準**: 
  - 投稿日時（CreatedAt）は更新できないこと（イミュータブル）
    - テスト方法: CreatedAtを含む更新リクエストで、CreatedAtが変更されないことを確認
  - バリデーションルールはREQ-FUNC-001と同一であること
    - テスト方法: 201文字のタイトルで更新し、400エラーが返ることを確認
  - 最終更新日時（UpdatedAt）が自動的に記録されること
    - テスト方法: 更新前後でUpdatedAtが変わることを確認
  - 更新成功後、500ms以内に一覧画面に反映されること
    - テスト方法: Performance APIで更新APIコール完了から画面更新までの時間を測定
  - 2つのブラウザで同じToDoを同時に編集した場合、後から保存した方がHTTP 409エラーになること
    - テスト方法: 2つのブラウザで同じToDoを取得し、片方で更新後、もう片方で更新して409が返ることを確認
  - 競合時のエラーメッセージに最新データが含まれること
    - テスト方法: 409エラーのレスポンスに`currentData`フィールドが含まれることを確認
  - 競合時、クライアントはユーザー入力を失わないこと
    - テスト方法: 競合エラー発生時、フォーム内容がlocalStorageに保存されることを確認
  - 更新リクエストにRowVersionが含まれていない場合、HTTP 400エラーが返ること
    - テスト方法: RowVersionなしでPUTリクエストし、400エラーが返ることを確認

##### REQ-FUNC-005: ToDo削除機能
- **説明**: ユーザーは不要なToDoを削除できる
- **入力**: ToDo ID
- **処理**: 
  1. 指定されたToDoの存在確認
  2. 関連するラベル関連付けの削除（CASCADE DELETE）
  3. ToDoレコードの削除（物理削除）
  4. トランザクション管理
- **出力**: 
  - HTTP 204 No Content（削除成功）
  - HTTP 404 Not Found（存在しないID）
  - HTTP 403 Forbidden（他人のToDo）
- **優先度**: Essential

**削除方式の決定**: **物理削除**を採用

**採用理由**:
1. MVPフェーズではデータ復元機能は対象外
2. ストレージコストの削減
3. GDPR等の削除権への対応が容易
4. データベースパフォーマンスの維持

**将来の拡張（Phase 2以降）**:
- ゴミ箱機能（論理削除）の導入を検討
- 削除後30日間は復元可能にする

**処理フロー**:
1. ユーザーが削除ボタンをクリック
2. 確認ダイアログを表示
   - メッセージ: 「このToDoを削除してもよろしいですか？この操作は取り消せません。」
   - ボタン: 「キャンセル」「削除」
3. 「削除」をクリック後、以下を実行:
   a. TodoLabelテーブルから関連レコードを削除（CASCADE DELETE）
   b. Todoテーブルからレコードを削除
   c. トランザクション内で実行
4. 削除成功後、500ms以内に一覧画面を更新

- **受け入れ基準**: 
  - 削除前に確認ダイアログが表示されること
    - テスト方法: 削除ボタンクリック後、確認ダイアログが表示されることをE2Eテストで確認
  - 確認ダイアログに「取り消せない」旨の警告が表示されること
    - テスト方法: ダイアログのテキストに「取り消せません」が含まれることを確認
  - 削除後、該当ToDoが一覧から消えること
    - テスト方法: 削除後、GETリクエストで該当IDが404を返すことを確認
  - 削除後、関連するラベルとの紐付けも削除されること
    - テスト方法: TodoLabelテーブルに該当レコードが存在しないことを確認
  - 削除成功時、HTTP 204 No Contentが返ること
    - テスト方法: DELETEリクエストのレスポンスが204であることを確認
  - 存在しないToDoの削除要求はHTTP 404エラーを返すこと
    - テスト方法: 存在しないIDでDELETEリクエストし、404が返ることを確認
  - 他ユーザーのToDoの削除はHTTP 403エラーを返すこと
    - テスト方法: 別ユーザーのToDoをDELETEし、403が返ることを確認
  - 削除は500ms以内に一覧画面に反映されること
    - テスト方法: Performance APIで削除APIコール完了から画面更新までの時間を測定

##### REQ-FUNC-006: ToDoステータス管理機能
- **説明**: ユーザーはToDoのステータスを管理できる
- **入力**: 
  - ToDo ID
  - 新しいステータス値
- **処理**: 
  1. ステータス値のバリデーション（定義済み値のみ許可）
  2. ステータス更新
  3. ステータス変更履歴の記録（オプション）
- **出力**: 
  - 更新後のステータス
  - 成功/失敗ステータス
- **優先度**: Essential
- **ステータス定義**:
  - `NOT_STARTED`: 未着手
  - `IN_PROGRESS`: 着手中
  - `COMPLETED`: 完了
  - `ABANDONED`: 放棄

**ステータス遷移制約**:
- MVPフェーズでは全てのステータス間の遷移を許可
- 制約なし（将来の拡張で制約を追加する可能性あり）
- 例: `COMPLETED` → `NOT_STARTED` も許可（再開を想定）

- **受け入れ基準**: 
  - 4つの定義済みステータスのみ設定可能であること
    - テスト方法: 定義外のステータス値でPATCHし、HTTP 422エラーが返ることを確認
  - 不正なステータス値は拒否され、エラーコード「INVALID_STATUS」を返すこと
    - テスト方法: `INVALID_VALUE`のようなステータスでPATCHし、422エラーとINVALID_STATUSが返ることを確認
  - ステータス変更は500ms以内にUIに反映されること
    - テスト方法: Performance APIでステータス更新APIコール完了から画面更新までの時間を測定
  - ステータス変更時に最終更新日時（UpdatedAt）が更新されること
    - テスト方法: ステータス変更前後でUpdatedAtが変わることを確認
  - 全てのステータス間の遷移が許可されること
    - テスト方法: COMPLETED → NOT_STARTEDなど、全ての組み合わせで遷移が成功することを確認

#### 3.1.2 ラベル管理機能

##### REQ-FUNC-007: ラベル作成機能
- **説明**: ユーザーは新規ラベルを作成できる
- **入力**: 
  - ラベル名（必須、1-50文字）
  - ラベル色（必須、カラーコードまたはプリセット色）
- **処理**: 
  1. 入力値のバリデーション
  2. 同名ラベルの重複チェック
  3. データベースに永続化
  4. 一意のラベルIDを生成
- **出力**: 
  - 作成されたラベルオブジェクト
  - 成功/失敗ステータス
- **優先度**: Essential

**ラベル名バリデーションルール**:
- 文字数: 1-50文字（必須）
- 許可文字: 英数字、日本語、一部記号（-, _, スペース）
- 禁止文字: 特殊記号（<, >, &, ', "）
- 大文字小文字: 区別する
- 重複: 同一ユーザー内で重複不可（大文字小文字を区別）

**色コードバリデーションルール**:
- 形式: `#RRGGBB` (6桁の16進数) - 大文字・小文字どちらも許可
- 例: `#FF5733`, `#3498DB`, `#ffffff`
- 検証: 正規表現 `^#[0-9A-Fa-f]{6}$`
- 省略形: `#RGB` 形式（3桁）は非対応（サーバーサイドで400エラー）

**プリセット色（10色）**:
| 色名 | カラーコード | 用途例 |
|---|---|---|
| レッド | #FF5733 | 緊急 |
| オレンジ | #FF8C42 | 重要 |
| イエロー | #FFC300 | 注意 |
| グリーン | #28A745 | 完了 |
| ブルー | #3498DB | 作業中 |
| パープル | #9B59B6 | 予定 |
| ピンク | #E91E63 | プライベート |
| グレー | #6C757D | 保留 |
| ブラウン | #795548 | その他 |
| シアン | #17A2B8 | 情報 |

- **受け入れ基準**: 
  - ラベル名が空の場合、HTTP 400エラーとエラーコード「LABEL_NAME_REQUIRED」を返すこと
    - テスト方法: 空文字列でPOSTし、400エラーが返ることを確認
  - ラベル名が50文字を超える場合、HTTP 400エラーが返ること
    - テスト方法: 51文字のラベル名でPOSTし、400エラーが返ることを確認
  - 同名のラベルが既に存在する場合、HTTP 409エラーとエラーコード「DUPLICATE_LABEL_NAME」を返すこと
    - テスト方法: 同じラベル名で2回POSTし、2回目が409エラーになることを確認
  - 色は`#RRGGBB`形式（6桁）で保存されること
    - テスト方法: レスポンスのcolorフィールドが正規表現`^#[0-9A-Fa-f]{6}$`に一致することを確認
  - `#RGB`形式（3桁）の色コードはHTTP 400エラーで拒否されること
    - テスト方法: `#FFF`のような3桁の色コードでPOSTし、400エラーが返ることを確認
  - プリセット色（10色）から選択可能であること
    - テスト方法: UI上でプリセット色選択機能が提供されていることを確認
  - カスタム色（任意の`#RRGGBB`）の入力も可能であること
    - テスト方法: カラーピッカーまたはテキスト入力で任意の色を指定できることを確認
  - 禁止文字（<, >, &, ', "）を含むラベル名はHTTP 400エラーで拒否されること
    - テスト方法: `Label<Script>`のような名前でPOSTし、400エラーが返ることを確認

##### REQ-FUNC-008: ラベル一覧表示機能
- **説明**: ユーザーは登録済みラベルの一覧を閲覧できる
- **入力**: なし（全ラベル取得）
- **処理**: 
  1. 全ラベルをデータベースから取得
  2. ラベル名の昇順でソート
  3. 各ラベルの使用回数を集計（オプション）
- **出力**: 
  - ラベルリスト
  - 各ラベルの使用回数（オプション）
- **優先度**: Essential
- **受け入れ基準**: 
  - ラベル一覧専用の管理画面が存在すること
  - 各ラベルは色とラベル名が視覚的に表示されること
  - 編集・削除アクションが各ラベルに対して利用可能であること

##### REQ-FUNC-009: ラベル更新機能
- **説明**: ユーザーは既存ラベルの情報を更新できる
- **入力**: 
  - ラベルID
  - 更新するフィールド（名前、色）
- **処理**: 
  1. 指定されたラベルの存在確認
  2. 入力値のバリデーション
  3. 同名チェック（他のラベルとの重複）
  4. データベースに永続化
- **出力**: 
  - 更新後のラベルオブジェクト
  - 成功/失敗ステータス
- **優先度**: Essential
- **受け入れ基準**: 
  - ラベル更新は関連付けられた全ToDoに即座に反映されること
  - バリデーションルールはREQ-FUNC-007と同一であること

##### REQ-FUNC-010: ラベル削除機能
- **説明**: ユーザーは不要なラベルを削除できる
- **入力**: ラベルID
- **処理**: 
  1. 指定されたラベルの存在確認
  2. ラベルを使用しているToDoの確認
  3. ToDoとの関連付けを解除
  4. ラベルレコードの削除
- **出力**: 
  - 削除成功/失敗ステータス
- **優先度**: Essential
- **受け入れ基準**: 
  - ラベル削除前に使用中のToDo数を表示し、確認ダイアログを表示すること
  - ラベル削除後、関連するToDoからラベルが自動的に削除されること
  - カスケード削除または関連解除が正しく機能すること

##### REQ-FUNC-011: ToDoへのラベル割り当て機能
- **説明**: ユーザーは複数のラベルをToDoに割り当てできる
- **入力**: 
  - ToDo ID
  - ラベルIDリスト（複数）
- **処理**: 
  1. ToDoとラベルの存在確認
  2. 既存の関連付けを削除
  3. 新しい関連付けを作成
  4. トランザクション管理
- **出力**: 
  - 割り当て後のラベルリスト
  - 成功/失敗ステータス
- **優先度**: Essential
- **受け入れ基準**: 
  - 1つのToDoに0個以上のラベルを設定できること
  - ラベルの上限は設定しない（無制限）
  - ラベルの割り当て・解除は即座にUIに反映されること
  - 同じラベルを重複して割り当てできないこと

#### 3.1.3 フィルタリング・検索機能

##### REQ-FUNC-012: ステータスフィルタリング機能
- **説明**: ユーザーはステータスでToDoをフィルタリングできる
- **入力**: ステータス値（単数または複数）
- **処理**: 
  1. 選択されたステータスに一致するToDoを抽出
  2. 複数選択時はOR条件で結合
  3. ページネーション適用
- **出力**: フィルタリングされたToDoリスト
- **優先度**: Essential
- **受け入れ基準**: 
  - 複数ステータスの同時選択が可能であること
  - 選択中のフィルター条件が視覚的に明示されること
  - フィルタークリア機能が提供されること

##### REQ-FUNC-013: ラベルフィルタリング機能
- **説明**: ユーザーはラベルでToDoをフィルタリングできる
- **入力**: ラベルID（単数または複数）
- **処理**: 
  1. 選択されたラベルが割り当てられたToDoを抽出
  2. 複数選択時のロジック（AND/OR）を適用
  3. ページネーション適用
- **出力**: フィルタリングされたToDoリスト
- **優先度**: Essential
- **受け入れ基準**: 
  - 複数ラベルの同時選択が可能であること
  - AND条件（全てのラベルを持つ）とOR条件（いずれかのラベルを持つ）を切り替え可能であること
  - ラベルは色と名前で視覚的に表示されること

##### REQ-FUNC-014: 日時範囲フィルタリング機能
- **説明**: ユーザーは投稿日時の範囲でToDoをフィルタリングできる
- **入力**: 
  - 開始日時（任意）
  - 終了日時（任意）
- **処理**: 
  1. 日時範囲のバリデーション（開始 ≤ 終了）
  2. 範囲内の投稿日時を持つToDoを抽出
  3. 開始のみ/終了のみの指定も許可
- **出力**: フィルタリングされたToDoリスト
- **優先度**: Essential
- **受け入れ基準**: 
  - 日時入力はカレンダーピッカーで選択可能であること
  - 「今日」「今週」「今月」などのプリセットボタンが提供されること
  - 開始日時のみ、終了日時のみの指定も可能であること
  - 不正な日時範囲（開始 > 終了）の場合、エラーメッセージを表示すること

##### REQ-FUNC-015: 自由記入項目検索機能
- **説明**: ユーザーはキーワードでToDoを検索できる
- **入力**: 検索キーワード（文字列）
- **処理**: 
  1. タイトルと内容に対して部分一致検索を実行
  2. 大文字小文字を区別しない（Case-insensitive）
  3. 複数キーワードはスペース区切りでAND検索
- **出力**: 検索結果のToDoリスト
- **優先度**: Essential
- **受け入れ基準**: 
  - タイトルと内容の両方が検索対象であること
  - 部分一致検索が機能すること
  - 検索キーワードがハイライト表示されること（オプション）
  - 検索結果が0件の場合、適切なメッセージを表示すること

##### REQ-FUNC-016: 複合フィルタリング機能
- **説明**: ユーザーは複数のフィルター条件を組み合わせできる
- **入力**: 
  - ステータス（任意、複数）
  - ラベル（任意、複数）
  - 日時範囲（任意）
  - 検索キーワード（任意）
- **処理**: 
  1. 全てのフィルター条件をAND結合
  2. 効率的なクエリ実行（インデックス活用）
  3. ページネーション適用
- **出力**: フィルタリングされたToDoリスト
- **優先度**: Essential

**フィルター条件の永続化仕様**:

1. **保存先**: ブラウザのlocalStorage
   - キー: `todoFilters_{userId}`
   - 値: JSON形式のフィルター条件

2. **保存内容**:
   ```json
   {
     "status": ["IN_PROGRESS", "NOT_STARTED"],
     "labelIds": [1, 3, 5],
     "labelFilterType": "AND",
     "startDate": "2024-01-01T00:00:00Z",
     "endDate": "2024-01-31T23:59:59Z",
     "search": "買い物",
     "sortBy": "createdAt",
     "sortOrder": "DESC"
   }
   ```

3. **保存タイミング**:
   - フィルター条件が変更されるたびに自動保存
   - デバウンス処理（500ms）を適用

4. **読み込みタイミング**:
   - ページ初回ロード時
   - ユーザーログイン後

5. **保存期間**:
   - localStorage の仕様に従う（ブラウザが削除するまで永続）
   - ユーザーが明示的にクリアした場合は削除

6. **代替案（Phase 2以降検討）**:
   - サーバーサイドに保存（ユーザー設定テーブル）
   - URLパラメータで共有可能にする

- **受け入れ基準**: 
  - 全てのフィルター条件を同時に適用可能であること
    - テスト方法: ステータス、ラベル、日時範囲、検索キーワードを全て指定してGETし、正しくフィルタリングされることを確認
  - フィルター条件はlocalStorageに保存され、ページリロード後も維持されること
    - テスト方法: フィルター設定後、ページリロードして同じフィルターが適用されていることを確認
  - フィルター条件変更から500ms後に自動保存されること
    - テスト方法: フィルター変更後500ms経過時点でlocalStorageに保存されていることを確認
  - アクティブなフィルター条件が一目で分かること
    - テスト方法: 適用中のフィルターがUIで視覚的に強調表示されることを確認
  - 「フィルタークリア」ボタンで全条件をリセットでき、localStorageからも削除されること
    - テスト方法: クリアボタンクリック後、全フィルターが解除され、localStorageが空になることを確認
  - 別のユーザーでログインした場合、異なるフィルター設定が読み込まれること
    - テスト方法: ユーザーAとユーザーBで異なるフィルターを設定し、それぞれ独立して保存されることを確認

#### 3.1.4 ソート機能

##### REQ-FUNC-017: ソート機能
- **説明**: ユーザーはToDoリストを任意の項目でソートできる
- **入力**: 
  - ソート対象フィールド（投稿日時、タイトル、ステータス）
  - ソート順序（昇順/降順）
- **処理**: 
  1. 指定されたフィールドでソート実行
  2. NULL値の扱いを定義
  3. ページネーション維持
- **出力**: ソートされたToDoリスト
- **優先度**: Conditional
- **受け入れ基準**: 
  - 投稿日時、タイトル、ステータスでソート可能であること
  - 列ヘッダークリックでソート切り替えが可能であること
  - 現在のソート状態がアイコンで表示されること

---

### 3.2 非機能要件

#### 3.2.1 性能要件

| 要件ID | 説明 | 目標値 | 優先度 |
|---|---|---|---|
| REQ-PERF-001 | ToDo一覧表示のレスポンスタイム | 95パーセンタイルで1秒以内 | Essential |
| REQ-PERF-002 | ToDo作成・更新のレスポンスタイム | 95パーセンタイルで500ms以内 | Essential |
| REQ-PERF-003 | 検索・フィルタリングのレスポンスタイム | 95パーセンタイルで1.5秒以内 | Essential |
| REQ-PERF-004 | 同時ユーザー数 | 100ユーザーで性能劣化なし | Conditional |
| REQ-PERF-005 | データベーススケーラビリティ | 10万件のToDoで性能維持 | Conditional |
| REQ-PERF-006 | フロントエンド初期ロード時間 | 3秒以内（3G環境） | Conditional |
| REQ-PERF-007 | APIエンドポイントのスループット | 100 req/sec以上 | Conditional |

**性能要件の測定条件**:

1. **測定環境**:
   - サーバースペック: Azure Standard B2s (2 vCPU, 4GB RAM) 相当
   - データベース: SQL Server Standard Edition
   - ネットワーク: 100Mbps, レイテンシ50ms以下
   - クライアント: Chrome最新版、Windows 10

2. **測定ツール**:
   - バックエンド: Application Insights、カスタムログ
   - フロントエンド: Lighthouse、Chrome DevTools Performance
   - 負荷テスト: Apache JMeter または k6

3. **測定方法**:
   - **REQ-PERF-001～003**: サーバーサイドでAPIレスポンスタイムを計測（ミドルウェアで記録）
   - **REQ-PERF-004**: 100ユーザーを同時シミュレートし、全リクエストの95パーセンタイルを測定
   - **REQ-PERF-005**: 10万件のテストデータを投入し、REQ-PERF-001～003が満たされることを確認
   - **REQ-PERF-006**: Lighthouse Performance Scoreで測定
   - **REQ-PERF-007**: JMeterで段階的に負荷を上げ、エラー率5%未満を維持できる最大req/secを測定

4. **測定データセット**:
   - ToDo: 1000件（小）、10,000件（中）、100,000件（大）
   - ラベル: 各ToDoに平均2.5個のラベル
   - ユーザー: 100ユーザー（負荷テスト時）

#### 3.2.2 セキュリティ要件

| 要件ID | 説明 | 実装方法 | カテゴリ | 優先度 |
|---|---|---|---|---|
| REQ-SEC-001 | ユーザー認証が必須であること | JWTトークンベース認証 | 認証 | Essential |
| REQ-SEC-002 | JWT（JSON Web Token）ベースの認証を実装 | 外部auth-serviceと連携 | 認証 | Essential |
| REQ-SEC-003 | HTTPS通信の強制 | サーバーサイドでHTTPリクエストを自動リダイレクト | 通信セキュリティ | Essential |
| REQ-SEC-004 | SQLインジェクション対策（パラメータ化クエリ） | Entity Framework CoreのパラメータバインディングまたはDapper使用 | データ保護 | Essential |
| REQ-SEC-005 | XSS対策 | 以下の対策を実装:<br>1. Angular DomSanitizerによる入力値のサニタイズ<br>2. Content Security Policy (CSP) ヘッダーの設定<br>3. innerHTML の使用禁止（textContent を使用）<br>4. サーバーサイドでの出力エスケープ処理 | データ保護 | Essential |
| REQ-SEC-006 | CSRF対策 | 以下の対策を実装:<br>1. ASP.NET Core AntiForgeryToken の使用<br>2. SameSite Cookie 属性の設定（Strict）<br>3. カスタムヘッダー（X-Requested-With）の検証 | データ保護 | Essential |
| REQ-SEC-007 | ユーザーは自身のToDoのみアクセス可能（認可） | JWTのUserIdクレームとリソースのUserIdを照合 | 認可 | Essential |
| REQ-SEC-008 | 入力値のサニタイゼーション | 以下のルールで入力値を検証・サニタイズ:<br>1. HTMLタグ: 全て除去またはエスケープ<br>2. JavaScriptコード: 検出時はHTTP 400エラー<br>3. SQLインジェクション: パラメータ化クエリの強制使用<br>4. 特殊文字: ホワイトリスト方式で許可文字を限定 | データ保護 | Essential |
| REQ-SEC-009 | パスワードのハッシュ化（bcrypt等） | auth-serviceで実装（本システムは認証を委譲） | データ保護 | Essential |
| REQ-SEC-010 | セッションタイムアウト（30分） | 30分間操作がない場合、自動ログアウト | 認証 | Conditional |

**セキュリティ実装チェックリスト**:
- [ ] OWASP Top 10 (2021) の全項目に対する対策を実装
- [ ] セキュリティスキャンツール（OWASP ZAP等）による自動診断
- [ ] セキュリティレビューの実施（開発フェーズ終了時）
- [ ] 依存ライブラリの脆弱性スキャン（npm audit、dotnet list package --vulnerable）
- [ ] API認証の単体テスト（401、403エラーのテスト）

##### 3.2.2.1 JWT認証の詳細仕様

**JWT構造**:
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-id-123",
    "name": "Taro Yamada",
    "email": "taro@example.com",
    "iat": 1674000000,
    "exp": 1674003600,
    "aud": "todo-service",
    "iss": "auth-service"
  }
}
```

**トークンライフサイクル**:
- **アクセストークン有効期限**: 1時間
- **リフレッシュトークン有効期限**: 7日間
- **セッションタイムアウト**: 30分間操作がない場合

**トークンリフレッシュフロー**:
```
1. アクセストークンの有効期限切れを検出（401エラー）
2. リフレッシュトークンを使用して新しいアクセストークンを取得
3. 新しいアクセストークンで再リクエスト
4. リフレッシュトークンも期限切れの場合は再ログインを促す
```

**認証エラー時の動作**:
- 401 Unauthorized: ログイン画面へリダイレクト
- トークン期限切れ: 自動リフレッシュ試行（最大1回）
- リフレッシュ失敗: ログイン画面へリダイレクト

**セキュリティ考慮事項**:
- トークンは `HttpOnly` Cookieまたは `Authorization` ヘッダーで送信
- LocalStorageには保存しない（XSS対策）
- HTTPS必須（トークン盗聴防止）
- トークン署名検証の実装

#### 3.2.3 ユーザビリティ要件

| 要件ID | 説明 | 基準 | 優先度 |
|---|---|---|---|
| REQ-USE-001 | レスポンシブデザイン対応 | デスクトップ、タブレット、スマートフォンで利用可能 | Essential |
| REQ-USE-002 | 直感的なUI設計 | 下記のユーザビリティテストで80%以上の成功率を達成 | Essential |
| REQ-USE-003 | エラーメッセージの明確性 | エラー原因と対処方法を明示 | Essential |
| REQ-USE-004 | アクセシビリティ対応 | WCAG 2.1 レベルAA準拠 | Conditional |
| REQ-USE-005 | 多言語対応（国際化） | 日本語・英語をサポート<br>**詳細仕様**:<br>- 言語切り替え: ヘッダーのドロップダウンメニュー<br>- 選択言語の保存: localStorage<br>- タイムゾーン: ユーザーのブラウザ設定を使用<br>- 日付フォーマット: 日本語「2024年1月31日」、英語「Jan 31, 2024」 | Optional |
| REQ-USE-006 | キーボードショートカット | 主要操作にショートカットを提供 | Optional |
| REQ-USE-007 | ダークモード対応 | テーマ切り替え機能 | Optional |

**REQ-USE-002 ユーザビリティテスト手順**:

**対象**: システム未使用の被験者10名
- 属性: 20-50歳、PCを日常的に使用する一般ユーザー
- 事前説明: システムの目的のみ伝える（操作方法は説明しない）

**タスク**:
1. **ToDo作成タスク**:
   - 目標: 「買い物リスト作成」というタイトルで新規ToDoを1件作成する
   - 制限時間: 3分以内
   - 補助: なし（UI上のヒントのみ）
   - 成功基準: タスクを完了し、作成したToDoが一覧に表示される

2. **ラベル付与タスク**:
   - 目標: 作成したToDoに「家事」と「重要」の2つのラベルを付与する
   - 制限時間: 2分以内
   - 補助: なし
   - 成功基準: 2つのラベルが正しく付与され、視覚的に確認できる

3. **ステータス変更タスク**:
   - 目標: ToDoのステータスを「完了」に変更する
   - 制限時間: 1分以内
   - 補助: なし
   - 成功基準: ステータスが「完了」に変更され、UIに反映される

**測定方法**:
- 各タスクを目標時間内に補助なしで完了できた場合を「成功」とカウント
- 3タスク × 10名 = 30回のうち、24回以上（80%）が成功で合格
- タスク完了後、満足度アンケート（5段階評価）を実施
- 操作中の発話（Think Aloud）を記録し、改善点を抽出

**合格基準**:
- タスク成功率: 80%以上
- 平均タスク完了時間: 目標時間の80%以内
- 満足度スコア: 平均4.0/5.0以上

**記録項目**:
- タスクごとの成功/失敗
- 完了時間
- エラー発生回数
- ヘルプ・ヒント利用回数
- ユーザーのコメント

#### 3.2.4 信頼性要件

| 要件ID | 説明 | 目標値 | 優先度 |
|---|---|---|---|
| REQ-REL-001 | システム可用性 | 99.5%以上（月次） | Essential |
| REQ-REL-002 | データバックアップ | 日次自動バックアップ | Essential |
| REQ-REL-003 | データ整合性 | トランザクション管理によるACID特性保証 | Essential |
| REQ-REL-004 | エラー回復 | クライアントサイドのエラーハンドリング | Essential |
| REQ-REL-005 | データ保持期間 | 削除されたデータは30日間バックアップに保持 | Conditional |

#### 3.2.5 保守性要件

| 要件ID | 説明 | 基準 | 優先度 |
|---|---|---|---|
| REQ-MAIN-001 | コードの可読性 | Linter（ESLint、StyleCop）に準拠 | Essential |
| REQ-MAIN-002 | APIドキュメント | OpenAPI/Swagger仕様書を自動生成 | Essential |
| REQ-MAIN-003 | テストカバレッジ | ユニットテストカバレッジ80%以上 | Conditional |
| REQ-MAIN-004 | ロギング | 適切なログレベルでの記録 | Essential |
| REQ-MAIN-005 | モニタリング | アプリケーション監視ツールの導入 | Conditional |

#### 3.2.6 移植性要件

| 要件ID | 説明 | 基準 | 優先度 |
|---|---|---|---|
| REQ-PORT-001 | ブラウザ互換性 | Chrome、Firefox、Safari、Edgeの最新2バージョン | Essential |
| REQ-PORT-002 | データベース移植性 | SQL標準に準拠したクエリ | Conditional |
| REQ-PORT-003 | コンテナ化 | Docker対応 | Conditional |

---

## 4. 制約条件

### 4.1 技術制約

| 制約ID | 内容 | 影響 |
|---|---|---|
| CONST-TECH-001 | フロントエンドはAngular（latest）を使用 | 開発チームのスキルセット、学習コスト |
| CONST-TECH-002 | バックエンドはASP.NET Core（latest）を使用 | .NET環境への依存 |
| CONST-TECH-003 | データベースはSQL Serverを使用 | ライセンスコスト、インフラ要件 |
| CONST-TECH-004 | RESTful API設計に準拠 | 設計パターンの制約 |
| CONST-TECH-005 | 既存の`/src/todo-service`ディレクトリ構造に従う | リポジトリレイアウトの制約 |

### 4.2 ビジネス制約

| 制約ID | 内容 | 影響 |
|---|---|---|
| CONST-BIZ-001 | 初期リリースは基本機能のみ | 段階的な機能追加が必要 |
| CONST-BIZ-002 | マルチユーザーコラボレーション機能は対象外 | 単一ユーザー向けの設計 |
| CONST-BIZ-003 | 無料での提供（初期バージョン） | 収益モデルの制約 |

### 4.3 法規制・コンプライアンス

| 制約ID | 内容 | 影響 |
|---|---|---|
| CONST-COMP-001 | 個人情報保護法への準拠 | データ取り扱いの制約 |
| CONST-COMP-002 | GDPR準拠（将来対応） | データ削除権、アクセス権の実装 |
| CONST-COMP-003 | アクセシビリティ法規への配慮 | UI設計への影響 |

---

## 5. 前提条件

| 前提ID | 内容 |
|---|---|
| ASSUME-001 | ユーザーはインターネット接続環境にある |
| ASSUME-002 | ユーザーはモダンブラウザを使用している |
| ASSUME-003 | 認証サービス（auth-service）が別途提供されている |
| ASSUME-004 | ユーザーサービス（user-service）が別途提供されている |
| ASSUME-005 | バックエンドAPIとフロントエンドは独立してデプロイ可能 |
| ASSUME-006 | データベースはクラウド環境または専用サーバーでホストされる |
| ASSUME-007 | 開発環境、ステージング環境、本番環境が分離されている |

---

## 6. 依存関係

| 依存先 | 内容 | 影響 | 優先度 |
|---|---|---|---|
| auth-service | ユーザー認証・認可機能 | 認証なしではシステム利用不可 | Critical |
| user-service | ユーザー情報管理 | ユーザー識別、プロフィール取得 | Critical |
| bff-service | Backend for Frontend（オプション） | API集約、ルーティング | Optional |
| データベース | データ永続化 | システムの全機能に影響 | Critical |
| Angularフレームワーク | フロントエンド実装 | UI/UX全般 | Critical |
| ASP.NET Coreフレームワーク | バックエンド実装 | ビジネスロジック、API | Critical |

---

## 7. トレーサビリティ

### 7.1 ビジネス要件→機能要件マッピング

| ビジネス要件 | 機能要件 | 優先度 |
|---|---|---|
| BR-001: タスク管理の効率化 | REQ-FUNC-001, REQ-FUNC-002, REQ-FUNC-003, REQ-FUNC-004, REQ-FUNC-005 | Essential |
| BR-002: 進捗の可視化 | REQ-FUNC-006 | Essential |
| BR-003: 情報の構造化 | REQ-FUNC-007, REQ-FUNC-008, REQ-FUNC-009, REQ-FUNC-010, REQ-FUNC-011 | Essential |
| BR-004: 時間管理の改善 | REQ-FUNC-014, REQ-FUNC-017 | Essential |
| BR-005: 高度な検索機能 | REQ-FUNC-012, REQ-FUNC-013, REQ-FUNC-015, REQ-FUNC-016, REQ-FUNC-017 | Essential |
| BR-006: ユーザー体験の向上 | REQ-USE-001, REQ-USE-002, REQ-USE-003, REQ-PERF-001 | Essential |

### 7.2 機能要件→非機能要件マッピング

| 機能要件 | 非機能要件 | 関連性 |
|---|---|---|
| REQ-FUNC-001～005（CRUD操作） | REQ-PERF-001, REQ-PERF-002, REQ-SEC-007 | 性能、セキュリティ |
| REQ-FUNC-012～016（検索） | REQ-PERF-003, REQ-PERF-005 | 性能、スケーラビリティ |
| 全機能要件 | REQ-SEC-001, REQ-SEC-007 | 認証認可 |
| 全機能要件 | REQ-USE-001, REQ-USE-002 | ユーザビリティ |
| 全機能要件 | REQ-REL-001, REQ-REL-003 | 信頼性 |

---

## 8. データモデル概要

### 8.1 主要エンティティ

#### ToDo エンティティ
| フィールド | 型 | 制約 | 説明 |
|---|---|---|---|
| Id | GUID/INT | PK, NOT NULL | 一意識別子 |
| UserId | GUID/INT | FK, NOT NULL | 所有者（外部キー） |
| Title | NVARCHAR(200) | NOT NULL | タイトル |
| Content | NVARCHAR(5000) | NULL | 内容 |
| Status | ENUM/VARCHAR(20) | NOT NULL, DEFAULT 'NOT_STARTED' | ステータス |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 投稿日時 |
| UpdatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 最終更新日時 |
| RowVersion | ROWVERSION/TIMESTAMP | NOT NULL | 楽観的同時実行制御 |

#### Label エンティティ
| フィールド | 型 | 制約 | 説明 |
|---|---|---|---|
| Id | GUID/INT | PK, NOT NULL | 一意識別子 |
| UserId | GUID/INT | FK, NOT NULL | 所有者（外部キー） |
| Name | NVARCHAR(50) | NOT NULL, UNIQUE (per user) | ラベル名 |
| Color | CHAR(7) | NOT NULL | カラーコード（#RRGGBB） |
| CreatedAt | DATETIME2 | NOT NULL, DEFAULT GETUTCDATE() | 作成日時 |

#### TodoLabel 関連テーブル（多対多）
| フィールド | 型 | 制約 | 説明 |
|---|---|---|---|
| TodoId | GUID/INT | FK, NOT NULL | ToDo識別子 |
| LabelId | GUID/INT | FK, NOT NULL | ラベル識別子 |
| PK | (TodoId, LabelId) | | 複合主キー |

### 8.2 ER図（概念図）

```
User (外部管理)
  │
  ├──< ToDo (1:N)
  │     │
  │     └──< TodoLabel (N:M)
  │              │
  └──< Label (1:N) ──┘
```

---

## 9. API設計概要

### 9.1 RESTful APIエンドポイント

#### ToDo API

| メソッド | エンドポイント | 説明 | 要件ID |
|---|---|---|---|
| GET | /api/todos | ToDo一覧取得（フィルタリング、ページング） | REQ-FUNC-002 |
| GET | /api/todos/{id} | ToDo詳細取得 | REQ-FUNC-003 |
| POST | /api/todos | ToDo作成 | REQ-FUNC-001 |
| PUT | /api/todos/{id} | ToDo更新 | REQ-FUNC-004 |
| DELETE | /api/todos/{id} | ToDo削除 | REQ-FUNC-005 |
| PATCH | /api/todos/{id}/status | ステータス更新 | REQ-FUNC-006 |

#### Label API

| メソッド | エンドポイント | 説明 | 要件ID |
|---|---|---|---|
| GET | /api/labels | ラベル一覧取得 | REQ-FUNC-008 |
| POST | /api/labels | ラベル作成 | REQ-FUNC-007 |
| PUT | /api/labels/{id} | ラベル更新 | REQ-FUNC-009 |
| DELETE | /api/labels/{id} | ラベル削除 | REQ-FUNC-010 |

#### TodoLabel 関連API

| メソッド | エンドポイント | 説明 | 要件ID |
|---|---|---|---|
| PUT | /api/todos/{id}/labels | ToDoへのラベル割り当て | REQ-FUNC-011 |

### 9.2 クエリパラメータ（フィルタリング）

**GET /api/todos**

| パラメータ | 型 | 説明 | 要件ID |
|---|---|---|---|
| status | string[] | ステータスフィルター | REQ-FUNC-012 |
| labelIds | int[] | ラベルIDフィルター | REQ-FUNC-013 |
| labelFilterType | string | AND/OR | REQ-FUNC-013 |
| startDate | datetime | 開始日時 | REQ-FUNC-014 |
| endDate | datetime | 終了日時 | REQ-FUNC-014 |
| search | string | 検索キーワード | REQ-FUNC-015 |
| sortBy | string | ソートフィールド | REQ-FUNC-017 |
| sortOrder | string | ASC/DESC | REQ-FUNC-017 |
| page | int | ページ番号 | REQ-FUNC-002 |
| pageSize | int | ページサイズ | REQ-FUNC-002 |

### 9.3 エラーハンドリング仕様

#### 9.3.1 HTTPステータスコード一覧

| ステータスコード | 使用シーン | 例 |
|---|---|---|
| 200 OK | 正常処理（取得、更新） | ToDo取得成功 |
| 201 Created | リソース作成成功 | ToDo作成成功 |
| 204 No Content | 正常処理（レスポンスボディなし） | ToDo削除成功 |
| 400 Bad Request | クライアントのリクエストが不正 | バリデーションエラー |
| 401 Unauthorized | 認証が必要または失敗 | JWTトークン未提供/無効 |
| 403 Forbidden | 認可されていない操作 | 他人のToDoへのアクセス |
| 404 Not Found | リソースが存在しない | 存在しないToDo IDの指定 |
| 409 Conflict | リソースの競合 | 楽観的同時実行制御の違反、重複ラベル名 |
| 422 Unprocessable Entity | セマンティックエラー | 不正なステータス値 |
| 500 Internal Server Error | サーバー内部エラー | データベース接続エラー |
| 503 Service Unavailable | サービス一時停止 | メンテナンス中 |

#### 9.3.2 エラーレスポンス形式

**統一フォーマット**:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "ユーザー向けエラーメッセージ",
    "details": [
      {
        "field": "title",
        "issue": "タイトルは1文字以上200文字以内で入力してください"
      }
    ],
    "timestamp": "2024-01-31T10:30:00Z",
    "traceId": "abc123-def456-ghi789"
  }
}
```

**フィールド説明**:
- `code`: エラーコード（アプリケーション固有）
- `message`: エンドユーザー向けのメッセージ（多言語対応）
- `details`: 詳細なエラー情報（バリデーションエラー時に複数フィールドの情報を含む）
- `timestamp`: エラー発生日時（ISO 8601形式）
- `traceId`: トレース用の一意ID（ログ調査用）

#### 9.3.3 エラーコード一覧

| エラーコード | HTTPステータス | 説明 | メッセージ例 |
|---|---|---|---|
| VALIDATION_ERROR | 400 | 入力値バリデーションエラー | 入力内容に誤りがあります |
| TITLE_REQUIRED | 400 | タイトル未入力 | タイトルを入力してください |
| TITLE_TOO_LONG | 400 | タイトル長超過 | タイトルは200文字以内で入力してください |
| CONTENT_TOO_LONG | 400 | 内容長超過 | 内容は5000文字以内で入力してください |
| LABEL_NAME_REQUIRED | 400 | ラベル名未入力 | ラベル名を入力してください |
| INVALID_COLOR_CODE | 400 | 不正な色コード | 色コードは#RRGGBBの形式で入力してください |
| INVALID_PAGE_SIZE | 400 | 不正なページサイズ | ページサイズは1-100の範囲で指定してください |
| ROWVERSION_REQUIRED | 400 | RowVersion未提供 | 更新にはRowVersionが必要です |
| INVALID_STATUS | 422 | 不正なステータス値 | 指定されたステータスは無効です（NOT_STARTED, IN_PROGRESS, COMPLETED, ABANDONEDのいずれか） |
| TODO_NOT_FOUND | 404 | ToDo未存在 | 指定されたToDoが見つかりません |
| LABEL_NOT_FOUND | 404 | ラベル未存在 | 指定されたラベルが見つかりません |
| DUPLICATE_LABEL_NAME | 409 | ラベル名重複 | 同じ名前のラベルが既に存在します |
| CONCURRENT_UPDATE_CONFLICT | 409 | 同時更新競合 | このToDoは他のユーザーによって更新されています |
| UNAUTHORIZED | 401 | 未認証 | 認証が必要です。ログインしてください |
| TOKEN_EXPIRED | 401 | トークン期限切れ | トークンの有効期限が切れています |
| FORBIDDEN | 403 | 権限不足 | この操作を実行する権限がありません |
| INTERNAL_ERROR | 500 | サーバーエラー | サーバーエラーが発生しました。しばらくしてから再試行してください |
| DATABASE_ERROR | 500 | データベースエラー | データベース接続エラーが発生しました |

#### 9.3.4 クライアントサイドエラーハンドリング方針

1. **グローバルエラーハンドラー**:
   - Angularの `ErrorHandler` を実装
   - 全てのHTTPエラーをHTTP Interceptorでインターセプト
   - ログ記録とユーザー通知を一元管理

2. **エラー表示方法**:
   - **400系エラー（バリデーション）**: フォーム内インラインエラー表示
   - **401エラー（未認証）**: ログイン画面へ自動リダイレクト
   - **403エラー（権限不足）**: エラーページまたはモーダルダイアログ
   - **404エラー（未存在）**: エラーページまたはトースト通知
   - **409エラー（競合）**: モーダルダイアログで詳細表示
   - **500系エラー**: トースト通知またはエラーページ
   - **ネットワークエラー**: リトライボタン付きエラー画面

3. **リトライポリシー**:
   - **500, 503エラー**: 最大3回の自動リトライ（Exponential Backoff: 1秒、2秒、4秒）
   - **401エラー（トークン期限切れ）**: リフレッシュトークンで自動再試行（1回のみ）
   - **400, 404, 409エラー**: リトライなし（ユーザー操作が必要）

4. **ログ記録**:
   - 全てのエラーをクライアントサイドログに記録
   - `traceId`を含めてサーバーサイドと紐付け可能にする
   - Application Insights等にエラーを送信（本番環境のみ）

### 9.4 APIレスポンス標準形式

#### 成功レスポンス（単一リソース）
```json
{
  "data": {
    "id": 123,
    "title": "買い物リスト作成",
    "content": "週末の買い物リストを作る",
    "status": "IN_PROGRESS",
    "createdAt": "2024-01-30T10:00:00Z",
    "updatedAt": "2024-01-30T11:30:00Z",
    "rowVersion": "AAAAAABcd123",
    "labels": [
      {
        "id": 1,
        "name": "家事",
        "color": "#FF5733"
      }
    ]
  }
}
```

#### 成功レスポンス（リスト）
```json
{
  "data": [
    { /* ToDoオブジェクト */ },
    { /* ToDoオブジェクト */ }
  ],
  "pagination": {
    "currentPage": 1,
    "pageSize": 20,
    "totalItems": 157,
    "totalPages": 8,
    "hasNextPage": true,
    "hasPreviousPage": false
  }
}
```

#### 作成成功レスポンス（201 Created）
```json
{
  "data": {
    "id": 124,
    /* 作成されたリソースの全フィールド */
  }
}
```
- `Location` ヘッダーに作成されたリソースのURIを含める
- 例: `Location: /api/todos/124`

#### 削除成功レスポンス（204 No Content）
- レスポンスボディなし

#### メタデータ（オプション）
```json
{
  "data": { /* ... */ },
  "meta": {
    "requestId": "req-abc123",
    "timestamp": "2024-01-31T10:30:00Z",
    "version": "v1"
  }
}
```

---

## 10. UI/UX 設計方針

### 10.1 画面構成

| 画面ID | 画面名 | 主要機能 | 要件ID |
|---|---|---|---|
| UI-001 | ToDo一覧画面 | 一覧表示、フィルタリング、検索 | REQ-FUNC-002, 012-016 |
| UI-002 | ToDo詳細画面 | 詳細表示、編集、削除 | REQ-FUNC-003, 004, 005 |
| UI-003 | ToDo作成画面/モーダル | 新規作成 | REQ-FUNC-001 |
| UI-004 | ラベル管理画面 | ラベルCRUD | REQ-FUNC-007-010 |

### 10.2 ナビゲーション構造

```
[ヘッダー: ロゴ | 検索バー | ユーザーメニュー]
[サイドバー: ToDo一覧 | ラベル管理]
[メインコンテンツエリア]
```

### 10.3 デザイン原則

- **シンプル性**: ミニマルなデザインで認知負荷を軽減
- **一貫性**: 全画面で統一されたUIパターン
- **フィードバック**: ユーザーアクションに対する即座のフィードバック
- **エラー防止**: 破壊的操作の確認ダイアログ

---

## 11. テスト要件

### 11.1 機能テスト

| テストID | テスト対象 | テストタイプ | 優先度 |
|---|---|---|---|
| TEST-FUNC-001 | 全CRUD操作 | 統合テスト | Essential |
| TEST-FUNC-002 | フィルタリング機能 | 統合テスト | Essential |
| TEST-FUNC-003 | バリデーション | ユニットテスト | Essential |
| TEST-FUNC-004 | 認証認可 | セキュリティテスト | Essential |

### 11.2 非機能テスト

| テストID | テスト対象 | テストタイプ | 優先度 |
|---|---|---|---|
| TEST-PERF-001 | レスポンスタイム | パフォーマンステスト | Essential |
| TEST-PERF-002 | 負荷テスト | パフォーマンステスト | Conditional |
| TEST-SEC-001 | 脆弱性診断 | セキュリティテスト | Essential |
| TEST-USE-001 | ユーザビリティテスト | ユーザーテスト | Conditional |

---

## 12. リスク分析

### 12.1 技術リスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 軽減策 |
|---|---|---|---|---|
| RISK-TECH-001 | フロントエンド・バックエンド間のAPI不整合 | 高 | 中 | OpenAPI仕様書の早期作成、契約テスト |
| RISK-TECH-002 | パフォーマンス劣化（大量データ） | 中 | 中 | インデックス最適化、ページネーション |
| RISK-TECH-003 | セキュリティ脆弱性 | 高 | 低 | セキュリティレビュー、自動スキャン |
| RISK-TECH-004 | ブラウザ互換性問題 | 低 | 低 | クロスブラウザテスト |

### 12.2 ビジネスリスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 軽減策 |
|---|---|---|---|---|
| RISK-BIZ-001 | ユーザー要求の変更 | 中 | 高 | アジャイル開発、MVP優先 |
| RISK-BIZ-002 | 競合製品との差別化不足 | 中 | 中 | ユーザーフィードバック収集 |
| RISK-BIZ-003 | ユーザー採用率の低迷 | 高 | 中 | ユーザビリティテスト、マーケティング |

---

## 13. 用語集

| 用語 | 定義 |
|---|---|
| ToDo | ユーザーが管理するタスクアイテム。タイトル、内容、ステータス、ラベル等の属性を持つ |
| ラベル | ToDoを分類するための色付きタグ。複数のToDoに対して再利用可能 |
| ステータス | ToDoの進捗状態。未着手、着手中、完了、放棄の4種類 |
| フィルタリング | 特定の条件に基づいてToDoリストを絞り込む機能 |
| ページネーション | 大量のデータを複数ページに分割して表示する手法 |
| 楽観的同時実行制御 | 複数ユーザーの同時更新を検出し、データ整合性を保つ仕組み |
| RESTful API | REST原則に基づいて設計されたWebAPI |
| JWT | JSON Web Token - トークンベース認証の標準形式 |
| CRUD | Create（作成）、Read（読取）、Update（更新）、Delete（削除）の略 |
| SPA | Single Page Application - ページ遷移なしで動作するWebアプリ |
| MVP | Minimum Viable Product - 最小限の機能を持つ製品 |

---

## 14. 今後の拡張計画（Roadmap）

### Phase 1（MVP） - 本仕様書の範囲
- 基本的なToDo CRUD機能
- ラベル管理
- フィルタリング・検索
- シングルユーザー向け

### Phase 2（将来）
- 繰り返しタスク（リカーリング）
- 期限（デッドライン）管理
- 優先度設定
- ファイル添付機能

### Phase 3（将来）
- マルチユーザー対応
- タスク共有・コラボレーション
- コメント機能
- 通知・リマインダー

### Phase 4（将来）
- カレンダー統合
- モバイルアプリ
- API公開（サードパーティ連携）
- AI機能（タスク推奨、優先度自動設定）

---

## 15. 成果物と納品物

| 成果物 | 説明 | 責任者 |
|---|---|---|
| 要求仕様書（本文書） | ISO 29148準拠の要求定義 | Product Owner |
| APIドキュメント | OpenAPI/Swagger仕様書 | Backend Team |
| データベーススキーマ | ER図、DDLスクリプト | Database Team |
| UI/UXデザイン | ワイヤーフレーム、モックアップ | Design Team |
| テスト計画書 | テストケース、テストシナリオ | QA Team |
| 実装コード | Angular + ASP.NET Core | Development Team |

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 | 承認者 |
|---|---|---|---|---|
| 1.0 | 2024-01-15 | 初版作成 | AI Agent | - |
| 1.1 | 2024-01-31 | レビュー指摘事項の修正（Critical 5件、Major 8件、Minor 6件対応）<br>- C-1: 受け入れ基準を測定可能な形式に修正<br>- C-2: REQ-USE-002にユーザビリティテスト手順を追加<br>- C-3: セキュリティ要件に実装詳細を追加<br>- C-4: REQ-FUNC-004に楽観的同時実行制御の詳細フローを追加<br>- C-5: 9.3章にエラーハンドリング仕様を新規追加<br>- M-1: REQ-FUNC-001にバリデーションルール詳細を追加<br>- M-2: REQ-FUNC-002にページネーション詳細仕様を追加<br>- M-3: REQ-FUNC-007にラベル色の制約を明記<br>- M-4: REQ-FUNC-016にフィルター永続化仕様を追加<br>- M-5: REQ-FUNC-005に物理削除の採用理由を明記<br>- M-6: 3.2.1に性能要件の測定条件を追加<br>- M-7: 3.2.2.1にJWT認証の詳細仕様を追加<br>- M-8: 9.4章にAPIレスポンス標準形式を追加<br>- m-1: 用語の表記を「ToDo」に統一<br>- m-2: 優先度の定義を用語集に追加<br>- m-3: トレーサビリティマトリクスにREQ-FUNC-017を追加<br>- m-4: REQ-FUNC-006にステータス遷移制約を明記<br>- m-6: REQ-USE-005に国際化の詳細仕様を追加 | AI Agent | - |
| | | | | |

---

## 承認

| 役割 | 氏名 | 署名 | 日付 |
|---|---|---|---|
| Product Owner | | | |
| Technical Lead | | | |
| QA Lead | | | |
| Project Manager | | | |

---

**文書終了**
