# 要求定義書 修正ガイド

このドキュメントは、レビュー結果に基づく具体的な修正例を提供します。

---

## Critical問題の修正例

### C-1: 受け入れ基準の測定可能性

#### ❌ 修正前（REQ-FUNC-002）
```
- 内容はプレビュー（最初の100文字）として表示されること
- 作成成功後、一覧画面に即座に反映されること
```

#### ✅ 修正後
```
- 内容は最初の100文字を表示し、100文字を超える場合は「...」を末尾に付加すること
  - テスト方法: 101文字の内容を持つToDoを作成し、一覧画面で100文字+「...」が表示されることを確認
- 作成成功後、500ms以内に一覧画面に反映されること
  - テスト方法: Performance APIを用いて作成APIコール完了から画面更新までの時間を測定
```

---

### C-2: 非機能要件の測定方法の具体化

#### ❌ 修正前（REQ-USE-002）
```
| REQ-USE-002 | 直感的なUI設計 | ユーザーテストで80%が操作方法を理解 | Essential |
```

#### ✅ 修正後
```
| REQ-USE-002 | 直感的なUI設計 | 下記の手順でユーザビリティテストを実施し、80%以上の成功率を達成すること | Essential |

**テスト手順**:
- 対象: システム未使用の被験者10名
- タスク: 
  1. 新規ToDoを1件作成する（目標: 3分以内、補助なし）
  2. 作成したToDoにラベルを2つ付与する（目標: 2分以内、補助なし）
  3. ステータスを「完了」に変更する（目標: 1分以内、補助なし）
- 成功基準: 各タスクを目標時間内に補助なしで完了できた場合を成功とカウント
- 合格基準: 3タスク × 10名 = 30回中、24回以上（80%）が成功
```

---

### C-3: セキュリティ要件の実装詳細

#### ❌ 修正前
```
| REQ-SEC-005 | XSS（クロスサイトスクリプティング）対策 | データ保護 | Essential |
| REQ-SEC-006 | CSRF（クロスサイトリクエストフォージェリ）対策 | データ保護 | Essential |
```

#### ✅ 修正後

**3.2.2 セキュリティ要件（拡張版）**

| 要件ID | 説明 | 実装方法 | カテゴリ | 優先度 |
|---|---|---|---|---|
| REQ-SEC-005 | XSS対策 | 以下の対策を実装すること:<br>1. Angular DomSanitizerによる入力値のサニタイズ<br>2. Content Security Policy (CSP) ヘッダーの設定<br>3. innerHTML の使用禁止（textContent を使用）<br>4. サーバーサイドでの出力エスケープ処理 | データ保護 | Essential |
| REQ-SEC-006 | CSRF対策 | 以下の対策を実装すること:<br>1. ASP.NET Core AntiForgeryToken の使用<br>2. SameSite Cookie 属性の設定（Strict）<br>3. カスタムヘッダー（X-Requested-With）の検証 | データ保護 | Essential |
| REQ-SEC-008 | 入力値のサニタイゼーション | 以下のルールで入力値を検証・サニタイズすること:<br>1. HTMLタグ: 全て除去またはエスケープ<br>2. JavaScriptコード: 検出時はエラー<br>3. SQLインジェクション: パラメータ化クエリの強制使用<br>4. 特殊文字: ホワイトリスト方式で許可文字を限定 | データ保護 | Essential |

**セキュリティ実装チェックリスト**:
- [ ] OWASP Top 10 (2021) の全項目に対する対策を実装
- [ ] セキュリティスキャンツール（OWASP ZAP等）による自動診断
- [ ] セキュリティレビューの実施（開発フェーズ終了時）

---

### C-4: 楽観的同時実行制御の詳細仕様

#### ❌ 修正前（REQ-FUNC-004）
```
- 楽観的同時実行制御が実装されていること（バージョン管理）
```

#### ✅ 修正後

**REQ-FUNC-004: ToDo更新機能（拡張版）**

**楽観的同時実行制御の詳細**:

1. **バージョン管理フィールド**:
   - データベースに `RowVersion` (ROWVERSION/TIMESTAMP) を追加
   - 各更新時に自動的にインクリメント

2. **更新処理フロー**:
   ```
   1. クライアントがToDo取得時に RowVersion を保持
   2. 更新リクエスト時に保持している RowVersion を送信
   3. サーバーは現在の RowVersion と比較
   4. 一致する場合: 更新を実行し、新しい RowVersion を返却
   5. 不一致の場合: HTTP 409 Conflict を返却
   ```

3. **競合発生時の処理**:
   - **エラーレスポンス**:
     ```json
     {
       "error": {
         "code": "CONCURRENT_UPDATE_CONFLICT",
         "message": "このToDoは他のユーザーによって更新されています",
         "currentVersion": "AAAAAABcd123",
         "currentData": { /* 最新のToDoデータ */ }
       }
     }
     ```
   - **クライアントサイドの対応**:
     - エラーダイアログを表示
     - 「最新データを表示」ボタンを提供
     - ユーザーの入力内容は一時保存（ブラウザのlocalStorageに退避）
     - 最新データを取得後、再編集を促す

4. **受け入れ基準**:
   - 2つのブラウザで同じToDoを同時に編集した場合、後から保存した方が409エラーになること
   - 競合時のエラーメッセージが表示されること
   - 最新データの確認後、再編集が可能であること

---

### C-5: エラーハンドリング仕様の追加

#### ✅ 新規セクション追加

**9.3 エラーハンドリング仕様**

**9.3.1 HTTPステータスコード一覧**

| ステータスコード | 使用シーン | 例 |
|---|---|---|
| 200 OK | 正常処理（取得、更新） | ToDo取得成功 |
| 201 Created | リソース作成成功 | ToDo作成成功 |
| 204 No Content | 正常処理（レスポンスボディなし） | ToDo削除成功 |
| 400 Bad Request | クライアントのリクエストが不正 | バリデーションエラー |
| 401 Unauthorized | 認証が必要または失敗 | JWTトークン未提供/無効 |
| 403 Forbidden | 認可されていない操作 | 他人のToDoへのアクセス |
| 404 Not Found | リソースが存在しない | 存在しないToDo IDの指定 |
| 409 Conflict | リソースの競合 | 楽観的同時実行制御の違反 |
| 422 Unprocessable Entity | セマンティックエラー | 不正なステータス値 |
| 500 Internal Server Error | サーバー内部エラー | データベース接続エラー |
| 503 Service Unavailable | サービス一時停止 | メンテナンス中 |

**9.3.2 エラーレスポンス形式**

**統一フォーマット**:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "ユーザー向けエラーメッセージ",
    "details": [
      {
        "field": "title",
        "issue": "タイトルは1文字以上200文字以内で入力してください"
      }
    ],
    "timestamp": "2024-01-30T15:30:00Z",
    "traceId": "abc123-def456-ghi789"
  }
}
```

**9.3.3 エラーコード一覧**

| エラーコード | HTTPステータス | 説明 | メッセージ例 |
|---|---|---|---|
| VALIDATION_ERROR | 400 | 入力値バリデーションエラー | 入力内容に誤りがあります |
| TITLE_REQUIRED | 400 | タイトル未入力 | タイトルを入力してください |
| TITLE_TOO_LONG | 400 | タイトル長超過 | タイトルは200文字以内で入力してください |
| CONTENT_TOO_LONG | 400 | 内容長超過 | 内容は5000文字以内で入力してください |
| INVALID_STATUS | 422 | 不正なステータス値 | 指定されたステータスは無効です |
| TODO_NOT_FOUND | 404 | ToDo未存在 | 指定されたToDoが見つかりません |
| LABEL_NOT_FOUND | 404 | ラベル未存在 | 指定されたラベルが見つかりません |
| DUPLICATE_LABEL_NAME | 409 | ラベル名重複 | 同じ名前のラベルが既に存在します |
| CONCURRENT_UPDATE_CONFLICT | 409 | 同時更新競合 | このToDoは他のユーザーによって更新されています |
| UNAUTHORIZED | 401 | 未認証 | 認証が必要です。ログインしてください |
| FORBIDDEN | 403 | 権限不足 | この操作を実行する権限がありません |
| INTERNAL_ERROR | 500 | サーバーエラー | サーバーエラーが発生しました。しばらくしてから再試行してください |

**9.3.4 クライアントサイドエラーハンドリング方針**

1. **グローバルエラーハンドラー**:
   - Angularの `ErrorHandler` を実装
   - 全てのHTTPエラーをインターセプト
   - ログ記録とユーザー通知を一元管理

2. **エラー表示方法**:
   - 400系エラー: フォーム内インラインエラー表示
   - 500系エラー: トースト通知またはモーダルダイアログ
   - ネットワークエラー: リトライボタン付きエラー画面

3. **リトライポリシー**:
   - 500, 503エラー: 最大3回の自動リトライ（Exponential Backoff）
   - 400系エラー: リトライなし（ユーザー操作が必要）

---

## Major問題の修正例

### M-1: バリデーションルールの網羅性

#### ✅ 修正後（REQ-FUNC-001に追加）

**詳細バリデーションルール**:

**タイトル**:
- 文字数: 1-200文字（必須）
- 許可文字: Unicode文字全般（絵文字含む）
- 禁止文字: なし
- 前後の空白: 自動トリミング
- HTMLタグ: エスケープして保存（表示時はテキストとして扱う）
- 制御文字: 改行（\n）のみ許可、その他は除去

**内容**:
- 文字数: 0-5000文字（任意）
- 許可文字: Unicode文字全般（絵文字含む）
- HTMLタグ: エスケープして保存
- Markdown: Phase 2で対応予定（現在は非対応）

**ラベル名**:
- 文字数: 1-50文字（必須）
- 許可文字: 英数字、日本語、一部記号（-, _, スペース）
- 禁止文字: 特殊記号（<, >, &, ', "）
- 大文字小文字: 区別する
- 重複: 同一ユーザー内で重複不可（大文字小文字を区別）

**色コード**:
- 形式: `#RRGGBB` (6桁の16進数)
- 例: `#FF5733`, `#3498DB`
- 検証: 正規表現 `^#[0-9A-Fa-f]{6}$`
- 省略形: `#RGB` 形式は非対応（サーバーサイドで拒否）

---

### M-2: ページネーションの仕様詳細化

#### ✅ 修正後（REQ-FUNC-002に追加）

**ページネーション詳細仕様**:

1. **デフォルト値**:
   - ページサイズ: 20件/ページ
   - 開始ページ: 1（1-based index）

2. **クエリパラメータ**:
   - `page`: ページ番号（1から開始）
   - `pageSize`: 1ページあたりの件数
   - 最小値: `pageSize=1`
   - 最大値: `pageSize=100`（100を超える場合は400エラー）

3. **レスポンス形式**:
   ```json
   {
     "data": [ /* ToDoリスト */ ],
     "pagination": {
       "currentPage": 1,
       "pageSize": 20,
       "totalItems": 157,
       "totalPages": 8,
       "hasNextPage": true,
       "hasPreviousPage": false
     }
   }
   ```

4. **総ページ数の計算**:
   ```
   totalPages = Math.ceil(totalItems / pageSize)
   ```
   - 例: totalItems=157, pageSize=20 → totalPages=8

5. **境界条件**:
   - ページ番号が総ページ数を超える場合: 空の配列を返す（404ではない）
   - ページ番号が0以下: 400 Bad Request

---

### M-5: 削除方式の明確化

#### ✅ 修正後（REQ-FUNC-005全面改訂）

**REQ-FUNC-005: ToDo削除機能**

**削除方式の決定**: **物理削除**を採用

**採用理由**:
1. MVPフェーズではデータ復元機能は対象外
2. ストレージコストの削減
3. GDPR等の削除権への対応が容易
4. データベースパフォーマンスの維持

**将来の拡張（Phase 2以降）**:
- ゴミ箱機能（論理削除）の導入を検討
- 削除後30日間は復元可能にする

**処理フロー**:
1. ユーザーが削除ボタンをクリック
2. 確認ダイアログを表示
   - メッセージ: 「このToDoを削除してもよろしいですか？この操作は取り消せません。」
   - ボタン: 「キャンセル」「削除」
3. 「削除」をクリック後、以下を実行:
   a. TodoLabelテーブルから関連レコードを削除（CASCADE DELETE）
   b. Todoテーブルからレコードを削除
   c. トランザクション内で実行
4. 削除成功後、一覧画面を更新

**受け入れ基準**:
- 削除前に確認ダイアログが表示されること
- 確認ダイアログに「取り消せない」旨の警告が表示されること
- 削除後、該当ToDoが一覧から消えること
- 削除後、関連するラベルとの紐付けも削除されること
- 存在しないToDoの削除要求は404エラーを返すこと
- 他ユーザーのToDoの削除は403エラーを返すこと

---

### M-7: 認証の詳細仕様

#### ✅ 新規セクション追加

**3.2.2.1 JWT認証の詳細仕様**

**JWT構造**:
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-id-123",
    "name": "Taro Yamada",
    "email": "taro@example.com",
    "iat": 1674000000,
    "exp": 1674003600,
    "aud": "todo-service",
    "iss": "auth-service"
  }
}
```

**トークンライフサイクル**:
- **アクセストークン有効期限**: 1時間
- **リフレッシュトークン有効期限**: 7日間
- **セッションタイムアウト**: 30分間操作がない場合

**トークンリフレッシュフロー**:
```
1. アクセストークンの有効期限切れを検出
2. リフレッシュトークンを使用して新しいアクセストークンを取得
3. 新しいアクセストークンで再リクエスト
4. リフレッシュトークンも期限切れの場合は再ログインを促す
```

**認証エラー時の動作**:
- 401 Unauthorized: ログイン画面へリダイレクト
- トークン期限切れ: 自動リフレッシュ試行
- リフレッシュ失敗: ログイン画面へリダイレクト

**セキュリティ考慮事項**:
- トークンは `HttpOnly` Cookieまたは `Authorization` ヘッダーで送信
- LocalStorageには保存しない（XSS対策）
- HTTPS必須

---

### M-8: API レスポンス形式の標準化

#### ✅ 9章に追加

**9.4 APIレスポンス標準形式**

**成功レスポンス（単一リソース）**:
```json
{
  "data": {
    "id": 123,
    "title": "買い物リスト作成",
    "content": "週末の買い物リストを作る",
    "status": "IN_PROGRESS",
    "createdAt": "2024-01-30T10:00:00Z",
    "updatedAt": "2024-01-30T11:30:00Z",
    "labels": [
      {
        "id": 1,
        "name": "家事",
        "color": "#FF5733"
      }
    ]
  }
}
```

**成功レスポンス（リスト）**:
```json
{
  "data": [ /* ToDoの配列 */ ],
  "pagination": {
    "currentPage": 1,
    "pageSize": 20,
    "totalItems": 157,
    "totalPages": 8,
    "hasNextPage": true,
    "hasPreviousPage": false
  }
}
```

**エラーレスポンス**:
（C-5を参照）

**メタデータ（オプション）**:
```json
{
  "data": { /* ... */ },
  "meta": {
    "requestId": "req-abc123",
    "timestamp": "2024-01-30T15:30:00Z",
    "version": "v1"
  }
}
```

---

## 修正作業の進め方

### 推奨順序:
1. **Critical問題（C-1～C-5）**: 最優先で修正
2. **Major問題（M-1～M-8）**: Critical修正後に対応
3. **Minor問題（m-1～m-6）**: 時間があれば修正

### 作業見積もり:
- Critical問題: 4-6時間
- Major問題: 2-3時間
- Minor問題: 1-2時間
- **合計**: 7-11時間

### 修正完了後:
- INDEX.mdを更新（バージョン1.1に更新）
- REVIEW-RESULT-001.mdを参照して全ての指摘に対応したか確認
- レビュー再実施をリクエスト

---

## 参考テンプレート

必要に応じて以下のセクションをコピーして使用してください。

### エラーコード定義テンプレート
```markdown
| エラーコード | HTTPステータス | 説明 | メッセージ例 |
|---|---|---|---|
| ERROR_CODE | 400 | エラー説明 | ユーザー向けメッセージ |
```

### 受け入れ基準テンプレート
```markdown
- [条件]の場合、[期待される結果]となること
  - テスト方法: [具体的なテスト手順]
  - 測定指標: [数値で測定可能な基準]
```

---

**作成日**: 2024-01-30  
**作成者**: QA Review Agent  
**更新履歴**: v1.0 初版
