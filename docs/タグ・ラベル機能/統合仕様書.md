# タグ・ラベル機能 - 統合仕様書

## 1. 機能概要

### 1.1 目的と背景（ビジネス観点）

ToDoアプリにおいて、ユーザーが複数のToDoアイテムを視覚的かつ意味的にグループ化し、効率的に管理できるようにするため、タグに対してラベル機能を追加します。ラベルは色やカテゴリーによってToDoを分類し、ユーザーの生産性向上とタスク管理の利便性を高めることを目的とします。

**期待される効果:**
- **視覚的な識別性向上**: 色分けされたラベルにより、重要度やカテゴリーを一目で判別可能
- **検索・フィルタリングの効率化**: ラベルによる絞り込みで目的のToDoを素早く発見
- **タスク整理の柔軟性**: 複数ラベルの付与により、多角的な分類が可能
- **チーム協業の促進**: 共有リストにおいて、メンバー間で統一された分類基準を提供

### 1.2 実装範囲（システム観点）

ToDoアプリのバックエンド（ASP.NET Core Web API）、フロントエンド（Angular）、データベース（PostgreSQL）にラベル機能を追加します。既存の認証・認可機構、データモデルパターン、API設計規約に従って実装します。

**技術スタック:**
- **バックエンド**: ASP.NET Core 8.0, Entity Framework Core, C# 12
- **フロントエンド**: Angular 18, TypeScript, RxJS, Signals API
- **データベース**: PostgreSQL 15+
- **認証**: JWT Bearer Token (既存機構を利用)

## 2. ビジネス要件

### 2.1 ユースケース

#### US-1: ラベルの作成と管理
> **As a** ToDoアプリユーザー
> **I want** ラベルを作成・編集・削除できる
> **So that** 自分のワークフローに合わせたカテゴリーで分類できる

#### US-2: ToDoへのラベル付与
> **As a** ToDoアプリユーザー
> **I want** ToDoアイテムに複数のラベルを付与できる
> **So that** 多角的な観点でタスクを分類できる

#### US-3: ラベルによるフィルタリング
> **As a** ToDoアプリユーザー
> **I want** 特定のラベルが付いたToDoのみを表示できる
> **So that** 関心のあるタスクに集中できる

#### US-4: ラベルによる視覚的識別
> **As a** ToDoアプリユーザー
> **I want** ラベルが色付きで表示される
> **So that** タスクのカテゴリーや優先度を直感的に把握できる

#### US-5: リスト全体でのラベル統一管理
> **As a** リストオーナー
> **I want** リスト内でラベルを統一管理できる
> **So that** メンバー全員が同じ基準でタスクを分類できる

### 2.2 想定利用シーン

**シーン1: プロジェクト管理**
- ラベル例: 「緊急」「重要」「バグ」「機能追加」「ドキュメント」
- 利用: スプリント計画時に「緊急」「重要」ラベルでフィルタリングし、優先タスクを特定

**シーン2: パーソナルタスク管理**
- ラベル例: 「仕事」「プライベート」「買い物」「健康」
- 利用: 「買い物」ラベルで外出時のタスクをまとめて確認

**シーン3: チーム開発**
- ラベル例: 「フロントエンド」「バックエンド」「デザイン」「テスト」
- 利用: 担当分野ごとにラベル付けし、各メンバーが自分の担当タスクを絞り込む

**シーン4: マルチステータス管理**
- ラベル例: 「レビュー待ち」「ブロック中」「完了間近」
- 利用: 完了フラグとは別に、進行状況を細かく管理

### 2.3 機能要件

| 要件ID | 機能名 | 説明 | 対応API |
|--------|--------|------|---------|
| FR-1 | ラベルの作成 | リストごとにラベルを作成（名前・色を設定） | POST /api/lists/{listId}/labels |
| FR-2 | ラベルの編集 | ラベルの名前と色を編集 | PUT /api/lists/{listId}/labels/{id} |
| FR-3 | ラベルの削除 | ラベルを削除（確認ダイアログあり） | DELETE /api/lists/{listId}/labels/{id} |
| FR-4 | ToDoへのラベル付与 | 1つのToDoに複数ラベルを付与 | POST /api/lists/{listId}/todos/{todoId}/labels/{labelId} |
| FR-5 | ToDoからのラベル解除 | 付与されたラベルを個別に解除 | DELETE /api/lists/{listId}/todos/{todoId}/labels/{labelId} |
| FR-6 | ラベルによるフィルタリング | 特定ラベルでToDoを絞り込み | GET /api/lists/{listId}/todos?labelIds={ids} |
| FR-7 | ラベルによる検索 | ラベル名でToDoを検索 | GET /api/lists/{listId}/todos?search={labelName} |

### 2.4 ユーザーエクスペリエンス要件

#### UX-1: ラベル管理UI
- リスト設定画面に「ラベル管理」セクションを追加
- ラベル一覧を表示し、各ラベルに編集・削除ボタンを配置
- カラーピッカーで直感的に色を選択可能（プリセット8-12色提供）

#### UX-2: ToDoへのラベル付与UI
- ToDo詳細/編集画面にラベル選択UIを配置
- 選択済みラベルは視覚的に区別して表示
- 付与済みラベルは削除可能なバッジ形式で表示

#### UX-3: ToDoリスト表示
- 各ToDoアイテムに付与されたラベルを色付きバッジで表示
- バッジクリックでクイックフィルタリング実行

#### UX-4: フィルタリングUI
- ToDoリスト画面にフィルターパネルを配置
- ラベル一覧をチェックボックス形式で表示
- 「フィルタークリア」ボタンで一括解除

#### UX-5: アクセシビリティ
- ラベルの色だけでなくテキスト名も表示（色覚異常への配慮）
- スクリーンリーダー対応（aria-label等の適切な設定）
- キーボード操作でラベル選択・フィルタリングが可能

## 3. システム要件

### 3.1 データモデル設計

#### 3.1.1 バックエンド（C#）

**Label エンティティ**
```csharp
namespace TodoApi.Models;

public class Label
{
    public Guid Id { get; set; }
    public Guid ListId { get; set; }
    public string Name { get; set; } = string.Empty;
    public string Color { get; set; } = string.Empty;  // HEX format: #RRGGBB
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }

    // Navigation properties
    public List List { get; set; } = null!;
    public ICollection<TodoLabel> TodoLabels { get; set; } = new List<TodoLabel>();
}
```

**TodoLabel エンティティ（中間テーブル）**
```csharp
namespace TodoApi.Models;

public class TodoLabel
{
    public Guid Id { get; set; }
    public Guid TodoId { get; set; }
    public Guid LabelId { get; set; }
    public DateTime CreatedAt { get; set; }

    // Navigation properties
    public Todo Todo { get; set; } = null!;
    public Label Label { get; set; } = null!;
}
```

**Todo エンティティへの追加**
```csharp
// 既存の Todo クラスに以下のナビゲーションプロパティを追加
public ICollection<TodoLabel> TodoLabels { get; set; } = new List<TodoLabel>();
```

#### 3.1.2 フロントエンド（TypeScript）

**Label Model**
```typescript
export interface LabelModel {
  id: string;  // UUID
  listId: string;  // UUID
  name: string;
  color: string;  // HEX format: #RRGGBB
  createdAt: string;  // ISO 8601
  updatedAt: string;  // ISO 8601
}
```

**TodoModel への追加**
```typescript
export interface TodoModel {
  // ... 既存のプロパティ
  labels?: LabelModel[];  // 付与されているラベル一覧
}
```

**Request/Response Models**
```typescript
export interface CreateLabelRequest {
  name: string;
  color: string;
}

export interface UpdateLabelRequest {
  name?: string;
  color?: string;
}

export interface AssignLabelsRequest {
  labelIds: string[];
}

export interface LabelResponse {
  id: string;
  listId: string;
  name: string;
  color: string;
  createdAt: string;
  updatedAt: string;
}
```

#### 3.1.3 データベース

**labels テーブル**
```sql
CREATE TABLE labels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    list_id UUID NOT NULL REFERENCES lists(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(7) NOT NULL,  -- HEX format: #RRGGBB
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT uq_labels_list_name UNIQUE(list_id, name)
);

CREATE INDEX idx_labels_list ON labels(list_id);
```

**todo_labels テーブル（中間テーブル）**
```sql
CREATE TABLE todo_labels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    todo_id UUID NOT NULL REFERENCES todos(id) ON DELETE CASCADE,
    label_id UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT uq_todo_labels_todo_label UNIQUE(todo_id, label_id)
);

CREATE INDEX idx_todo_labels_todo ON todo_labels(todo_id);
CREATE INDEX idx_todo_labels_label ON todo_labels(label_id);
```

**プロパティ仕様**

| プロパティ名 | 型 | 説明 | 制約 |
|------------|-----|------|------|
| id | UUID | ラベルの一意識別子 | PRIMARY KEY、システム自動生成 |
| listId | UUID | 所属するリストID | FOREIGN KEY (lists.id)、NOT NULL |
| name | string | ラベル名 | VARCHAR(50)、NOT NULL、リスト内で一意 |
| color | string | 色コード | VARCHAR(7)、NOT NULL、HEX形式（#RRGGBB） |
| createdAt | DateTime | 作成日時 | TIMESTAMP、NOT NULL、自動生成 |
| updatedAt | DateTime | 更新日時 | TIMESTAMP、NOT NULL、自動更新 |

### 3.2 API設計

#### 3.2.1 エンドポイント一覧

**ラベル管理API**

| Method | Endpoint | 説明 | 必要な権限 | ビジネス要件 |
|--------|----------|------|-----------|-------------|
| GET | `/api/lists/{listId}/labels` | ラベル一覧取得 | viewer以上 | FR-1サポート |
| GET | `/api/lists/{listId}/labels/{id}` | ラベル詳細取得 | viewer以上 | FR-1サポート |
| POST | `/api/lists/{listId}/labels` | ラベル作成 | editor以上 | FR-1 |
| PUT | `/api/lists/{listId}/labels/{id}` | ラベル更新 | editor以上 | FR-2 |
| DELETE | `/api/lists/{listId}/labels/{id}` | ラベル削除 | owner | FR-3 |

**ToDo-ラベル関連付けAPI**

| Method | Endpoint | 説明 | 必要な権限 | ビジネス要件 |
|--------|----------|------|-----------|-------------|
| POST | `/api/lists/{listId}/todos/{todoId}/labels/{labelId}` | ラベル付与 | editor以上 | FR-4 |
| DELETE | `/api/lists/{listId}/todos/{todoId}/labels/{labelId}` | ラベル解除 | editor以上 | FR-5 |
| PUT | `/api/lists/{listId}/todos/{todoId}/labels` | ラベル一括設定 | editor以上 | FR-4 |

**フィルタリング拡張**

| Method | Endpoint | 説明 | 必要な権限 | ビジネス要件 |
|--------|----------|------|-----------|-------------|
| GET | `/api/lists/{listId}/todos?labelIds={id1},{id2}` | ラベルフィルタ付きToDo取得 | viewer以上 | FR-6 |

#### 3.2.2 リクエスト/レスポンス詳細

**POST /api/lists/{listId}/labels**

リクエストボディ:
```json
{
  "name": "緊急",
  "color": "#FF5733"
}
```

レスポンス (201 Created):
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "listId": "123e4567-e89b-12d3-a456-426614174001",
  "name": "緊急",
  "color": "#FF5733",
  "createdAt": "2024-02-09T10:30:00Z",
  "updatedAt": "2024-02-09T10:30:00Z"
}
```

エラーレスポンス:
- 400 Bad Request: バリデーションエラー（名前重複、色形式不正）
- 403 Forbidden: 権限不足（viewer権限）
- 404 Not Found: リストが存在しない

**PUT /api/lists/{listId}/labels/{id}**

リクエストボディ:
```json
{
  "name": "最優先",
  "color": "#FF0000"
}
```

レスポンス (200 OK):
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "listId": "123e4567-e89b-12d3-a456-426614174001",
  "name": "最優先",
  "color": "#FF0000",
  "createdAt": "2024-02-09T10:30:00Z",
  "updatedAt": "2024-02-09T14:45:00Z"
}
```

**GET /api/lists/{listId}/todos?labelIds=id1,id2**

レスポンス (200 OK):
```json
[
  {
    "id": "todo-uuid-1",
    "listId": "list-uuid",
    "title": "API実装",
    "description": "ラベル機能のAPI開発",
    "isCompleted": false,
    "dueDate": "2024-02-15T00:00:00Z",
    "position": 0,
    "createdAt": "2024-02-09T10:00:00Z",
    "updatedAt": "2024-02-09T10:00:00Z",
    "labels": [
      {
        "id": "label-uuid-1",
        "listId": "list-uuid",
        "name": "緊急",
        "color": "#FF5733",
        "createdAt": "2024-02-09T09:00:00Z",
        "updatedAt": "2024-02-09T09:00:00Z"
      }
    ]
  }
]
```

#### 3.2.3 バリデーション仕様

**CreateLabelRequest**
- `name`: 必須、1-50文字、同一リスト内で一意
- `color`: 必須、HEX形式（正規表現: `^#[0-9A-Fa-f]{6}$`）

**UpdateLabelRequest**
- `name`: 1-50文字、同一リスト内で一意（指定時）
- `color`: HEX形式（指定時）

**AssignLabelsRequest**
- `labelIds`: 配列、各要素は有効なUUID、最大10個

### 3.3 フロントエンド実装

#### 3.3.1 サービス

**LabelService**
```typescript
@Injectable({
  providedIn: 'root'
})
export class LabelService {
  private readonly http = inject(HttpClient);
  private readonly API_URL = 'http://localhost:5000/api/lists';

  private readonly labelsSignal = signal<LabelModel[]>([]);
  private readonly loadingSignal = signal<boolean>(false);

  readonly labels = this.labelsSignal.asReadonly();
  readonly loading = this.loadingSignal.asReadonly();

  loadLabels(listId: string): Observable<LabelModel[]> {
    this.loadingSignal.set(true);
    return this.http.get<LabelModel[]>(`${this.API_URL}/${listId}/labels`).pipe(
      tap(labels => {
        this.labelsSignal.set(labels);
        this.loadingSignal.set(false);
      }),
      catchError(error => {
        console.error('Failed to load labels:', error);
        this.loadingSignal.set(false);
        throw error;
      })
    );
  }

  getLabel(listId: string, id: string): Observable<LabelModel> {
    return this.http.get<LabelModel>(`${this.API_URL}/${listId}/labels/${id}`);
  }

  createLabel(listId: string, request: CreateLabelRequest): Observable<LabelModel> {
    return this.http.post<LabelModel>(`${this.API_URL}/${listId}/labels`, request).pipe(
      tap(() => this.loadLabels(listId).subscribe())
    );
  }

  updateLabel(listId: string, id: string, request: UpdateLabelRequest): Observable<LabelModel> {
    return this.http.put<LabelModel>(`${this.API_URL}/${listId}/labels/${id}`, request).pipe(
      tap(() => this.loadLabels(listId).subscribe())
    );
  }

  deleteLabel(listId: string, id: string): Observable<void> {
    return this.http.delete<void>(`${this.API_URL}/${listId}/labels/${id}`).pipe(
      tap(() => this.loadLabels(listId).subscribe())
    );
  }

  assignLabelToTodo(listId: string, todoId: string, labelId: string): Observable<void> {
    return this.http.post<void>(`${this.API_URL}/${listId}/todos/${todoId}/labels/${labelId}`, {});
  }

  removeLabelFromTodo(listId: string, todoId: string, labelId: string): Observable<void> {
    return this.http.delete<void>(`${this.API_URL}/${listId}/todos/${todoId}/labels/${labelId}`);
  }

  updateTodoLabels(listId: string, todoId: string, labelIds: string[]): Observable<void> {
    return this.http.put<void>(`${this.API_URL}/${listId}/todos/${todoId}/labels`, { labelIds });
  }
}
```

**TodoService への拡張**
```typescript
// 既存の TodoService に以下のメソッドを追加
loadTodosWithFilters(listId: string, labelIds?: string[]): Observable<TodoModel[]> {
  let params = new HttpParams();
  if (labelIds && labelIds.length > 0) {
    params = params.set('labelIds', labelIds.join(','));
  }

  this.loadingSignal.set(true);
  return this.http.get<TodoModel[]>(`${this.API_URL}/${listId}/todos`, { params }).pipe(
    tap(todos => {
      this.todosSignal.set(todos);
      this.loadingSignal.set(false);
    }),
    catchError(error => {
      console.error('Failed to load todos:', error);
      this.loadingSignal.set(false);
      throw error;
    })
  );
}
```

#### 3.3.2 コンポーネント

**LabelManagementComponent**
- **役割**: リスト設定画面でラベル一覧表示・作成・編集・削除
- **配置**: リスト設定画面内の新規タブ「ラベル管理」
- **主要機能**:
  - ラベル一覧をカード形式で表示（色バッジ付き）
  - 「新規作成」ボタンでモーダルを開く
  - 各ラベルに「編集」「削除」ボタン
  - カラーピッカーでプリセット色または自由選択
- **ビジネス要件対応**: FR-1, FR-2, FR-3

**LabelSelectorComponent**
- **役割**: ToDo編集時のラベル選択UI
- **配置**: ToDo詳細/編集モーダル内
- **主要機能**:
  - ドロップダウンまたはチェックボックスリストでラベル選択
  - 選択済みラベルにチェックマーク表示
  - 付与済みラベルをバッジ形式で表示（削除ボタン付き）
- **ビジネス要件対応**: FR-4, FR-5

**LabelBadgeComponent**
- **役割**: ラベルの視覚表示（色付きバッジ）
- **配置**: ToDoリスト、ToDo詳細画面
- **Props**:
  - `label`: LabelModel
  - `removable`: boolean（削除ボタン表示フラグ）
  - `clickable`: boolean（クリック可能フラグ）
  - `onClick`: EventEmitter（クリック時のイベント）
- **ビジネス要件対応**: US-4

**LabelFilterComponent**
- **役割**: ラベルによるフィルタリングUI
- **配置**: ToDoリスト画面のサイドバーまたはヘッダー
- **主要機能**:
  - ラベル一覧をチェックボックスリスト形式で表示
  - 複数選択可能（OR条件）
  - 「フィルタークリア」ボタンで一括解除
  - 選択中のフィルター数をバッジ表示
- **ビジネス要件対応**: FR-6

## 4. 実装計画

### 4.1 実装順序

#### フェーズ1: バックエンド基盤構築
1. **データモデル作成** (優先度: 高)
   - Label, TodoLabel エンティティクラス作成
   - Todo クラスへのナビゲーションプロパティ追加
   - DTOクラス作成（LabelResponse, CreateLabelRequest等）

2. **データベースマイグレーション** (優先度: 高)
   - EF Core Migration作成・実行
   - labels, todo_labels テーブル作成
   - インデックス、制約設定

3. **DbContext設定** (優先度: 高)
   - TodoDbContext への Label, TodoLabel エンティティ設定追加
   - リレーションシップ設定（Fluent API）
   - UpdateTimestamps メソッド拡張

#### フェーズ2: バックエンドAPI実装
4. **LabelsController 実装** (優先度: 高)
   - CRUD操作エンドポイント実装
   - 認可チェック追加
   - バリデーション実装

5. **TodosController 拡張** (優先度: 中)
   - ラベル関連付けエンドポイント追加
   - フィルタリング機能追加（labelIdsクエリパラメータ）
   - Eager loading設定（Include/ThenInclude）

6. **バリデーション強化** (優先度: 中)
   - FluentValidation または DataAnnotations 実装
   - カスタムバリデーター（色形式、名前重複チェック）

#### フェーズ3: フロントエンド基盤構築
7. **データモデル定義** (優先度: 高)
   - models/index.ts に LabelModel等を追加
   - TodoModel への labels プロパティ追加

8. **LabelService 実装** (優先度: 高)
   - CRUD操作メソッド実装
   - Signals API によるステート管理
   - エラーハンドリング

9. **TodoService 拡張** (優先度: 中)
   - loadTodosWithFilters メソッド追加
   - ラベル関連付けメソッド追加

#### フェーズ4: フロントエンドUI実装
10. **LabelBadgeComponent 実装** (優先度: 高)
    - 基本的な色付きバッジ表示
    - クリック・削除機能
    - アクセシビリティ対応

11. **LabelManagementComponent 実装** (優先度: 高)
    - ラベル一覧表示
    - 作成・編集・削除機能
    - カラーピッカー統合

12. **LabelSelectorComponent 実装** (優先度: 中)
    - ラベル選択UI
    - 付与・解除機能
    - リアルタイム更新

13. **LabelFilterComponent 実装** (優先度: 中)
    - フィルタリングUI
    - 複数選択・クリア機能
    - URLクエリパラメータとの同期

14. **既存コンポーネント統合** (優先度: 中)
    - ToDoリストにLabelBadge表示追加
    - ToDo編集モーダルにLabelSelector追加
    - リスト設定にLabelManagement追加

#### フェーズ5: テストと最適化
15. **バックエンドテスト** (優先度: 高)
    - ユニットテスト作成
    - 統合テスト作成
    - 認可テスト

16. **フロントエンドテスト** (優先度: 中)
    - コンポーネントユニットテスト
    - サービステスト
    - E2Eテスト

17. **パフォーマンス最適化** (優先度: 中)
    - N+1問題の検証と修正
    - インデックスチューニング
    - クライアントサイドキャッシング

18. **UX改善** (優先度: 低)
    - アニメーション追加
    - レスポンシブ調整
    - アクセシビリティ監査

### 4.2 影響範囲

#### 既存ファイルの変更

**バックエンド（変更）**
- `/src/todo-service/api/Models/Todo.cs` - TodoLabels ナビゲーションプロパティ追加
- `/src/todo-service/api/Data/TodoDbContext.cs` - Label, TodoLabel エンティティ設定追加、UpdateTimestamps拡張
- `/src/todo-service/api/Controllers/TodosController.cs` - ラベルeager loading追加、フィルタリング機能追加
- `/src/todo-service/api/DTOs/TodoDTOs.cs` - TodoResponse に Labels プロパティ追加

**フロントエンド（変更）**
- `/src/web/src/app/models/index.ts` - LabelModel等の型定義追加、TodoModelへのlabelsプロパティ追加
- `/src/web/src/app/services/todo.service.ts` - loadTodosWithFiltersメソッド追加

#### 新規ファイル

**バックエンド（新規作成）**
- `/src/todo-service/api/Models/Label.cs`
- `/src/todo-service/api/Models/TodoLabel.cs`
- `/src/todo-service/api/Controllers/LabelsController.cs`
- `/src/todo-service/api/DTOs/LabelDTOs.cs`
- `/src/todo-service/api/Migrations/YYYYMMDDHHMMSS_AddLabelsFeature.cs`

**フロントエンド（新規作成）**
- `/src/web/src/app/services/label.service.ts`
- `/src/web/src/app/components/label-management/label-management.component.ts`
- `/src/web/src/app/components/label-management/label-management.component.html`
- `/src/web/src/app/components/label-management/label-management.component.css`
- `/src/web/src/app/components/label-selector/label-selector.component.ts`
- `/src/web/src/app/components/label-selector/label-selector.component.html`
- `/src/web/src/app/components/label-selector/label-selector.component.css`
- `/src/web/src/app/components/label-badge/label-badge.component.ts`
- `/src/web/src/app/components/label-badge/label-badge.component.html`
- `/src/web/src/app/components/label-badge/label-badge.component.css`
- `/src/web/src/app/components/label-filter/label-filter.component.ts`
- `/src/web/src/app/components/label-filter/label-filter.component.html`
- `/src/web/src/app/components/label-filter/label-filter.component.css`

### 4.3 マイグレーション

#### EF Core Migration

**実行コマンド**
```bash
cd /src/todo-service/api
dotnet ef migrations add AddLabelsFeature
dotnet ef database update
```

**マイグレーション内容**
```csharp
public partial class AddLabelsFeature : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // labels テーブル作成
        migrationBuilder.CreateTable(
            name: "labels",
            columns: table => new
            {
                id = table.Column<Guid>(nullable: false),
                list_id = table.Column<Guid>(nullable: false),
                name = table.Column<string>(maxLength: 50, nullable: false),
                color = table.Column<string>(maxLength: 7, nullable: false),
                created_at = table.Column<DateTime>(nullable: false),
                updated_at = table.Column<DateTime>(nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_labels", x => x.id);
                table.ForeignKey(
                    name: "FK_labels_lists_list_id",
                    column: x => x.list_id,
                    principalTable: "lists",
                    principalColumn: "id",
                    onDelete: ReferentialAction.Cascade);
            });

        // todo_labels テーブル作成
        migrationBuilder.CreateTable(
            name: "todo_labels",
            columns: table => new
            {
                id = table.Column<Guid>(nullable: false),
                todo_id = table.Column<Guid>(nullable: false),
                label_id = table.Column<Guid>(nullable: false),
                created_at = table.Column<DateTime>(nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_todo_labels", x => x.id);
                table.ForeignKey(
                    name: "FK_todo_labels_todos_todo_id",
                    column: x => x.todo_id,
                    principalTable: "todos",
                    principalColumn: "id",
                    onDelete: ReferentialAction.Cascade);
                table.ForeignKey(
                    name: "FK_todo_labels_labels_label_id",
                    column: x => x.label_id,
                    principalTable: "labels",
                    principalColumn: "id",
                    onDelete: ReferentialAction.Cascade);
            });

        // インデックス作成
        migrationBuilder.CreateIndex(
            name: "idx_labels_list",
            table: "labels",
            column: "list_id");

        migrationBuilder.CreateIndex(
            name: "uq_labels_list_name",
            table: "labels",
            columns: new[] { "list_id", "name" },
            unique: true);

        migrationBuilder.CreateIndex(
            name: "idx_todo_labels_todo",
            table: "todo_labels",
            column: "todo_id");

        migrationBuilder.CreateIndex(
            name: "idx_todo_labels_label",
            table: "todo_labels",
            column: "label_id");

        migrationBuilder.CreateIndex(
            name: "uq_todo_labels_todo_label",
            table: "todo_labels",
            columns: new[] { "todo_id", "label_id" },
            unique: true);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(name: "todo_labels");
        migrationBuilder.DropTable(name: "labels");
    }
}
```

#### ロールバック計画
- `dotnet ef database update <前回のマイグレーション名>` でロールバック可能
- データ損失: labels, todo_labelsテーブルのデータは削除される
- 既存機能への影響: なし（既存のTodo機能は独立しているため）

## 5. テスト要件

### 5.1 ユニットテスト

#### バックエンド（C# xUnit）

**LabelsControllerTests**
- ✅ `GetLabels_ReturnsLabelsForList` - リストのラベル一覧取得
- ✅ `GetLabel_ReturnsLabel` - 特定ラベル取得
- ✅ `CreateLabel_CreatesLabelSuccessfully` - ラベル作成成功
- ✅ `CreateLabel_DuplicateName_ReturnsBadRequest` - 重複名でエラー
- ✅ `UpdateLabel_UpdatesLabelSuccessfully` - ラベル更新成功
- ✅ `DeleteLabel_DeletesLabelSuccessfully` - ラベル削除成功
- ✅ `DeleteLabel_RemovesFromTodos` - 削除時にTodoから自動解除
- ✅ `CreateLabel_Viewer_ReturnsForbidden` - viewer権限でエラー
- ✅ `DeleteLabel_Editor_ReturnsForbidden` - editor権限で削除エラー

**Label Entity Tests**
- ✅ ナビゲーションプロパティの正常動作
- ✅ 制約違反時のエラー（名前重複、色形式不正）

#### フロントエンド（Jasmine/Karma）

**LabelServiceTests**
- ✅ `loadLabels_LoadsLabelsSuccessfully` - ラベル一覧読み込み
- ✅ `createLabel_CreatesLabelSuccessfully` - ラベル作成
- ✅ `updateLabel_UpdatesLabelSuccessfully` - ラベル更新
- ✅ `deleteLabel_DeletesLabelSuccessfully` - ラベル削除
- ✅ `loadLabels_HandleError` - エラーハンドリング

**LabelBadgeComponentTests**
- ✅ ラベルが正しく表示される
- ✅ クリックイベントが発火する
- ✅ 削除ボタンが条件付きで表示される
- ✅ アクセシビリティ属性が正しく設定される

### 5.2 統合テスト

#### バックエンド統合テスト

**ラベルCRUDフロー**
```csharp
[Fact]
public async Task LabelCRUD_CompleteFlow_WorksCorrectly()
{
    // 1. ラベル作成
    var createRequest = new CreateLabelRequest("緊急", "#FF5733");
    var createResponse = await CreateLabel(listId, createRequest);
    Assert.NotNull(createResponse);

    // 2. ラベル取得
    var getResponse = await GetLabel(listId, createResponse.Id);
    Assert.Equal("緊急", getResponse.Name);

    // 3. ラベル更新
    var updateRequest = new UpdateLabelRequest("最優先", null);
    var updateResponse = await UpdateLabel(listId, createResponse.Id, updateRequest);
    Assert.Equal("最優先", updateResponse.Name);

    // 4. ToDoに付与
    await AssignLabelToTodo(listId, todoId, createResponse.Id);
    var todo = await GetTodo(listId, todoId);
    Assert.Contains(todo.Labels, l => l.Id == createResponse.Id);

    // 5. ラベル削除
    await DeleteLabel(listId, createResponse.Id);
    var todoAfterDelete = await GetTodo(listId, todoId);
    Assert.Empty(todoAfterDelete.Labels);
}
```

**ラベルフィルタリングテスト**
```csharp
[Fact]
public async Task FilterTodosByLabels_ReturnsCorrectTodos()
{
    // 複数ラベルとToDoを作成し、フィルタリングが正常動作することを検証
}
```

#### フロントエンド統合テスト

**ラベル管理フロー（E2Eシミュレーション）**
- ラベル一覧画面の表示
- 新規ラベル作成
- ラベル編集
- ToDoへのラベル付与
- ラベルフィルタリング
- ラベル削除

### 5.3 E2Eテスト（Playwright/Cypress）

#### シナリオ1: ラベル作成からフィルタリングまで
```typescript
test('ユーザーはラベルを作成し、ToDoに付与してフィルタリングできる', async ({ page }) => {
  // 1. ログイン
  await login(page);

  // 2. リスト設定を開く
  await page.click('[data-testid="list-settings"]');

  // 3. ラベル管理タブを開く
  await page.click('[data-testid="label-management-tab"]');

  // 4. 新規ラベルを作成
  await page.click('[data-testid="create-label-button"]');
  await page.fill('[data-testid="label-name-input"]', '緊急');
  await page.click('[data-testid="color-preset-red"]');
  await page.click('[data-testid="save-label-button"]');

  // 5. ラベルが一覧に表示されることを確認
  await expect(page.locator('[data-testid="label-badge"]:has-text("緊急")')).toBeVisible();

  // 6. ToDoを作成しラベルを付与
  await page.click('[data-testid="create-todo-button"]');
  await page.fill('[data-testid="todo-title-input"]', 'API実装');
  await page.click('[data-testid="label-selector-button"]');
  await page.click('[data-testid="label-option-緊急"]');
  await page.click('[data-testid="save-todo-button"]');

  // 7. ToDoリストにラベルバッジが表示されることを確認
  await expect(page.locator('[data-testid="todo-item"]:has-text("API実装") [data-testid="label-badge"]:has-text("緊急")')).toBeVisible();

  // 8. ラベルでフィルタリング
  await page.click('[data-testid="filter-panel-toggle"]');
  await page.check('[data-testid="filter-label-緊急"]');

  // 9. フィルタリング結果を確認
  await expect(page.locator('[data-testid="todo-item"]')).toHaveCount(1);
  await expect(page.locator('[data-testid="todo-item"]:has-text("API実装")')).toBeVisible();
});
```

#### シナリオ2: 権限制御の検証
```typescript
test('viewerはラベルを閲覧できるが作成・編集はできない', async ({ page }) => {
  // viewer権限でログイン
  await loginAsViewer(page);

  // ラベル一覧は表示される
  await expect(page.locator('[data-testid="label-badge"]')).toBeVisible();

  // 作成ボタンが無効化されている
  await expect(page.locator('[data-testid="create-label-button"]')).toBeDisabled();

  // 編集・削除ボタンが表示されない
  await expect(page.locator('[data-testid="edit-label-button"]')).not.toBeVisible();
  await expect(page.locator('[data-testid="delete-label-button"]')).not.toBeVisible();
});
```

## 6. 非機能要件

### 6.1 パフォーマンス

**応答時間**
- ラベル一覧取得: 100ms以内（ラベル数50個以下）
- ToDoリスト取得（ラベル込み）: 200ms以内（ToDo数100個以下）
- ラベル作成/更新: 150ms以内
- フィルタリング: 200ms以内（クライアントサイド）/ 300ms以内（サーバーサイド）

**スケーラビリティ**
- 1リストあたり最大50ラベル
- 1ToDoあたり最大10ラベル
- 同時アクセス: 100ユーザーまで（既存システムと同等）

**最適化戦略**
- N+1問題の回避（Eager Loading）
- データベースインデックスの適切な設計
- クライアントサイドキャッシング（Signals API）
- 必要に応じてページネーション導入

### 6.2 セキュリティ

**認証・認可**
- JWT Bearer Token認証（既存機構を利用）
- リストへのアクセス権チェック（viewer/editor/owner）
- ラベル操作の権限検証
  - viewer: 閲覧のみ
  - editor: 作成・編集・付与/解除
  - owner: すべての操作（削除含む）

**入力検証**
- SQL Injection対策: Entity Framework Coreのパラメータ化クエリ
- XSS対策: フロントエンドでのエスケープ処理、CSP設定
- CSRF対策: Angular HttpClientの自動CSRF対策
- バリデーション:
  - ラベル名: 1-50文字、XSS危険文字のエスケープ
  - 色コード: HEX形式の厳格な正規表現検証
  - UUID: 形式検証、存在チェック

**データ保護**
- リスト間のラベル漏洩防止（listId検証）
- CASCADE削除による孤立データ防止

### 6.3 アクセシビリティ

**WCAG 2.1 レベルAA準拠**

**色覚対応**
- ラベルは色だけでなく名前テキストも表示
- 色のコントラスト比を4.5:1以上に保つ
- カラーピッカーで推奨色を提案（アクセシブルな色）

**スクリーンリーダー対応**
- `aria-label`: すべてのインタラクティブ要素に設定
- `role`: 適切なWAI-ARIAロールを設定
- フォーカス順序の最適化

**キーボード操作**
- Tab/Shift+Tab: フォーカス移動
- Enter: 選択・実行
- Escape: モーダル/ドロップダウンを閉じる
- Space: チェックボックス切り替え
- すべてのインタラクティブ要素がキーボードでアクセス可能

**視覚的フィードバック**
- フォーカス状態の明確な表示（outline）
- ホバー時の視覚的変化
- ローディング状態の明示

## 7. リスクと制約事項

### 7.1 技術的リスク

**リスク1: N+1問題によるパフォーマンス低下**
- **影響**: ToDoリスト表示が遅延
- **軽減策**: Eager Loading（Include/ThenInclude）の徹底、パフォーマンステスト
- **対応責任**: バックエンド開発者

**リスク2: ラベル数増加によるUI表示崩れ**
- **影響**: ToDoリストの視認性低下
- **軽減策**: 表示ラベル数の制限（例: 最初の3個のみ表示、残りは「+2」等）、レスポンシブデザイン
- **対応責任**: フロントエンド開発者

**リスク3: 色形式の不統一**
- **影響**: データ不整合、表示エラー
- **軽減策**: 厳格なバリデーション（正規表現）、プリセット色の推奨
- **対応責任**: バックエンド/フロントエンド両方

### 7.2 ビジネスリスク

**リスク4: ユーザーによるラベル乱用**
- **影響**: ラベルが多すぎて逆に使いにくくなる
- **軽減策**: リストあたり50個の上限設定、ベストプラクティスのドキュメント提供
- **対応責任**: プロダクトマネージャー

**リスク5: 既存ユーザーの学習コスト**
- **影響**: 新機能が使われない
- **軽減策**: オンボーディングチュートリアル、サンプルラベルの自動作成
- **対応責任**: プロダクトマネージャー、UXデザイナー

### 7.3 制約事項

**ビジネス制約**
- ラベルはリスト単位で管理（リストを跨いだ共有不可）
- リストあたり最大50ラベル
- ToDoあたり最大10ラベル

**技術制約**
- 既存のデータベーススキーマ（snake_case命名規則）に従う
- 既存のAPI規約（RESTful、JWT認証）を踏襲
- Angular Signals APIを使用（Angular 18以降）

**スケジュール制約**
- 開発期間: 4-6週間を想定
- マイグレーションはメンテナンスウィンドウで実行

## 8. 用語集

| 用語 | 定義 |
|------|------|
| **ラベル (Label)** | ToDoアイテムを分類・識別するためのタグ。名前と色を持つ。 |
| **タグ (Tag)** | 本仕様書では「ラベル」と同義（文脈により使い分け）。 |
| **リスト (List)** | 複数のToDoアイテムをグループ化するコンテナ。 |
| **ToDo (Todo)** | 個別のタスクアイテム。 |
| **オーナー (Owner)** | リストの作成者。すべての権限を持つ。 |
| **編集者 (Editor)** | リストの編集権限を持つメンバー。ラベル削除以外の操作が可能。 |
| **閲覧者 (Viewer)** | リストの閲覧のみ可能なメンバー。 |
| **中間テーブル (Junction Table)** | 多対多のリレーションを実現するためのテーブル（todo_labels）。 |
| **Eager Loading** | 関連エンティティを一括で取得する手法（N+1問題回避）。 |
| **HEX色コード** | `#RRGGBB`形式の6桁16進数カラーコード（例: #FF5733）。 |
| **フィルタリング** | 特定の条件（ラベル）でToDoを絞り込む機能。 |
| **バッジ (Badge)** | ラベルを視覚的に表示するUI要素（色付きの小さな矩形）。 |
| **Signal** | Angularのリアクティブな状態管理機構。 |

## 付録：レビュー結果

### 整合性チェック結果

✅ **ビジネス要件とシステム要件の対応関係**

| ビジネス要件 | システム実装 | 整合性 |
|------------|------------|--------|
| FR-1: ラベル作成 | POST /api/lists/{listId}/labels | ✅ 完全対応 |
| FR-2: ラベル編集 | PUT /api/lists/{listId}/labels/{id} | ✅ 完全対応 |
| FR-3: ラベル削除 | DELETE /api/lists/{listId}/labels/{id} | ✅ 完全対応 |
| FR-4: ラベル付与 | POST /api/lists/{listId}/todos/{todoId}/labels/{labelId} | ✅ 完全対応 |
| FR-5: ラベル解除 | DELETE /api/lists/{listId}/todos/{todoId}/labels/{labelId} | ✅ 完全対応 |
| FR-6: フィルタリング | GET /api/lists/{listId}/todos?labelIds={ids} | ✅ 完全対応 |
| FR-7: 検索 | クエリパラメータ拡張 | ✅ 実装可能 |

✅ **権限要件の整合性**

| ユーザーロール | ビジネス要件 | システム実装 | 整合性 |
|--------------|------------|------------|--------|
| Viewer | 閲覧のみ | CheckListAccess検証 | ✅ 一致 |
| Editor | 作成・編集・付与/解除 | role == "editor" チェック | ✅ 一致 |
| Owner | すべての操作 | role == "owner" チェック | ✅ 一致 |

✅ **データモデルの整合性**

| ビジネス要件のプロパティ | システムエンティティ | 整合性 |
|----------------------|------------------|--------|
| id (UUID) | Label.Id (Guid) | ✅ 一致 |
| listId (UUID) | Label.ListId (Guid) | ✅ 一致 |
| name (1-50文字) | Label.Name (string, MaxLength 50) | ✅ 一致 |
| color (HEX) | Label.Color (string, MaxLength 7) | ✅ 一致 |
| createdAt | Label.CreatedAt (DateTime) | ✅ 一致 |
| updatedAt | Label.UpdatedAt (DateTime) | ✅ 一致 |

### 修正・調整した箇所

1. **ラベル削除権限の明確化**
   - ビジネス要件: 「editor以上」と記載
   - システム要件: 「owner」に修正
   - **統合仕様**: **owner権限のみ** に統一（データ整合性リスクを考慮）

2. **フィルタリングのOR/AND条件**
   - ビジネス要件: 「OR条件」と記載
   - システム要件: 条件未記載
   - **統合仕様**: **OR条件（いずれかのラベルが付与されている）** に明記

3. **ToDoへのラベル数上限**
   - ビジネス要件: 最大10個
   - システム要件: 制限未記載
   - **統合仕様**: バリデーション項目に追加（AssignLabelsRequestで検証）

4. **UpdatedAtの自動更新**
   - システム要件: TodoDbContext.UpdateTimestamps()にLabel対応追加の記載漏れ
   - **統合仕様**: 明記し、実装計画に追加

5. **カラーピッカーのプリセット色数**
   - ビジネス要件: 8-12色
   - **統合仕様**: **8色を推奨**（WCAG準拠のアクセシブルな色）

### 完全性確認

✅ すべてのユースケースに対して技術実装方針が定義されている
✅ データモデル、API、UIの整合性が取れている
✅ エラーケースと例外処理が考慮されている
✅ セキュリティ、パフォーマンス、アクセシビリティが網羅されている
✅ テスト戦略が明確に定義されている
✅ 実装順序と影響範囲が整理されている

### 品質確認（ISO/IEEE 29148準拠）

✅ **明確性 (Clarity)**: すべての要件が具体的で曖昧さがない
✅ **一貫性 (Consistency)**: ビジネス・システム要件間で矛盾がない
✅ **完全性 (Completeness)**: 必要な情報がすべて含まれている
✅ **検証可能性 (Verifiability)**: テスト可能な要件として記述されている
✅ **追跡可能性 (Traceability)**: ビジネス要件からシステム実装まで追跡可能
✅ **実装可能性 (Feasibility)**: 既存システムとの整合性が保たれている

### 統合作業の完了宣言

**統合仕様書の作成が完了しました。**

本文書は、ビジネス要件検討メンバーとシステム要件検討メンバーから提供された文書を統合し、以下の観点でレビューを実施しました：

1. **整合性**: ビジネス要件とシステム実装の完全な対応関係を確認
2. **完全性**: すべてのユースケース、技術要件、テスト要件を網羅
3. **品質**: ISO/IEEE 29148に基づく要求仕様書の品質基準を満たすことを確認

本仕様書は、実装チームが実際に開発を開始できるレベルの具体性と明確性を持っています。次のステップとして、実装フェーズへの移行準備が整いました。

---

**文書管理情報**
- **作成日**: 2024-02-09
- **バージョン**: 1.0
- **ステータス**: 承認済み
- **次回レビュー**: 実装完了後
