# 脆弱性 I-02: ハードコードされた秘匿情報（パスワード直書き）
# 脆弱性 I-03: 不要ポートの公開（DBポートが外部公開）
# 脆弱性 D-01: 弱いDBパスワード
# 脆弱性 D-03: 暗号化なし通信（SSL/TLS未使用）

# .env ファイルから GH_TOKEN 等を読み込み
# cp .env.example .env して値を設定してください

services:
  # ============================================================
  #  アプリケーションサービス
  # ============================================================
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: vulndb
      POSTGRES_USER: postgres
      # 脆弱性 D-01 / I-02: 弱いパスワード＆ハードコード
      POSTGRES_PASSWORD: postgres123
    ports:
      # 脆弱性 I-03: DBポートが外部に公開
      - "15432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./src/db/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./src/db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ./src/api
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      # 脆弱性 I-02 / D-03: 接続文字列にパスワード直書き＆SSL未使用
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
      ASPNETCORE_ENVIRONMENT: Development
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/5000' 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - api
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ============================================================
  #  統合脆弱性スキャナー（プロファイルで起動制御）
  #
  #  1コンテナに全ツールを内包:
  #    OWASP ZAP / Nikto / sqlmap / Nmap / Trivy
  #    + Playwright (Chromium) / GitHub CLI / GitHub Copilot CLI
  #
  #  使用方法:
  #    全スキャン:            docker compose --profile scan run --rm scanner all
  #    個別スキャン:          docker compose --profile scan run --rm scanner nmap
  #    ZAP パッシブスキャン:  docker compose --profile scan run --rm scanner shell
  #                           （scanner コンテナ内で zap-passive-scan エージェントが実行）
  #    Copilot CLI:          docker compose --profile scan run --rm -e GH_TOKEN=$GH_TOKEN scanner copilot
  #    シェルに入る:          docker compose --profile scan run --rm scanner shell
  #    スクリプト経由:        ./run-scan.sh all
  # ============================================================
  scanner:
    build:
      context: ./src/scanner
      dockerfile: Dockerfile
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      # スキャン対象URL（コンテナ内ネットワーク）
      SCAN_TARGET_FRONTEND: "http://frontend:80"
      SCAN_TARGET_API: "http://api:5000"
      SCAN_TARGET_DB: "db"
      SCAN_TARGET_OPENAPI: "http://api:5000/openapi/v1.json"
      SQLMAP_TARGET_URL: "http://api:5000/api/users?search=test"
      # ZAP パッシブスキャン設定
      ZAP_PROXY_PORT: "8090"
      ZAP_API_KEY: "zap-passive-scan-key"
      # Playwright 設定
      FRONTEND_URL: "http://frontend:80"
      API_URL: "http://api:5000"
      ZAP_PROXY: "http://localhost:8090"
      # GitHub Copilot CLI 認証（.env ファイルまたは環境変数から読み込み）
      GH_TOKEN: "${GH_TOKEN:-}"
    volumes:
      - ./reports:/reports
      - ./:/workdir:ro
      - ./docker-work-dir:/docker-work-dir
    depends_on:
      frontend:
        condition: service_healthy
      api:
        condition: service_healthy
    profiles:
      - scan

volumes:
  pgdata:
