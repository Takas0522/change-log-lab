# 脆弱性スキャン環境 構成ガイド

## 概要

本プロジェクトの意図的脆弱性（[vulnerabilities.md](vulnerabilities.md)参照）を自動検出するため、
Docker Compose にヘッドレス（CLI）で動作する脆弱性スキャナー群を統合しています。

## ツール選定

### なぜ Kali Linux / ParrotOS ではなく個別ツールコンテナか

| 比較項目 | Kali Linux (フルイメージ) | 個別ツールコンテナ（本構成） |
|----------|--------------------------|------------------------------|
| イメージサイズ | ~3–5 GB | 各 100–500 MB |
| 起動時間 | 遅い | 高速 |
| ヘッドレス最適化 | GUI ツールも含まれる | CLI 専用で最適化済み |
| CI/CD 統合 | 困難 | 容易 |
| ツール更新 | OS全体の更新が必要 | 各イメージ個別に更新可能 |
| リソース消費 | 大 | 小 |

各スキャナーは Kali Linux / ParrotOS にプリインストールされている **同一のツール** です。
単体コンテナとして分離することで、必要なツールだけを必要な時に起動できます。

### 採用ツール一覧

| ツール | Docker イメージ | 用途 | 検出対象の脆弱性 |
|--------|----------------|------|-------------------|
| **OWASP ZAP** | `zaproxy/zap-stable` | Webアプリ脆弱性スキャン | F-01, F-03, F-04, A-01, A-04, A-05, A-07, A-08 |
| **Nikto** | `secsi/nikto` | Webサーバー設定検査 | サーバー設定不備, 情報漏洩 |
| **sqlmap** | `paoloo/sqlmap` | SQLインジェクション特化 | A-01 |
| **Nmap** | `instrumentisto/nmap` | ネットワーク脆弱性スキャン | I-03, D-03 |
| **Trivy** | `aquasecurity/trivy` | ファイルシステム脆弱性スキャン | I-01, I-02 |

## 使用方法

### 前提条件

- Docker & Docker Compose がインストール済み
- 本ディレクトリ (`vulnerability-site/`) で作業

### スクリプト経由（推奨）

```bash
# 実行権限を付与
chmod +x run-scan.sh

# 全スキャナーを順次実行
./run-scan.sh all

# 個別実行
./run-scan.sh zap        # OWASP ZAP ベースライン
./run-scan.sh zap-full   # OWASP ZAP フルスキャン（長時間）
./run-scan.sh zap-api    # OWASP ZAP API スキャン
./run-scan.sh nikto      # Nikto Web サーバースキャン
./run-scan.sh sqlmap     # sqlmap SQLインジェクション
./run-scan.sh nmap       # Nmap ネットワークスキャン
./run-scan.sh trivy      # Trivy ファイルシステムスキャン

# 停止
./run-scan.sh stop
```

### Docker Compose 直接実行

```bash
# アプリケーションを起動
docker compose up -d

# 全スキャナーを一括起動（profile: scan）
docker compose --profile scan up

# ツール別に起動
docker compose --profile scan-zap up       # ZAP ベースライン
docker compose --profile scan-full up      # ZAP フルスキャン
docker compose --profile scan-api up       # ZAP API スキャン
docker compose --profile scan-nikto up     # Nikto
docker compose --profile scan-sqlmap up    # sqlmap
docker compose --profile scan-nmap up      # Nmap
docker compose --profile scan-trivy up     # Trivy
```

## レポート出力

スキャン結果は `reports/` ディレクトリに出力されます：

```
reports/
├── zap/
│   ├── zap-baseline-report.html    # ZAP ベースライン HTML レポート
│   ├── zap-baseline-report.json    # ZAP ベースライン JSON レポート
│   ├── zap-full-report.html        # ZAP フルスキャン HTML レポート
│   ├── zap-full-report.json        # ZAP フルスキャン JSON レポート
│   ├── zap-api-report.html         # ZAP API スキャン HTML レポート
│   └── zap-api-report.json         # ZAP API スキャン JSON レポート
├── nikto/
│   ├── nikto-frontend-report.html  # Nikto フロントエンド スキャン結果
│   └── nikto-api-report.html       # Nikto API スキャン結果
├── nmap/
│   ├── nmap-report.txt             # Nmap テキストレポート
│   └── nmap-report.xml             # Nmap XML レポート
├── sqlmap/
│   └── (sqlmap 出力ディレクトリ)
└── trivy/
    └── trivy-fs-report.txt         # Trivy ファイルシステムスキャン結果
```

## 各ツールの検出範囲マッピング

```
脆弱性 ID    ZAP   Nikto  sqlmap  Nmap  Trivy
─────────────────────────────────────────────
F-01 (XSS)    ✓
F-02 (秘密露出)                          ✓
F-03 (リダイレクト) ✓
F-04 (CSRF)   ✓
F-05 (ログ)                              ✓
A-01 (SQLi)   ✓            ✓
A-02 (認証)   ✓
A-04 (エラー) ✓     ✓
A-05 (CORS)   ✓
A-06 (Mass)   ✓
A-07 (トラバーサル) ✓  ✓
A-08 (ヘッダ) ✓     ✓
A-09 (レート) ✓
D-01 (弱パス)                     ✓
D-03 (SSL)                        ✓
I-01 (root)                              ✓
I-02 (秘密)                              ✓
I-03 (ポート)                     ✓
```

## 注意事項

- スキャンは **検証環境のみ** で実施してください。本番環境への実行は禁止です
- ZAP フルスキャンは能動的な攻撃テストを行うため、長時間かかる場合があります
- sqlmap は実際にSQLインジェクションを試行するため、DB データが変更される可能性があります
- `reports/` ディレクトリは `.gitignore` に追加することを推奨します
