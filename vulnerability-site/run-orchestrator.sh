#!/usr/bin/env bash
# =============================================================================
# run-orchestrator.sh
#
# vulnerability-site ディレクトリから実行するオーケストレーター起動スクリプト。
# Docker Compose の scanner サービスを使用し、Copilot CLI の
# vuln-scan-orchestrator カスタムエージェントで全工程の脆弱性診断を実行する。
#
# 前提条件:
#   - GH_TOKEN 環境変数が設定されていること（GitHub Copilot CLI 認証）
#   - Docker Compose のアプリケーションサービス（db, api, frontend）が起動済み
#
# 使用方法:
#   export GH_TOKEN="your-github-token"
#   ./run-orchestrator.sh
#
#   # または直接 GH_TOKEN を渡す
#   GH_TOKEN="your-token" ./run-orchestrator.sh
# =============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "${SCRIPT_DIR}"

# .env ファイルから環境変数を読み込み
if [ -f ".env" ]; then
  set -a
  # コメント行・空行を除外して source で読み込み
  source <(grep -v '^#' .env | grep -v '^$' | grep '=')
  set +a
fi

# --- 色付き出力 ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${CYAN}[INFO]${NC}  $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC}    $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC}  $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# =============================================================================
# 1. 前提条件チェック
# =============================================================================
log_info "=========================================="
log_info "  脆弱性診断オーケストレーター"
log_info "=========================================="

# GH_TOKEN チェック
if [ -z "${GH_TOKEN:-}" ]; then
  log_error "GH_TOKEN が設定されていません。"
  echo ""
  echo "  方法1: .env ファイルに設定（推奨）"
  echo "    cp .env.example .env"
  echo "    # .env ファイルの GH_TOKEN= に値を設定"
  echo ""
  echo "  方法2: 環境変数で直接渡す"
  echo "    export GH_TOKEN=\"your-github-token\""
  echo "    ./run-orchestrator.sh"
  echo ""
  echo "  GitHub Token の取得:"
  echo "    https://github.com/settings/personal-access-tokens/new"
  echo "    → Permissions → \"Copilot Requests\" を有効化"
  echo ""
  exit 1
fi

# Docker 確認
if ! command -v docker &>/dev/null; then
  log_error "Docker が見つかりません。Docker をインストールしてください。"
  exit 1
fi

# docker-compose.yml 確認
if [ ! -f "docker-compose.yml" ]; then
  log_error "docker-compose.yml が見つかりません。vulnerability-site ディレクトリから実行してください。"
  exit 1
fi

# docker-work-dir 確認
if [ ! -d "docker-work-dir" ]; then
  log_error "docker-work-dir ディレクトリが見つかりません。"
  exit 1
fi

if [ ! -f "docker-work-dir/.github/agents/vuln-scan-orchestrator.agent.md" ]; then
  log_error "vuln-scan-orchestrator.agent.md が見つかりません。"
  exit 1
fi

# =============================================================================
# 2. アプリケーションサービスの起動確認
# =============================================================================
log_info "アプリケーションサービスの状態確認中..."

APP_RUNNING=$(docker compose ps --status running --format json 2>/dev/null | grep -c '"Service"' || echo "0")

if [ "$APP_RUNNING" -lt 3 ]; then
  log_warn "アプリケーションサービスが起動していません。起動します..."
  docker compose up -d --build
  log_info "ヘルスチェック待機中 (最大120秒)..."

  TIMEOUT=120
  ELAPSED=0
  while [ $ELAPSED -lt $TIMEOUT ]; do
    HEALTHY=$(docker compose ps --format json 2>/dev/null | grep -c '"healthy"' || echo "0")
    if [ "$HEALTHY" -ge 3 ]; then
      log_ok "全サービス healthy"
      break
    fi
    sleep 5
    ELAPSED=$((ELAPSED + 5))
    echo -ne "\r  待機中... ${ELAPSED}s / ${TIMEOUT}s (healthy: ${HEALTHY}/3)"
  done
  echo ""

  if [ $ELAPSED -ge $TIMEOUT ]; then
    log_warn "タイムアウト。一部サービスが healthy でない可能性があります。"
    docker compose ps
  fi
else
  log_ok "アプリケーションサービス起動済み"
fi

# =============================================================================
# 3. レポートディレクトリの準備
# =============================================================================
mkdir -p reports
mkdir -p docker-work-dir/docs/reports
mkdir -p docker-work-dir/docs/進捗

log_info "レポートディレクトリ準備完了"

# =============================================================================
# 4. オーケストレーター実行
# =============================================================================
log_info "Copilot CLI オーケストレーターを起動します..."
log_info ""
log_info "  エージェント: vuln-scan-orchestrator"
log_info "  作業ディレクトリ: docker-work-dir/"
log_info "  対象サービス: db, api, frontend"
log_info ""
log_info "  診断レポート出力先: docker-work-dir/docs/reports/"
log_info "  スキャン生データ: reports/"
log_info ""

# set -e を一時無効化し、docker compose run の終了コードを確実に取得する
# （set -e が有効だと非ゼロ終了時にスクリプトが即座に中断し、結果レポートが表示されない）
set +e
docker compose --profile scan run --rm \
  -e GH_TOKEN="${GH_TOKEN}" \
  scanner orchestrate

EXIT_CODE=$?
set -e

# =============================================================================
# 5. 結果確認
# =============================================================================
echo ""
log_info "=========================================="
if [ $EXIT_CODE -eq 0 ]; then
  log_ok "  オーケストレーター正常終了"
else
  log_warn "  オーケストレーター終了 (exit code: ${EXIT_CODE})"
fi
log_info "=========================================="

echo ""
log_info "=== 診断レポート ==="
if [ -d "docker-work-dir/docs/reports" ]; then
  find docker-work-dir/docs/reports -type f -name "*.md" -exec ls -lh {} \; 2>/dev/null | sort || true
fi

echo ""
log_info "=== 進捗管理ファイル ==="
if [ -d "docker-work-dir/docs/進捗" ]; then
  find "docker-work-dir/docs/進捗" -type f -name "*.md" -exec ls -lh {} \; 2>/dev/null | sort || true
fi

echo ""
log_info "=== スキャン生データ ==="
if [ -d "reports" ]; then
  find reports -type f \( -name "*.txt" -o -name "*.json" -o -name "*.html" -o -name "*.xml" -o -name "*.log" \) \
    -exec ls -lh {} \; 2>/dev/null | sort || true
fi

exit $EXIT_CODE
