import { useEffect, useState } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import type { User } from '../types';
import { fetchUser, deleteUser } from '../api';

export default function UserDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (id) {
      fetchUser(Number(id)).then((data) => {
        setUser(data);
        setLoading(false);
      });
    }
  }, [id]);

  async function handleDelete() {
    if (id && window.confirm('本当に削除しますか？')) {
      await deleteUser(Number(id));
      navigate('/');
    }
  }

  if (loading) return <p>読み込み中...</p>;
  if (!user) return <p>ユーザーが見つかりません</p>;

  return (
    <div>
      <h2>ユーザー詳細</h2>
      <div style={{ background: '#fff', padding: 24, borderRadius: 8, boxShadow: '0 2px 4px rgba(0,0,0,0.1)', maxWidth: 600 }}>
        <table style={{ width: '100%' }}>
          <tbody>
            <tr><td style={labelStyle}>ID</td><td>{user.id}</td></tr>
            <tr><td style={labelStyle}>ユーザー名</td><td>{user.username}</td></tr>
            <tr><td style={labelStyle}>メール</td><td>{user.email}</td></tr>
            {/* 脆弱性 F-01: XSS — dangerouslySetInnerHTMLでユーザー入力を表示 */}
            <tr>
              <td style={labelStyle}>プロフィール</td>
              <td dangerouslySetInnerHTML={{ __html: user.profileImageUrl || '<em>未設定</em>' }} />
            </tr>
            <tr><td style={labelStyle}>ロール</td><td>{user.role}</td></tr>
            <tr><td style={labelStyle}>作成日</td><td>{new Date(user.createdAt).toLocaleString('ja-JP')}</td></tr>
            <tr><td style={labelStyle}>更新日</td><td>{new Date(user.updatedAt).toLocaleString('ja-JP')}</td></tr>
          </tbody>
        </table>
        <div style={{ marginTop: 24, display: 'flex', gap: 8 }}>
          <Link to={`/users/${user.id}/edit`}>
            <button style={{ padding: '8px 16px', background: '#FF9800', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer' }}>
              編集
            </button>
          </Link>
          <button
            onClick={handleDelete}
            style={{ padding: '8px 16px', background: '#f44336', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer' }}
          >
            削除
          </button>
          <Link to="/">
            <button style={{ padding: '8px 16px', background: '#607D8B', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer' }}>
              戻る
            </button>
          </Link>
        </div>
      </div>
    </div>
  );
}

const labelStyle: React.CSSProperties = { fontWeight: 'bold', padding: '8px 16px 8px 0', width: 120 };
