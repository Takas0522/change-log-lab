import type { User } from './types';
import { API_BASE_URL, debugLog } from './config';

// 脆弱性 F-04: CSRF対策の欠如 — CSRFトークンなしでAPIリクエスト送信
const headers = { 'Content-Type': 'application/json' };

export async function fetchUsers(search?: string): Promise<User[]> {
  const url = search
    ? `${API_BASE_URL}/users?search=${search}`
    : `${API_BASE_URL}/users`;
  const res = await fetch(url, { headers });
  // 脆弱性 F-05: コンソールログへの機密情報出力
  const data = await res.json();
  debugLog('fetchUsers response', data);
  return data;
}

export async function fetchUser(id: number): Promise<User> {
  const res = await fetch(`${API_BASE_URL}/users/${id}`, { headers });
  const data = await res.json();
  debugLog('fetchUser response', data);
  return data;
}

export async function createUser(user: Partial<User>): Promise<User> {
  // 脆弱性 F-05: パスワードをログ出力
  debugLog('createUser request', user);
  const res = await fetch(`${API_BASE_URL}/users`, {
    method: 'POST',
    headers,
    body: JSON.stringify(user),
  });
  return res.json();
}

export async function updateUser(id: number, user: Partial<User>): Promise<User> {
  debugLog('updateUser request', { id, ...user });
  const res = await fetch(`${API_BASE_URL}/users/${id}`, {
    method: 'PUT',
    headers,
    body: JSON.stringify(user),
  });
  return res.json();
}

export async function deleteUser(id: number): Promise<void> {
  await fetch(`${API_BASE_URL}/users/${id}`, {
    method: 'DELETE',
    headers,
  });
}

export async function login(username: string, password: string): Promise<{ success: boolean; message: string; user?: User }> {
  // 脆弱性 F-05: パスワードをコンソールに出力
  debugLog('login attempt', { username, password });
  const res = await fetch(`${API_BASE_URL}/login`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ username, password }),
  });
  return res.json();
}
