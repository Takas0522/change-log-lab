using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;

namespace VulnApi.Controllers;

/// <summary>
/// ファイル操作・デシリアライズAPI
/// 脆弱性 A-07: ディレクトリトラバーサル
/// 脆弱性 A-10: 安全でないデシリアライズ
/// </summary>
[ApiController]
[Route("api")]
public class FileController : ControllerBase
{
    private readonly ILogger<FileController> _logger;

    public FileController(ILogger<FileController> logger)
    {
        _logger = logger;
    }

    /// <summary>
    /// プロフィール画像取得
    /// 脆弱性 A-07: ディレクトリトラバーサル — パスのバリデーションなし
    /// </summary>
    [HttpGet("files/{*filePath}")]
    public IActionResult GetFile(string filePath)
    {
        try
        {
            // 脆弱性 A-07: ディレクトリトラバーサル
            var fullPath = Path.Combine("/app/uploads", filePath);
            if (!System.IO.File.Exists(fullPath))
            {
                return NotFound(new { message = "File not found" });
            }
            var bytes = System.IO.File.ReadAllBytes(fullPath);
            return File(bytes, "application/octet-stream");
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// JSONデシリアライズエンドポイント
    /// 脆弱性 A-10: TypeNameHandling.All による安全でないデシリアライズ
    /// </summary>
    [HttpPost("import")]
    public IActionResult Import([FromBody] object data)
    {
        try
        {
            // 脆弱性 A-10: 安全でないデシリアライズ
            var settings = new JsonSerializerSettings
            {
                TypeNameHandling = TypeNameHandling.All
            };
            var json = data?.ToString() ?? "{}";
            var result = JsonConvert.DeserializeObject(json, settings);
            return Ok(new { message = "Import successful", data = result });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }
}
