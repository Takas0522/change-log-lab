using Microsoft.AspNetCore.Mvc;
using Npgsql;
using VulnApi.Models;
using VulnApi.Services;

namespace VulnApi.Controllers;

/// <summary>
/// ユーザー管理API コントローラー
/// </summary>
[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase
{
    private readonly DbConnectionFactory _dbFactory;
    private readonly ILogger<UsersController> _logger;

    public UsersController(DbConnectionFactory dbFactory, ILogger<UsersController> logger)
    {
        _dbFactory = dbFactory;
        _logger = logger;
    }

    /// <summary>
    /// ユーザー一覧取得（検索対応）
    /// 脆弱性 A-01: SQLインジェクション — searchパラメータを文字列連結でSQL構築
    /// </summary>
    [HttpGet]
    public async Task<IActionResult> GetAll([FromQuery] string? search)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            // 脆弱性 A-01: SQLインジェクション
            var sql = "SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users";
            if (!string.IsNullOrEmpty(search))
            {
                sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
            }
            sql += " ORDER BY id";

            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();

            var users = new List<User>();
            while (await reader.ReadAsync())
            {
                users.Add(MapUser(reader));
            }
            return Ok(users);
        }
        catch (Exception ex)
        {
            // 脆弱性 A-04: 詳細エラー情報の露出
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// ユーザー詳細取得
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(int id)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            // 脆弱性 A-01: SQLインジェクション（idはintなのでここは安全だが、パターンとして残す）
            var sql = $"SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users WHERE id = {id}";
            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();

            if (await reader.ReadAsync())
            {
                return Ok(MapUser(reader));
            }
            return NotFound(new { message = "User not found" });
        }
        catch (Exception ex)
        {
            // 脆弱性 A-04: 詳細エラー情報の露出
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// ユーザー新規作成
    /// 脆弱性 A-06: Mass Assignment — roleが直接バインドされる
    /// 脆弱性 A-03: パスワード平文保存
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] User user)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            // 脆弱性 A-01: SQLインジェクション
            var sql = $@"INSERT INTO users (username, email, password, role, profile_image_url)
                         VALUES ('{user.Username}', '{user.Email}', '{user.Password}', '{user.Role}', '{user.ProfileImageUrl}')
                         RETURNING id, username, email, password, role, profile_image_url, created_at, updated_at";

            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();

            if (await reader.ReadAsync())
            {
                return CreatedAtAction(nameof(GetById), new { id = reader.GetInt32(0) }, MapUser(reader));
            }
            return BadRequest(new { message = "Failed to create user" });
        }
        catch (Exception ex)
        {
            // 脆弱性 A-04: 詳細エラー情報の露出
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// ユーザー更新
    /// </summary>
    [HttpPut("{id}")]
    public async Task<IActionResult> Update(int id, [FromBody] User user)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            // 脆弱性 A-01: SQLインジェクション
            var sql = $@"UPDATE users SET
                            username = '{user.Username}',
                            email = '{user.Email}',
                            password = '{user.Password}',
                            role = '{user.Role}',
                            profile_image_url = '{user.ProfileImageUrl}',
                            updated_at = NOW()
                         WHERE id = {id}
                         RETURNING id, username, email, password, role, profile_image_url, created_at, updated_at";

            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();

            if (await reader.ReadAsync())
            {
                return Ok(MapUser(reader));
            }
            return NotFound(new { message = "User not found" });
        }
        catch (Exception ex)
        {
            // 脆弱性 A-04: 詳細エラー情報の露出
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// ユーザー削除
    /// 脆弱性 A-02: 認証バイパス — 認証チェックなし
    /// </summary>
    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(int id)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            var sql = $"DELETE FROM users WHERE id = {id}";
            await using var cmd = new NpgsqlCommand(sql, conn);
            var affected = await cmd.ExecuteNonQueryAsync();

            if (affected > 0)
            {
                return Ok(new { message = "User deleted" });
            }
            return NotFound(new { message = "User not found" });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }

    /// <summary>
    /// DataReaderからUserオブジェクトをマッピングする
    /// </summary>
    private static User MapUser(NpgsqlDataReader reader)
    {
        return new User
        {
            Id = reader.GetInt32(0),
            Username = reader.GetString(1),
            Email = reader.GetString(2),
            Password = reader.GetString(3),
            Role = reader.GetString(4),
            ProfileImageUrl = reader.IsDBNull(5) ? string.Empty : reader.GetString(5),
            CreatedAt = reader.GetDateTime(6),
            UpdatedAt = reader.GetDateTime(7)
        };
    }
}
