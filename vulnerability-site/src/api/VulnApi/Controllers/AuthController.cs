using Microsoft.AspNetCore.Mvc;
using Npgsql;
using VulnApi.Models;
using VulnApi.Services;

namespace VulnApi.Controllers;

/// <summary>
/// 認証API コントローラー
/// 脆弱性 A-09: レート制限の欠如
/// </summary>
[ApiController]
[Route("api")]
public class AuthController : ControllerBase
{
    private readonly DbConnectionFactory _dbFactory;
    private readonly ILogger<AuthController> _logger;

    public AuthController(DbConnectionFactory dbFactory, ILogger<AuthController> logger)
    {
        _dbFactory = dbFactory;
        _logger = logger;
    }

    /// <summary>
    /// ログイン
    /// 脆弱性 A-01: SQLインジェクション
    /// 脆弱性 A-03: パスワード平文比較
    /// 脆弱性 A-09: レート制限なし
    /// </summary>
    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequest request)
    {
        try
        {
            await using var conn = _dbFactory.CreateConnection();
            await conn.OpenAsync();

            // 脆弱性 A-01: SQLインジェクション
            var sql = $"SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();

            if (await reader.ReadAsync())
            {
                var user = new User
                {
                    Id = reader.GetInt32(0),
                    Username = reader.GetString(1),
                    Email = reader.GetString(2),
                    Password = reader.GetString(3),
                    Role = reader.GetString(4),
                    ProfileImageUrl = reader.IsDBNull(5) ? string.Empty : reader.GetString(5),
                    CreatedAt = reader.GetDateTime(6),
                    UpdatedAt = reader.GetDateTime(7)
                };

                // 脆弱性 A-08: HTTPヘッダインジェクション
                Response.Headers.Append("X-User-Role", user.Role);
                Response.Headers.Append("X-Username", user.Username);

                return Ok(new LoginResponse { Success = true, Message = "Login successful", User = user });
            }

            return Unauthorized(new LoginResponse { Success = false, Message = "Invalid credentials" });
        }
        catch (Exception ex)
        {
            // 脆弱性 A-04: 詳細エラー情報の露出
            return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
        }
    }
}
