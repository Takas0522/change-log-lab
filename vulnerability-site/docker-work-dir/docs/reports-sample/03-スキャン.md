# スキャンレポート

> **実施日時**: 2026-02-23 12:42 〜 12:46 UTC  
> **実施者**: スキャンエージェント (Discovery Scanning)  
> **前工程レポート**: 
> - `/docker-work-dir/docs/reports/01-情報収集.md`
> - `/docker-work-dir/docs/reports/02-アタックサーフェース定義.md`

---

## 1. スキャン実施サマリー

| # | ツール | 対象 | ステータス | 所要時間 | 検出数 |
|---|--------|------|-----------|---------|--------|
| 1 | **Nmap** | 全サービス (frontend, api, db) | ✅ 成功 | 84秒 | 1件（脆弱性） |
| 2 | **Trivy** | ファイルシステム (/workdir) | ✅ 成功 | 60秒 | 4件 (HIGH: 3, CRITICAL: 1) |
| 3 | **Nikto** | Frontend (http://frontend:80) | ✅ 成功 | 1秒 | 5件（セキュリティヘッダ欠如） |
| 4 | **Nikto** | API (http://api:5000) | ✅ 成功 | 1秒 | 5件（セキュリティヘッダ欠如） |
| 5 | **ZAP Baseline** | Frontend (http://frontend:80) | ✅ 成功 | 47秒 | 10件 (Medium: 2, Low: 5, Info: 3) |
| 6 | **ZAP API Scan** | API OpenAPI (http://api:5000/openapi/v1.json) | ⚠️ 部分的失敗 | 10秒 | スキャン起動失敗 |

**合計実施時間**: 約4分  
**合計検出数**: 26件（ZAP API除く）

**注意事項**:
- OWASP ZAP API Scanは、アクティブスキャンの起動に失敗しました（OpenAPI定義は正常にインポート済み、12 URLを確認）
- この工程はパッシブスキャン（Discovery）のため、攻撃的な検証は工程6（検証フェーズ）で実施予定です

---

## 2. Nmap スキャン結果

### 2.1 検出ポート・サービス

#### Frontend (172.26.0.4)
| ポート | 状態 | サービス | バージョン |
|--------|------|---------|-----------|
| 80/tcp | Open | http | **nginx 1.29.5** |
| 5000/tcp | Closed | - | - |
| 5432/tcp | Closed | - | - |

**HTTPレスポンスヘッダ**:
```
Server: nginx/1.29.5
```

#### API (172.26.0.3)
| ポート | 状態 | サービス | バージョン |
|--------|------|---------|-----------|
| 80/tcp | Closed | - | - |
| 5000/tcp | Open | upnp? | **Kestrel (ASP.NET Core)** |
| 5432/tcp | Closed | - | - |

**HTTPレスポンスヘッダ**:
```
Server: Kestrel
```

**フィンガープリント検出**:
- `HTTP/1.1 404 Not Found` (GET /)
- `HTTP/1.1 400 Bad Request` (不正リクエスト)
- `HTTP/1.1 505 HTTP Version Not Supported` (RTSP)

#### Database (172.26.0.2)
| ポート | 状態 | サービス | バージョン |
|--------|------|---------|-----------|
| 80/tcp | Closed | - | - |
| 5000/tcp | Closed | - | - |
| 5432/tcp | Open | postgresql | **PostgreSQL DB 9.6.0 or later** |

**フィンガープリント検出**:
```
SFATAL VFATAL C0A000
Munsupported frontend protocol 65363.19778: server supports 3.0 to 3.0
```

### 2.2 脆弱性スクリプト結果

#### 🔴 CVE-2011-3192: Apache byterange filter DoS (Frontend)
**状態**: VULNERABLE  
**影響**: nginx 1.29.5 にて検出

```
VULNERABLE:
Apache byterange filter DoS
  State: VULNERABLE
  IDs:  CVE:CVE-2011-3192  BID:49303
  
The Apache web server is vulnerable to a denial of service attack when numerous
overlapping byte ranges are requested.

Disclosure date: 2011-08-19
References:
  https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-3192
  https://www.securityfocus.com/bid/49303
```

**注意**: このCVEはApache専用の脆弱性ですが、Nmapスクリプトが誤検出した可能性があります（nginx環境）。

#### その他のスクリプト実行結果
- ❌ XSS (DOM-based): 検出なし
- ❌ XSS (Stored): 検出なし
- ❌ CSRF: 検出なし
- ⚠️ `http-vuln-cve2017-1001000`: スクリプト実行エラー
- ⚠️ `http-majordomo2-dir-traversal`: スクリプト実行エラー

---

## 3. Trivy スキャン結果

### 3.1 脆弱性一覧（HIGH/CRITICAL）

#### 🔴 CRITICAL: GitHub Personal Access Token 露出

**ファイル**: `.env`  
**種類**: Secret (github-fine-grained-pat)  
**リスク**: CRITICAL

```
15 [ GH_TOKEN=*********************************************************************************************
```

**影響**: 
- GitHub リポジトリへの不正アクセス
- Copilot API の悪用
- リポジトリの改ざん・削除

**推奨対策**:
- トークンを即座に無効化
- 環境変数またはシークレット管理ツール（Vault等）を使用
- `.env` ファイルを `.gitignore` に追加

---

#### 🟠 HIGH: Dockerfile - root ユーザーでコンテナ実行

**検出数**: 3件  
**対象Dockerfile**:
1. `docker-work-dir/scanner/Dockerfile`
2. `src/api/Dockerfile`
3. `src/frontend/Dockerfile`

**脆弱性ID**: AVD-DS-0002

```
Specify at least 1 USER command in Dockerfile with non-root user as argument
```

**影響**:
- コンテナエスケープ発生時の影響範囲が拡大
- ホストシステムへの攻撃リスク増大

**推奨対策**:
```dockerfile
# Dockerfileに追加
RUN addgroup -g 1001 appuser && \
    adduser -D -u 1001 -G appuser appuser
USER appuser
```

**参照**: https://avd.aquasec.com/misconfig/ds002

---

### 3.2 シークレット検出

| ファイル | 種類 | リスクレベル | 詳細 |
|---------|------|-------------|------|
| `.env` | GitHub Fine-grained PAT | CRITICAL | GitHubトークンが平文で保存 |

**その他の機密情報** (ソースコード分析から):
- `docker-compose.yml`: PostgreSQLパスワード `postgres123`
- `src/frontend/src/config.ts`: `INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345'`
- `src/frontend/src/config.ts`: `ADMIN_PANEL_URL = 'http://internal-admin.local:8080'`

---

### 3.3 設定ミス（Misconfiguration）

| 項目 | リスク | 対象ファイル |
|------|--------|-------------|
| **Root ユーザー実行** | HIGH | 全Dockerfile (3ファイル) |
| **認証情報ハードコード** | CRITICAL | docker-compose.yml, .env |
| **セキュリティヘッダ欠如** | MEDIUM | nginx.conf |

---

## 4. Nikto スキャン結果

### 4.1 Frontend スキャン結果 (http://frontend:80)

**サーバー情報**: nginx/1.29.5  
**スキャン時間**: 1秒  
**総リクエスト数**: 397件  
**検出項目**: 5件

| ID | 種類 | 詳細 | 参照 |
|----|------|------|------|
| 013587 | セキュリティヘッダ欠如 | **X-Content-Type-Options** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options) |
| 013587 | セキュリティヘッダ欠如 | **Referrer-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) |
| 013587 | セキュリティヘッダ欠如 | **Strict-Transport-Security** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) |
| 013587 | セキュリティヘッダ欠如 | **Content-Security-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) |
| 013587 | セキュリティヘッダ欠如 | **Permissions-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy) |

**影響**:
- XSS攻撃リスク増大（CSP未設定）
- クリックジャッキング可能性（X-Frame-Options未設定）
- MIMEタイプスニッフィング脆弱性（X-Content-Type-Options未設定）
- HTTPS強制なし（HSTS未設定）

---

### 4.2 API スキャン結果 (http://api:5000)

**サーバー情報**: Kestrel  
**スキャン時間**: 0秒  
**総リクエスト数**: 391件  
**検出項目**: 5件

| ID | 種類 | 詳細 | 参照 |
|----|------|------|------|
| 013587 | セキュリティヘッダ欠如 | **Strict-Transport-Security** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) |
| 013587 | セキュリティヘッダ欠如 | **X-Content-Type-Options** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options) |
| 013587 | セキュリティヘッダ欠如 | **Content-Security-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) |
| 013587 | セキュリティヘッダ欠可 | **Referrer-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) |
| 013587 | セキュリティヘッダ欠如 | **Permissions-Policy** | [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy) |

**影響**: Frontend と同様

---

## 5. OWASP ZAP スキャン結果

### 5.1 ベースラインスキャン (Frontend)

**対象URL**: http://frontend:80  
**スキャン時間**: 47秒  
**総URL数**: 8件  
**ZAPバージョン**: 2.16.1  
**生成日時**: 2026-02-23 12:45:35 UTC

#### アラート総数: 10件

| リスクレベル | 件数 |
|------------|------|
| Medium | 2 |
| Low | 5 |
| Informational | 3 |

#### 詳細アラート一覧

##### 🟡 Medium リスク (2件)

###### 1. Content Security Policy (CSP) Header Not Set
**Plugin ID**: 10038  
**信頼度**: High  
**影響URL**: 5件
- `http://frontend:80/`
- `http://frontend:80`
- `http://frontend/robots.txt`
- `http://frontend/sitemap.xml`
- その他

**説明**:  
Content Security Policy (CSP) はXSSやデータインジェクション攻撃を検出・軽減するためのセキュリティ層です。JavaScriptやCSS、iframe等の承認されたソースを宣言できます。

**推奨対策**:
```nginx
# nginx.confに追加
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
```

**CWE**: 693  
**WASC**: 15

---

###### 2. Missing Anti-clickjacking Header
**Plugin ID**: 10020  
**信頼度**: Medium  
**影響URL**: 5件

**説明**:  
ClickJacking攻撃を防ぐための `X-Frame-Options` ヘッダまたはCSPの `frame-ancestors` ディレクティブが設定されていません。

**推奨対策**:
```nginx
# nginx.confに追加
add_header X-Frame-Options "DENY" always;
# または
add_header Content-Security-Policy "frame-ancestors 'none';" always;
```

**CWE**: 1021  
**WASC**: 15

---

##### 🟢 Low リスク (5件)

###### 3. Insufficient Site Isolation Against Spectre Vulnerability
**Plugin ID**: 90004  
**信頼度**: Medium  
**影響URL**: 6件

**説明**:  
`Cross-Origin-Resource-Policy` ヘッダが設定されていないため、Spectreのようなサイドチャネル攻撃に対する防御が不十分です。

**推奨対策**:
```nginx
add_header Cross-Origin-Resource-Policy "same-origin" always;
```

---

###### 4. Permissions Policy Header Not Set
**Plugin ID**: 10063  
**信頼度**: Medium  
**影響URL**: 5件

**説明**:  
ブラウザAPIの利用制限を設定する `Permissions-Policy` ヘッダが設定されていません。

**推奨対策**:
```nginx
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
```

---

###### 5. Server Leaks Version Information via "Server" HTTP Response Header
**Plugin ID**: 10036  
**信頼度**: High  
**影響URL**: 5件

**証拠**: `Server: nginx/1.29.5`

**説明**:  
サーバーバージョン情報が公開されており、攻撃者がバージョン固有の脆弱性を標的にできます。

**推奨対策**:
```nginx
# nginx.confに追加
server_tokens off;
```

---

###### 6. X-Content-Type-Options Header Missing
**Plugin ID**: 10021  
**信頼度**: High  
**影響URL**: 5件

**説明**:  
MIMEタイプスニッフィングを防ぐ `X-Content-Type-Options: nosniff` ヘッダが設定されていません。

**推奨対策**:
```nginx
add_header X-Content-Type-Options "nosniff" always;
```

---

##### ℹ️ Informational (3件)

###### 7. ZAP is Out of Date
**Plugin ID**: 10116  
**説明**: ZAPのバージョンが最新ではありません（スキャナー環境の問題、アプリケーションには無関係）

###### 8. その他Informationalアラート
- Modern Web Application検出
- Retrieved from Cache

---

### 5.2 APIスキャン (OpenAPI)

**対象URL**: http://api:5000/openapi/v1.json  
**ステータス**: ⚠️ **スキャン起動失敗**

**エラーメッセージ**:
```
zap_common.ScanNotStartedException: Failed to start the scan, check the log/output for more details.
```

**インポート状況**:
- ✅ OpenAPI定義のインポート: 成功
- ✅ 検出URL数: **12件**
- ❌ アクティブスキャン起動: 失敗

**推定原因**:
- ZAPのアクティブスキャン設定の問題
- API認証要件との不一致
- タイムアウト

**後続対応**:
- 工程6（検証フェーズ）でOWASP ZAP Proxyを使用した手動検証を実施予定
- SQLインジェクション、認証バイパス等はsqlmap/Burp Suite等で代替検証

---

## 6. 総合検出サマリー

### 6.1 リスクレベル別集計

| リスクレベル | 検出数 | 主な項目 |
|------------|--------|---------|
| **CRITICAL** | 1 | GitHubトークン露出 (.env) |
| **HIGH** | 3 | Dockerfile root実行 (3件) |
| **MEDIUM** | 12 | CSP未設定 (2件)、Anti-Clickjacking未設定 (2件)、セキュリティヘッダ欠如 (8件) |
| **LOW** | 5 | Spectreサイト分離不足、Permissions Policy未設定、サーバーバージョン露出 |
| **INFORMATIONAL** | 4 | ZAPバージョン、キャッシュ検出、その他 |
| **誤検出の可能性** | 1 | CVE-2011-3192 (Apache専用、nginxで検出) |

**合計**: 26件（誤検出含む）

---

### 6.2 カテゴリ別サマリー

#### セキュリティヘッダ欠如 (20件)
| ヘッダ名 | Frontend | API | 影響 |
|---------|---------|-----|------|
| **Content-Security-Policy** | ❌ | ❌ | XSS攻撃リスク増大 |
| **X-Frame-Options** | ❌ | ❌ | クリックジャッキング可能 |
| **Strict-Transport-Security** | ❌ | ❌ | HTTPS強制なし |
| **X-Content-Type-Options** | ❌ | ❌ | MIMEスニッフィング脆弱性 |
| **Referrer-Policy** | ❌ | ❌ | 情報漏洩リスク |
| **Permissions-Policy** | ❌ | ❌ | ブラウザAPI制限なし |
| **Cross-Origin-Resource-Policy** | ❌ | - | Spectre脆弱性 |

#### 情報漏洩 (4件)
- サーバーバージョン露出: `nginx/1.29.5`, `Kestrel`
- GitHubトークン露出: `.env`
- データベースバージョン: `PostgreSQL 9.6.0 or later`

#### インフラストラクチャ脆弱性 (3件)
- root ユーザーでコンテナ実行 (全Dockerfile)

---

### 6.3 OWASP Top 10 (2021) マッピング

前工程の情報収集結果とスキャン結果を統合:

| OWASP Top 10 | 関連検出項目 | ステータス |
|-------------|-------------|----------|
| **A01:2021 – Broken Access Control** | 認証チェック欠如（前工程で確認） | 🔍 要検証 |
| **A02:2021 – Cryptographic Failures** | HSTS未設定、SSL/TLS未使用 | ✅ 検出 |
| **A03:2021 – Injection** | SQLインジェクション（前工程で確認） | 🔍 要検証 |
| **A04:2021 – Insecure Design** | CORS設定不備（前工程で確認） | 🔍 要検証 |
| **A05:2021 – Security Misconfiguration** | セキュリティヘッダ欠如、root実行 | ✅ 検出 |
| **A06:2021 – Vulnerable Components** | - | ⚠️ 未検出 |
| **A07:2021 – Identification and Authentication Failures** | レート制限なし（前工程で確認） | 🔍 要検証 |
| **A08:2021 – Software and Data Integrity Failures** | 安全でないデシリアライズ（前工程で確認） | 🔍 要検証 |
| **A09:2021 – Security Logging and Monitoring Failures** | - | 🔍 要検証 |
| **A10:2021 – Server-Side Request Forgery (SSRF)** | - | 🔍 要検証 |

**🔍 要検証**: 工程6（検証フェーズ）でPoCを実施予定

---

## 7. スキャン生データの格納先

### 7.1 レポートファイル一覧

| ツール | ファイル名 | フォーマット | サイズ | パス |
|--------|-----------|------------|--------|------|
| Nmap | nmap-report.txt | Text | 5.9 KB | `/reports/nmap/nmap-report.txt` |
| Nmap | nmap-report.xml | XML | 11 KB | `/reports/nmap/nmap-report.xml` |
| Trivy | trivy-fs-report.txt | Table | 5.5 KB | `/reports/trivy/trivy-fs-report.txt` |
| Nikto | nikto-frontend-report.html | HTML | - | `/reports/nikto/nikto-frontend-report.html` |
| Nikto | nikto-api-report.html | HTML | - | `/reports/nikto/nikto-api-report.html` |
| ZAP | zap-baseline-report.json | JSON | 32 KB | `/reports/zap/zap-baseline-report.json` |
| ZAP | zap-baseline-report.html | HTML | 87 KB | `/reports/zap/zap-baseline-report.html` |
| ZAP API | zap-api-report.json | - | - | （生成失敗） |
| ZAP API | zap-api-report.html | - | - | （生成失敗） |

### 7.2 ディレクトリ構造

```
/reports/
├── nmap/
│   ├── nmap-report.txt
│   └── nmap-report.xml
├── trivy/
│   └── trivy-fs-report.txt
├── nikto/
│   ├── nikto-frontend-report.html
│   └── nikto-api-report.html
└── zap/
    ├── zap-baseline-report.json
    └── zap-baseline-report.html
```

**アクセス方法**:
```bash
# Dockerホストから参照
ls -lh /workdir/reports/

# 個別確認
cat /reports/nmap/nmap-report.txt
cat /reports/trivy/trivy-fs-report.txt
jq . /reports/zap/zap-baseline-report.json
```

---

## 8. 次工程への引き継ぎ事項

### 8.1 工程4（列挙フェーズ）への情報提供

以下のスキャン生データを詳細分析に使用してください:

1. **Nmapスキャン結果** (`/reports/nmap/nmap-report.xml`)
   - サービスバージョン情報
   - フィンガープリントデータ

2. **Trivyスキャン結果** (`/reports/trivy/trivy-fs-report.txt`)
   - 秘匿情報検出
   - 設定ミス一覧

3. **ZAPスキャン結果** (`/reports/zap/zap-baseline-report.json`)
   - 全アラート詳細
   - リスク評価根拠

### 8.2 工程5（検証項目決定）への推奨事項

#### 優先度: CRITICAL
- [ ] GitHubトークンの悪用可能性検証
- [ ] SQLインジェクション（前工程で発見済み）

#### 優先度: HIGH
- [ ] 認証バイパス検証
- [ ] Mass Assignment脆弱性
- [ ] 安全でないデシリアライズ（RCE可能性）
- [ ] ディレクトリトラバーサル

#### 優先度: MEDIUM
- [ ] XSS攻撃（CSP未設定のため）
- [ ] CSRF攻撃（CORS設定不備）
- [ ] オープンリダイレクト
- [ ] セッション管理の脆弱性

#### 優先度: LOW
- [ ] 情報漏洩（サーバーバージョン露出）
- [ ] クリックジャッキング

### 8.3 工程6（検証フェーズ）への注意事項

**スキャンの再実行は不要です**。本工程で取得したスキャン結果を前提として、以下の検証のみを実施してください:

1. **手動検証が必要な項目**:
   - SQLインジェクション（sqlmap等）
   - 認証バイパス（Burp Suite）
   - ディレクトリトラバーサル（curl）
   - XSS（手動ペイロード）

2. **PoCが必要な項目**:
   - Mass Assignment（`role: "admin"`送信）
   - 安全でないデシリアライズ（RCEペイロード）

3. **再スキャン禁止**:
   - Nmap, Trivy, Nikto, ZAP Baselineは**再実行しない**
   - `/reports/` の既存データを参照

---

## 9. 制約事項と既知の問題

### 9.1 スキャン範囲の制約

- **対象**: ローカルDockerネットワーク内のみ（frontend, api, db）
- **非対象**: 外部ネットワーク、インターネット上のホスト
- **実行環境**: scannerコンテナ内（ツール統合環境）

### 9.2 既知の問題

1. **OWASP ZAP API Scanの失敗**
   - OpenAPI定義は正常にインポート（12 URLs）
   - アクティブスキャンの起動に失敗
   - 原因: 設定の問題またはタイムアウト
   - 対策: 工程6でZAP Proxyを使用した手動スキャン

2. **Nmap脆弱性スクリプトの誤検出**
   - CVE-2011-3192（Apache専用）がnginxで検出
   - 原因: スクリプトのヒューリスティック検出
   - 対策: 手動で誤検出を除外

3. **Trivyの一部エラー**
   - Regoポリシーの解析エラー（AWS EC2関連）
   - 影響: スキャン結果には影響なし

---

## 10. 結論

本スキャンフェーズでは、5種類の自動化ツール（Nmap, Trivy, Nikto, ZAP）を使用して、対象アプリケーションの**広範な脆弱性候補を発見**しました。

### 主要な発見事項

1. **秘匿情報の露出**: GitHub Personal Access Tokenが平文で`.env`に保存（CRITICAL）
2. **セキュリティヘッダの欠如**: 全てのWebサーバーで主要なセキュリティヘッダが未設定（20件）
3. **インフラストラクチャ設定不備**: 全コンテナがrootユーザーで実行（3件）
4. **情報漏洩**: サーバーバージョン情報の露出（nginx, Kestrel, PostgreSQL）

### 次のステップ

- **工程4（列挙）**: スキャン結果の詳細分類・優先度付け
- **工程5（検証項目決定）**: リスクベースの検証項目選定
- **工程6（検証）**: 攻撃的な手法によるPoC実施（SQLインジェクション、認証バイパス等）
- **工程7（リスク評価）**: 総合的なリスク評価とCVSS算出

本レポートで生成されたスキャンデータは `/reports/` ディレクトリに永続化されており、後続の全フェーズで共有・参照されます。

---

**レポート作成者**: スキャンエージェント (Discovery Scanning)  
**レポート形式**: CEHスキャンフェーズに基づく  
**対象環境**: ローカルネットワーク内のDocker Compose環境のみ  
**スキャン実行日時**: 2026-02-23 12:42 〜 12:46 UTC  
**総検出数**: 26件（ZAP API除く）
