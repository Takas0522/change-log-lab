# 情報収集レポート

> **実施日時**: 2026-02-08 09:01:44 UTC  
> **診断フェーズ**: 01-Reconnaissance（情報収集）  
> **対象**: ローカルネットワーク内のDocker Compose環境

---

## 1. 対象アプリケーション概要

### 1.1 アプリケーション概要

**名称**: vulnerability-site  
**目的**: 意図的に脆弱性を埋め込んだWeb アプリケーション（学習・検証用環境）  
**機能**: ユーザー管理（CRUD操作、検索、ログイン）

### 1.2 サービス構成

| サービス名 | 役割 | ポートマッピング | 依存関係 |
|----------|------|-----------------|---------|
| **db** | PostgreSQL データベース | `15432:5432` | なし |
| **api** | ASP.NET Core Web API | `5000:5000` | db（healthy待機） |
| **frontend** | React フロントエンド（Nginx配信） | `3000:80` | api |
| **scanner** | 脆弱性スキャナー統合コンテナ | なし（profile: scan） | frontend, api（healthy待機） |

#### サービス間通信

```
Frontend (http://frontend:80)
    ↓ Nginx Proxy
API (http://api:5000)
    ↓ Npgsql
Database (db:5432)
```

### 1.3 技術スタック

| コンポーネント | 技術 | バージョン | 詳細 |
|--------------|------|-----------|------|
| **Frontend** | React | 19.2.0 | Vite + TypeScript + React Router DOM 7.13.0 |
| **Frontend Web Server** | Nginx | alpine | 静的ファイル配信 + `/api/` のリバースプロキシ |
| **Backend** | ASP.NET Core | .NET 10.0-preview | RESTful API + OpenAPI (Swagger) |
| **Database** | PostgreSQL | 16-alpine | Npgsql 9.0.3 でアクセス |
| **コンテナ** | Docker Compose | - | ヘルスチェック機能付き |
| **その他パッケージ** | Newtonsoft.Json | 13.0.3 | JSON デシリアライズ |

#### フロントエンド主要依存関係

```json
{
  "react": "^19.2.0",
  "react-dom": "^19.2.0",
  "react-router-dom": "^7.13.0",
  "vite": "^7.2.4",
  "typescript": "~5.9.3"
}
```

#### バックエンド依存関係

```xml
<PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="10.0.0-preview.7.25380.108" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="Npgsql" Version="9.0.3" />
```

### 1.4 ネットワーク構成

**Docker ネットワーク**: `vulnerability-site_default` (デフォルトブリッジネットワーク)

**内部ホスト名解決**:
- `frontend` → `frontend:80`
- `api` → `api:5000`
- `db` → `db:5432`

**外部公開ポート**:
- `localhost:3000` → frontend:80
- `localhost:5000` → api:5000
- `localhost:15432` → db:5432 ⚠️ **DBポートが外部公開（脆弱性 I-03）**

---

## 2. 公開エンドポイント

### 2.1 Frontend

| 項目 | 値 |
|-----|-----|
| **URL（内部）** | `http://frontend:80` |
| **URL（外部）** | `http://localhost:3000` |
| **配信方法** | Nginx による静的ファイル配信 |
| **リバースプロキシ** | `/api/` → `http://api:5000/api/` |

#### 画面一覧

| 画面名 | パス | 説明 |
|--------|------|------|
| ユーザー一覧 | `/` | ユーザーの一覧表示（検索機能付き） |
| ユーザー詳細 | `/users/:id` | ユーザーの詳細情報表示 |
| ユーザー追加 | `/users/new` | 新規ユーザー登録フォーム |
| ユーザー編集 | `/users/:id/edit` | ユーザー情報編集フォーム |
| ログイン | `/login` | ログイン画面 |

### 2.2 API エンドポイント

| メソッド | パス | 説明 | 脆弱性 |
|----------|------|------|-------|
| **GET** | `/api/users` | ユーザー一覧取得（`?search=` クエリ対応） | A-01: SQLi |
| **GET** | `/api/users/{id}` | ユーザー詳細取得 | A-01: SQLi |
| **POST** | `/api/users` | ユーザー新規作成 | A-01: SQLi, A-03: 平文PW, A-06: Mass Assignment |
| **PUT** | `/api/users/{id}` | ユーザー更新 | A-01: SQLi, A-03: 平文PW, A-06: Mass Assignment |
| **DELETE** | `/api/users/{id}` | ユーザー削除 | A-02: 認証バイパス |
| **POST** | `/api/login` | ログイン | A-01: SQLi, A-03: 平文PW, A-08: Header Injection, A-09: レート制限なし |
| **GET** | `/api/files/{*filePath}` | ファイル取得 | A-07: ディレクトリトラバーサル |
| **POST** | `/api/import` | JSONデシリアライズ | A-10: 安全でないデシリアライズ |
| **GET** | `/openapi/v1.json` | OpenAPI定義 | A-04: 情報露出 |

**API Base URL（内部）**: `http://api:5000`  
**API Base URL（外部）**: `http://localhost:5000`

### 2.3 データベース

| 項目 | 値 |
|-----|-----|
| **DBMS** | PostgreSQL 16-alpine |
| **データベース名** | `vulndb` |
| **ユーザー** | `postgres` |
| **パスワード** | `postgres123` ⚠️ **弱いパスワード（脆弱性 D-01）** |
| **内部ポート** | `db:5432` |
| **外部ポート** | `localhost:15432` ⚠️ **外部公開（脆弱性 I-03）** |
| **SSL接続** | 無効（`SSL Mode=Disable`） ⚠️ **脆弱性 D-03** |

#### データベーススキーマ

**テーブル**: `users`

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 主キー |
| `username` | VARCHAR(100) | NOT NULL | ユーザー名 |
| `email` | VARCHAR(255) | NOT NULL | メールアドレス |
| `password` | VARCHAR(255) | NOT NULL | ⚠️ **パスワード（平文保存・脆弱性 D-04）** |
| `role` | VARCHAR(50) | NOT NULL, DEFAULT 'user' | ロール（admin/user） |
| `profile_image_url` | TEXT | DEFAULT '' | プロフィール画像URL |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | 更新日時 |

#### 初期データ（シードデータ）

```sql
-- 脆弱性 A-03 / D-04: パスワードを平文で格納
INSERT INTO users (username, email, password, role, profile_image_url) VALUES
('admin', 'admin@example.com', 'admin123', 'admin', ''),
('tanaka', 'tanaka@example.com', 'password', 'user', ''),
('suzuki', 'suzuki@example.com', '123456', 'user', ''),
('sato', 'sato@example.com', 'qwerty', 'user', ''),
('yamada', 'yamada@example.com', 'letmein', 'user', '');
```

⚠️ **5ユーザーの弱いパスワードが平文で保存**

---

## 3. HTTPレスポンスヘッダ分析

### 3.1 Frontend（Nginx）想定レスポンスヘッダ

```
Server: nginx
Content-Type: text/html
```

**懸念点**:
- `X-Frame-Options` の欠如 → クリックジャッキング脆弱性の可能性
- `Content-Security-Policy` の欠如 → XSS緩和策なし
- `X-Content-Type-Options: nosniff` の欠如 → MIME sniffing 攻撃の可能性

### 3.2 API（ASP.NET Core）想定レスポンスヘッダ

```
Content-Type: application/json
Server: Kestrel
```

**懸念点**:
- 開発環境（`ASPNETCORE_ENVIRONMENT: Development`）がDocker設定で有効
- スタックトレース露出（脆弱性 A-04）
- CORS: `AllowAnyOrigin()` 設定（脆弱性 A-05）

**特殊なレスポンスヘッダ（ログイン時）**:
```
X-User-Role: {user.Role}
X-Username: {user.Username}
```
⚠️ **HTTPヘッダインジェクション脆弱性（A-08）**

---

## 4. 設定ファイル分析

### 4.1 Docker Compose 設定（`docker-compose.yml`）

#### 環境変数・ハードコードされた秘匿情報

| サービス | 環境変数 | 値 | 脆弱性 |
|---------|---------|-----|-------|
| **db** | `POSTGRES_PASSWORD` | `postgres123` | **I-02, D-01** |
| **api** | `ConnectionStrings__DefaultConnection` | `Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable` | **I-02, D-03** |
| **api** | `ASPNETCORE_ENVIRONMENT` | `Development` | **A-04** |

⚠️ **重大な問題**:
1. **パスワードがdocker-compose.ymlにハードコード** → 環境変数や Secrets 使用を推奨
2. **SSL無効** → 中間者攻撃のリスク
3. **開発モード** → 詳細エラー情報の露出

#### ポートマッピング

```yaml
db:
  ports:
    - "15432:5432"  # ⚠️ DBポートが外部公開（I-03）
api:
  ports:
    - "5000:5000"
frontend:
  ports:
    - "3000:80"
```

#### ボリュームマウント

```yaml
db:
  volumes:
    - pgdata:/var/lib/postgresql/data
    - ./src/db/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    - ./src/db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
```

**初期化スクリプトがマウント** → データベーススキーマとシードデータが自動投入

### 4.2 Dockerfile 分析

#### Frontend Dockerfile

```dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
# 脆弱性 I-01: rootのまま実行
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

⚠️ **脆弱性 I-01**: `USER` ディレクティブがなく、root権限で実行

#### API Dockerfile

```dockerfile
FROM mcr.microsoft.com/dotnet/sdk:10.0-preview AS build
WORKDIR /src
COPY VulnApi/VulnApi.csproj ./VulnApi/
RUN dotnet restore ./VulnApi/VulnApi.csproj
COPY VulnApi/ ./VulnApi/
RUN dotnet publish ./VulnApi/VulnApi.csproj -c Release -o /app/publish

FROM mcr.microsoft.com/dotnet/aspnet:10.0-preview
# 脆弱性 I-01: rootのまま実行（USERディレクティブなし）
WORKDIR /app
COPY --from=build /app/publish .
RUN mkdir -p /app/uploads
ENV ASPNETCORE_URLS=http://+:5000
ENV ASPNETCORE_ENVIRONMENT=Development
EXPOSE 5000
ENTRYPOINT ["dotnet", "VulnApi.dll"]
```

⚠️ **脆弱性 I-01**: `USER` ディレクティブがなく、root権限で実行

### 4.3 アプリケーション設定（`Program.cs`）

#### CORS設定

```csharp
// 脆弱性 A-05: CORS設定の不備 — 全オリジン許可
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});
```

⚠️ **全オリジンからのアクセスを許可** → CSRF攻撃のリスク増大

#### 開発者例外ページ

```csharp
if (app.Environment.IsDevelopment())
{
    app.MapOpenApi();
    // 脆弱性 A-04: 開発者ページを制限なしで有効化
    app.UseDeveloperExceptionPage();
}
```

⚠️ **Development環境でスタックトレース露出**

---

## 5. ソースコード概観

### 5.1 ディレクトリ構造

```
/workdir/
├── docker-compose.yml
├── src/
│   ├── api/
│   │   ├── Dockerfile
│   │   └── VulnApi/
│   │       ├── Controllers/
│   │       │   ├── UsersController.cs
│   │       │   ├── AuthController.cs
│   │       │   └── FileController.cs
│   │       ├── Models/
│   │       │   ├── User.cs
│   │       │   └── LoginModels.cs
│   │       ├── Services/
│   │       │   └── DbConnectionFactory.cs
│   │       ├── Program.cs
│   │       └── VulnApi.csproj
│   ├── frontend/
│   │   ├── Dockerfile
│   │   ├── nginx.conf
│   │   ├── package.json
│   │   └── src/
│   │       ├── App.tsx
│   │       ├── api.ts
│   │       ├── config.ts
│   │       ├── types.ts
│   │       └── pages/
│   │           ├── UserList.tsx
│   │           ├── UserDetail.tsx
│   │           ├── UserEdit.tsx
│   │           ├── UserCreate.tsx
│   │           └── Login.tsx
│   ├── db/
│   │   ├── init.sql
│   │   └── seed.sql
│   └── scanner/
│       ├── Dockerfile
│       └── scanner-entrypoint.sh
├── docs/
│   ├── specification.md
│   ├── vulnerabilities.md
│   └── scanning-guide.md
└── reports/
    ├── zap/
    ├── nikto/
    ├── nmap/
    ├── sqlmap/
    └── trivy/
```

### 5.2 主要ファイル

#### Backend（API）

| ファイル | 役割 | 脆弱性 |
|---------|------|-------|
| `UsersController.cs` | ユーザーCRUD API | A-01（SQLi）, A-03（平文PW）, A-04（エラー露出）, A-06（Mass Assignment） |
| `AuthController.cs` | ログイン API | A-01（SQLi）, A-03（平文PW）, A-08（Header Injection）, A-09（レート制限なし） |
| `FileController.cs` | ファイル操作・デシリアライズ API | A-07（ディレクトリトラバーサル）, A-10（安全でないデシリアライズ） |
| `DbConnectionFactory.cs` | DB接続管理 | - |
| `Program.cs` | アプリケーション設定 | A-04（開発者ページ）, A-05（CORS設定不備） |

#### Frontend

| ファイル | 役割 | 脆弱性 |
|---------|------|-------|
| `config.ts` | 設定ファイル | F-02（APIキーハードコード）, F-05（debugLog関数） |
| `api.ts` | API通信ロジック | F-04（CSRF対策なし）, F-05（機密情報ログ出力） |
| `UserList.tsx` | ユーザー一覧画面 | F-03（オープンリダイレクト） |
| `UserDetail.tsx` | ユーザー詳細画面 | F-01（XSS - dangerouslySetInnerHTML） |

### 5.3 依存パッケージ分析

#### バックエンド（.NET）

- **Npgsql 9.0.3**: PostgreSQL接続ドライバ（最新版）
- **Newtonsoft.Json 13.0.3**: JSON デシリアライズ
  - ⚠️ **`TypeNameHandling.All` 設定による脆弱性（A-10）**

#### フロントエンド（npm）

- **React 19.2.0**: 最新版
- **React Router DOM 7.13.0**: ルーティング
- **Vite 7.2.4**: ビルドツール

---

## 6. 初期観察事項

### 6.1 重大な脆弱性（Critical）

1. **SQLインジェクション（A-01）**
   - 全APIエンドポイントで文字列連結によるSQL構築
   - パラメータ化クエリ未使用
   - 特に `/api/users?search=` と `/api/login` が高リスク

2. **認証・認可の欠如（A-02）**
   - 全エンドポイントが認証なしでアクセス可能
   - 削除APIに認可チェックなし

3. **パスワード平文保存（A-03, D-04）**
   - データベースに平文でパスワード格納
   - ハッシュ化処理なし

4. **データベースポート外部公開（I-03）**
   - `15432:5432` で外部からPostgreSQL直接アクセス可能

### 6.2 高リスク脆弱性（High）

1. **XSS（F-01）**
   - `dangerouslySetInnerHTML` でユーザー入力を未サニタイズ表示

2. **安全でないデシリアライズ（A-10）**
   - `TypeNameHandling.All` によるRCEリスク

3. **ディレクトリトラバーサル（A-07）**
   - ファイルパスのバリデーション不足

4. **ハードコードされた秘匿情報（I-02, F-02）**
   - docker-compose.yml: DB接続文字列にパスワード直書き
   - config.ts: APIキー・内部URLをハードコード

5. **CORS設定の不備（A-05）**
   - `AllowAnyOrigin()` で全オリジン許可

### 6.3 中リスク脆弱性（Medium）

1. **詳細エラー情報の露出（A-04）**
   - スタックトレースがAPIレスポンスに含まれる

2. **HTTPヘッダインジェクション（A-08）**
   - ログイン時にユーザー入力をヘッダに直接出力

3. **レート制限の欠如（A-09）**
   - ブルートフォース攻撃に対する防御なし

4. **Mass Assignment（A-06）**
   - リクエストボディから直接 `role` をバインド

5. **オープンリダイレクト（F-03）**
   - `?redirect=` パラメータのバリデーション不足

6. **CSRF対策の欠如（F-04）**
   - CSRFトークンなし

7. **コンソールログへの機密情報出力（F-05）**
   - パスワード等をconsole.logで出力

8. **SSL/TLS未使用（D-03）**
   - データベース接続が平文通信

9. **root権限での実行（I-01）**
   - 全コンテナがroot権限で実行

### 6.4 情報露出

1. **OpenAPI定義の公開**
   - `/openapi/v1.json` でAPI構造が公開
   - 攻撃対象の特定が容易

2. **開発モードでの運用**
   - `ASPNETCORE_ENVIRONMENT: Development`
   - 詳細エラー情報、OpenAPI UI が有効

3. **弱いパスワード（D-01）**
   - `postgres123`, `admin123`, `password`, `123456`, `qwerty`, `letmein`

---

## 7. 次のステップへの推奨事項

### 7.1 アタックサーフェース定義（フェーズ02）

以下の攻撃対象を優先的に定義：

1. **SQLインジェクション攻撃面**
   - `/api/users?search=` パラメータ
   - `/api/login` の `username`, `password` パラメータ

2. **認証バイパス攻撃面**
   - 全APIエンドポイント（認証チェックなし）

3. **XSS攻撃面**
   - `profile_image_url` フィールド（dangerouslySetInnerHTML）

4. **データベース直接アクセス**
   - `localhost:15432` への外部接続

### 7.2 スキャン実施（フェーズ03）

優先スキャンツール：
1. **sqlmap** → SQLインジェクション検証
2. **OWASP ZAP** → Webアプリケーション総合スキャン
3. **Nmap** → ポートスキャン（DBポート15432の確認）
4. **Nikto** → Webサーバー設定検査

---

## 付録: 収集データサマリ

| 項目 | 件数/値 |
|-----|--------|
| **サービス数** | 4（db, api, frontend, scanner） |
| **APIエンドポイント数** | 8 |
| **データベーステーブル数** | 1（users） |
| **初期ユーザー数** | 5 |
| **既知脆弱性（意図的）** | 24件（F:5, A:10, D:4, I:3） |
| **外部公開ポート数** | 3（3000, 5000, 15432） |
| **技術スタック数** | 5（React, Nginx, ASP.NET Core, PostgreSQL, Docker） |

---

**次フェーズ**: `02-attack-surface.agent.md`（アタックサーフェース定義）へ進む
