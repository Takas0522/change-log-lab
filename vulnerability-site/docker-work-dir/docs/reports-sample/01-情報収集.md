# 情報収集レポート

> **実施日時**: 2026-02-23 12:30:40  
> **対象環境**: ローカルDockerネットワーク内のアプリケーション  
> **手法**: パッシブ情報収集（コード分析、設定ファイル分析、サービス応答確認）

---

## 1. 対象アプリケーション概要

### 1.1 サービス構成

Docker Composeによる3層構成のWebアプリケーション：

| サービス名 | 役割 | コンテナイメージ | 公開ポート（ホスト:コンテナ） | 内部IP |
|-----------|------|----------------|---------------------------|---------|
| **db** | データベース | `postgres:16-alpine` | `15432:5432` | 172.26.0.2 |
| **api** | Web API | カスタムビルド (.NET) | `5000:5000` | 172.26.0.3 |
| **frontend** | フロントエンド | カスタムビルド (React + Nginx) | `3000:80` | 172.26.0.4 |

**依存関係**:
- `frontend` → `api`
- `api` → `db` (ヘルスチェック待機)

**Docker Compose ファイル**: `/workdir/docker-compose.yml`

### 1.2 技術スタック

| コンポーネント | 技術 | バージョン | 詳細 |
|--------------|------|-----------|------|
| **Frontend** | React | 19.2.0 | Vite でビルド、TypeScript使用 |
| | Nginx | 1.29.5 (Alpine) | リバースプロキシ・静的ファイル配信 |
| | Node.js | 22-alpine | ビルド環境 |
| **API** | ASP.NET Core | .NET 10.0-preview | Kestrel サーバー |
| | OpenAPI | 標準搭載 | `/openapi/v1.json` で定義公開 |
| | Npgsql | 9.0.3 | PostgreSQL接続ドライバ |
| | Newtonsoft.Json | 13.0.3 | JSONシリアライズ |
| **Database** | PostgreSQL | 16.12 (Alpine 15.2.0) | x86_64-pc-linux-musl |
| **コンテナ** | Docker Compose | (ホスト環境依存) | ネットワーク: `vulnerability-site_default` |

### 1.3 ネットワーク構成

**Dockerネットワーク**: `vulnerability-site_default` (デフォルトブリッジ)

```
┌─────────────────────────────────────────────────────────────┐
│ ホストマシン                                                   │
│                                                             │
│  localhost:3000  ──┐                                        │
│  localhost:5000  ──┼─> ポートマッピング                       │
│  localhost:15432 ──┘                                        │
└─────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Docker ネットワーク (172.26.0.0/16)                           │
│                                                             │
│  ┌───────────────┐     ┌───────────────┐     ┌──────────┐  │
│  │ frontend:80   │────>│ api:5000      │────>│ db:5432  │  │
│  │ 172.26.0.4    │     │ 172.26.0.3    │     │172.26.0.2│  │
│  │ Nginx + React │     │ .NET Kestrel  │     │PostgreSQL│  │
│  └───────────────┘     └───────────────┘     └──────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**DNS解決**:
- `frontend` → 172.26.0.4
- `api` → 172.26.0.3
- `db` → 172.26.0.2

**通信フロー**:
1. ブラウザ → `http://localhost:3000/` → frontend コンテナ (Nginx)
2. Nginx → `/api/*` → `http://api:5000/api/*` (リバースプロキシ)
3. API → `Host=db;Port=5432` → PostgreSQL

---

## 2. 公開エンドポイント

### 2.1 Frontend (`http://frontend:80` / `http://localhost:3000`)

**HTTPレスポンスヘッダ**:
```http
HTTP/1.1 200 OK
Server: nginx/1.29.5
Content-Type: text/html
Content-Length: 477 bytes
Last-Modified: Sun, 22 Feb 2026 04:31:51 GMT
ETag: "699a86b7-1dd"
Accept-Ranges: bytes
```

**配信内容**:
- React SPA (Single Page Application)
- `/assets/index-*.js` - バンドルされたJavaScript
- `/assets/index-*.css` - スタイルシート
- `vite.svg` - ファビコン

**ルーティング** (React Router):
```
/ ...................... ユーザー一覧
/users/:id ............. ユーザー詳細
/users/new ............. ユーザー新規作成
/users/:id/edit ........ ユーザー編集
/login ................. ログイン画面
```

### 2.2 API エンドポイント (`http://api:5000`)

**HTTPレスポンスヘッダ**:
```http
Server: Kestrel
Date: Mon, 23 Feb 2026 12:29:09 GMT
```

**OpenAPI定義**: `http://api:5000/openapi/v1.json` (304行、公開中)

**エンドポイント一覧**:

| メソッド | パス | 説明 | タグ |
|---------|------|------|------|
| POST | `/api/login` | ログイン認証 | Auth |
| GET | `/api/files/{filePath}` | ファイル取得 | File |
| POST | `/api/import` | JSONインポート | File |
| GET | `/api/Users` | ユーザー一覧 (検索対応) | Users |
| POST | `/api/Users` | ユーザー新規作成 | Users |
| GET | `/api/Users/{id}` | ユーザー詳細取得 | Users |
| PUT | `/api/Users/{id}` | ユーザー更新 | Users |
| DELETE | `/api/Users/{id}` | ユーザー削除 | Users |

**実際の応答例**:

```bash
# ユーザー一覧 (最初の3件)
GET /api/users
```
```json
[
  {
    "id": 2,
    "username": "updated_normal",
    "email": "updated@test.com",
    "password": "newpass",
    "role": "user",
    "profileImageUrl": "",
    "createdAt": "2026-02-23T03:48:36.116783",
    "updatedAt": "2026-02-23T09:54:49.580881"
  },
  {
    "id": 5,
    "username": "maliciousadmin",
    "email": "evil@test.com",
    "password": "test123",
    "role": "admin",
    "profileImageUrl": "thishouldnotexistandhopefullyitwillnot",
    "createdAt": "2026-02-23T03:49:55.345679",
    "updatedAt": "2026-02-23T06:38:01.95342"
  }
]
```

⚠️ **重大な発見**: **パスワードがAPIレスポンスに平文で含まれている**

### 2.3 データベース (`db:5432` / `localhost:15432`)

**接続情報**:
- **ホスト**: `db` (内部) / `localhost:15432` (外部公開)
- **ユーザー**: `postgres`
- **パスワード**: `postgres123` (Docker Compose にハードコード)
- **データベース名**: `vulndb`
- **SSL/TLS**: **無効** (`SSL Mode=Disable`)

**PostgreSQLバージョン**:
```
PostgreSQL 16.12 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
```

**テーブル構成**:

```sql
-- users テーブル
Table "public.users"
      Column       |            Type             | Nullable |              Default              
-------------------+-----------------------------+----------+-----------------------------------
 id                | integer                     | NOT NULL | nextval('users_id_seq'::regclass)
 username          | character varying(255)      | NOT NULL | 
 email             | character varying(255)      |          | 
 password          | character varying(255)      |          | 
 role              | character varying(50)       |          | 
 profile_image_url | text                        |          | 
 created_at        | timestamp without time zone |          | CURRENT_TIMESTAMP
 updated_at        | timestamp without time zone |          | CURRENT_TIMESTAMP

Indexes: "users_pkey" PRIMARY KEY, btree (id)
```

**初期データ** (`/workdir/src/db/seed.sql`):
```sql
INSERT INTO users (username, email, password, role, profile_image_url) VALUES
('admin', 'admin@example.com', 'admin123', 'admin', ''),
('tanaka', 'tanaka@example.com', 'password', 'user', ''),
('suzuki', 'suzuki@example.com', '123456', 'user', ''),
('sato', 'sato@example.com', 'qwerty', 'user', ''),
('yamada', 'yamada@example.com', 'letmein', 'user', '');
```

⚠️ **パスワードが平文で保存されている**

**現在のレコード数**: 5,803件 (テスト実行により増加)

---

## 3. HTTPレスポンスヘッダ分析

### 3.1 Frontend (Nginx)

```http
Server: nginx/1.29.5
```

**観察事項**:
- ✅ Nginxバージョンが公開されている（情報漏洩）
- ❌ セキュリティヘッダの欠如:
  - `X-Content-Type-Options` なし
  - `X-Frame-Options` なし
  - `Content-Security-Policy` なし
  - `Strict-Transport-Security` なし (HTTPS未使用)

### 3.2 API (Kestrel / ASP.NET Core)

```http
Server: Kestrel
```

**観察事項**:
- ✅ サーバー情報が公開されている
- ❌ `X-Powered-By` 等の追加ヘッダはないが、Kestrelの存在から.NETが特定可能
- ❌ CORS設定が過度に緩い（後述）

---

## 4. 設定ファイル分析

### 4.1 Docker Compose 設定 (`docker-compose.yml`)

**環境変数** (ハードコードされた秘匿情報):

```yaml
# データベース設定
POSTGRES_PASSWORD: postgres123  # ← 脆弱性 I-02, D-01

# API設定
ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
# ← 脆弱性 I-02 (パスワード直書き), D-03 (SSL無効)
```

**ポートマッピング**:
```yaml
ports:
  - "15432:5432"  # ← 脆弱性 I-03: DBポートが外部公開
```

⚠️ **重大な問題**: データベースが外部ネットワークから直接アクセス可能

**ボリュームマッピング**:
- `pgdata:/var/lib/postgresql/data` - データベース永続化
- `./src/db/init.sql` - スキーマ初期化
- `./src/db/seed.sql` - 初期データ投入

### 4.2 アプリケーション設定

#### API (`Program.cs`)

```csharp
// 脆弱性 A-05: CORS設定の不備
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()       // ← すべてのオリジン許可
              .AllowAnyMethod()       // ← すべてのHTTPメソッド許可
              .AllowAnyHeader();      // ← すべてのヘッダ許可
    });
});

// 脆弱性 A-04: 開発者ページを本番で有効化
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();  // ← 詳細エラー情報を公開
}
```

#### Frontend (`config.ts`)

```typescript
// 脆弱性 F-02: 機密情報のクライアント露出
export const API_BASE_URL = '/api';
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';  // ← ハードコード
export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';  // ← 内部URL露出

// 脆弱性 F-05: コンソールログへの機密情報出力
export function debugLog(label: string, data: unknown): void {
  console.log(`[DEBUG] ${label}:`, data);  // ← パスワードもログ出力
}
```

#### Nginx設定 (`nginx.conf`)

```nginx
location /api/ {
    proxy_pass http://api:5000/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

**観察事項**:
- リバースプロキシとして `/api/*` を API サーバーに転送
- セキュリティヘッダの追加なし

---

## 5. ソースコード概観

### 5.1 ディレクトリ構造

```
/workdir/
├── docker-compose.yml     # サービス定義
├── .env                   # 環境変数 (GitHub Token含む)
├── docs/
│   ├── specification.md   # アプリケーション仕様
│   └── vulnerabilities.md # 意図的な脆弱性一覧
└── src/
    ├── api/               # ASP.NET Core Web API
    │   ├── Dockerfile
    │   └── VulnApi/
    │       ├── Controllers/
    │       │   ├── UsersController.cs    # ユーザーCRUD
    │       │   ├── AuthController.cs     # ログイン
    │       │   └── FileController.cs     # ファイル操作
    │       ├── Models/
    │       │   ├── User.cs
    │       │   └── LoginModels.cs
    │       ├── Services/
    │       │   └── DbConnectionFactory.cs
    │       ├── Program.cs
    │       └── VulnApi.csproj
    ├── frontend/          # React SPA
    │   ├── Dockerfile
    │   ├── nginx.conf
    │   ├── package.json
    │   └── src/
    │       ├── main.tsx
    │       ├── App.tsx
    │       ├── api.ts              # API呼び出しロジック
    │       ├── config.ts           # 設定（機密情報含む）
    │       └── pages/
    │           ├── UserList.tsx
    │           ├── UserDetail.tsx
    │           ├── UserCreate.tsx
    │           ├── UserEdit.tsx
    │           └── Login.tsx
    ├── db/                # データベース初期化
    │   ├── init.sql       # スキーマ定義
    │   └── seed.sql       # 初期データ
    └── e2e/               # Playwright E2Eテスト
```

**ソースファイル数**: 19ファイル (`.cs`, `.tsx`, `.ts`)

### 5.2 主要ファイル

#### API - UsersController.cs

**SQLインジェクションの例** (脆弱性 A-01):

```csharp
// 文字列連結でSQL構築 → SQLインジェクション脆弱性
var sql = "SELECT ... FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
    // ↑ ユーザー入力を直接SQL文に埋め込み
}
```

**Mass Assignment脆弱性** (A-06):

```csharp
[HttpPost]
public async Task<IActionResult> Create([FromBody] User user)
{
    // リクエストボディのroleフィールドがそのまま受け入れられる
    // → 一般ユーザーが自分をadminに昇格可能
}
```

#### API - AuthController.cs

**ログイン処理** (複数の脆弱性):

```csharp
// 脆弱性 A-01: SQLインジェクション
var sql = $"SELECT ... FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";

// 脆弱性 A-03: パスワード平文比較
// 脆弱性 A-09: レート制限なし

// 脆弱性 A-08: HTTPヘッダインジェクション
Response.Headers.Append("X-User-Role", user.Role);
Response.Headers.Append("X-Username", user.Username);
```

#### API - FileController.cs

**ディレクトリトラバーサル** (A-07):

```csharp
[HttpGet("files/{*filePath}")]
public IActionResult GetFile(string filePath)
{
    // パスのバリデーションなし
    var fullPath = Path.Combine("/app/uploads", filePath);
    // → ../../../../etc/passwd 等のアクセスが可能
}
```

**安全でないデシリアライズ** (A-10):

```csharp
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All  // ← RCE脆弱性
};
var result = JsonConvert.DeserializeObject(json, settings);
```

#### Frontend - UserList.tsx

**オープンリダイレクト** (F-03):

```typescript
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const redirect = params.get('redirect');
  if (redirect) {
    window.location.href = redirect;  // ← 検証なし
  }
}, []);
```

#### Frontend - api.ts

**CSRF対策の欠如** (F-04):

```typescript
const headers = { 'Content-Type': 'application/json' };
// CSRFトークンの送信なし
```

**パスワードのログ出力** (F-05):

```typescript
export async function login(username: string, password: string) {
  debugLog('login attempt', { username, password });  // ← コンソールに出力
}
```

### 5.3 依存パッケージ

#### Frontend (`package.json`)

```json
{
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.13.0"
  },
  "devDependencies": {
    "vite": "^7.2.4",
    "typescript": "~5.9.3"
  }
}
```

#### API (`VulnApi.csproj`)

```xml
<PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="10.0.0-preview.7.25380.108" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="Npgsql" Version="9.0.3" />
```

**観察事項**:
- .NET 10.0 プレビュー版を使用 (安定版ではない)
- Newtonsoft.Json はデシリアライズ脆弱性で知られる

---

## 6. 初期観察事項（セキュリティ上の懸念点）

### 🔴 Critical (重大)

1. **パスワードの平文保存・平文通信**
   - データベースのpasswordカラムに平文保存
   - APIレスポンスにパスワードが含まれる
   - 影響: 全ユーザーのパスワードが容易に漏洩

2. **SQLインジェクション脆弱性**
   - 全てのAPI（検索、ログイン、CRUD）で文字列連結によるSQL構築
   - 影響: データベース全体へのアクセス、データ改ざん・削除

3. **データベースポートの外部公開**
   - `localhost:15432` から直接PostgreSQLにアクセス可能
   - パスワード: `postgres123` (弱い・ハードコード)
   - 影響: 認証突破後、DB全体が掌握される

4. **認証・認可の欠如**
   - ユーザー削除APIに認証チェックなし
   - Mass Assignment により一般ユーザーがadminに昇格可能
   - 影響: 権限昇格、不正なデータ操作

5. **安全でないデシリアライズ (RCE)**
   - `TypeNameHandling.All` 設定によりリモートコード実行が可能
   - 影響: サーバー完全掌握

### 🟡 High (高)

6. **ディレクトリトラバーサル**
   - `/api/files/{filePath}` でパス検証なし
   - 影響: システムファイル（/etc/passwd等）の読み取り

7. **CORS設定の不備**
   - AllowAnyOrigin により全てのオリジンからのリクエストを許可
   - 影響: CSRF攻撃、情報漏洩

8. **HTTPヘッダインジェクション**
   - ユーザー入力をHTTPヘッダに未検証で設定
   - 影響: レスポンス分割攻撃

9. **詳細エラー情報の露出**
   - スタックトレース、データベースエラーがクライアントに返される
   - 影響: 内部構造の暴露、攻撃の手がかり提供

10. **XSS (クロスサイトスクリプティング)**
    - `dangerouslySetInnerHTML` でユーザー入力を未サニタイズ表示
    - 影響: セッション乗っ取り、フィッシング

### 🟢 Medium (中)

11. **オープンリダイレクト**
    - `?redirect=` パラメータを検証なしで使用
    - 影響: フィッシング攻撃の踏み台

12. **レート制限の欠如**
    - ログインAPIに回数制限なし
    - 影響: ブルートフォース攻撃

13. **機密情報のクライアント露出**
    - APIキー、内部URLがフロントエンドコードにハードコード
    - 影響: 内部システムへの攻撃手がかり

14. **コンソールログへの機密情報出力**
    - パスワードがブラウザコンソールに表示
    - 影響: ショルダーハッキング、ログファイルからの漏洩

15. **コンテナのroot実行**
    - 全コンテナがroot権限で実行
    - 影響: コンテナ脱出時の影響拡大

16. **SSL/TLS未使用**
    - HTTP通信、データベース接続が平文
    - 影響: 通信傍受、中間者攻撃

17. **セキュリティヘッダの欠如**
    - CSP, X-Frame-Options, HSTS等が未設定
    - 影響: XSS、クリックジャッキング

### 📊 統計サマリー

| カテゴリ | 脆弱性数 |
|---------|---------|
| Frontend (F-01〜F-05) | 5件 |
| API (A-01〜A-10) | 10件 |
| Database (D-01〜D-04) | 4件 |
| Infrastructure (I-01〜I-03) | 3件 |
| **合計** | **22件** |

---

## 7. 次のステップ（推奨される診断手順）

情報収集により、以下の脆弱性診断が有効であることが判明しました：

### 7.1 自動スキャン

- [ ] **Nmap**: ポートスキャン、サービスバージョン特定
- [ ] **OWASP ZAP**: パッシブ/アクティブスキャン
- [ ] **Nikto**: Webサーバー脆弱性スキャン
- [ ] **sqlmap**: SQLインジェクション自動検出・悪用
- [ ] **Trivy**: コンテナイメージ脆弱性スキャン

### 7.2 手動検証

- [ ] **SQLインジェクション**: `/api/users?search=`, `/api/login`
- [ ] **ディレクトリトラバーサル**: `/api/files/../../../../etc/passwd`
- [ ] **Mass Assignment**: `POST /api/users` で `role: "admin"` 送信
- [ ] **認証バイパス**: `DELETE /api/users/1` を未認証で実行
- [ ] **XSS**: `username` フィールドに `<script>alert(1)</script>` 挿入
- [ ] **オープンリダイレクト**: `/?redirect=http://evil.com`
- [ ] **安全でないデシリアライズ**: `/api/import` にペイロード送信

### 7.3 ペネトレーションテスト

- [ ] データベース直接接続 (`psql -h localhost -p 15432 -U postgres`)
- [ ] パスワードリスト攻撃 (rockyou.txt等)
- [ ] 権限昇格テスト
- [ ] セッション管理の検証

---

## 付録A: 主要な設定ファイルの要約

### docker-compose.yml (抜粋)

```yaml
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: postgres123  # 脆弱
    ports:
      - "15432:5432"  # 外部公開（脆弱）
  
  api:
    environment:
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
    ports:
      - "5000:5000"
  
  frontend:
    ports:
      - "3000:80"
```

### .env (抜粋)

```bash
GH_TOKEN=github_pat_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

⚠️ GitHub Personal Access Token が平文保存

---

## 付録B: OpenAPI エンドポイント詳細

完全なOpenAPI定義: `http://api:5000/openapi/v1.json` (304行)

主要スキーマ:

```json
{
  "components": {
    "schemas": {
      "User": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "username": { "type": "string" },
          "email": { "type": "string" },
          "password": { "type": "string" },  // ← レスポンスに含まれる
          "role": { "type": "string" },
          "profileImageUrl": { "type": "string" },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" }
        }
      }
    }
  }
}
```

---

## 結論

本情報収集により、対象アプリケーションは**教育目的で意図的に脆弱性を含む環境**であることが確認されました。

**22件の脆弱性**がドキュメント化されており、SQLインジェクション、認証バイパス、パスワード平文保存など、OWASPトップ10の多くをカバーしています。

次フェーズでは、各脆弱性の実証（PoC）と詳細な影響分析を実施します。

---

**レポート作成者**: 情報収集エージェント (Reconnaissance)  
**レポート形式**: CEH情報収集フェーズに基づく  
**対象環境**: ローカルネットワーク内のDocker Compose環境のみ
