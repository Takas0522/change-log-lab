# 情報収集レポート

> 実施日時: 2026年02月23日 02:12:37

## 1. 対象アプリケーション概要

### 1.1 アプリケーション名
ユーザー管理システム（脆弱性診断用サンプルアプリケーション）

### 1.2 サービス構成

Docker Composeにより以下の3つのサービスで構成されています：

| サービス | コンテナ名 | IPアドレス | ポートマッピング | 役割 |
|---------|-----------|-----------|----------------|------|
| frontend | frontend | 172.26.0.4 | 3000:80 | React + Nginx フロントエンド |
| api | api | 172.26.0.3 | 5000:5000 | ASP.NET Core Web API |
| db | db | 172.26.0.2 | 15432:5432 | PostgreSQL 16 データベース |

**依存関係:**
- `frontend` → `api` (APIエンドポイントへのプロキシ)
- `api` → `db` (データベース接続)

**ヘルスチェック:**
- DB: `pg_isready -U postgres` (5秒間隔)
- API: TCP接続チェック (10秒間隔、15秒起動猶予)
- Frontend: HTTP GETリクエスト (10秒間隔、10秒起動猶予)

### 1.3 技術スタック

| コンポーネント | 技術 | バージョン | 詳細 |
|--------------|------|-----------|------|
| Frontend | React | 19.2.0 | Vite + TypeScript |
| Frontend Server | Nginx | 1.29.5 (Alpine) | リバースプロキシ設定あり |
| API Framework | ASP.NET Core | .NET 10.0 Preview | OpenAPI対応 |
| Database | PostgreSQL | 16-alpine | - |
| コンテナ | Docker Compose | - | 3サービス構成 |
| Node.js | Node.js | 22-alpine | ビルド環境 |
| ビルドツール | Vite | 7.2.4 | フロントエンドビルド |
| TypeScript | TypeScript | 5.9.3 | 型チェック |
| ルーティング | React Router | 7.13.0 | SPA ルーティング |

**主要な依存パッケージ (API):**
- `Npgsql` 9.0.3 (PostgreSQL接続)
- `Newtonsoft.Json` 13.0.3 (JSON処理)
- `Microsoft.AspNetCore.OpenApi` 10.0.0-preview (OpenAPI定義)

### 1.4 ネットワーク構成

**Docker Network:**
- ネットワーク名: `vulnerability-site_default` (Bridge)
- サブネット: 172.26.0.0/16
- コンテナ間通信: 内部DNS名解決により `frontend`, `api`, `db` で相互通信可能

**外部公開ポート:**
- Frontend: `localhost:3000` → `frontend:80`
- API: `localhost:5000` → `api:5000`
- Database: `localhost:15432` → `db:5432` ⚠️ **外部公開（脆弱性 I-03）**

**プロキシ設定 (Nginx):**
```nginx
location /api/ {
    proxy_pass http://api:5000/api/;
}
```
フロントエンドからAPIへのリクエストはNginxがプロキシします。

## 2. 公開エンドポイント

### 2.1 Frontend
**URL:** `http://frontend:80` (ホスト: `http://localhost:3000`)

**レスポンス情報:**
```
HTTP/1.1 200 OK
Server: nginx/1.29.5
Content-Type: text/html
Content-Length: 477 bytes
```

**画面一覧:**
| 画面名 | パス | 説明 |
|--------|------|------|
| ユーザー一覧 | `/` | ユーザーの一覧表示。検索機能付き |
| ユーザー詳細 | `/users/:id` | ユーザーの詳細情報表示 |
| ユーザー追加 | `/users/new` | 新規ユーザー登録フォーム |
| ユーザー編集 | `/users/:id/edit` | ユーザー情報編集フォーム |
| ログイン | `/login` | ログイン画面 |

### 2.2 API エンドポイント
**URL:** `http://api:5000` (ホスト: `http://localhost:5000`)

**レスポンスヘッダ情報:**
```
Server: Kestrel
Date: Mon, 23 Feb 2026 02:12:01 GMT
```

**OpenAPI定義:** `http://api:5000/openapi/v1.json`

**エンドポイント一覧:**

| メソッド | パス | 説明 | 脆弱性 |
|----------|------|------|--------|
| GET | `/api/users` | ユーザー一覧取得（検索クエリ `?search=xxx` 対応） | A-01 SQLインジェクション |
| GET | `/api/users/{id}` | ユーザー詳細取得 | A-01 SQLインジェクション |
| POST | `/api/users` | ユーザー新規作成 | A-01, A-03, A-06 |
| PUT | `/api/users/{id}` | ユーザー更新 | A-01, A-03, A-06 |
| DELETE | `/api/users/{id}` | ユーザー削除 | A-02 認証バイパス |
| POST | `/api/login` | ログイン | A-01, A-03, A-08, A-09 |
| GET | `/api/files/{filePath}` | ファイル取得 | A-07 ディレクトリトラバーサル |
| POST | `/api/import` | JSONデータインポート | A-10 安全でないデシリアライズ |

**実際のAPIレスポンス例 (GET /api/users/1):**
```json
{
    "id": 1,
    "username": "hacked_admin",
    "email": "hacked@test.com",
    "password": "hacked",
    "role": "admin",
    "profileImageUrl": "",
    "createdAt": "2026-02-23T00:43:55.37237",
    "updatedAt": "2026-02-23T00:52:06.64358"
}
```

⚠️ **重大な問題:** パスワードが平文でAPIレスポンスに含まれています（A-03）

### 2.3 データベース
**接続情報:**
- ホスト: `db` (コンテナ内) / `localhost:15432` (ホスト側)
- データベース名: `vulndb`
- ユーザー名: `postgres`
- パスワード: `postgres123` ⚠️ **弱いパスワード（D-01）**
- SSL: Disable ⚠️ **暗号化なし（D-03）**

⚠️ **重大な問題:** DBポート15432が外部公開されており、直接アクセス可能（I-03）

**データベーススキーマ (users テーブル):**
```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,  -- ⚠️ 平文パスワード (D-04)
    role VARCHAR(50) NOT NULL DEFAULT 'user',
    profile_image_url TEXT DEFAULT '',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**初期データ (seed.sql):**
```sql
INSERT INTO users (username, email, password, role, profile_image_url) VALUES
('admin', 'admin@example.com', 'admin123', 'admin', ''),
('tanaka', 'tanaka@example.com', 'password', 'user', ''),
('suzuki', 'suzuki@example.com', '123456', 'user', ''),
('sato', 'sato@example.com', 'qwerty', 'user', ''),
('yamada', 'yamada@example.com', 'letmein', 'user', '');
```

⚠️ すべてのパスワードが平文で格納されており、非常に弱いパスワードが使用されています。

## 3. HTTPレスポンスヘッダ分析

### 3.1 Frontend (Nginx)
```
HTTP/1.1 200 OK
Server: nginx/1.29.5
Date: Mon, 23 Feb 2026 02:11:57 GMT
Content-Type: text/html
Content-Length: 477
Last-Modified: Sun, 22 Feb 2026 04:31:51 GMT
Connection: keep-alive
ETag: "699a86b7-1dd"
Accept-Ranges: bytes
```

**セキュリティヘッダの欠如:**
- `X-Content-Type-Options` なし
- `X-Frame-Options` なし
- `Content-Security-Policy` なし
- `Strict-Transport-Security` なし

### 3.2 API (Kestrel)
```
HTTP/1.1 405 Method Not Allowed
Date: Mon, 23 Feb 2026 02:12:01 GMT
Server: Kestrel
Allow: GET, POST
```

**セキュリティヘッダの欠如:**
- `X-Content-Type-Options` なし
- `X-Frame-Options` なし
- CORS設定: `AllowAnyOrigin()` ⚠️ すべてのオリジンを許可（A-05）

**カスタムヘッダ (ログイン時):**
```
X-User-Role: {user.Role}
X-Username: {user.Username}
```
⚠️ ユーザー入力をそのままヘッダに設定（A-08 HTTPヘッダインジェクション）

## 4. 設定ファイル分析

### 4.1 Docker Compose 設定

**環境変数（ハードコード）:**
```yaml
# DB設定
POSTGRES_DB: vulndb
POSTGRES_USER: postgres
POSTGRES_PASSWORD: postgres123  # ⚠️ I-02: ハードコード

# API設定
ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"  # ⚠️ I-02, D-03
ASPNETCORE_ENVIRONMENT: Development
```

⚠️ **重大な問題:**
- パスワードがdocker-compose.ymlに平文でハードコード（I-02）
- SSL/TLS未使用（D-03）
- 本番環境で開発モードが有効（A-04 詳細エラー露出）

**ボリューム設定:**
```yaml
volumes:
  - pgdata:/var/lib/postgresql/data
  - ./src/db/init.sql:/docker-entrypoint-initdb.d/01-init.sql
  - ./src/db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
```

**セキュリティ上の問題:**
- すべてのコンテナがrootユーザーで実行（I-01）
- USERディレクティブが定義されていない

### 4.2 アプリケーション設定

**appsettings.json:**
```json
{
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123"
  }
}
```

⚠️ `AllowedHosts: "*"` - すべてのホストからのリクエストを許可

**Program.cs (CORS設定):**
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});
```

⚠️ A-05: すべてのオリジン・メソッド・ヘッダーを許可（CORS設定の不備）

**開発者例外ページ:**
```csharp
if (app.Environment.IsDevelopment())
{
    app.MapOpenApi();
    app.UseDeveloperExceptionPage();  // ⚠️ A-04
}
```

⚠️ スタックトレースを含む詳細なエラー情報が露出

## 5. ソースコード概観

### 5.1 ディレクトリ構造

```
/workdir/
├── docker-compose.yml
├── .env.example
├── src/
│   ├── api/
│   │   ├── Dockerfile
│   │   └── VulnApi/
│   │       ├── VulnApi.csproj
│   │       ├── Program.cs
│   │       ├── Controllers/
│   │       │   ├── UsersController.cs      (A-01, A-02, A-03, A-04, A-06)
│   │       │   ├── AuthController.cs       (A-01, A-03, A-08, A-09)
│   │       │   └── FileController.cs       (A-07, A-10)
│   │       ├── Models/
│   │       │   ├── User.cs                 (A-03, A-06)
│   │       │   └── LoginModels.cs
│   │       └── Services/
│   │           └── DbConnectionFactory.cs
│   ├── frontend/
│   │   ├── Dockerfile
│   │   ├── nginx.conf
│   │   ├── package.json
│   │   └── src/
│   │       ├── config.ts                   (F-02, F-05)
│   │       ├── api.ts                      (F-04, F-05)
│   │       ├── App.tsx
│   │       └── pages/
│   │           ├── UserList.tsx            (F-03)
│   │           ├── UserDetail.tsx          (F-01)
│   │           ├── UserCreate.tsx
│   │           ├── UserEdit.tsx
│   │           └── Login.tsx               (F-05)
│   └── db/
│       ├── init.sql                         (D-04)
│       └── seed.sql                         (A-03, D-04)
└── docs/
    ├── specification.md
    └── vulnerabilities.md
```

### 5.2 主要ファイル

**API コントローラー:**
- `UsersController.cs`: CRUD操作、SQLインジェクション脆弱性（A-01）
- `AuthController.cs`: ログイン処理、レート制限なし（A-09）
- `FileController.cs`: ファイル操作、ディレクトリトラバーサル（A-07）

**Frontend:**
- `config.ts`: APIキーのハードコード（F-02）
- `api.ts`: CSRF対策なし（F-04）、パスワードログ出力（F-05）
- `UserDetail.tsx`: XSS脆弱性（F-01）
- `UserList.tsx`: オープンリダイレクト（F-03）

### 5.3 依存パッケージ

**Frontend (package.json):**
```json
{
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.13.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^5.1.1",
    "typescript": "~5.9.3",
    "vite": "^7.2.4"
  }
}
```

**API (VulnApi.csproj):**
```xml
<PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="10.0.0-preview.7.25380.108" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="Npgsql" Version="9.0.3" />
```

## 6. 初期観察事項

### 6.1 セキュリティ上の重大な懸念点

#### 🔴 Critical（緊急対応必要）

1. **SQLインジェクション (A-01)**
   - すべてのDBクエリで文字列連結を使用
   - `search`パラメータで容易に攻撃可能
   - 例: `GET /api/users?search=test' OR '1'='1`

2. **パスワード平文保存 (A-03, D-04)**
   - データベースに平文で保存
   - APIレスポンスに含まれる
   - 初期データのパスワードも脆弱

3. **データベースポート外部公開 (I-03)**
   - `15432:5432` で外部公開
   - 直接攻撃が可能

4. **認証バイパス (A-02)**
   - DELETE操作に認証チェックなし
   - 管理者権限チェックなし

5. **ハードコードされた認証情報 (I-02)**
   - docker-compose.ymlにパスワード直書き
   - appsettings.jsonにも平文保存

#### 🟠 High（早急な対応推奨）

6. **XSS脆弱性 (F-01)**
   - `dangerouslySetInnerHTML`でユーザー入力を未サニタイズ表示
   - `profileImageUrl`フィールドで攻撃可能

7. **ディレクトリトラバーサル (A-07)**
   - `/api/files/{filePath}`でパス検証なし
   - `../`を使用してファイルシステム全体にアクセス可能

8. **安全でないデシリアライズ (A-10)**
   - `TypeNameHandling.All`による任意コード実行リスク
   - `/api/import`エンドポイント

9. **詳細エラー情報の露出 (A-04)**
   - スタックトレースをレスポンスに含む
   - データベース構造が露出

#### 🟡 Medium

10. **CSRF対策の欠如 (F-04)**
    - CSRFトークンなし
    - すべてのオリジンを許可（A-05）

11. **オープンリダイレクト (F-03)**
    - `?redirect=`パラメータの検証なし

12. **機密情報の露出 (F-02, F-05)**
    - APIキーのハードコード
    - コンソールログへのパスワード出力
    - localStorageに認証情報を平文保存

13. **レート制限の欠如 (A-09)**
    - ブルートフォース攻撃に対する防御なし

14. **HTTPヘッダインジェクション (A-08)**
    - ユーザー入力を未検証でヘッダに設定

15. **Mass Assignment (A-06)**
    - `role`フィールドが直接バインド可能
    - 一般ユーザーが管理者権限を取得可能

16. **rootユーザーでの実行 (I-01)**
    - すべてのコンテナがroot権限で実行

17. **SSL/TLS未使用 (D-03)**
    - データベース接続が暗号化されていない

### 6.2 観察された実際のデータ

APIから取得したユーザーデータには、過去のスキャンやテスト攻撃の痕跡が含まれています：

- `hacked_admin`: 管理者権限への昇格
- `<script>alert(1)</script>`: XSS攻撃のテスト
- `eviluser`: 不正な管理者アカウント作成

これは、アプリケーションに複数の脆弱性が実際に存在し、悪用可能であることを示しています。

### 6.3 次のステップへの推奨事項

1. **脆弱性スキャン**フェーズで以下を実施：
   - SQLインジェクションの自動スキャン
   - XSSペイロードのテスト
   - 認証・認可の欠陥検証
   - ディレクトリトラバーサルの検証

2. **手動検証**フェーズで以下を実施：
   - Mass Assignmentによる権限昇格
   - デシリアライズ攻撃のPoC作成
   - パスワードクラッキングの試行

3. **報告書作成**時の優先順位：
   - Critical/Highの脆弱性を優先
   - 実際に悪用可能なPoCを提供
   - CVSS スコアリングの実施

---

**情報収集完了**

合計17種類の脆弱性カテゴリが確認されました。すべての脆弱性がソースコード上で明示的にコメントされており、意図的に作成された脆弱性診断用アプリケーションであることが確認できます。
