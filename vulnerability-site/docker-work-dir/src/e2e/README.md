# Playwright E2E テスト — ZAP アクティブスキャン用

このディレクトリには、OWASP ZAP Proxy 経由で通信を収集するための Playwright E2E テストが含まれています。

## 📋 概要

- **目的**: ZAP アクティブスキャンのための通信収集
- **テスト数**: 102テスト（13ファイル）
- **シナリオ数**: 11シナリオ + スモークテスト
- **対象**: http://frontend:80, http://api:5000

## 🚀 テスト実行方法

### 1. 事前準備

```bash
# 依存パッケージのインストール
npm ci

# Chromium のインストール
npx playwright install chromium
```

### 2. テスト実行（Proxy なし — 動作検証用）

```bash
# 環境変数でProxy設定を無効化
unset ZAP_PROXY

# テスト実行
FRONTEND_URL=http://frontend:80 \
API_URL=http://api:5000 \
npx playwright test --reporter=list
```

### 3. テスト実行（Proxy あり — ZAP通信収集用）

```bash
# ZAP Proxy 経由でテスト実行
ZAP_PROXY=http://localhost:8090 \
FRONTEND_URL=http://frontend:80 \
API_URL=http://api:5000 \
npx playwright test --reporter=list
```

### 4. 特定シナリオのみ実行

```bash
# S-02（検索機能）のみ
npx playwright test s02-user-list-search.spec.ts

# S-07（認証）とS-09（XSS）のみ
npx playwright test s07-login.spec.ts s09-xss-scenario.spec.ts
```

### 5. デバッグモード

```bash
# ブラウザを表示して実行
npx playwright test --headed

# デバッグモード（ステップ実行）
npx playwright test --debug
```

## 📁 ファイル構成

```
tests/
├── helpers.ts                              # 共通ヘルパー関数
├── smoke.spec.ts                           # スモークテスト
├── s01-initial-access.spec.ts              # 初期アクセス
├── s02-user-list-search.spec.ts            # 検索機能
├── s03-user-create.spec.ts                 # ユーザー作成
├── s04-user-detail.spec.ts                 # ユーザー詳細
├── s05-user-edit.spec.ts                   # ユーザー編集
├── s06-user-delete.spec.ts                 # ユーザー削除
├── s07-login.spec.ts                       # 認証フロー
├── s08-error-cases.spec.ts                 # エラーケース
├── s09-xss-scenario.spec.ts                # XSS シナリオ
├── s10-file-operations.spec.ts             # ファイル操作
└── s11-frontend-vulnerabilities.spec.ts    # フロントエンド脆弱性
```

## 🎯 テストの特徴

### 通信収集最優先

- **ソフトアサーション**: `expect.soft()` を使用し、失敗しても処理を継続
- **エラー処理**: `try-catch` でエラーを捕捉し、テスト全体を止めない
- **ヘルパー関数**: `safeGoto()`, `safeFill()`, `safeClick()` で安全な操作

### ZAP Proxy 対応

- `playwright.config.ts` で Proxy 設定を自動切り替え
- `ZAP_PROXY` 環境変数が設定されている場合のみ Proxy 経由
- `page.request` によるAPI直接呼び出しも Proxy 経由で送信

### API直接呼び出し

UI操作に加え、`page.request.get/post/put/delete` でAPI を直接呼び出し、
UI経由で発生しない通信パターンも収集します。

## 📊 検証される脆弱性

| ID | カテゴリ | 脆弱性名 | 関連シナリオ |
|----|---------|---------|------------|
| A-01 | Injection | SQLインジェクション | S-02, S-03, S-04, S-05, S-07, S-08 |
| A-02 | Broken Auth | 認証バイパス | S-01, S-06 |
| A-03 | Sensitive Data | パスワード平文保存 | S-01, S-07 |
| A-04 | XXE/SSRF | 詳細エラー露出 | S-04, S-08 |
| A-05 | Broken Access | CORS全許可 | - |
| A-06 | Security Misconfig | Mass Assignment | S-03, S-05 |
| A-07 | Path Traversal | ディレクトリトラバーサル | S-10 |
| A-08 | Injection | HTTPヘッダインジェクション | S-07 |
| A-09 | Rate Limiting | レート制限なし | S-07 |
| A-10 | Deserialization | 安全でないデシリアライズ | S-10 |
| F-01 | XSS | DOM-based XSS | S-09 |
| F-02 | Info Disclosure | 機密情報露出 | S-11 |
| F-03 | Open Redirect | オープンリダイレクト | S-11 |
| F-04 | CSRF | CSRF対策の欠如 | S-03, S-05, S-06 |
| F-05 | Info Disclosure | コンソールログ機密情報 | S-11 |

## 🔧 トラブルシューティング

### テストがタイムアウトする

```typescript
// playwright.config.ts でタイムアウトを延長
use: {
  navigationTimeout: 60000,  // 30秒 → 60秒
  actionTimeout: 30000,      // 15秒 → 30秒
}
```

### ZAPに通信が記録されない

```bash
# ZAP_PROXY 環境変数が正しく設定されているか確認
echo $ZAP_PROXY

# Proxy設定を確認
# playwright.config.ts の proxy 設定を確認
```

### セレクタが見つからない

ヘルパー関数 `findFirstSelector()` を使用して複数のセレクタ候補を試行：

```typescript
const selector = await findFirstSelector(page, [
  'button:has-text("作成")',
  'button[type="submit"]',
  'input[value="作成"]'
]);
```

## 📈 期待される成果

- **収集される通信数**: 80件以上
- **テスト成功率**: 70%以上（通信収集が目的のため、一部失敗も許容）
- **ZAP記録URL数**: 80件以上

## 🔗 関連ドキュメント

- [シナリオ文書](../../docs/zap-active-scan-scenarios.md)
- [実装ガイド](../../docs/playwright-implementation-guide.md)
- [検証サマリ](../../e2e-reports/TEST-VERIFICATION-SUMMARY.md)
- [テストファイル一覧](../../e2e-reports/TEST-FILES-SUMMARY.md)

## 📝 作成情報

- **作成日**: 2026-02-23
- **作成者**: Playwright テストコード生成エージェント
- **Playwright バージョン**: ^1.52.0
- **Node.js バージョン**: 22

---

**重要**: このテストは通信収集が最優先です。テストの成否よりも、
すべてのシナリオが実行され、ZAPに通信が記録されることを重視しています。
