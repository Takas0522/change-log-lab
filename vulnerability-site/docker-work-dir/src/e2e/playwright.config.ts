import { defineConfig } from '@playwright/test';

/**
 * OWASP ZAP パッシブスキャン用 Playwright 設定
 *
 * ZAP Proxy 経由でブラウザを動作させ、全 HTTP 通信を ZAP に収集させる。
 * 環境変数:
 *   - FRONTEND_URL: フロントエンドURL (default: http://frontend:80)
 *   - API_URL: API URL (default: http://api:5000)
 *   - ZAP_PROXY: ZAP Proxy アドレス (設定時のみ Proxy 経由)
 *   - E2E_REPORT_DIR: レポート出力先 (default: /docker-work-dir/e2e-reports/{timestamp})
 */

// タイムスタンプ付きレポートディレクトリ
// Docker 外から docker-work-dir/e2e-reports/ で確認可能
const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').slice(0, 19);
const reportDir = process.env.E2E_REPORT_DIR || `/docker-work-dir/e2e-reports/${timestamp}`;

export default defineConfig({
  testDir: './tests',
  fullyParallel: false,       // 順次実行で通信を確実に収集
  retries: 0,                 // 通信収集が目的のためリトライ不要
  workers: 1,                 // 単一ワーカーで順次実行
  timeout: 60_000,            // 各テスト60秒タイムアウト
  expect: {
    timeout: 10_000,
  },

  // テスト成果物（スクリーンショット・動画・トレース）の出力先
  outputDir: `${reportDir}/test-results`,

  use: {
    baseURL: process.env.FRONTEND_URL || 'http://frontend:80',

    // ZAP Proxy 経由で全通信を送信（ZAP_PROXY 環境変数が設定されている場合のみ）
    // P-2（動作検証）では Proxy なし、P-3（パッシブスキャン）では Proxy あり
    ...(process.env.ZAP_PROXY ? { proxy: { server: process.env.ZAP_PROXY } } : {}),

    // ヘッドレス実行
    headless: true,

    // HTTPS 証明書エラーを無視（ZAP Proxy の自己署名証明書対応）
    ignoreHTTPSErrors: true,

    // スクリーンショット（常に保存）
    screenshot: 'on',

    // 動画録画（常に保存）
    video: 'on',

    // トレース（常に保存）
    trace: 'on',

    // タイムアウト設定
    actionTimeout: 10_000,
    navigationTimeout: 30_000,
  },

  // Chromium のみ使用（scanner コンテナにインストール済み）
  projects: [
    {
      name: 'chromium',
      use: {
        browserName: 'chromium',
        // Chromium 起動オプション
        launchOptions: {
          args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            // ZAP_PROXY環境変数がない場合は明示的にプロキシ無効化
            ...(process.env.ZAP_PROXY ? [] : ['--no-proxy-server']),
          ],
        },
      },
    },
  ],

  // レポーター設定（タイムスタンプ付きディレクトリに出力）
  reporter: [
    ['list'],
    ['json', { outputFile: `${reportDir}/playwright-results.json` }],
    ['html', { outputFolder: `${reportDir}/html-report`, open: 'never' }],
  ],
});
