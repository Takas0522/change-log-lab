# =============================================================================
# 統合脆弱性スキャナー + GitHub Copilot CLI
#
# 内包ツール:
#   - OWASP ZAP       (Web アプリケーション脆弱性スキャナー)
#   - Nikto            (Web サーバースキャナー)
#   - sqlmap            (SQL インジェクション特化スキャナー)
#   - Nmap             (ネットワーク脆弱性スキャナー)
#   - Trivy            (コンテナ / ファイルシステム脆弱性スキャナー)
#   - GitHub Copilot CLI (AI アシスタント)
#   - GitHub CLI (gh)
#
# ベースイメージ: Debian Bookworm (Kali/ParrotOS と同系統)
# =============================================================================
FROM debian:bookworm-slim

LABEL maintainer="vulnerability-scanner"
LABEL description="All-in-one vulnerability scanner with OWASP ZAP, Nikto, sqlmap, Nmap, Trivy, and GitHub Copilot CLI"

# --- 環境変数 ---
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    ZAP_VERSION=2.16.1 \
    TRIVY_VERSION=0.58.2 \
    NODE_MAJOR=22

# =============================================================================
# 1. システムパッケージ（Nmap 含む）
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 基本ツール
    ca-certificates \
    curl \
    wget \
    git \
    unzip \
    gnupg \
    lsb-release \
    jq \
    # Nmap
    nmap \
    # Python 3 (sqlmap / Nikto依存)
    python3 \
    python3-pip \
    python3-venv \
    # Java (OWASP ZAP)
    default-jre-headless \
    # Nikto 依存
    perl \
    libnet-ssleay-perl \
    libwhisker2-perl \
    libjson-perl \
    libxml-writer-perl \
    libwww-perl \
    # ネットワークツール
    net-tools \
    iputils-ping \
    dnsutils \
    # PostgreSQL クライアント (DB直接検証用)
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# 2. Node.js 22 (Copilot CLI 前提条件)
# =============================================================================
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_MAJOR}.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/* \
    && node --version && npm --version

# =============================================================================
# 3. GitHub CLI (gh)
# =============================================================================
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y --no-install-recommends gh \
    && rm -rf /var/lib/apt/lists/* \
    && gh --version

# =============================================================================
# 4. GitHub Copilot CLI
#    認証: コンテナ起動時に GH_TOKEN 環境変数 または /login で認証
# =============================================================================
RUN npm install -g @github/copilot \
    && copilot --version || echo "Copilot CLI installed (version check may require auth)"

# =============================================================================
# 5. OWASP ZAP (ヘッドレスモード)
# =============================================================================
RUN mkdir -p /opt/zap \
    && curl -fsSL "https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/ZAP_${ZAP_VERSION}_Linux.tar.gz" \
        | tar xz -C /opt/zap --strip-components=1 \
    && ln -s /opt/zap/zap.sh /usr/local/bin/zap.sh

# ZAP Docker ラッパースクリプトを GitHub から取得
# (standalone tarball にはラッパースクリプトが含まれないため)
RUN for script in zap-baseline.py zap-full-scan.py zap-api-scan.py zap_common.py; do \
      curl -fsSL "https://raw.githubusercontent.com/zaproxy/zaproxy/v${ZAP_VERSION}/docker/${script}" \
        -o "/opt/zap/${script}" \
      && chmod +x "/opt/zap/${script}"; \
    done

# ZAP Python API クライアント（ラッパースクリプトの依存）
RUN pip3 install --no-cache-dir --break-system-packages python-owasp-zap-v2.4 requests pyyaml

# ZAP の Python スクリプトをPATHに配置
ENV PATH="/opt/zap:${PATH}"

# ZAP Docker ラッパースクリプト互換パス設定
# ラッパースクリプト (zap_common.py) は公式 ZAP Docker イメージの
# レイアウト (/zap/zap-x.sh) をハードコードしているため、
# /zap -> /opt/zap へのシンボリックリンクと zap-x.sh の互換スクリプトを作成
RUN ln -sfn /opt/zap /zap \
    && cp /opt/zap/zap.sh /zap/zap-x.sh \
    && chmod +x /zap/zap-x.sh \
    && mkdir -p /zap/wrk

# =============================================================================
# 6. Nikto (Git からインストール)
# =============================================================================
RUN git clone --depth 1 https://github.com/sullo/nikto.git /opt/nikto \
    && ln -s /opt/nikto/program/nikto.pl /usr/local/bin/nikto

# =============================================================================
# 7. sqlmap (Git からインストール)
# =============================================================================
RUN git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git /opt/sqlmap \
    && ln -s /opt/sqlmap/sqlmap.py /usr/local/bin/sqlmap \
    && chmod +x /opt/sqlmap/sqlmap.py

# =============================================================================
# 8. Trivy (公式バイナリ)
# =============================================================================
RUN curl -fsSL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb" \
        -o /tmp/trivy.deb \
    && dpkg -i /tmp/trivy.deb \
    && rm /tmp/trivy.deb \
    && trivy --version

# =============================================================================
# 9. Playwright + Chromium（ZAP アクティブスキャン用）
#    ZAP Proxy 経由でブラウザを操作し通信を収集・アクティブスキャンを実施
# =============================================================================
RUN npm install -g @playwright/test \
    && npx playwright install --with-deps chromium \
    && npx playwright --version

# =============================================================================
# 10. 作業ディレクトリ / レポート出力先
# =============================================================================
RUN mkdir -p /reports/{zap,zap-active,nikto,nmap,sqlmap,trivy} /workdir /docker-work-dir

WORKDIR /workdir

# =============================================================================
# 11. docker-work-dir 環境変数
#     ホスト側の docker-work-dir をマウントするパス
#     Copilot CLI がカスタムエージェント (.github/agents/) を認識するための
#     作業ディレクトリとして使用される
# =============================================================================
ENV DOCKER_WORK_DIR=/docker-work-dir

# =============================================================================
# 12. エントリポイント / スキャンスクリプト
# =============================================================================
COPY scanner-entrypoint.sh /usr/local/bin/scanner-entrypoint.sh
RUN chmod +x /usr/local/bin/scanner-entrypoint.sh

ENTRYPOINT ["/usr/local/bin/scanner-entrypoint.sh"]
CMD ["help"]
