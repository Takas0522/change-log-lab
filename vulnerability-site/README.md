# 脆弱性診断環境（vulnerability-site）

意図的に脆弱性を埋め込んだ Web アプリケーションと、  
自動脆弱性診断ツールを統合した学習・検証用環境です。

> **⚠️ 警告**: 本環境はローカル検証専用です。本番環境やインターネットに公開しないでください。

---

## アーキテクチャ

```
┌─────────────┐    ┌─────────────┐    ┌─────────────────┐
│  Frontend   │    │   Web API   │    │   PostgreSQL    │
│  (React)    │◄──►│ (ASP.NET)   │◄──►│   (16-alpine)   │
│  :3000      │    │  :5000      │    │  :15432         │
└─────────────┘    └─────────────┘    └─────────────────┘
                          ▲
                          │  Docker Network
                          ▼
              ┌───────────────────────┐
              │   Scanner Container   │
              │  ZAP / Nikto / Nmap   │
              │  sqlmap / Trivy       │
              │  GitHub Copilot CLI   │
              └───────────────────────┘
```

## 前提条件

- Docker & Docker Compose
- GitHub Token（Copilot CLI オーケストレーター使用時）

---

## クイックスタート

### 0. 環境変数の設定

`.env.example` をコピーして `.env` を作成し、`GH_TOKEN` を設定してください:

```bash
cp .env.example .env
# .env ファイルを編集して GH_TOKEN の値を設定
```

Token は [Fine-grained personal access tokens](https://github.com/settings/personal-access-tokens/new) から作成し、
**Permissions → "Copilot Requests"** を有効化してください。

> `.env` は `.gitignore` に含まれており、Git にコミットされません。

### 1. アプリケーションの起動

```bash
cd vulnerability-site
docker compose up -d --build
```

ヘルスチェックが通るまで待機後、以下で確認:

```bash
docker compose ps
```

| サービス   | URL                        |
|-----------|----------------------------|
| Frontend  | http://localhost:3000       |
| API       | http://localhost:5000       |
| Database  | localhost:15432             |

### 2. アプリケーションの停止

```bash
docker compose down
```

---

## 脆弱性スキャン

Scanner コンテナに以下のツールが統合されています:

| ツール      | 用途                             |
|------------|----------------------------------|
| OWASP ZAP  | Web アプリケーション脆弱性スキャン     |
| Nikto      | Web サーバー設定検査                |
| sqlmap     | SQL インジェクション特化スキャン      |
| Nmap       | ネットワーク・ポートスキャン           |
| Trivy      | コンテナ / ファイルシステム脆弱性スキャン |
| Copilot CLI | AI による脆弱性診断オーケストレーション |

### 全スキャン一括実行

```bash
docker compose --profile scan run --rm scanner all
```

### 個別スキャン

```bash
docker compose --profile scan run --rm scanner nmap          # Nmap
docker compose --profile scan run --rm scanner nikto         # Nikto
docker compose --profile scan run --rm scanner zap-baseline  # ZAP ベースライン（高速）
docker compose --profile scan run --rm scanner zap-full      # ZAP フルスキャン（長時間）
docker compose --profile scan run --rm scanner zap-api       # ZAP API スキャン
docker compose --profile scan run --rm scanner sqlmap        # sqlmap
docker compose --profile scan run --rm scanner trivy         # Trivy
```

### シェルに入る

```bash
docker compose --profile scan run --rm -it scanner shell
```

---

## AI オーケストレーター（Copilot CLI）

GitHub Copilot CLI のカスタムエージェント `vuln-scan-orchestrator` を使用し、  
CEH（Certified Ethical Hacker）の手法に基づく**全7工程の脆弱性診断を自動実行**します。

### 工程一覧

| # | 工程                 | サブエージェント          | 出力レポート                              |
|---|----------------------|------------------------|------------------------------------------|
| 1 | 情報収集             | `01-reconnaissance`     | `docs/reports/01-情報収集.md`              |
| 2 | アタックサーフェース定義 | `02-attack-surface`    | `docs/reports/02-アタックサーフェース定義.md` |
| 3 | スキャン             | `03-scanning`           | `docs/reports/03-スキャン.md`              |
| 4 | 列挙                 | `04-enumeration`        | `docs/reports/04-列挙.md`                  |
| 5 | 検証項目の決定        | `05-verification-plan`  | `docs/reports/05-検証項目.md`              |
| 6 | 検証                 | `06-verification`       | `docs/reports/06-検証.md`                  |
| 7 | リスク評価&是正提案   | `07-risk-assessment`    | `docs/reports/07-リスク評価_是正提案.md`    |

### 実行方法

#### A. 便利スクリプト（推奨）

`.env` に `GH_TOKEN` が設定済みであれば、そのまま実行できます:

```bash
./run-orchestrator.sh
```

スクリプトが自動的に以下を行います:

1. `GH_TOKEN` の存在確認
2. アプリケーションサービスの起動確認（未起動なら起動）
3. レポートディレクトリの作成
4. Scanner コンテナでオーケストレーター実行
5. 完了後のレポート一覧表示

#### B. Docker Compose 直接実行

```bash
docker compose --profile scan run --rm \
  -e GH_TOKEN=$GH_TOKEN \
  scanner orchestrate
```

#### C. Copilot CLI インタラクティブモード

Scanner コンテナ内で Copilot CLI を対話的に使用:

```bash
docker compose --profile scan run --rm -it \
  -e GH_TOKEN=$GH_TOKEN \
  scanner copilot
```

### Copilot CLI パラメータ（プログラマティックモード）

オーケストレーター内部では以下のパラメータで Copilot CLI を実行しています:

```bash
copilot \
  --agent=vuln-scan-orchestrator \   # カスタムエージェント指定
  --allow-all-tools \                # 全ツール自動承認（ヘッドレス実行に必須）
  --allow-all-paths \                # パスアクセス制限解除
  -p "プロンプト..."                  # プログラマティックモードのプロンプト
```

| オプション          | 説明                                              |
|--------------------|---------------------------------------------------|
| `--agent=NAME`     | `.github/agents/` 内のカスタムエージェントを指定       |
| `--allow-all-tools`| 全ツール（shell, write 等）を確認なしで自動承認        |
| `--allow-all-paths`| パスアクセス制限を解除                               |
| `--allow-tool`     | 特定ツールのみ自動承認（例: `--allow-tool 'shell'`）  |
| `--deny-tool`      | 特定ツールを拒否（例: `--deny-tool 'shell(rm)'`）    |
| `-p "prompt"`      | プログラマティックモード（非対話的にプロンプト実行）      |

> 参考: [GitHub Copilot CLI ドキュメント](https://docs.github.com/en/copilot/concepts/agents/about-copilot-cli)

---

## ディレクトリ構成

```
vulnerability-site/
├── docker-compose.yml          # サービス定義（db, api, frontend, scanner）
├── run-orchestrator.sh         # AI オーケストレーター起動スクリプト
├── docker-work-dir/            # Copilot CLI 作業ディレクトリ（コンテナにマウント）
│   ├── scanner/                # Scanner コンテナ（検査ツール）
│   │   ├── Dockerfile
│   │   └── scanner-entrypoint.sh
│   ├── .github/
│   │   └── agents/             # カスタムエージェント定義
│   │       ├── vuln-scan-orchestrator.agent.md
│   │       ├── 01-reconnaissance.agent.md
│   │       ├── 02-attack-surface.agent.md
│   │       ├── 03-scanning.agent.md
│   │       ├── 04-enumeration.agent.md
│   │       ├── 05-verification-plan.agent.md
│   │       ├── 06-verification.agent.md
│   │       └── 07-risk-assessment.agent.md
│   └── docs/
│       ├── reports/            # 診断レポート出力先
│       └── 進捗/               # 工程管理表・チェックリスト
├── reports/                    # スキャンツール生データ出力先
│   ├── zap/
│   ├── nikto/
│   ├── nmap/
│   ├── sqlmap/
│   └── trivy/
├── src/
│   ├── api/                    # ASP.NET Core Web API
│   ├── db/                     # PostgreSQL スキーマ / シードデータ
│   └── frontend/               # React フロントエンド
└── docs/
    ├── specification.md        # アプリケーション仕様
    ├── vulnerabilities.md      # 意図的脆弱性一覧
    └── scanning-guide.md       # スキャン環境構成ガイド
```

### コンテナ内ディレクトリマッピング

| ホスト側              | コンテナ内         | アクセス | 用途                      |
|----------------------|-------------------|---------|---------------------------|
| `./`                 | `/workdir`        | 読み取り | ソースコード参照             |
| `./docker-work-dir/` | `/docker-work-dir`| 読み書き | Copilot CLI 作業ディレクトリ |
| `./reports/`         | `/reports`        | 読み書き | スキャン結果出力             |

### 環境変数（.env）

| 変数名     | 必須 | 説明                                   |
|-----------|------|----------------------------------------|
| `GH_TOKEN`| ⭕   | GitHub Copilot CLI 認証トークン         |

`.env.example` をコピーして `.env` を作成してください。

---

## 意図的脆弱性

本アプリケーションには以下のカテゴリの脆弱性が埋め込まれています。  
詳細は [docs/vulnerabilities.md](docs/vulnerabilities.md) を参照してください。

| カテゴリ        | 件数 | 例                                  |
|----------------|------|--------------------------------------|
| Frontend       | 5    | XSS, CSRF, オープンリダイレクト          |
| Web API        | 10   | SQLi, 認証バイパス, CORS 不備           |
| Database       | 4    | 弱いパスワード, 平文保存, SSL 未使用     |
| Docker / インフラ | 3   | root 実行, ハードコード秘匿情報          |

---

## 注意事項

- スキャンは**ローカル検証環境のみ**で実施してください
- ZAP フルスキャンはアクティブ攻撃を行うため長時間かかります
- sqlmap は SQL インジェクションを試行するため DB データが変更される可能性があります
- `reports/` ディレクトリは `.gitignore` に追加することを推奨します
